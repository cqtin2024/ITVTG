<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quản Lý Giải Đấu & Cập Nhật Thông Tin (GitHub Sync)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100;400;700;900&display=swap" rel="stylesheet">
    <style>
        /* Base styles for Dark Mode */
        :root {
            --bg-color: #111827; /* Gray-900 */
            --text-color: #f3f4f6; /* Gray-100 */
            --card-bg: #1f2937; /* Gray-800 */
            --border-color: #374151; /* Gray-700 */
            --accent-color: #06b6d4; /* Cyan-500 */
            --match-bg: #1f2937;
            --input-bg: #4b5563; /* Gray-600 */
            --group-header-text: #60a5fa; /* Blue-400 */
        }
        
        /* Light Mode Overrides */
        .light-mode {
            --bg-color: #f9fafb; /* Gray-50 */
            --text-color: #111827; /* Gray-900 */
            --card-bg: #ffffff;
            --border-color: #e5e7eb; /* Gray-200 */
            --accent-color: #ef4444; /* Red-500 */
            --match-bg: #f3f4f6; /* Gray-100 */
            --input-bg: #ffffff;
            --group-header-text: #10b981; /* Emerald-500 */
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            transition: background-color 0.3s, color 0.3s;
        }
        .container {
            max-width: 1200px;
        }
        .score-input, .text-input {
            background-color: var(--input-bg);
            border: 1px solid var(--border-color);
            color: var(--text-color);
            transition: all 0.2s;
        }
        .score-input:focus, .text-input:focus {
            box-shadow: 0 0 0 3px var(--accent-color);
            border-color: var(--accent-color);
        }
        .tab-button {
            border-bottom-color: var(--border-color);
        }
        .tab-button.active {
            color: var(--accent-color);
            border-color: var(--accent-color);
            background-color: var(--card-bg);
        }
        .tab-content {
            display: none;
            background-color: var(--card-bg);
            border-radius: 0.75rem; /* rounded-xl */
            padding: 1.5rem; /* p-6 */
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); /* shadow-2xl */
        }
        /* Custom scrollbar */
        ::-webkit-scrollbar-thumb { background: var(--border-color); }
        ::-webkit-scrollbar-thumb:hover { background: #6b7280; }
        
        /* Specific content styles for brightness/clarity */
        .match-card {
            background-color: var(--match-bg);
            border-bottom: 1px solid var(--border-color);
        }
        .light-mode .match-card {
            background-color: #ffffff;
            border-bottom: 1px solid #e5e7eb;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
        }
        /* Modal Backdrop */
        .modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 50;
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <div id="app" class="container mx-auto">
        <header class="flex items-center justify-between mb-6">
            <div class="flex items-center">
                <svg class="w-10 h-10 md:w-12 md:h-12 text-[var(--accent-color)]" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 15.75l-4-4m0 0l4-4m-4 4h14M17 12a5 5 0 11-10 0 5 5 0 0110 0z"></path></svg>
                <div class="text-left ml-4">
                    <h1 class="text-xl md:text-3xl font-extrabold text-[var(--text-color)] leading-none">QUẢN LÝ GIẢI ĐẤU PICKLEBALL</h1>
                    <p class="text-xs md:text-sm text-[var(--accent-color)]">Cập Nhật Tỉ Số & Thông Tin Đội (GitHub Sync)</p>
                </div>
            </div>
            
            <button id="themeToggle" class="p-3 rounded-full bg-[var(--card-bg)] shadow-md text-[var(--text-color)] hover:bg-[var(--border-color)] transition duration-200">
                <svg id="sunIcon" class="w-6 h-6 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>
                <svg id="moonIcon" class="w-6 h-6 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path></svg>
            </button>
        </header>

        <div id="statusMessage" class="text-center p-4 bg-blue-900/50 rounded-lg text-blue-300 font-semibold mb-6">
            Đang tải dữ liệu trạng thái từ GitHub...
        </div>
        
        <nav class="mb-8 border-b border-[var(--border-color)] overflow-x-auto whitespace-nowrap">
            <button class="tab-button py-3 px-4 md:px-6 text-sm md:text-base font-semibold border-b-2 border-transparent text-gray-400 hover:text-[var(--accent-color)] transition" onclick="switchTab('General')" data-tab="General">General</button>
            <button class="tab-button py-3 px-4 md:px-6 text-sm md:text-base font-semibold border-b-2 border-transparent text-gray-400 hover:text-[var(--accent-color)] transition" onclick="switchTab('TeamManagement')" data-tab="TeamManagement">Quản Lý Đội</button>
            <button class="tab-button py-3 px-4 md:px-6 text-sm md:text-base font-semibold border-b-2 border-transparent text-gray-400 hover:text-[var(--accent-color)] transition" onclick="switchTab('GroupA')" data-tab="GroupA">Group A</button>
            <button class="tab-button py-3 px-4 md:px-6 text-sm md:text-base font-semibold border-b-2 border-transparent text-gray-400 hover:text-[var(--accent-color)] transition" onclick="switchTab('GroupB')" data-tab="GroupB">Group B</button>
            <button class="tab-button py-3 px-4 md:px-6 text-sm md:text-base font-semibold border-b-2 border-transparent text-gray-400 hover:text-[var(--accent-color)] transition" onclick="switchTab('GroupC')" data-tab="GroupC">Group C</button>
            <button class="tab-button py-3 px-4 md:px-6 text-sm md:text-base font-semibold border-b-2 border-transparent text-gray-400 hover:text-[var(--accent-color)] transition" onclick="switchTab('GroupD')" data-tab="GroupD">Group D</button>
            <button class="tab-button py-3 px-4 md:px-6 text-sm md:text-base font-semibold border-b-2 border-transparent text-gray-400 hover:text-[var(--accent-color)] transition" onclick="switchTab('Knockout')" data-tab="Knockout">Knockout</button>
            <button class="tab-button py-3 px-4 md:px-6 text-sm md:text-base font-semibold border-b-2 border-transparent text-gray-400 hover:text-[var(--accent-color)] transition" onclick="switchTab('Configuration')" data-tab="Configuration">Cấu Hình</button>
        </nav>

        <div id="General" class="tab-content">
             <h2 class="text-3xl font-extrabold text-yellow-500 mb-6 border-b border-[var(--border-color)] pb-2">Final Results (Kết quả chung cuộc)</h2>
            <section id="finalResults" class="mb-10 p-4 rounded-xl shadow-lg bg-[var(--match-bg)]"></section>

            <h2 class="text-3xl font-extrabold text-[var(--text-color)] mb-6 border-b border-[var(--border-color)] pb-2">Team List (Danh sách các đội)</h2>
            <section id="teamList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                </section>
        </div>
        
        <div id="TeamManagement" class="tab-content">
            <h2 class="text-3xl font-extrabold text-blue-500 mb-6 border-b border-[var(--border-color)] pb-2">Quản Lý Thông Tin Đội (Cập nhật `state3.json`)</h2>
            <p class="text-sm text-gray-400 mb-4">Điều chỉnh **Tên đội (Tn)**, **Tên người chơi (name)**, **Cấp độ (pL)**, và **Năm sinh (bY)**. Sau khi chỉnh sửa, hãy nhấn **CẬP NHẬT THÔNG TIN** để ghi đè `state3.json`.</p>
            
            <button id="commitTeamButton" onclick="commitTeamChangesToGitHub()" class="w-full md:w-auto px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-lg shadow-lg transition duration-300 mb-6 disabled:opacity-50">
                CẬP NHẬT THÔNG TIN ĐỘI (Ghi đè state3.json)
            </button>
            
            <div id="teamCommitResult" class="mt-3 p-3 rounded-lg text-sm font-semibold hidden"></div>

            <section id="teamManagementList" class="space-y-6"></section>
        </div>


        <div id="GroupA" class="tab-content grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div id="tableA" class="lg:col-span-1"></div>
            <div id="matchesA" class="lg:col-span-2"></div>
        </div>

        <div id="GroupB" class="tab-content grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div id="tableB" class="lg:col-span-1"></div>
            <div id="matchesB" class="lg:col-span-2"></div>
        </div>

        <div id="GroupC" class="tab-content grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div id="tableC" class="lg:col-span-1"></div>
            <div id="matchesC" class="lg:col-span-2"></div>
        </div>

        <div id="GroupD" class="tab-content grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div id="tableD" class="lg:col-span-1"></div>
            <div id="matchesD" class="lg:col-span-2"></div>
        </div>

        <div id="Knockout" class="tab-content">
            <div id="quarterfinals" class="mb-6"></div>
            <div id="semifinals" class="mb-6"></div>
            <div id="finalMatchSection">
                <div id="finalSection"></div>
            </div>
        </div>

        <div id="Configuration" class="tab-content space-y-8">
            <h2 class="text-3xl font-extrabold text-red-500 mb-6 border-b border-[var(--border-color)] pb-2">Cấu Hình & Đồng Bộ Hóa (GitHub API)</h2>
            
             <section class="p-4 bg-red-900/20 rounded-lg border-l-4 border-red-500">
                 <h3 class="text-xl font-bold text-red-400 mb-3 flex items-center">
                    <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-2a2 2 0 00-2-2H6a2 2 0 00-2 2v2a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path></svg>
                    1. GitHub Personal Access Token (PAT)
                </h3>
                <p class="text-sm text-red-300 mb-4 font-bold">CẢNH BÁO BẢO MẬT: Token này sẽ được lưu trữ trong trình duyệt. Chỉ sử dụng Token có phạm vi (Scope) nhỏ nhất. <span class="text-yellow-300">CẦN PHẢI CÓ QUYỀN **repo** (hoặc contents:write)</span>.</p>
                <input type="password" id="githubToken" 
                    class="score-input w-full p-2 rounded-md focus:ring-red-500 transition" 
                    placeholder="Dán GitHub PAT của bạn vào đây...">
                <button onclick="saveToken()" class="mt-2 px-4 py-1 bg-green-600 hover:bg-green-700 text-white text-sm font-bold rounded-lg transition duration-300">Lưu Token cục bộ</button>
            </section>

            <section class="p-4 bg-[var(--match-bg)] rounded-lg border-l-4 border-purple-500">
                <h3 class="text-xl font-bold text-[var(--group-header-text)] mb-3 flex items-center">
                    <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4"></path></svg>
                    2. Cập Nhật Tỉ Số (Commit) lên state3s.json
                </h3>
                <p class="text-gray-400 mb-4">Sử dụng Token đã lưu để commit những tỉ số **đã thay đổi** lên GitHub.</p>
                
                <button id="commitScoreButton" onclick="commitScoreChangesToGitHub()" class="w-full md:w-auto px-6 py-2 bg-purple-600 hover:bg-purple-700 text-white font-bold rounded-lg shadow-lg transition duration-300 mb-4 disabled:opacity-50">
                    COMMIT TỈ SỐ ĐÃ THAY ĐỔI
                </button>

                <div id="scoreCommitResult" class="mt-3 p-3 rounded-lg text-sm font-semibold hidden"></div>
            </section>
            
            <section class="p-4 bg-[var(--match-bg)] rounded-lg border-l-4 border-yellow-500">
                 <h3 class="text-xl font-bold text-[var(--group-header-text)] mb-3 flex items-center">
                    <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>
                    3. Tùy Chọn Giao Diện & Đồng Bộ Lại
                </h3>
                <p class="text-[var(--text-color)] mb-4">Bạn có thể chuyển đổi giữa giao diện Sáng/Tối hoặc tải lại trạng thái online mới nhất.</p>
                <button onclick="document.getElementById('themeToggle').click()" class="md:w-auto px-6 py-2 bg-yellow-500 hover:bg-yellow-600 text-black font-bold rounded-lg shadow-lg transition duration-300 mr-4">
                    Chuyển Đổi Giao Diện (Hiện tại: <span id="currentThemeDisplay">Tối</span>)
                </button>
                <button id="reSyncButton" onclick="showConfirmationModal()" class="md:w-auto px-6 py-2 bg-red-600 hover:bg-red-700 text-white font-bold rounded-lg shadow-lg transition duration-300">
                    Đồng Bộ Lại (Tải lại từ GitHub)
                </button>
            </section>

        </div>

    </div>
    
    <div id="confirmationBox" class="modal-backdrop hidden">
        <div class="bg-[var(--card-bg)] p-6 rounded-xl shadow-2xl w-11/12 max-w-sm border-t-4 border-red-500 text-[var(--text-color)]">
            <h4 class="text-xl font-bold text-red-400 mb-4">Xác Nhận Đồng Bộ Lại</h4>
            <p class="text-[var(--text-color)] mb-6">Bạn có chắc chắn muốn **ĐỒNG BỘ LẠI** trạng thái giải đấu về dữ liệu mới nhất từ GitHub không? Điều này sẽ ghi đè trạng thái đang nhập cục bộ!</p>
            <div class="flex justify-end space-x-4">
                <button id="confirmNo" class="px-4 py-2 bg-gray-600 hover:bg-gray-500 text-white rounded-lg transition duration-150">Hủy bỏ</button>
                <button id="confirmYes" class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white font-bold rounded-lg transition duration-150">Xác nhận Đồng bộ</button>
            </div>
        </div>
    </div>

    <script>
        
        // ==============================================================================================================
        // KHỐI CẤU HÌNH GITHUB API & DỮ LIỆU
        // ==============================================================================================================
        const GITHUB_REPO_OWNER = 'cqtin2024';
        const GITHUB_REPO_NAME = 'ITVTG';
        
        // Cấu hình cho file Điểm số (diff)
        const SCORE_FILE_PATH = 'data/state3s.json';
        const SCORE_API_URL = `https://api.github.com/repos/${GITHUB_REPO_OWNER}/${GITHUB_REPO_NAME}/contents/${SCORE_FILE_PATH}`;
        const DIFF_DATA_URL = `https://raw.githubusercontent.com/${GITHUB_REPO_OWNER}/${GITHUB_REPO_NAME}/main/${SCORE_FILE_PATH}`;

        // Cấu hình cho file Dữ liệu Gốc (Team/Init)
        const BASE_FILE_PATH = 'data/state3.json';
        const BASE_API_URL = `https://api.github.com/repos/${GITHUB_REPO_OWNER}/${GITHUB_REPO_NAME}/contents/${BASE_FILE_PATH}`;
        const STATIC_DATA_URL = `https://raw.githubusercontent.com/${GITHUB_REPO_OWNER}/${GITHUB_REPO_NAME}/main/${BASE_FILE_PATH}`;

        const BRANCH = 'main';

        let tournamentData = null; 
        let initialTournamentData = null; // Trạng thái gốc (từ state3.json)
        let githubToken = ''; // Lưu token cục bộ
        let startX = 0; 
        let endX = 0;   
        const swipeThreshold = 75; 
        
        // Hàm chuyển đổi JSON sang Base64
        const jsonToBase64 = (json) => btoa(unescape(encodeURIComponent(JSON.stringify(json, null, 2))));
        
        // --- CHỨC NĂNG TƯƠNG TÁC GITHUB CHUNG ---

        function saveToken() {
            const tokenInput = document.getElementById('githubToken').value.trim();
            if (tokenInput.length > 0 && tokenInput !== '********') {
                githubToken = tokenInput;
                localStorage.setItem('githubToken', githubToken);
                showStatus('Token đã được lưu cục bộ. Hãy thử COMMIT.', 'success', 'scoreCommitResult');
                showStatus('Token đã được lưu cục bộ. Hãy thử COMMIT.', 'success', 'teamCommitResult');
                // Hide token for security after saving
                document.getElementById('githubToken').value = '********';
            } else if (tokenInput.length === 0) {
                 githubToken = '';
                 localStorage.removeItem('githubToken');
                 showStatus('Token đã bị xóa khỏi bộ nhớ cục bộ.', 'info', 'scoreCommitResult');
                 showStatus('Token đã bị xóa khỏi bộ nhớ cục bộ.', 'info', 'teamCommitResult');
                 document.getElementById('githubToken').value = '';
            } else {
                 showStatus('Vui lòng nhập Token mới hoặc Token đã được lưu.', 'info', 'scoreCommitResult');
                 showStatus('Vui lòng nhập Token mới hoặc Token đã được lưu.', 'info', 'teamCommitResult');
            }
        }
        
        function showStatus(message, type = 'info', elementId = 'statusMessage') {
            const statusElement = document.getElementById(elementId);
            if (!statusElement) return;

            // Clear previous classes
            statusElement.innerHTML = message;
            statusElement.classList.remove('hidden', 'bg-red-900/50', 'bg-green-900/50', 'bg-blue-900/50', 'bg-orange-900/50', 'text-red-300', 'text-green-300', 'text-blue-300', 'text-orange-300');
            
            // Set new class based on type
            if (type === 'success') {
                statusElement.classList.add('bg-green-900/50', 'text-green-300');
            } else if (type === 'error') {
                statusElement.classList.add('bg-red-900/50', 'text-red-300');
            } else if (type === 'warning') {
                 statusElement.classList.add('bg-orange-900/50', 'text-orange-300');
            } else {
                 statusElement.classList.add('bg-blue-900/50', 'text-blue-300');
            }
            statusElement.style.display = 'block';

            // Auto-hide after 8 seconds for success/info/warning messages (but not error)
            if (type !== 'error') {
                setTimeout(() => {
                    if (statusElement.id === elementId && statusElement.style.display !== 'none') {
                        statusElement.style.display = 'none';
                    }
                }, 8000);
            }
        }
        
        // Hàm Commit chung cho cả 2 file (state3s.json và state3.json)
        async function getShaAndCommit(fileUrl, contentBase64, commitMessage, buttonId, resultElementId) {
            const pat = githubToken.trim();
            const commitButton = document.getElementById(buttonId);
            commitButton.disabled = true;
            commitButton.textContent = 'Đang tiến hành...';

            let sha = null;
            
            // --- BƯỚC 1: LẤY SHA HIỆN TẠI ---
            try {
                showStatus('Đang lấy SHA hiện tại của file...', 'info', resultElementId);

                const shaResponse = await fetch(fileUrl + `?ref=${BRANCH}`, {
                    headers: { 'Authorization': `token ${pat}` }
                });

                if (shaResponse.status === 404) {
                    showStatus('File chưa tồn tại trên nhánh, sẽ tạo mới.', 'info', resultElementId);
                } else if (shaResponse.status === 401) {
                    const errorJson = await shaResponse.json();
                    throw new Error(`401 Unauthorized: ${errorJson.message || 'Token không hợp lệ hoặc thiếu quyền "repo".'}`);
                } else if (!shaResponse.ok) {
                    const errorJson = await shaResponse.json();
                    throw new Error(`Lỗi API khi lấy SHA: ${shaResponse.status} - ${errorJson.message || shaResponse.statusText}`);
                } else {
                    const data = await shaResponse.json();
                    sha = data.sha;
                    showStatus(`Đã lấy SHA file thành công. SHA: ${sha.substring(0, 10)}...`, 'info', resultElementId);
                }
                
                // --- BƯỚC 2: THỰC HIỆN COMMIT (PUT request) ---
                commitButton.textContent = 'Đang Commit (PUT)...';
                
                const payload = {
                    message: commitMessage,
                    content: contentBase64,
                    branch: BRANCH
                };
                if (sha) {
                    payload.sha = sha; // Chỉ gửi SHA nếu file đã tồn tại (để cập nhật)
                }

                const commitResponse = await fetch(fileUrl, {
                    method: 'PUT',
                    headers: { 
                        'Authorization': `token ${pat}`,
                        'Content-Type': 'application/json',
                        'Accept': 'application/vnd.github.v3+json'
                    },
                    body: JSON.stringify(payload)
                });

                if (commitResponse.status === 401) {
                    const errorJson = await commitResponse.json();
                    throw new Error(`401 Unauthorized: ${errorJson.message || 'Token không hợp lệ hoặc thiếu quyền "repo". Vui lòng kiểm tra lại Token của bạn.'}`);
                } else if (!commitResponse.ok) {
                    const errorData = await commitResponse.json();
                    throw new Error(`Commit thất bại: Status ${commitResponse.status}. ${errorData.message || 'Lỗi không xác định.'}`);
                }

                const result = await commitResponse.json();
                showStatus(`✅ COMMIT THÀNH CÔNG! Dữ liệu đã được cập nhật trên GitHub. <br>Commit SHA: <a href="${result.commit.html_url}" target="_blank" class="text-white underline">${result.commit.sha.substring(0, 7)}</a>`, 'success', resultElementId);
                
            } catch (error) {
                console.error("Lỗi Commit GitHub:", error);
                showStatus(`❌ LỖI COMMIT: ${error.message}`, 'error', resultElementId);
            } finally {
                // Đặt lại text cụ thể cho từng nút
                if(buttonId === 'commitScoreButton') commitButton.textContent = 'COMMIT TỈ SỐ ĐÃ THAY ĐỔI';
                else if(buttonId === 'commitTeamButton') commitButton.textContent = 'CẬP NHẬT THÔNG TIN ĐỘI (Ghi đè state3.json)';
                else commitButton.textContent = 'COMMIT THAY ĐỔI';
                commitButton.disabled = false;
            }
        }
        
        // --- LOGIC HỢP NHẤT DỮ LIỆU ---
        function mergeUpdates(baseData, diffData) {
            if (!diffData || !baseData) return baseData;
            const rounds = ['matchesA', 'matchesB', 'matchesC', 'matchesD', 'quarterfinals', 'semifinals', 'final'];
            
            rounds.forEach(roundKey => {
                if (!diffData[roundKey]) return;
                
                if (roundKey === 'final') {
                    // Cập nhật trận Chung kết
                    if (diffData.final && diffData.final.sA !== undefined) baseData.final.sA = diffData.final.sA;
                    if (diffData.final && diffData.final.sB !== undefined) baseData.final.sB = diffData.final.sB;
                    return;
                }
                
                // Cập nhật các trận đấu vòng bảng/Knockout
                if (Array.isArray(diffData[roundKey])) {
                    diffData[roundKey].forEach(diffMatch => {
                        const index = diffMatch.i;
                        if (baseData[roundKey] && baseData[roundKey][index]) {
                            baseData[roundKey][index].sA = diffMatch.sA;
                            baseData[roundKey][index].sB = diffMatch.sB;
                        }
                    });
                }
            });
            return baseData;
        }

        // --- LOGIC TẢI DỮ LIỆU ---
        async function fetchWithRetry(url, options = {}, maxRetries = 3) {
            let lastError = null;
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(url, options);
                    if (response.status === 404) {
                        return null; // Trả về null nếu không tìm thấy file (VD: state3s.json chưa được tạo)
                    }
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status} for ${url}`);
                    }
                    return response;
                } catch (error) {
                    lastError = error;
                    const delay = Math.pow(2, i) * 500;
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
            console.error(`Failed to fetch data from ${url} after multiple retries.`, lastError);
            showStatus(`❌ Lỗi kết nối: Không thể tải dữ liệu từ GitHub sau ${maxRetries} lần thử.`, 'error');
            throw lastError;
        }

        async function loadDataFromGitHub() {
            showStatus('Đang tải dữ liệu gốc (state3.json)...');
            try {
                // 1. Tải dữ liệu GỐC (state3.json)
                const baseResponse = await fetchWithRetry(STATIC_DATA_URL);
                if (!baseResponse) {
                    throw new Error("Không thể tải state3.json. Vui lòng kiểm tra lại đường dẫn và file trên GitHub.");
                }
                const baseData = await baseResponse.json();
                initialTournamentData = JSON.parse(JSON.stringify(baseData)); // Lưu bản gốc

                // 2. Tải dữ liệu cập nhật tỉ số (state3s.json)
                showStatus('Đang tải dữ liệu tỉ số cập nhật (state3s.json)...');
                const diffResponse = await fetchWithRetry(DIFF_DATA_URL);
                let diffData = {};
                if (diffResponse) {
                    diffData = await diffResponse.json();
                    showStatus('Đã tải thành công cả dữ liệu gốc và tỉ số cập nhật. Đang hợp nhất...', 'info');
                } else {
                    showStatus('ℹ️ Không tìm thấy state3s.json. Sử dụng dữ liệu gốc.', 'warning');
                }

                // 3. Hợp nhất dữ liệu
                tournamentData = mergeUpdates(baseData, diffData);

                // 4. Tính toán trạng thái giải đấu
                recalculateTournamentState();

                // 5. Cập nhật giao diện
                renderUI();
                switchTab(localStorage.getItem('activeTab') || 'General'); // Mở tab đã lưu
                showStatus('✅ Tải dữ liệu thành công và giao diện đã sẵn sàng.', 'success');
            
            } catch (error) {
                console.error("Lỗi tải dữ liệu chính:", error);
                showStatus(`❌ Lỗi tải dữ liệu chính: ${error.message}`, 'error');
            }
        }
        
        window.reSyncStaticData = function() {
            document.getElementById('confirmationBox').classList.add('hidden');
            loadDataFromGitHub();
        }
        
        // --- LOGIC TÍNH TOÁN (CẦN THIẾT CHO UI VÀ COMMIT) ---

        function getMatchWinner(scoreA, scoreB) {
            const sA = parseInt(scoreA) || 0;
            const sB = parseInt(scoreB) || 0;
            if (sA > sB) return 'A';
            if (sB > sA) return 'B';
            return null; // Hòa hoặc chưa đấu
        }

        // Hàm tính toán bảng xếp hạng và cập nhật đội vào Knockout
        window.recalculateTournamentState = function() {
            if (!tournamentData) return;

            // 1. Tính toán bảng xếp hạng (Group Stage)
            const groups = {
                A: { matches: tournamentData.matchesA, table: {} },
                B: { matches: tournamentData.matchesB, table: {} },
                C: { matches: tournamentData.matchesC, table: {} },
                D: { matches: tournamentData.matchesD, table: {} }
            };

            // Khởi tạo bảng xếp hạng
            tournamentData.tL.forEach(team => {
                if (groups[team.group]) {
                    groups[team.group].table[team.tN] = { 
                        tN: team.tN, Tn: team.Tn, W: 0, L: 0, F: 0, A: 0, Pts: 0, Rank: 0 
                    };
                }
            });

            // Xử lý kết quả các trận đấu
            Object.values(groups).forEach(group => {
                group.matches.forEach(match => {
                    const statsA = group.table[match.tA];
                    const statsB = group.table[match.tB];
                    
                    if (!statsA || !statsB) return;

                    const winner = getMatchWinner(match.sA, match.sB);
                    const scoreA = parseInt(match.sA) || 0;
                    const scoreB = parseInt(match.sB) || 0;

                    statsA.F += scoreA;
                    statsA.A += scoreB;
                    statsB.F += scoreB;
                    statsB.A += scoreA;

                    if (winner === 'A') {
                        statsA.W += 1; statsA.Pts += 3;
                        statsB.L += 1; 
                    } else if (winner === 'B') {
                        statsB.W += 1; statsB.Pts += 3;
                        statsA.L += 1; 
                    }
                    // Bỏ qua trường hợp Hòa vì trong Pickleball 1 set thường không có hòa
                });
            });

            // Sắp xếp và lưu kết quả
            Object.entries(groups).forEach(([groupName, group]) => {
                const tableArray = Object.values(group.table);
                tableArray.sort((a, b) => {
                    if (b.Pts !== a.Pts) return b.Pts - a.Pts; // 1. Điểm
                    if ((b.F - b.A) !== (a.F - a.A)) return (b.F - b.A) - (a.F - a.A); // 2. Hiệu số
                    return b.F - a.F; // 3. Điểm thắng
                });
                
                tableArray.forEach((stats, index) => stats.Rank = index + 1);
                tournamentData[`table${groupName}`] = tableArray;
            });
            
            // 2. Cập nhật đội vào vòng Knockout (Quarterfinals)
            const getTeamByRank = (groupName, rank) => {
                const table = tournamentData[`table${groupName}`];
                if (!table) return 'TBD';
                const teamStats = table.find(t => t.Rank === rank);
                return teamStats ? teamStats.tN : `TBD ${groupName}${rank}`;
            };

            const qf = tournamentData.quarterfinals;
            if (qf && qf.length === 4) {
                // A1 vs B2
                qf[0].tA = getTeamByRank('A', 1);
                qf[0].tB = getTeamByRank('B', 2);
                // C1 vs D2
                qf[1].tA = getTeamByRank('C', 1);
                qf[1].tB = getTeamByRank('D', 2);
                // B1 vs A2
                qf[2].tA = getTeamByRank('B', 1);
                qf[2].tB = getTeamByRank('A', 2);
                // D1 vs C2
                qf[3].tA = getTeamByRank('D', 1);
                qf[3].tB = getTeamByRank('C', 2);
            }
            
            // 3. Cập nhật đội vào Semifinals (SF)
            const sf = tournamentData.semifinals;
            if (sf && sf.length === 2) {
                sf[0].tA = tournamentData.quarterfinals[0].winner || 'W QF1';
                sf[0].tB = tournamentData.quarterfinals[1].winner || 'W QF2';
                sf[1].tA = tournamentData.quarterfinals[2].winner || 'W QF3';
                sf[1].tB = tournamentData.quarterfinals[3].winner || 'W QF4';
            }
            
            // 4. Cập nhật đội vào Final
            const final = tournamentData.final;
            if (final) {
                final.tA = tournamentData.semifinals[0].winner || 'W SF1';
                final.tB = tournamentData.semifinals[1].winner || 'W SF2';
            }
            
            // 5. Cập nhật người thắng Knockout
            ['quarterfinals', 'semifinals', 'final'].forEach(roundKey => {
                if(tournamentData[roundKey]) {
                    const matches = Array.isArray(tournamentData[roundKey]) ? tournamentData[roundKey] : [tournamentData[roundKey]];
                    matches.forEach(match => {
                        match.winner = getMatchWinner(match.sA, match.sB) === 'A' ? match.tA : (getMatchWinner(match.sA, match.sB) === 'B' ? match.tB : null);
                    });
                }
            });
        }

        // --- LOGIC CẬP NHẬT ĐIỂM SỐ (state3s.json) ---

        function getDiffData() {
            if (!tournamentData || !initialTournamentData) return {};

            const diffData = {};
            const rounds = ['matchesA', 'matchesB', 'matchesC', 'matchesD', 'quarterfinals', 'semifinals', 'final'];
            
            // Hàm so sánh tỉ số
            const compareMatches = (liveMatch, initialMatch) => 
                String(liveMatch.sA) !== String(initialMatch.sA) || 
                String(liveMatch.sB) !== String(initialMatch.sB);

            rounds.forEach(roundKey => {
                const liveRound = tournamentData[roundKey];
                const initialRound = initialTournamentData[roundKey];

                if (!liveRound) return; 

                if (roundKey === 'final') {
                    // Xử lý trận chung kết (không phải mảng)
                    const initialFinal = initialRound || { sA: null, sB: null };
                    if (compareMatches(liveRound, initialFinal)) {
                        diffData[roundKey] = {
                            sA: liveRound.sA,
                            sB: liveRound.sB
                        };
                    }
                    return;
                }
                
                // Vòng bảng và Knockout (là mảng)
                const modifiedMatches = [];
                // Sử dụng liveRound.forEach vì chỉ muốn so sánh các trận đấu hiện có
                liveRound.forEach((liveMatch, index) => {
                    // Lấy trận đấu gốc, nếu không có thì tạo đối tượng trống để so sánh
                    const initialMatch = (initialRound && initialRound[index]) ? initialRound[index] : { sA: null, sB: null };

                    if (compareMatches(liveMatch, initialMatch)) {
                        modifiedMatches.push({
                            i: index, 
                            sA: liveMatch.sA,
                            sB: liveMatch.sB
                        });
                    }
                });

                if (modifiedMatches.length > 0) {
                    diffData[roundKey] = modifiedMatches;
                }
            });

            return diffData;
        }

        window.commitScoreChangesToGitHub = async function() {
            githubToken = localStorage.getItem('githubToken') || ''; 
            if (!githubToken || githubToken.trim().length === 0) {
                showStatus('❌ Lỗi: Vui lòng nhập và lưu GitHub Token trước.', 'error', 'scoreCommitResult');
                return;
            }
            if (!tournamentData || !initialTournamentData) {
                 showStatus('❌ Lỗi: Dữ liệu giải đấu chưa được tải.', 'error', 'scoreCommitResult');
                 return;
            }

            const diffData = getDiffData();
            
            if (Object.keys(diffData).length === 0) {
                showStatus('ℹ️ Không có thay đổi tỉ số nào được ghi nhận so với dữ liệu gốc.', 'info', 'scoreCommitResult');
                return;
            }
            
            diffData.lastUpdate = new Date().toISOString(); // Thêm timestamp vào commit

            const base64Content = jsonToBase64(diffData);
            const commitMessage = 'Update match scores via web app (state3s.json)';
            
            await getShaAndCommit(SCORE_API_URL, base64Content, commitMessage, 'commitScoreButton', 'scoreCommitResult');
        };
        
        // --- LOGIC CẬP NHẬT THÔNG TIN ĐỘI (state3.json) ---
        window.commitTeamChangesToGitHub = async function() {
            githubToken = localStorage.getItem('githubToken') || '';
            if (!githubToken || githubToken.trim().length === 0) {
                showStatus('❌ Lỗi: Vui lòng nhập và lưu GitHub Token trước.', 'error', 'teamCommitResult');
                return;
            }
            if (!tournamentData || !initialTournamentData) {
                 showStatus('❌ Lỗi: Dữ liệu giải đấu chưa được tải.', 'error', 'teamCommitResult');
                 return;
            }

            // Tạo bản sao đầy đủ từ dữ liệu GỐC (state3.json)
            const fullTeamData = JSON.parse(JSON.stringify(initialTournamentData));
            
            // Ghi đè danh sách đội (từ giao diện, đã chỉnh sửa trong tournamentData.tL)
            fullTeamData.tL = tournamentData.tL;
            fullTeamData.lastTeamUpdate = new Date().toISOString(); // Thêm dấu thời gian
            
            const base64Content = jsonToBase64(fullTeamData);
            const commitMessage = 'Update team details and overwrite state3.json via web app';
            
            // Yêu cầu xác nhận vì thao tác này GHI ĐÈ toàn bộ file state3.json
            if (!confirm("⚠️ CẢNH BÁO: Thao tác này sẽ GHI ĐÈ TOÀN BỘ file state3.json trên GitHub. Bạn có chắc chắn không?")) {
                showStatus("ℹ️ Thao tác cập nhật đội đã bị hủy.", 'info', 'teamCommitResult');
                return;
            }

            await getShaAndCommit(BASE_API_URL, base64Content, commitMessage, 'commitTeamButton', 'teamCommitResult');
            
            // Sau khi commit thành công, cần tải lại dữ liệu để initialTournamentData được cập nhật
            setTimeout(async () => {
                showStatus('Đang đồng bộ lại dữ liệu gốc (state3.json) mới.', 'warning');
                await loadDataFromGitHub();
                switchTab('TeamManagement');
            }, 3000);
        }

        // --- LOGIC THAY ĐỔI DỮ LIỆU CỤC BỘ (INPUT HANDLERS) ---
        
        function handleScoreChange(roundKey, index, teamKey, value) {
            if (!tournamentData) return;
            
            const isFinal = roundKey === 'final';
            const match = isFinal ? tournamentData[roundKey] : tournamentData[roundKey][index];
            const oldValue = match[teamKey];
            
            if (value === '' || value === null) {
                match[teamKey] = null;
            } else {
                const numValue = parseInt(value);
                if (!isNaN(numValue) && numValue >= 0) {
                     match[teamKey] = numValue;
                } else {
                    // Nếu nhập giá trị không hợp lệ, giữ nguyên giá trị cũ
                    const elementId = isFinal ? `${roundKey}-0-${teamKey}` : `${roundKey}-${index}-${teamKey}`;
                    document.getElementById(elementId).value = oldValue !== null ? oldValue : '';
                    return; 
                }
            }

            recalculateTournamentState(); 
            // Chỉ render lại tab hiện tại để cải thiện hiệu suất
            const activeTab = localStorage.getItem('activeTab') || 'General';
            renderUI(activeTab); 
        }
        
        function handleTeamInputChange(teamIndex, field, value) {
            if (!tournamentData || !tournamentData.tL[teamIndex]) return;
            
            const team = tournamentData.tL[teamIndex];
            
            if (field === 'Tn') {
                 team[field] = value;
            } else {
                const playerIndex = parseInt(field.charAt(1)) - 1; // p1 -> 0, p2 -> 1
                const playerField = field.substring(2); // name, pL, bY
                
                if (team.players && team.players[playerIndex]) {
                    if (playerField === 'pL') { // Cấp độ là số
                        const numValue = parseInt(value);
                        team.players[playerIndex][playerField] = isNaN(numValue) ? null : numValue;
                    } else if (playerField === 'bY') { // Năm sinh
                        const numValue = parseInt(value);
                         team.players[playerIndex][playerField] = isNaN(numValue) ? null : numValue;
                    } else { // name là chuỗi
                        team.players[playerIndex][playerField] = value;
                    }
                }
            }

            recalculateTournamentState();
            renderTeamManagement(); 
            renderTeamList();
        }

        // --- LOGIC RENDER UI ---

        function getTeamName(tN) {
            const team = tournamentData.tL.find(t => t.tN === tN);
            return team ? team.Tn : (tN || 'Chưa xác định');
        }

        function renderGroupTable(groupName) {
            const tableContainer = document.getElementById(`table${groupName}`);
            const tableData = tournamentData[`table${groupName}`];
            
            if (!tableContainer || !tableData) return;

            let html = `<h3 class="text-2xl font-extrabold text-[var(--group-header-text)] mb-4">Bảng ${groupName} - Bảng Xếp Hạng</h3>`;
            html += `<div class="overflow-x-auto shadow-xl rounded-lg border border-[var(--border-color)]">
                <table class="min-w-full divide-y divide-[var(--border-color)]">
                <thead class="bg-[var(--match-bg)]">
                    <tr>
                        <th class="p-3 text-left text-xs font-medium uppercase tracking-wider">H.</th>
                        <th class="p-3 text-left text-xs font-medium uppercase tracking-wider">Đội</th>
                        <th class="p-3 text-center text-xs font-medium uppercase tracking-wider">Thắng</th>
                        <th class="p-3 text-center text-xs font-medium uppercase tracking-wider">Thua</th>
                        <th class="p-3 text-center text-xs font-medium uppercase tracking-wider">+/-</th>
                        <th class="p-3 text-center text-xs font-medium uppercase tracking-wider">Điểm</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-[var(--border-color)]">`;
            
            tableData.forEach((stats) => {
                const rankClass = stats.Rank <= 2 ? 'text-green-400 font-bold' : '';
                html += `<tr class="bg-[var(--card-bg)] hover:bg-[var(--match-bg)] transition">
                    <td class="p-3 whitespace-nowrap text-sm ${rankClass}">${stats.Rank}</td>
                    <td class="p-3 whitespace-nowrap text-sm font-semibold">${stats.Tn}</td>
                    <td class="p-3 whitespace-nowrap text-sm text-center">${stats.W}</td>
                    <td class="p-3 whitespace-nowrap text-sm text-center">${stats.L}</td>
                    <td class="p-3 whitespace-nowrap text-sm text-center">${stats.F - stats.A}</td>
                    <td class="p-3 whitespace-nowrap text-sm font-bold text-center">${stats.Pts}</td>
                </tr>`;
            });

            html += `</tbody></table></div>`;
            tableContainer.innerHTML = html;
        }

        function renderMatches(roundKey) {
            const matchesContainer = document.getElementById(roundKey);
            const matches = tournamentData[roundKey];
            
            if (!matchesContainer || !matches) return;

            const header = roundKey.includes('matches') ? `Các Trận Đấu Bảng ${roundKey.slice(-1)}` : (roundKey === 'quarterfinals' ? 'Tứ Kết' : (roundKey === 'semifinals' ? 'Bán Kết' : 'Vòng Knockout'));

            let html = `<h3 class="text-2xl font-extrabold text-[var(--group-header-text)] mb-4">${header}</h3>`;
            html += `<div class="space-y-4">`;

            matches.forEach((match, index) => {
                const teamA = getTeamName(match.tA);
                const teamB = getTeamName(match.tB);
                const matchName = roundKey.includes('matches') ? `Trận ${index + 1}` : (roundKey === 'quarterfinals' ? `QF${index + 1}` : (roundKey === 'semifinals' ? `SF${index + 1}` : ''));
                const winnerClass = (match.winner && match.winner !== 'Chưa xác định') ? 'border-l-4 border-yellow-500' : 'border-l-4 border-[var(--border-color)]';
                
                html += `
                <div class="match-card p-4 rounded-xl shadow-md flex justify-between items-center ${winnerClass}">
                    <div class="flex-grow min-w-0">
                        <p class="text-sm font-bold text-gray-400 mb-1">${matchName} - ${match.date || ''}</p>
                        <div class="flex items-center justify-between py-1">
                            <span class="font-semibold truncate mr-2 text-md w-1/2 ${match.winner === match.tA ? 'text-yellow-400' : ''}">${teamA}</span>
                            <input id="${roundKey}-${index}-sA" type="number" min="0" 
                                value="${match.sA !== null ? match.sA : ''}"
                                onchange="handleScoreChange('${roundKey}', ${index}, 'sA', this.value)"
                                class="score-input w-16 text-center text-lg p-1 rounded-md">
                        </div>
                        <div class="flex items-center justify-between py-1">
                            <span class="font-semibold truncate mr-2 text-md w-1/2 ${match.winner === match.tB ? 'text-yellow-400' : ''}">${teamB}</span>
                            <input id="${roundKey}-${index}-sB" type="number" min="0" 
                                value="${match.sB !== null ? match.sB : ''}"
                                onchange="handleScoreChange('${roundKey}', ${index}, 'sB', this.value)"
                                class="score-input w-16 text-center text-lg p-1 rounded-md">
                        </div>
                    </div>
                </div>`;
            });
            html += `</div>`;
            matchesContainer.innerHTML = html;
        }

        function renderKnockout() {
            renderMatches('quarterfinals');
            renderMatches('semifinals');
            renderFinal();
        }

        function renderFinal() {
            const container = document.getElementById('finalSection');
            const match = tournamentData.final;
            
            if (!container || !match) return;

            const teamA = getTeamName(match.tA);
            const teamB = getTeamName(match.tB);
            const winnerName = getTeamName(match.winner) || 'Chưa xác định';
            const winnerClass = (match.winner && match.winner !== 'Chưa xác định') ? 'border-l-4 border-yellow-500' : 'border-l-4 border-[var(--border-color)]';

            let finalHtml = `
            <h3 class="text-2xl font-extrabold text-red-500 mb-4">CHUNG KẾT</h3>
            <div class="match-card p-6 rounded-xl shadow-2xl flex justify-between items-center ${winnerClass} mb-6">
                <div class="flex-grow min-w-0">
                    <p class="text-sm font-bold text-red-400 mb-2">${match.date || ''}</p>
                    <div class="flex items-center justify-between py-1">
                        <span class="font-bold truncate text-xl w-1/2 ${match.winner === match.tA ? 'text-yellow-400' : 'text-[var(--text-color)]'}">${teamA}</span>
                        <input id="final-0-sA" type="number" min="0" 
                            value="${match.sA !== null ? match.sA : ''}"
                            onchange="handleScoreChange('final', 0, 'sA', this.value)"
                            class="score-input w-20 text-center text-xl p-2 rounded-lg">
                    </div>
                    <div class="flex items-center justify-between py-1">
                        <span class="font-bold truncate text-xl w-1/2 ${match.winner === match.tB ? 'text-yellow-400' : 'text-[var(--text-color)]'}">${teamB}</span>
                        <input id="final-0-sB" type="number" min="0" 
                            value="${match.sB !== null ? match.sB : ''}"
                            onchange="handleScoreChange('final', 0, 'sB', this.value)"
                            class="score-input w-20 text-center text-xl p-2 rounded-lg">
                    </div>
                </div>
            </div>
            `;
            
            let resultHtml = `<h4 class="text-2xl font-bold text-yellow-500">🏆 Nhà Vô Địch: ${winnerName} 🏆</h4>`;

            container.innerHTML = finalHtml;
            document.getElementById('finalResults').innerHTML = resultHtml;
        }

        function renderTeamList() {
             const teamListContainer = document.getElementById('teamList');
             if (!teamListContainer || !tournamentData || !tournamentData.tL) return;

             let html = '';
             tournamentData.tL.forEach(team => {
                 const playersHtml = team.players ? team.players.map(p => 
                     `<p class="text-sm font-medium text-gray-300">
                        ${p.name || 'N/A'} 
                        <span class="text-xs text-gray-500">(${p.pL || 'N/A'} / ${p.bY || 'N/A'})</span>
                     </p>`
                 ).join('') : '<p class="text-sm text-red-400">Không có người chơi</p>';

                 html += `
                    <div class="bg-[var(--card-bg)] p-4 rounded-lg shadow-md border-l-4 border-cyan-500">
                        <h4 class="text-xl font-bold mb-1 text-cyan-400">${team.Tn}</h4>
                        <p class="text-sm text-gray-500 mb-2">Mã: ${team.tN} | Group: ${team.group}</p>
                        <div class="space-y-1">${playersHtml}</div>
                    </div>
                 `;
             });
             teamListContainer.innerHTML = html;
        }

        function renderTeamManagement() {
            const container = document.getElementById('teamManagementList');
            if (!container || !tournamentData || !tournamentData.tL) return;

            let html = '';
            tournamentData.tL.forEach((team, teamIndex) => {
                const teamId = team.tN;
                const groupColor = team.group === 'A' ? 'border-blue-500' : (team.group === 'B' ? 'border-green-500' : (team.group === 'C' ? 'border-yellow-500' : 'border-red-500'));

                let playersHtml = '';
                if (team.players) {
                    team.players.forEach((player, playerIndex) => {
                        const pId = playerIndex + 1;
                        playersHtml += `
                            <div class="md:col-span-1 border-t border-[var(--border-color)] pt-3 mt-3">
                                <h5 class="text-sm font-bold text-gray-400 mb-2">Người chơi ${pId}</h5>
                                <div class="space-y-2">
                                    <input type="text" value="${player.name || ''}" placeholder="Tên người chơi"
                                        onchange="handleTeamInputChange(${teamIndex}, 'p${pId}name', this.value)"
                                        class="text-input w-full p-2 text-sm rounded-md" maxlength="50">
                                    <input type="number" value="${player.pL !== null ? player.pL : ''}" placeholder="Cấp độ (pL)"
                                        onchange="handleTeamInputChange(${teamIndex}, 'p${pId}pL', this.value)"
                                        class="text-input w-full p-2 text-sm rounded-md" min="1" max="10">
                                    <input type="number" value="${player.bY !== null ? player.bY : ''}" placeholder="Năm sinh (bY)"
                                        onchange="handleTeamInputChange(${teamIndex}, 'p${pId}bY', this.value)"
                                        class="text-input w-full p-2 text-sm rounded-md" min="1950" max="2020">
                                </div>
                            </div>
                        `;
                    });
                }


                html += `
                    <div class="bg-[var(--card-bg)] p-5 rounded-xl shadow-lg border-l-8 ${groupColor}">
                        <h4 class="text-xl font-extrabold text-[var(--text-color)] mb-4 flex justify-between items-center">
                            ${team.Tn} 
                            <span class="text-sm font-normal text-gray-500">(${teamId}) - Group ${team.group}</span>
                        </h4>
                        
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-400 mb-1">Tên Đội (Tn)</label>
                            <input type="text" value="${team.Tn || ''}" placeholder="Tên Đội Hiển Thị"
                                onchange="handleTeamInputChange(${teamIndex}, 'Tn', this.value)"
                                class="text-input w-full p-2 text-lg rounded-md font-semibold">
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            ${playersHtml}
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        function renderUI(focusedTab = null) {
            if (!tournamentData) return;
            
            // Render General Tab
            renderTeamList();
            renderFinal();

            // Render Management Tab
            renderTeamManagement();

            // Render Group Tabs
            if (!focusedTab || focusedTab === 'GroupA') { renderGroupTable('A'); renderMatches('matchesA'); }
            if (!focusedTab || focusedTab === 'GroupB') { renderGroupTable('B'); renderMatches('matchesB'); }
            if (!focusedTab || focusedTab === 'GroupC') { renderGroupTable('C'); renderMatches('matchesC'); }
            if (!focusedTab || focusedTab === 'GroupD') { renderGroupTable('D'); renderMatches('matchesD'); }
            
            // Render Knockout Tab
            if (!focusedTab || focusedTab === 'Knockout') { renderKnockout(); }
        }

        // --- LOGIC GIAO DIỆN CHUNG (TAB, THEME, SWIPE) ---

        function switchTab(tabId) {
            // Ẩn tất cả nội dung
            document.querySelectorAll('.tab-content').forEach(content => {
                content.style.display = 'none';
            });
            // Hủy trạng thái active của tất cả nút
            document.querySelectorAll('.tab-button').forEach(button => {
                button.classList.remove('active');
            });

            // Hiện nội dung tab được chọn
            const activeContent = document.getElementById(tabId);
            if (activeContent) {
                activeContent.style.display = 'block';
            }

            // Đặt trạng thái active cho nút được chọn
            const activeButton = document.querySelector(`.tab-button[data-tab="${tabId}"]`);
            if (activeButton) {
                activeButton.classList.add('active');
            }
            
            // Lưu tab hiện tại
            localStorage.setItem('activeTab', tabId);

            // Cập nhật UI lại cho tab mới nếu cần
            if (tournamentData) {
                renderUI(tabId);
            }
        }

        function applyTheme(theme) {
            const body = document.body;
            const sunIcon = document.getElementById('sunIcon');
            const moonIcon = document.getElementById('moonIcon');
            const themeDisplay = document.getElementById('currentThemeDisplay');
            
            if (theme === 'light') {
                body.classList.add('light-mode');
                sunIcon.classList.remove('hidden');
                moonIcon.classList.add('hidden');
                themeDisplay.textContent = 'Sáng';
            } else {
                body.classList.remove('light-mode');
                sunIcon.classList.add('hidden');
                moonIcon.classList.remove('hidden');
                themeDisplay.textContent = 'Tối';
            }
            localStorage.setItem('theme', theme);
        }

        function toggleTheme() {
            const currentTheme = document.body.classList.contains('light-mode') ? 'light' : 'dark';
            applyTheme(currentTheme === 'dark' ? 'light' : 'dark');
        }
        
        function handleGesture() {
            const diff = startX - endX;
            if (Math.abs(diff) > swipeThreshold) {
                const tabs = Array.from(document.querySelectorAll('.tab-button')).map(btn => btn.getAttribute('data-tab'));
                const activeTabButton = document.querySelector('.tab-button.active');
                if (!activeTabButton) return;
                
                const currentTabId = activeTabButton.getAttribute('data-tab');
                const currentIndex = tabs.indexOf(currentTabId);
                
                let nextIndex = -1;

                if (diff > 0) { // Swipe Left (Chuyển sang tab tiếp theo)
                    nextIndex = currentIndex < tabs.length - 1 ? currentIndex + 1 : -1;
                } else { // Swipe Right (Chuyển về tab trước đó)
                    nextIndex = currentIndex > 0 ? currentIndex - 1 : -1;
                }
                
                if (nextIndex !== -1) {
                    switchTab(tabs[nextIndex]);
                }
            }
        }
        
        function showConfirmationModal() {
            document.getElementById('confirmationBox').classList.remove('hidden');
        }
        
        // --- KHỞI TẠO ---

        function initializeApp() {
            // Load saved token and theme
            githubToken = localStorage.getItem('githubToken') || '';
            const savedTheme = localStorage.getItem('theme') || 'dark'; 
            applyTheme(savedTheme);

            if (githubToken) {
                 document.getElementById('githubToken').value = '********';
            }

            // Event listeners
            document.getElementById('themeToggle').addEventListener('click', toggleTheme);
            document.getElementById('app').addEventListener('touchstart', (e) => {
                // Đảm bảo không kích hoạt swipe khi chạm vào input
                if (e.target.closest('.score-input') || e.target.closest('.text-input')) return;
                startX = e.changedTouches[0].screenX;
            }, { passive: true });

            document.getElementById('app').addEventListener('touchend', (e) => {
                // Đảm bảo không kích hoạt swipe khi chạm vào input
                if (e.target.closest('.score-input') || e.target.closest('.text-input')) return;
                endX = e.changedTouches[0].screenX;
                handleGesture();
            }, { passive: true });
            
            // Modal button setup
            document.getElementById('confirmYes').onclick = window.reSyncStaticData;
            document.getElementById('confirmNo').onclick = () => document.getElementById('confirmationBox').classList.add('hidden');

            // Start data loading
            loadDataFromGitHub();
        }

        window.onload = initializeApp;
    </script>
</body>
</html>
