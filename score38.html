<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quản Lý Giải Đấu & Cập Nhật Thông Tin (GitHub Sync)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100;400;700;900&display=swap" rel="stylesheet">
    <style>
        /* Base styles for Dark Mode */
        :root {
            --bg-color: #111827; /* Gray-900 */
            --text-color: #f3f4f6; /* Gray-100 */
            --card-bg: #1f2937; /* Gray-800 */
            --border-color: #374151; /* Gray-700 */
            --accent-color: #06b6d4; /* Cyan-500 */
            --match-bg: #1f2937;
            --input-bg: #4b5563; /* Gray-600 */
            --group-header-text: #60a5fa; /* Blue-400 */
        }
        
        /* Light Mode Overrides */
        .light-mode {
            --bg-color: #f9fafb; /* Gray-50 */
            --text-color: #111827; /* Gray-900 */
            --card-bg: #ffffff;
            --border-color: #e5e7eb; /* Gray-200 */
            --accent-color: #ef4444; /* Red-500 */
            --match-bg: #f3f4f6; /* Gray-100 */
            --input-bg: #ffffff;
            --group-header-text: #10b981; /* Emerald-500 */
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            transition: background-color 0.3s, color 0.3s;
        }
        .container {
            max-width: 1200px;
        }
        .score-input, .text-input {
            background-color: var(--input-bg);
            border: 1px solid var(--border-color);
            color: var(--text-color);
        }
        .score-input:focus, .text-input:focus {
            box-shadow: 0 0 0 3px var(--accent-color);
        }
        .score-input:disabled, .text-input:disabled {
            background-color: #374151; /* Gray-700 */
            opacity: 0.7;
            cursor: not-allowed;
        }
        .tab-button {
            border-bottom-color: var(--border-color);
        }
        .tab-button.active {
            color: var(--accent-color);
            border-color: var(--accent-color);
            background-color: var(--card-bg);
        }
        .tab-content {
            display: none;
            background-color: var(--card-bg);
            border-radius: 0.75rem; /* rounded-xl */
            padding: 1.5rem; /* p-6 */
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); /* shadow-2xl */
        }
        /* Custom scrollbar */
        ::-webkit-scrollbar-thumb { background: var(--border-color); }
        ::-webkit-scrollbar-thumb:hover { background: #6b7280; }
        
        /* Specific content styles for brightness/clarity */
        .match-card {
            background-color: var(--match-bg);
            border-bottom: 1px solid var(--border-color);
        }
        .light-mode .match-card {
            background-color: #ffffff;
            border-bottom: 1px solid #e5e7eb;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
        }
        /* Modal Backdrop */
        .modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 50;
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <div id="app" class="container mx-auto">
        <header class="flex items-center justify-between mb-6">
            <div class="flex items-center">
                <svg class="w-10 h-10 md:w-12 md:h-12 text-[var(--accent-color)]" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 15.75l-4-4m0 0l4-4m-4 4h14M17 12a5 5 0 11-10 0 5 5 0 0110 0z"></path></svg>
                <div class="text-left ml-4">
                    <h1 class="text-xl md:text-3xl font-extrabold text-[var(--text-color)] leading-none">QUẢN LÝ GIẢI ĐẤU PICKLEBALL</h1>
                    <p class="text-xs md:text-sm text-[var(--accent-color)]">Cập Nhật Tỉ Số & Thông Tin Đội (GitHub Sync) - **v1.6.8 (Bugfix: t is not defined)**</p>
                </div>
            </div>
            
            <button id="themeToggle" class="p-3 rounded-full bg-[var(--card-bg)] shadow-md text-[var(--text-color)] hover:bg-[var(--border-color)] transition duration-200">
                <svg id="sunIcon" class="w-6 h-6 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>
                <svg id="moonIcon" class="w-6 h-6 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path></svg>
            </button>
        </header>

        <div id="statusMessage" class="text-center p-4 bg-blue-900/50 rounded-lg text-blue-300 font-semibold mb-6">
            Đang tải dữ liệu trạng thái từ GitHub...
        </div>
        
        <nav class="mb-8 border-b border-[var(--border-color)] overflow-x-auto whitespace-nowrap">
            <button class="tab-button py-3 px-4 md:px-6 text-sm md:text-base font-semibold border-b-2 border-transparent text-gray-400 hover:text-[var(--accent-color)] transition" onclick="switchTab('General')" data-tab="General">General</button>
            <button class="tab-button py-3 px-4 md:px-6 text-sm md:text-base font-semibold border-b-2 border-transparent text-gray-400 hover:text-[var(--accent-color)] transition" onclick="switchTab('TeamManagement')" data-tab="TeamManagement">Quản Lý Đội</button>
            <button class="tab-button py-3 px-4 md:px-6 text-sm md:text-base font-semibold border-b-2 border-transparent text-gray-400 hover:text-[var(--accent-color)] transition" onclick="switchTab('GroupA')" data-tab="GroupA">Group A</button>
            <button class="tab-button py-3 px-4 md:px-6 text-sm md:text-base font-semibold border-b-2 border-transparent text-gray-400 hover:text-[var(--accent-color)] transition" onclick="switchTab('GroupB')" data-tab="GroupB">Group B</button>
            <button class="tab-button py-3 px-4 md:px-6 text-sm md:text-base font-semibold border-b-2 border-transparent text-gray-400 hover:text-[var(--accent-color)] transition" onclick="switchTab('GroupC')" data-tab="GroupC">Group C</button>
            <button class="tab-button py-3 px-4 md:px-6 text-sm md:text-base font-semibold border-b-2 border-transparent text-gray-400 hover:text-[var(--accent-color)] transition" onclick="switchTab('GroupD')" data-tab="GroupD">Group D</button>
            <button class="tab-button py-3 px-4 md:px-6 text-sm md:text-base font-semibold border-b-2 border-transparent text-gray-400 hover:text-[var(--accent-color)] transition" onclick="switchTab('Knockout')" data-tab="Knockout">Knockout</button>
            <button class="tab-button py-3 px-4 md:px-6 text-sm md:text-base font-semibold border-b-2 border-transparent text-gray-400 hover:text-[var(--accent-color)] transition" onclick="switchTab('Configuration')" data-tab="Configuration">Cấu Hình</button>
        </nav>

        <div id="General" class="tab-content">
             <h2 class="text-3xl font-extrabold text-yellow-500 mb-6 border-b border-[var(--border-color)] pb-2">Final Results (Kết quả chung cuộc)</h2>
            <section id="finalResults" class="mb-10 p-4 rounded-xl shadow-lg bg-[var(--match-bg)]"></section>

            <h2 class="text-3xl font-extrabold text-[var(--text-color)] mb-6 border-b border-[var(--border-color)] pb-2">Team List (Danh sách các đội)</h2>
            <section id="teamList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                </section>
        </div>
        
        <div id="TeamManagement" class="tab-content">
            <h2 class="text-3xl font-extrabold text-blue-500 mb-6 border-b border-[var(--border-color)] pb-2">Quản Lý Thông Tin Đội (Cập nhật `state3.json`)</h2>
            <p class="text-sm text-gray-400 mb-4">Điều chỉnh **Tên đội (Tn)**, **Tên người chơi (name)**, **Cấp độ (pL)**, và **Năm sinh (bY)**. Sau khi chỉnh sửa, hãy nhấn **CẬP NHẬT THÔNG TIN** để ghi đè `state3.json`.</p>
            
            <button id="commitTeamButton" onclick="commitTeamChangesToGitHub()" class="w-full md:w-auto px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-lg shadow-lg transition duration-300 mb-6 disabled:opacity-50">
                CẬP NHẬT THÔNG TIN ĐỘI (Ghi đè state3.json)
            </button>
            
            <div id="teamCommitResult" class="mt-3 p-3 rounded-lg text-sm font-semibold hidden"></div>

            <section id="teamManagementList" class="space-y-6"></section>
        </div>


        <div id="GroupA" class="tab-content grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div id="tableA" class="lg:col-span-1"></div>
            <div id="matchesA" class="lg:col-span-2"></div>
        </div>

        <div id="GroupB" class="tab-content grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div id="tableB" class="lg:col-span-1"></div>
            <div id="matchesB" class="lg:col-span-2"></div>
        </div>

        <div id="GroupC" class="tab-content grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div id="tableC" class="lg:col-span-1"></div>
            <div id="matchesC" class="lg:col-span-2"></div>
        </div>

        <div id="GroupD" class="tab-content grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div id="tableD" class="lg:col-span-1"></div>
            <div id="matchesD" class="lg:col-span-2"></div>
        </div>

        <div id="Knockout" class="tab-content">
            <div id="quarterfinals" class="mb-6"></div>
            <div id="semifinals" class="mb-6"></div>
            <div id="finalMatchSection">
                <div id="finalSection"></div>
            </div>
        </div>

        <div id="Configuration" class="tab-content space-y-8">
            <h2 class="text-3xl font-extrabold text-red-500 mb-6 border-b border-[var(--border-color)] pb-2">Cấu Hình & Đồng Bộ Hóa (GitHub API)</h2>
            
             <section class="p-4 bg-red-900/20 rounded-lg border-l-4 border-red-500">
                 <h3 class="text-xl font-bold text-red-400 mb-3 flex items-center">
                    <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-2a2 2 0 00-2-2H6a2 2 0 00-2 2v2a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path></svg> 1. GitHub Personal Access Token (PAT) </h3>
                 <p class="text-sm text-red-300 mb-4 font-bold">CẢNH BÁO BẢO MẬT: Token này sẽ được lưu trữ trong trình duyệt. Chỉ sử dụng Token có phạm vi (Scope) nhỏ nhất. <span class="text-yellow-300">CẦN PHẢI CÓ QUYỀN **repo** (hoặc contents:write)</span>.</p>
                 <input type="password" id="githubToken" class="score-input w-full p-2 rounded-md focus:ring-red-500" placeholder="Dán GitHub PAT của bạn vào đây...">
                 <button onclick="saveToken()" class="mt-2 w-full px-4 py-2 bg-red-600 hover:bg-red-700 text-white font-bold rounded-lg transition duration-300">Lưu Token</button>
             </section>

             <section class="p-4 bg-green-900/20 rounded-lg border-l-4 border-green-500">
                 <h3 class="text-xl font-bold text-green-400 mb-3 flex items-center">
                    <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg> 2. Export & Commit Tỉ Số Lên GitHub (state3s.json) 
                 </h3>
                 <p class="text-sm text-gray-400 mb-4">
                     Tỉ số mới nhất đang được lưu trữ ở <span id="currentStatus" class="font-bold text-yellow-300">...</span>
                 </p>
                 <button id="commitScoreButton" onclick="commitScoreChangesToGitHub()" class="w-full px-6 py-2 bg-green-600 hover:bg-green-700 text-white font-bold rounded-lg shadow-lg transition duration-300 disabled:opacity-50">
                     EXPORT & COMMIT TẤT CẢ TỈ SỐ (Ghi đè state3s.json)
                 </button>
                 <div id="scoreCommitResult" class="mt-3 p-3 rounded-lg text-sm font-semibold hidden"></div>
             </section>

             <section class="p-4 bg-blue-900/20 rounded-lg border-l-4 border-blue-500">
                 <h3 class="text-xl font-bold text-blue-400 mb-3 flex items-center">
                    <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11.133 11l-1.46-1.46M12 21a9 9 0 100-18 9 9 0 000 18z"></path></svg> 3. Đồng Bộ Lại Dữ Liệu Gốc
                 </h3>
                 <p class="text-sm text-gray-400 mb-4">
                     Bấm nút này để tải lại `state3.json` và `state3s.json` từ GitHub, bỏ qua mọi thay đổi chưa được commit.
                 </p>
                 <button onclick="document.getElementById('confirmationBox').classList.remove('hidden')" class="w-full px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-lg shadow-lg transition duration-300">
                     ĐỒNG BỘ LẠI (Tải lại từ GitHub)
                 </button>
             </section>

             <section class="p-4 bg-[var(--card-bg)] rounded-lg border-l-4 border-gray-500 space-y-4">
                <h3 class="text-xl font-bold text-gray-400 mb-3">4. Cấu hình URL (Nâng cao)</h3>
                <div class="space-y-2">
                    <label for="baseApiUrl" class="block text-sm font-medium text-gray-400">BASE_API_URL (state3.json)</label>
                    <input type="text" id="baseApiUrl" class="text-input w-full p-2 rounded-md" placeholder="URL API GitHub cho state3.json" disabled>
                </div>
                <div class="space-y-2">
                    <label for="scoreApiUrl" class="block text-sm font-medium text-gray-400">SCORE_API_URL (state3s.json)</label>
                    <input type="text" id="scoreApiUrl" class="text-input w-full p-2 rounded-md" placeholder="URL API GitHub cho state3s.json" disabled>
                </div>
                <div class="space-y-2">
                    <label for="staticDataUrl" class="block text-sm font-medium text-gray-400">STATIC_DATA_URL (Raw state3.json)</label>
                    <input type="text" id="staticDataUrl" class="text-input w-full p-2 rounded-md" placeholder="URL Raw Content cho state3.json" disabled>
                </div>
                <div class="space-y-2">
                    <label for="diffDataUrl" class="block text-sm font-medium text-gray-400">DIFF_DATA_URL (Raw state3s.json)</label>
                    <input type="text" id="diffDataUrl" class="text-input w-full p-2 rounded-md" placeholder="URL Raw Content cho state3s.json" disabled>
                </div>
             </section>
        </div>


        <div id="confirmationBox" class="modal-backdrop hidden">
            <div class="bg-[var(--card-bg)] p-8 rounded-xl shadow-2xl max-w-sm w-full">
                <h3 class="text-xl font-bold text-red-500 mb-4">Xác nhận Đồng bộ Lại</h3>
                <p class="text-gray-300 mb-6">Bạn có chắc chắn muốn Tải lại (Re-sync) dữ liệu gốc từ GitHub không? Hành động này sẽ **xóa bỏ mọi thay đổi tỉ số chưa được COMMIT**.</p>
                <div class="flex justify-end space-x-4">
                    <button id="confirmNo" class="px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white rounded-lg transition">Hủy</button>
                    <button id="confirmYes" class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white font-bold rounded-lg transition">Xác nhận Tải lại</button>
                </div>
            </div>
        </div>

    </div>

    <script>
        // =================================================================
        // HẰNG SỐ CẤU HÌNH (CONSTANTS)
        // =================================================================
        const REPO_OWNER = 'cqtin2024'; // Tên người dùng hoặc tổ chức GitHub
        const REPO_NAME = 'ITVTG'; // Tên kho lưu trữ
        const BRANCH = 'main'; // Tên nhánh

        // Base URLs (Không cần thay đổi trừ khi cấu trúc GitHub khác)
        const BASE_API_URL = `https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/data/state3.json`;
        const SCORE_API_URL = `https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/data/state3s.json`;
        
        // Raw Content URLs (Sử dụng để tải dữ liệu)
        const STATIC_DATA_URL = `https://raw.githubusercontent.com/${REPO_OWNER}/${REPO_NAME}/${BRANCH}/data/state3.json`;
        const DIFF_DATA_URL = `https://raw.githubusercontent.com/${REPO_OWNER}/${REPO_NAME}/${BRANCH}/data/state3s.json`;


        // =================================================================
        // BIẾN TOÀN CỤC VÀ TRẠNG THÁI
        // =================================================================
        let githubToken = '';
        let tournamentData = null; // Dữ liệu đã hợp nhất (gốc + tỉ số)
        let initialTournamentData = null; // Dữ liệu gốc (chỉ state3.json)
        let currentTab = 'General';
        let startX = 0;
        let endX = 0;


        // =================================================================
        // HÀM CHUNG VÀ TIỆN ÍCH
        // =================================================================

        /**
         * Chuyển đổi đối tượng JS thành Base64 string cho GitHub API.
         * @param {Object} data 
         * @returns {string} Base64 string
         */
        function jsonToBase64(data) {
            const jsonString = JSON.stringify(data, null, 2);
            return btoa(unescape(encodeURIComponent(jsonString)));
        }

        /**
         * Chuyển đổi Base64 string thành đối tượng JS.
         * @param {string} base64 
         * @returns {Object} JSON object
         */
        function base64ToJson(base64) {
             const jsonString = decodeURIComponent(escape(atob(base64)));
             return JSON.parse(jsonString);
        }

        // --- CÁC HÀM TRA CỨU ĐỘI ĐÃ ĐƯỢC CHUẨN HÓA DỰA TRÊN CẤU TRÚC JSON MỚI ---
        
        /**
         * Lấy ID của đội (T) dựa trên tên đội dùng trong match object (Tn/D).
         * @param {string} teamName - Tên đội đầy đủ (e.g., "Duy Hưng-Minh Tú").
         * @returns {string|null} Mã đội (T) hoặc null.
         */
        function getTeamIdByTeamName(teamName) {
            if (!tournamentData || !tournamentData.tL) return null;
            // Dùng D để tra cứu nếu Tn bị thiếu hoặc dùng để hiển thị khác
            for (const team of tournamentData.tL) {
                // Ưu tiên so sánh với Tn (Tên rút gọn/định danh)
                if (team.Tn === teamName) {
                    return team.T;
                }
            }
            return null;
        }
        
        /**
         * Lấy tên rút gọn của đội (Tn) dựa trên ID.
         * @param {string} teamId - Mã đội (T).
         * @returns {string|null} Tên rút gọn (Tn) hoặc Mã đội nếu không tìm thấy.
         */
        function getTeamNameById(teamId) {
             if (!tournamentData || !tournamentData.tL) return teamId;
             for (const team of tournamentData.tL) {
                 if (team.T === teamId) {
                     return team.Tn;
                 }
             }
             return teamId;
         }

        /**
         * Lấy thông tin chi tiết người chơi dựa trên mã đội (T)
         * NOTE: Hàm này dùng initialTournamentData để lấy dữ liệu gốc, bao gồm team details (P, aPL)
         * @param {string} teamId - Mã đội (T)
         * @returns {Object|null} Thông tin đội hoặc null
         */
        function getTeamDetailById(teamId) {
            if (!initialTournamentData || !initialTournamentData.tL) return null;
            // FIX v1.6.8: Sửa lỗi ReferenceError: t is not defined -> team.T
            return initialTournamentData.tL.find(team => team.T === teamId) || null;
        }

        // ------------------------------------------------------------------------
        
        // =================================================================
        // HÀM TẢI VÀ ĐỒNG BỘ DỮ LIỆU (DATA SYNCHRONIZATION)
        // =================================================================

        /**
         * Lấy nội dung file JSON thô từ GitHub (RAW Content URL).
         * @param {string} url - URL RAW content (STATIC_DATA_URL hoặc DIFF_DATA_URL).
         * @returns {Promise<Object>} JSON object của file.
         */
        async function fetchDataFromGitHub(url) {
            const response = await fetch(url);
            
            // 1. Kiểm tra HTTP Status Code
            if (!response.ok) {
                // Trả về {} nếu file state3s.json không tồn tại (404) để mergeData vẫn chạy
                if (response.status === 404 && url.includes('state3s.json')) {
                    console.warn(`File tỉ số (state3s.json) không tồn tại hoặc bị xóa (404). Sử dụng dữ liệu gốc.`);
                    return {};
                }
                // Lỗi chung cho các trường hợp khác (400, 401, 500, hoặc 404 cho state3.json)
                throw new Error(`Lỗi tải dữ liệu từ GitHub: ${response.status} ${response.statusText} (${url})`);
            }
            
            // 2. Thử Parse JSON (Làm cho việc tải dữ liệu Raw ổn định hơn, bỏ qua Content-Type header)
            try {
                return response.json(); 
            } catch (e) {
                 const contentType = response.headers.get("content-type");
                 // Báo cáo lỗi cụ thể nếu không parse được
                 throw new Error(`Dữ liệu tải về không thể parse thành JSON. Content-Type được báo cáo: ${contentType}.`);
            }
        }

        /**
         * Tải dữ liệu state3.json (gốc) và state3s.json (tỉ số) từ GitHub, sau đó hợp nhất.
         */
        async function loadDataFromGitHub() {
            const statusEl = document.getElementById('statusMessage');
            statusEl.textContent = 'Đang tải và hợp nhất dữ liệu từ GitHub...';
            statusEl.classList.remove('bg-green-900/50', 'bg-red-900/50');
            statusEl.classList.add('bg-blue-900/50');

            try {
                // 1. Lấy dữ liệu gốc (state3.json)
                const baseData = await fetchDataFromGitHub(STATIC_DATA_URL);
                initialTournamentData = baseData; 
                
                // 2. L
