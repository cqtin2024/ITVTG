<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pickleball Tournament Management (GitHub Sync)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100;400;700;900&display=swap" rel="stylesheet">
    <style>
        /* Base styles for Dark Mode */
        :root {
            --bg-color: #111827; /* Gray-900 */
            --text-color: #f3f4f6; /* Gray-100 */
            --card-bg: #1f2937; /* Gray-800 */
            --border-color: #374151; /* Gray-700 */
            --accent-color: #06b6d4; /* Cyan-500 */
            --match-bg: #1f2937;
            --input-bg: #4b5563; /* Gray-600 */
            --group-header-text: #60a5fa; /* Blue-400 */
        }
        
        /* Light Mode Overrides */
        .light-mode {
            --bg-color: #f9fafb; /* Gray-50 */
            --text-color: #111827; /* Gray-900 */
            --card-bg: #ffffff;
            --border-color: #e5e7eb; /* Gray-200 */
            --accent-color: #ef4444; /* Red-500 */
            --match-bg: #f3f4f6; /* Gray-100 */
            --input-bg: #ffffff;
            --group-header-text: #10b981; /* Emerald-500 */
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            transition: background-color 0.3s, color 0.3s;
        }
        .container {
            max-width: 1200px;
        }
        .score-input, .text-input {
            background-color: var(--input-bg);
            border: 1px solid var(--border-color);
            color: var(--text-color);
        }
        .score-input:focus, .text-input:focus {
            box-shadow: 0 0 0 3px var(--accent-color);
        }
        .score-input:disabled, .text-input:disabled {
            background-color: #374151; /* Gray-700 */
            opacity: 0.7;
            cursor: not-allowed;
        }
        .tab-button {
            border-bottom-color: var(--border-color);
        }
        .tab-button.active {
            color: var(--accent-color);
            border-color: var(--accent-color);
            background-color: var(--card-bg);
        }
        .tab-content {
            display: none;
            background-color: var(--card-bg);
            border-radius: 0.75rem; /* rounded-xl */
            padding: 1rem; /* p-4 (compacted) */
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); /* shadow-2xl */
        }
        /* Custom scrollbar */
        ::-webkit-scrollbar-thumb { background: var(--border-color); }
        ::-webkit-scrollbar-thumb:hover { background: #6b7280; }
        
        /* Specific content styles for brightness/clarity */
        .match-card {
            background-color: var(--match-bg);
            border-bottom: 1px solid var(--border-color);
        }
        .light-mode .match-card {
            background-color: #ffffff;
            border-bottom: 1px solid #e5e7eb;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
        }
        /* Modal Backdrop */
        .modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 50;
        }
    </style>
</head>
<body class="p-2 md:p-8">

    <div id="app" class="container mx-auto">
        <header class="flex items-center justify-between mb-4">
            <div class="flex items-center">
                <svg class="w-8 h-8 md:w-10 md:h-10 text-[var(--accent-color)]" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 15.75l-4-4m0 0l4-4m-4 4h14M17 12a5 5 0 11-10 0 5 5 0 0110 0z"></path></svg>
                <div class="text-left ml-2">
                    <h1 class="text-lg md:text-3xl font-extrabold text-[var(--text-color)] leading-tight">PICKLEBALL TOURNAMENT MGMT</h1>
                    <p class="text-xs text-[var(--accent-color)]">Score & Team Update (GitHub Sync) - **v1.6.9 (QF Seeding Fix)**</p>
                </div>
            </div>
            
            <button id="themeToggle" class="p-2 rounded-full bg-[var(--card-bg)] shadow-md text-[var(--text-color)] hover:bg-[var(--border-color)] transition duration-200">
                <svg id="sunIcon" class="w-5 h-5 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>
                <svg id="moonIcon" class="w-5 h-5 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path></svg>
            </button>
        </header>

        <div id="statusMessage" class="text-center p-3 bg-blue-900/50 rounded-lg text-blue-300 font-semibold mb-4 text-sm">
            Loading status data from GitHub...
        </div>
        
        <nav class="mb-6 border-b border-[var(--border-color)] overflow-x-auto whitespace-nowrap">
            <button class="tab-button py-2 px-3 text-sm font-semibold border-b-2 border-transparent text-gray-400 hover:text-[var(--accent-color)] transition" onclick="switchTab('General')" data-tab="General">General</button>
            <button class="tab-button py-2 px-3 text-sm font-semibold border-b-2 border-transparent text-gray-400 hover:text-[var(--accent-color)] transition" onclick="switchTab('TeamManagement')" data-tab="TeamMgmt">Team Mgmt</button>
            <button class="tab-button py-2 px-3 text-sm font-semibold border-b-2 border-transparent text-gray-400 hover:text-[var(--accent-color)] transition" onclick="switchTab('GroupA')" data-tab="GroupA">Group A</button>
            <button class="tab-button py-2 px-3 text-sm font-semibold border-b-2 border-transparent text-gray-400 hover:text-[var(--accent-color)] transition" onclick="switchTab('GroupB')" data-tab="GroupB">Group B</button>
            <button class="tab-button py-2 px-3 text-sm font-semibold border-b-2 border-transparent text-gray-400 hover:text-[var(--accent-color)] transition" onclick="switchTab('GroupC')" data-tab="GroupC">Group C</button>
            <button class="tab-button py-2 px-3 text-sm font-semibold border-b-2 border-transparent text-gray-400 hover:text-[var(--accent-color)] transition" onclick="switchTab('GroupD')" data-tab="GroupD">Group D</button>
            <button class="tab-button py-2 px-3 text-sm font-semibold border-b-2 border-transparent text-gray-400 hover:text-[var(--accent-color)] transition" onclick="switchTab('Knockout')" data-tab="Knockout">Knockout</button>
            <button class="tab-button py-2 px-3 text-sm font-semibold border-b-2 border-transparent text-gray-400 hover:text-[var(--accent-color)] transition" onclick="switchTab('Configuration')" data-tab="Configuration">Config</button>
        </nav>

        <div id="General" class="tab-content">
             <h2 class="text-2xl font-extrabold text-yellow-500 mb-4 border-b border-[var(--border-color)] pb-2">Final Results</h2>
            <section id="finalResults" class="mb-8 p-3 rounded-xl shadow-lg bg-[var(--match-bg)]"></section>

            <h2 class="text-2xl font-extrabold text-[var(--text-color)] mb-4 border-b border-[var(--border-color)] pb-2">Team List</h2>
            <section id="teamList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
                </section>
        </div>
        
        <div id="TeamManagement" class="tab-content">
            <h2 class="text-2xl font-extrabold text-blue-500 mb-4 border-b border-[var(--border-color)] pb-2">Team Details Mgmt (`state3.json`)</h2>
            <p class="text-xs text-gray-400 mb-3">Adjust **Team Name (Tn)**, **Player Name**, **Level (pL)**, and **YOB (bY)**. Click **COMMIT TEAM DETAILS** to update `state3.json`.</p>
            
            <button id="commitTeamButton" onclick="commitTeamChangesToGitHub()" class="w-full md:w-auto px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-lg shadow-lg transition duration-300 mb-4 text-sm disabled:opacity-50">
                COMMIT TEAM DETAILS (Overwrite state3.json)
            </button>
            
            <div id="teamCommitResult" class="mt-2 p-2 rounded-lg text-xs font-semibold hidden"></div>

            <section id="teamManagementList" class="space-y-4"></section>
        </div>


        <div id="GroupA" class="tab-content grid grid-cols-1 lg:grid-cols-3 gap-4">
            <div id="tableA" class="lg:col-span-1"></div>
            <div id="matchesA" class="lg:col-span-2"></div>
        </div>

        <div id="GroupB" class="tab-content grid grid-cols-1 lg:grid-cols-3 gap-4">
            <div id="tableB" class="lg:col-span-1"></div>
            <div id="matchesB" class="lg:col-span-2"></div>
        </div>

        <div id="GroupC" class="tab-content grid grid-cols-1 lg:grid-cols-3 gap-4">
            <div id="tableC" class="lg:col-span-1"></div>
            <div id="matchesC" class="lg:col-span-2"></div>
        </div>

        <div id="GroupD" class="tab-content grid grid-cols-1 lg:grid-cols-3 gap-4">
            <div id="tableD" class="lg:col-span-1"></div>
            <div id="matchesD" class="lg:col-span-2"></div>
        </div>

        <div id="Knockout" class="tab-content">
            <div id="quarterfinals" class="mb-4"></div>
            <div id="semifinals" class="mb-4"></div>
            <div id="finalMatchSection">
                <div id="finalSection"></div>
            </div>
        </div>

        <div id="Configuration" class="tab-content space-y-4">
            <h2 class="text-2xl font-extrabold text-red-500 mb-4 border-b border-[var(--border-color)] pb-2">Configuration (GitHub API)</h2>
            
             <section class="p-3 bg-red-900/20 rounded-lg border-l-4 border-red-500">
                 <h3 class="text-lg font-bold text-red-400 mb-2 flex items-center">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-2a2 2 0 00-2-2H6a2 2 0 00-2 2v2a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path></svg> 1. GitHub Personal Access Token (PAT) </h3>
                 <p class="text-xs text-red-300 mb-3 font-bold">SECURITY: Token is stored in the browser. Needs **repo** scope.</p>
                 <input type="password" id="githubToken" class="score-input w-full p-2 rounded-md focus:ring-red-500 text-sm" placeholder="Paste your GitHub PAT here...">
                 <button onclick="saveToken()" class="mt-2 w-full px-4 py-2 bg-red-600 hover:bg-red-700 text-white font-bold rounded-lg transition duration-300 text-sm">Save Token</button>
             </section>

             <section class="p-3 bg-green-900/20 rounded-lg border-l-4 border-green-500">
                 <h3 class="text-lg font-bold text-green-400 mb-2 flex items-center">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg> 2. Export & Commit Scores (state3s.json) 
                 </h3>
                 <p class="text-xs text-gray-400 mb-3">
                     Current status: <span id="currentStatus" class="font-bold text-yellow-300">...</span>
                 </p>
                 <button id="commitScoreButton" onclick="commitScoreChangesToGitHub()" class="w-full px-4 py-2 bg-green-600 hover:bg-green-700 text-white font-bold rounded-lg shadow-lg transition duration-300 text-sm disabled:opacity-50">
                     COMMIT SCORES (state3s.json)
                 </button>
                 <div id="scoreCommitResult" class="mt-2 p-2 rounded-lg text-xs font-semibold hidden"></div>
             </section>

             <section class="p-3 bg-blue-900/20 rounded-lg border-l-4 border-blue-500">
                 <h3 class="text-lg font-bold text-blue-400 mb-2 flex items-center">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11.133 11l-1.46-1.46M12 21a9 9 0 100-18 9 9 0 000 18z"></path></svg> 3. Re-Sync Data
                 </h3>
                 <p class="text-xs text-gray-400 mb-3">
                     Reloads `state3.json` and `state3s.json` from GitHub, discarding uncommitted local changes.
                 </p>
                 <button onclick="document.getElementById('confirmationBox').classList.remove('hidden')" class="w-full px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-lg shadow-lg transition duration-300 text-sm">
                     RE-SYNC DATA (From GitHub)
                 </button>
             </section>

             <section class="p-3 bg-[var(--card-bg)] rounded-lg border-l-4 border-gray-500 space-y-3">
                <h3 class="text-lg font-bold text-gray-400 mb-2">4. URL Configuration (Advanced)</h3>
                <div class="space-y-1">
                    <label for="baseApiUrl" class="block text-xs font-medium text-gray-400">BASE_API_URL (state3.json)</label>
                    <input type="text" id="baseApiUrl" class="text-input w-full p-2 rounded-md text-xs" disabled>
                </div>
                <div class="space-y-1">
                    <label for="scoreApiUrl" class="block text-xs font-medium text-gray-400">SCORE_API_URL (state3s.json)</label>
                    <input type="text" id="scoreApiUrl" class="text-full p-2 rounded-md text-xs" disabled>
                </div>
                <div class="space-y-1">
                    <label for="staticDataUrl" class="block text-xs font-medium text-gray-400">STATIC_DATA_URL (Raw state3.json)</label>
                    <input type="text" id="staticDataUrl" class="text-input w-full p-2 rounded-md text-xs" disabled>
                </div>
                <div class="space-y-1">
                    <label for="diffDataUrl" class="block text-xs font-medium text-gray-400">DIFF_DATA_URL (Raw state3s.json)</label>
                    <input type="text" id="diffDataUrl" class="text-input w-full p-2 rounded-md text-xs" disabled>
                </div>
             </section>
        </div>


        <div id="confirmationBox" class="modal-backdrop hidden">
            <div class="bg-[var(--card-bg)] p-6 rounded-xl shadow-2xl max-w-sm w-full">
                <h3 class="text-xl font-bold text-red-500 mb-3">Confirm Re-sync</h3>
                <p class="text-gray-300 mb-4 text-sm">Are you sure you want to Re-sync data from GitHub? This action will **DISCARD all uncommitted score changes**.</p>
                <div class="flex justify-end space-x-3">
                    <button id="confirmNo" class="px-3 py-1 bg-gray-600 hover:bg-gray-700 text-white rounded-lg transition text-sm">Cancel</button>
                    <button id="confirmYes" class="px-3 py-1 bg-red-600 hover:bg-red-700 text-white font-bold rounded-lg transition text-sm">Confirm Re-sync</button>
                </div>
            </div>
        </div>

    </div>

    <script>
        // =================================================================
        // HẰNG SỐ CẤU HÌNH (CONSTANTS)
        // =================================================================
        const REPO_OWNER = 'cqtin2024'; // Tên người dùng hoặc tổ chức GitHub
        const REPO_NAME = 'ITVTG'; // Tên kho lưu trữ
        const BRANCH = 'main'; // Tên nhánh

        // Base URLs (Không cần thay đổi trừ khi cấu trúc GitHub khác)
        const BASE_API_URL = \`https://api.github.com/repos/\${REPO_OWNER}/\${REPO_NAME}/contents/data/state3.json\`;
        const SCORE_API_URL = \`https://api.github.com/repos/\${REPO_OWNER}/\${REPO_NAME}/contents/data/state3s.json\`;
        
        // Raw Content URLs (Sử dụng để tải dữ liệu)
        const STATIC_DATA_URL = \`https://raw.githubusercontent.com/\${REPO_OWNER}/\${REPO_NAME}/\${BRANCH}/data/state3.json\`;
        const DIFF_DATA_URL = \`https://raw.githubusercontent.com/\${REPO_OWNER}/\${REPO_NAME}/\${BRANCH}/data/state3s.json\`;


        // =================================================================
        // BIẾN TOÀN CỤC VÀ TRẠNG THÁI
        // =================================================================
        let githubToken = '';
        let tournamentData = null; // Dữ liệu đã hợp nhất (gốc + tỉ số)
        let initialTournamentData = null; // Dữ liệu gốc (chỉ state3.json)
        let currentTab = 'General';
        let startX = 0;
        let endX = 0;
        let needsInitialCommit = true; // Cờ mới: Cần thực hiện tự động commit lần đầu

        // =================================================================
        // HÀM CHUNG VÀ TIỆN ÍCH
        // =================================================================

        /**
         * Chuyển đổi đối tượng JS thành Base64 string cho GitHub API.
         * @param {Object} data 
         * @returns {string} Base64 string
         */
        function jsonToBase64(data) {
            const jsonString = JSON.stringify(data, null, 2);
            return btoa(unescape(encodeURIComponent(jsonString)));
        }

        /**
         * Chuyển đổi Base64 string thành đối tượng JS.
         * @param {string} base64 
         * @returns {Object} JSON object
         */
        function base64ToJson(base64) {
             const jsonString = decodeURIComponent(escape(atob(base64)));
             return JSON.parse(jsonString);
        }

        // --- CÁC HÀM TRA CỨU ĐỘI ĐÃ ĐƯỢC CHUẨN HÓA DỰA TRÊN CẤU TRÚC JSON MỚI ---
        
        /**
         * Lấy ID của đội (T) dựa trên tên đội dùng trong match object (Tn/D).
         * @param {string} teamName - Tên đội đầy đủ (e.g., "Duy Hưng-Minh Tú").
         * @returns {string|null} Mã đội (T) hoặc null.
         */
        function getTeamIdByTeamName(teamName) {
            if (!tournamentData || !tournamentData.tL) return null;
            // Dùng D để tra cứu nếu Tn bị thiếu hoặc dùng để hiển thị khác
            for (const team of tournamentData.tL) {
                // Ưu tiên so sánh với Tn (Tên rút gọn/định danh)
                if (team.Tn === teamName) {
                    return team.T;
                }
            }
            return null;
        }
        
        /**
         * Lấy tên rút gọn của đội (Tn) dựa trên ID.
         * @param {string} teamId - Mã đội (T).
         * @returns {string|null} Tên rút gọn (Tn) hoặc Mã đội nếu không tìm thấy.
         */
        function getTeamNameById(teamId) {
             if (!tournamentData || !tournamentData.tL) return teamId;
             for (const team of tournamentData.tL) {
                 if (team.T === teamId) {
                     return team.Tn;
                 }
             }
             return teamId;
         }

        /**
         * Lấy thông tin chi tiết người chơi dựa trên mã đội (T)
         * NOTE: Hàm này dùng initialTournamentData để lấy dữ liệu gốc, bao gồm team details (P, aPL)
         * @param {string} teamId - Mã đội (T)
         * @returns {Object|null} Thông tin đội hoặc null
         */
        function getTeamDetailById(teamId) {
            if (!initialTournamentData || !initialTournamentData.tL) return null;
            // FIX v1.6.8: Sửa lỗi ReferenceError: t is not defined -> team.T
            return initialTournamentData.tL.find(team => team.T === teamId) || null;
        }

        // ------------------------------------------------------------------------
        
        // =================================================================
        // HÀM TẢI VÀ ĐỒNG BỘ DỮ LIỆU (DATA SYNCHRONIZATION)
        // =================================================================

        /**
         * Lấy nội dung file JSON thô từ GitHub (RAW Content URL).
         * @param {string} url - URL RAW content (STATIC_DATA_URL hoặc DIFF_DATA_URL).
         * @returns {Promise<Object>} JSON object của file.
         */
        async function fetchDataFromGitHub(url) {
            const response = await fetch(url);
            
            // 1. Kiểm tra HTTP Status Code
            if (!response.ok) {
                // Trả về {} nếu file state3s.json không tồn tại (404) để mergeData vẫn chạy
                if (response.status === 404 && url.includes('state3s.json')) {
                    console.warn(\`File tỉ số (state3s.json) không tồn tại hoặc bị xóa (404). Sử dụng dữ liệu gốc.\`);
                    return {};
                }
                // Lỗi chung cho các trường hợp khác (400, 401, 500, hoặc 404 cho state3.json)
                throw new Error(\`Lỗi tải dữ liệu từ GitHub: \${response.status} \${response.statusText} (\${url})\`);
            }
            
            // 2. Thử Parse JSON (Làm cho việc tải dữ liệu Raw ổn định hơn, bỏ qua Content-Type header)
            try {
                return response.json(); 
            } catch (e) {
                 const contentType = response.headers.get("content-type");
                 // Báo cáo lỗi cụ thể nếu không parse được
                 throw new Error(\`Dữ liệu tải về không thể parse thành JSON. Content-Type được báo cáo: \${contentType}.\`);
            }
        }

        /**
         * Tải dữ liệu state3.json (gốc) và state3s.json (tỉ số) từ GitHub, sau đó hợp nhất.
         */
        async function loadDataFromGitHub() {
            const statusEl = document.getElementById('statusMessage');
            statusEl.textContent = 'Loading and merging data from GitHub...';
            statusEl.classList.remove('bg-green-900/50', 'bg-red-900/50');
            statusEl.classList.add('bg-blue-900/50');

            try {
                // 1. Lấy dữ liệu gốc (state3.json)
                const baseData = await fetchDataFromGitHub(STATIC_DATA_URL);
                initialTournamentData = baseData; 
                
                // 2. Lấy dữ liệu tỉ số (state3s.json). Sẽ trả về {} nếu 404/file rỗng
                const diffData = await fetchDataFromGitHub(DIFF_DATA_URL);
                const isDiffDataEmpty = Object.keys(diffData).length === 0;
                
                // 3. Hợp nhất
                tournamentData = mergeData(initialTournamentData, diffData);

                // 4. Chạy logic và render
                runAllLogic(); 

                // 5. Logic Tự động Commit (Chỉ chạy lần đầu và khi state3s.json rỗng/không tồn tại)
                if (needsInitialCommit && isDiffDataEmpty) {
                     // Set cờ false ngay lập tức để ngăn chặn vòng lặp vô tận khi tự động reload.
                     needsInitialCommit = false; 
                     
                     // Chỉ gọi commit nếu có thay đổi (tức là sau runAllLogic đã tạo ra diffDataForCommit)
                     const diffToCommit = window.diffDataForCommit || {};
                     if (Object.keys(diffToCommit).length > 0) {
                         // GỌI COMMIT IM LẶNG
                         await commitQuietly();
                         return; // Thoát khỏi lần tải hiện tại để lần tải tiếp theo từ commit xử lý hiển thị.
                     }
                }
                
                needsInitialCommit = false; // Đảm bảo cờ được set false nếu không tự động commit

                // 6. Hiển thị trạng thái thành công cho lần tải cuối cùng
                statusEl.classList.remove('bg-blue-900/50');
                statusEl.classList.add('bg-green-900/50');
                statusEl.textContent = \`✅ Sync successful. Version: \${tournamentData.version || 'N/A'}.\`;
                
            } catch (error) {
                console.error('Lỗi tải/hợp nhất dữ liệu:', error);
                statusEl.classList.remove('bg-blue-900/50');
                statusEl.classList.add('bg-red-900/50');
                statusEl.textContent = \`❌ DATA LOAD ERROR: \${error.message}. Check URL and network connection.\`;
            }
        }
        
        /**
         * Hàm được gọi khi người dùng muốn Đồng bộ lại (Re-sync) dữ liệu gốc.
         */
        async function reSyncStaticData() {
            document.getElementById('confirmationBox').classList.add('hidden');
            // Đặt lại dữ liệu tỉ số tạm thời (diffDataForCommit)
            window.diffDataForCommit = {}; 
            document.getElementById('scoreCommitResult').classList.add('hidden');
            document.getElementById('teamCommitResult').classList.add('hidden');
            needsInitialCommit = true; // Cho phép tự động commit nếu cần
            await loadDataFromGitHub();
        }
        // Đăng ký hàm reSyncStaticData vào window để dùng trong event listener
        window.reSyncStaticData = reSyncStaticData;

        // =================================================================
        // HÀM LOGIC GIẢI ĐẤU
        // =================================================================

        /**
         * Hợp nhất dữ liệu tỉ số vào dữ liệu giải đấu chính.
         * @param {Object} baseData - Dữ liệu state3.json.
         * @param {Object} diffData - Dữ liệu state3s.json.
         * @returns {Object} Dữ liệu đã hợp nhất.
         */
        function mergeData(baseData, diffData) {
            const merged = JSON.parse(JSON.stringify(baseData)); // Deep copy base
            
            // Nếu diffData là đối tượng rỗng (do file rỗng/404) thì vẫn tiếp tục
            if (!diffData || Object.keys(diffData).length === 0) return merged;

            // 1. Merge group match scores (matchesA-D)
            ['A', 'B', 'C', 'D'].forEach(group => {
                const matchesKey = \`matches\${group}\`;
                if (merged[matchesKey] && diffData[matchesKey]) {
                    merged[matchesKey] = merged[matchesKey].map((match, index) => {
                        const diffMatch = diffData[matchesKey][index];
                        if (diffMatch) {
                            // Merge only score and winner/loser fields
                            return { 
                                ...match, 
                                // Dùng toán tử nullish coalescing (??) hoặc kiểm tra undefined/null
                                sA: diffMatch.sA !== undefined ? diffMatch.sA : match.sA,
                                sB: diffMatch.sB !== undefined ? diffMatch.sB : match.sB,
                                Wn: diffMatch.Wn !== undefined ? diffMatch.Wn : match.Wn,
                                rU: diffMatch.rU !== undefined ? diffMatch.rU : match.rU,
                            };
                        }
                        return match;
                    });
                }
            });

            // 2. Merge knockout scores
            ['quarterfinals', 'semifinals'].forEach(round => {
                if (merged[round] && diffData[round]) {
                     merged[round] = merged[round].map((match, index) => {
                         const diffMatch = diffData[round][index];
                         if (diffMatch) {
                             return { 
                                 ...match, 
                                 sA: diffMatch.sA !== undefined ? diffMatch.sA : match.sA,
                                 sB: diffMatch.sB !== undefined ? diffMatch.sB : match.sB,
                                 Wn: diffMatch.Wn !== undefined ? diffMatch.Wn : match.Wn,
                                 rU: diffMatch.rU !== undefined ? diffMatch.rU : match.rU,
                             };
                         }
                         return match;
                     });
                 }
            });
            
            // 3. Merge final score
            if (merged.final && diffData.final) {
                // final is an object, but diffData.final might be an array with one element if committed as array
                const finalDiff = Array.isArray(diffData.final) ? diffData.final[0] : diffData.final;
                merged.final = { ...merged.final, ...finalDiff };
            }

            return merged;
        }

        /**
         * Xác định đội thắng và cập nhật trường Wn.
         * Dùng cho cả vòng bảng (isGroupMatch=true, dùng A/B là tên đội) và vòng loại (isGroupMatch=false, dùng tA/tB là ID).
         * @param {Object} match - Đối tượng trận đấu.
         * @param {boolean} isGroupMatch - True nếu là trận vòng bảng (dùng A, B, Wn strings), False nếu là vòng loại (dùng tA, tB, Wn IDs).
         */
        function calculateWinner(match, isGroupMatch) {
            // Đảm bảo score là số, nếu null/undefined/'' thì coi là 0 để so sánh
            const scoreA = match.sA !== null && match.sA !== undefined ? parseInt(match.sA) : 0;
            const scoreB = match.sB !== null && match.sB !== undefined ? parseInt(match.sB) : 0;

            let teamA, teamB;
            if (isGroupMatch) {
                teamA = match.A; // Team Name string
                teamB = match.B; // Team Name string
            } else {
                teamA = match.tA; // Team ID (T)
                teamB = match.tB; // Team ID (T)
            }
            
            // Chỉ tính thắng thua nếu tỉ số khác 0 hoặc khác nhau
            if (scoreA > scoreB) {
                match.Wn = teamA;
            } else if (scoreB > scoreA) {
                match.Wn = teamB;
            } else if (scoreA === 0 && scoreB === 0) {
                 // Nếu cả hai đều là 0 (hoặc chưa nhập), coi như chưa có kết quả
                 match.Wn = null; 
            } else {
                // Trường hợp hòa và có tỉ số khác 0 (nếu cho phép hòa)
                match.Wn = null; 
            }
        }
        
        /**
         * Tính toán lại thống kê vòng bảng (W, L, Pts) và sắp xếp.
         * [CẬP NHẬT V1.6.7: Thêm PF và PD cho xếp hạng Pickleball]
         */
        function recalculateAndSortGroupTables() {
            if (!tournamentData) return;

            const groups = ['A', 'B', 'C', 'D'];

            groups.forEach(group => {
                const matchesKey = \`matches\${group}\`;
                const tableKey = \`table\${group}\`;
                const groupMatches = tournamentData[matchesKey] || [];
                
                const teamStats = {}; 
                const teamsInGroupNames = new Set();
                
                // 1. Thu thập tất cả các đội tham gia trong Matches
                groupMatches.forEach(match => {
                     if (match.A) teamsInGroupNames.add(match.A);
                     if (match.B) teamsInGroupNames.add(match.B);
                });
                
                // 2. Khởi tạo stats cho các đội đã tham gia
                teamsInGroupNames.forEach(teamName => {
                    const teamId = getTeamIdByTeamName(teamName);
                    if (teamId) {
                         const teamOriginal = tournamentData.tL.find(t => t.T === teamId) || {};
                         teamStats[teamId] = { 
                            ...teamOriginal, 
                            T: teamId, 
                            W: 0, L: 0, Pts: 0, mP: 0,
                            PF: 0, PD: 0, // THÊM POINTS FOR (PF) VÀ POINT DIFFERENTIAL (PD)
                            D: teamOriginal.Tn || teamOriginal.T 
                         };
                    }
                });
                
                
                // 3. Aggregate stats from matches
                groupMatches.forEach(match => {
                    // Cập nhật Wn (Tên đội) dựa trên tỉ số sA/sB hiện tại
                    calculateWinner(match, true); 

                    // Lấy ID đội từ Tên đội
                    const teamAId = getTeamIdByTeamName(match.A);
                    const teamBId = getTeamIdByTeamName(match.B); 
                    const winnerName = match.Wn;
                    const winnerId = winnerName ? getTeamIdByTeamName(winnerName) : null; 
                    
                    if (teamAId && teamBId && teamStats[teamAId] && teamStats[teamBId]) {
                         
                         const isMatchPlayed = match.sA !== null || match.sB !== null;
                         const scoreA = parseInt(match.sA) || 0; // Đảm bảo là số, nếu null/undefined dùng 0
                         const scoreB = parseInt(match.sB) || 0;

                         if (isMatchPlayed) {
                            // Cập nhật Matches Played (mP) cho cả hai đội
                            teamStats[teamAId].mP += 1;
                            teamStats[teamBId].mP += 1;
                            
                            // TÍNH TOÁN VÀ TÍCH LŨY PF, PD
                            teamStats[teamAId].PF += scoreA;
                            teamStats[teamAId].PD += (scoreA - scoreB);
                            
                            teamStats[teamBId].PF += scoreB;
                            teamStats[teamBId].PD += (scoreB - scoreA);

                            // Cập nhật W, L, Pts
                            if (winnerId === teamAId) {
                                teamStats[teamAId].W += 1; teamStats[teamAId].Pts += 3; 
                                teamStats[teamBId].L += 1;
                            } else if (winnerId === teamBId) {
                                teamStats[teamBId].W += 1; teamStats[teamBId].Pts += 3;
                                teamStats[teamAId].L += 1;
                            } 
                         }
                    }
                });
                
                let groupTable = Object.keys(teamStats).map(teamId => teamStats[teamId]);
                
                // 4. Sort the new table (LUẬT PICKLEBALL: W > Pts > PD > PF)
                groupTable.sort((a, b) => {
                    if (b.W !== a.W) return b.W - a.W;       // 1. Số trận thắng (W)
                    if (b.Pts !== a.Pts) return b.Pts - a.Pts; // 2. Tổng điểm (Pts) - Vẫn dùng để xếp hạng
                    if (b.PD !== a.PD) return b.PD - a.PD;   // 3. Hiệu số điểm (Point Differential - PD)
                    if (b.PF !== a.PF) return b.PF - a.PF;   // 4. Tổng điểm ghi được (Points For - PF)
                    return 0; 
                });
                
                tournamentData[tableKey] = groupTable;
            });
        }
        
        /**
         * Lấy đội thắng vòng bảng (A1, B2, v.v...) và điền vào các trận Tứ kết (tA, tB).
         */
        function seedKnockoutMatches() {
            if (!tournamentData || !tournamentData.quarterfinals) return;

            // Hàm Helper để lấy Team ID dựa trên vị trí seeding (ví dụ: 'A1', 'C2')
            function getTeamIdByPosition(position) {
                if (!position || position.length < 2) return null;
                const group = position[0]; // 'A', 'B', 'C', 'D'
                const rank = parseInt(position.substring(1)); // 1, 2, 3... (1-based index)
                
                if (isNaN(rank) || rank <= 0) return null;

                const tableKey = \`table\${group}\`;
                const groupTable = tournamentData[tableKey];
                
                // rank - 1 vì index của mảng groupTable là 0-based
                if (groupTable && groupTable[rank - 1]) {
                    return groupTable[rank - 1].T; // Return Team ID (T)
                }
                return null;
            }

            // Chỉ cập nhật các trận Tứ kết
            tournamentData.quarterfinals.forEach((match, index) => {
                let positionA = match.pA;
                let positionB = match.pB;
                
                // **QUY TẮC PHÂN HẠT TỨ KẾT ĐẶC BIỆT (QF1-QF4)**
                // Ghi đè vị trí phân hạt dựa trên index để đảm bảo tuân thủ quy tắc chéo
                if (index === 0) { // QF1
                    positionA = 'A1'; // W.A
                    positionB = 'B2'; // R.B
                } else if (index === 1) { // QF2
                    positionA = 'B1'; // W.B
                    positionB = 'A2'; // R.A
                } else if (index === 2) { // QF3
                    positionA = 'C1'; // W.C
                    positionB = 'D2'; // R.D
                } else if (index === 3) { // QF4
                    positionA = 'D1'; // W.D
                    positionB = 'C2'; // R.C
                }
                // Nếu có QF khác (>= index 4), nó sẽ tự động dùng pA/pB từ JSON gốc
                
                // Lấy ID đội dựa trên vị trí seeding đã xác định
                const teamAId = getTeamIdByPosition(positionA);
                const teamBId = getTeamIdByPosition(positionB);

                // Cập nhật tA và tB. Nếu không tìm thấy (TBD), gán null
                match.tA = teamAId;
                match.tB = teamBId;
            });
        }

        /**
         * Cập nhật thông tin các trận đấu vòng loại (tứ kết, bán kết, chung kết).
         * @param {string} round - 'quarterfinals', 'semifinals', 'final'
         */
        function updateKnockoutMatches(round) {
            if (!tournamentData || !tournamentData[round]) return;

            const matches = Array.isArray(tournamentData[round]) ? tournamentData[round] : [tournamentData[round]];

            matches.forEach(match => {
                const teamAId = match.tA; // Vòng loại dùng T (ID)
                const teamBId = match.tB;

                if (teamAId && teamBId) {
                    // Cập nhật Winner/Loser (Wn là ID của đội thắng)
                    calculateWinner(match, false); // false for knockout match (uses tA/tB, sets Wn to ID)

                    if (round === 'final' && match.Wn) {
                        // Cập nhật đội Á quân cho trận chung kết
                        match.rU = match.Wn === teamAId ? teamBId : teamAId;
                    } else if (round !== 'final' && match.Wn) {
                        // Cập nhật đội đi tiếp (Chỉ áp dụng cho Tứ kết và Bán kết)
                        const winner = match.Wn;

                        // <BẮT ĐẦU ĐIỀU CHỈNH LOGIC PHÂN HẠT TỨ KẾT -> BÁN KẾT>
                        if (round === 'quarterfinals') {
                            const qfPos = match.Pos; // 1, 2, 3, 4
                            const sfMatches = tournamentData.semifinals;

                            if (sfMatches && sfMatches.length >= 2) {
                                // SF1 (index 0): W.QF1 vs W.QF3
                                if (qfPos === 1) { // W.QF1 -> SF1 Team A
                                    sfMatches[0].tA = winner;
                                } else if (qfPos === 3) { // W.QF3 -> SF1 Team B
                                    sfMatches[0].tB = winner;
                                } 
                                // SF2 (index 1): W.QF2 vs W.QF4
                                else if (qfPos === 2) { // W.QF2 -> SF2 Team A
                                    sfMatches[1].tA = winner;
                                } else if (qfPos === 4) { // W.QF4 -> SF2 Team B
                                    sfMatches[1].tB = winner;
                                }
                            }
                        } 
                        // <KẾT THÚC ĐIỀU CHỈNH LOGIC PHÂN HẠT TỨ KẾT -> BÁN KẾT>
                        
                        // Logic Bán kết -> Chung kết
                        if (round === 'semifinals') {
                             const nextRound = tournamentData.final;
                             const position = match.Pos;

                            if (nextRound) {
                                // Xử lý Bán kết -> Chung kết (nextRound là object)
                                if (position === 1) { // Bán kết 1 (SF1)
                                    nextRound.tA = winner;
                                } else if (position === 2) { // Bán kết 2 (SF2)
                                    nextRound.tB = winner;
                                }
                            }
                        }
                    }
                } else {
                    // Nếu một trong hai team ID là null/undefined, đảm bảo Wn cũng là null
                    match.Wn = null;
                    match.rU = null;
                }
            });
        }

        /**
         * Chạy tất cả các logic tính toán lại sau khi tỉ số mới được nhập.
         */
        function runAllLogic() {
            recalculateAndSortGroupTables();
            seedKnockoutMatches(); // V1.6.6 FIX: Cần chạy seeding trước khi tính toán các vòng loại khác
            updateKnockoutMatches('quarterfinals');
            updateKnockoutMatches('semifinals');
            updateKnockoutMatches('final');

            renderAllSections();
            updateDiffData(); // Chuẩn bị dữ liệu để commit tỉ số
        }

        /**
         * Chuẩn bị dữ liệu tỉ số thay đổi (state3s.json) để commit.
         */
        function updateDiffData() {
            if (!tournamentData || !initialTournamentData) return;

            const diffData = {};
            const keysToCheck = [
                'matchesA', 'matchesB', 'matchesC', 'matchesD',
                'quarterfinals', 'semifinals', 'final'
            ];

            keysToCheck.forEach(key => {
                if (tournamentData[key]) {
                    const currentData = Array.isArray(tournamentData[key]) ? tournamentData[key] : [tournamentData[key]];
                    const initialData = Array.isArray(initialTournamentData[key]) ? initialTournamentData[key] : [initialTournamentData[key]];
                    
                    const diffArray = [];
                    currentData.forEach((currentMatch, index) => {
                        const initialMatch = initialData[index];
                        const diffMatch = {};
                        let isDiff = false;
                        
                        // Chỉ commit những field cần thiết
                        const fieldsToCompare = ['sA', 'sB', 'Wn', 'rU'];

                        fieldsToCompare.forEach(field => {
                            // So sánh dựa trên giá trị (bao gồm null)
                            if (String(currentMatch[field]) !== String(initialMatch[field])) {
                                // Chỉ gán giá trị nếu nó khác, bao gồm cả null
                                if (currentMatch[field] !== undefined) {
                                    diffMatch[field] = currentMatch[field];
                                }
                                isDiff = true;
                            }
                        });

                        if (isDiff) {
                            diffArray[index] = diffMatch;
                        } else {
                            diffArray[index] = {};
                        }
                    });

                    // Lọc bỏ placeholder rỗng và các phần tử undefined/null khỏi mảng (chỉ giữ lại index có data)
                    const filteredDiffArray = diffArray.filter(item => item && Object.keys(item).length > 0);
                    
                    if (filteredDiffArray.length > 0) {
                        if (key === 'final') {
                             // Final là object đơn, không phải array
                            diffData[key] = diffArray[0]; 
                        } else {
                            // Cần giữ cấu trúc array với các phần tử rỗng ở index không có thay đổi
                            diffData[key] = diffArray;
                        }
                    }
                }
            });
            
            // Cập nhật global variable để commit
            window.diffDataForCommit = diffData; 

            // Cập nhật trạng thái hiển thị
            const commitBtn = document.getElementById('commitScoreButton');
            const statusEl = document.getElementById('currentStatus');
            
            if (Object.keys(diffData).length > 0) {
                commitBtn.disabled = false;
                statusEl.textContent = 'Uncommitted changes (ready to export)!';
                statusEl.classList.remove('text-green-300');
                statusEl.classList.add('text-yellow-300');
            } else {
                commitBtn.disabled = true;
                statusEl.textContent = 'All scores are up to date.';
                statusEl.classList.remove('text-yellow-300');
                statusEl.classList.add('text-green-300');
            }
        }


        // =================================================================
        // HÀM GIAO TIẾP VỚI GITHUB API (GITHUB COMMUNICATION)
        // =================================================================

        /**
         * Lấy SHA hiện tại của một file trên GitHub (dùng để update).
         * @param {string} apiUrl - BASE_API_URL hoặc SCORE_API_URL
         * @returns {Promise<string|null>} SHA hash của file hoặc null.
         */
        async function getFileSha(apiUrl) {
            const token = localStorage.getItem('githubToken');
            if (!token) return null;

            try {
                const response = await fetch(apiUrl, {
                    method: 'GET',
                    headers: {
                        'Authorization': \`token \${token}\`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                
                // Nếu file không tồn tại (404), trả về null. Đây là trường hợp state3s.json lần đầu.
                if (response.status === 404) {
                    return null;
                }
                if (!response.ok) {
                    // Lỗi xác thực, giới hạn rate, v.v.
                    const errorData = await response.json();
                    throw new Error(\`Failed to fetch SHA: \${response.statusText}. Detail: \${errorData.message}\`);
                }

                const data = await response.json();
                return data.sha;
            } catch (error) {
                console.error(\`Error getting SHA for \${apiUrl.includes('state3s.json') ? 'state3s.json' : 'state3.json'}:\`, error.message);
                return null;
            }
        }

        /**
         * Gửi nội dung mới của file lên GitHub.
         * @param {string} apiUrl - BASE_API_URL hoặc SCORE_API_URL
         * @param {Object} contentData - Dữ liệu JSON cần commit.
         * @param {string} message - Commit message.
         * @param {string|null} sha - SHA hiện tại của file (cần thiết cho update).
         */
        async function commitToGitHub(apiUrl, contentData, message, sha) {
            const token = localStorage.getItem('githubToken');
            if (!token) {
                return { success: false, message: 'Lỗi: GitHub Token chưa được lưu.' };
            }

            const contentBase64 = jsonToBase64(contentData);
            const body = {
                message: message,
                content: contentBase64,
                sha: sha, // Chỉ gửi SHA nếu là update, null nếu là create
                branch: BRANCH
            };

            try {
                const response = await fetch(apiUrl, {
                    method: 'PUT',
                    headers: {
                        'Authorization': \`token \${token}\`,
                        'Content-Type': 'application/json',
                        'Accept': 'application/vnd.github.v3+json'
                    },
                    body: JSON.stringify(body)
                });
                
                const result = await response.json();

                if (!response.ok) {
                    return { 
                        success: false, 
                        message: \`Commit failed: \${result.message || response.statusText}\`,
                        detail: result.errors ? result.errors.map(e => e.message).join(' | ') : ''
                    };
                }

                return { success: true, message: \`Commit successful. SHA: \${result.commit.sha.substring(0, 7)}\` };

            } catch (error) {
                return { success: false, message: \`Network Error: \${error.message}\` };
            }
        }
        
        /**
         * Commit tỉ số thay đổi (state3s.json) lên GitHub.
         */
        async function commitScoreChangesToGitHub() {
            const resultEl = document.getElementById('scoreCommitResult');
            const button = document.getElementById('commitScoreButton');
            
            resultEl.classList.remove('hidden', 'bg-red-900/50', 'bg-green-900/50');
            resultEl.classList.add('bg-blue-900/50');
            resultEl.textContent = 'Commiting scores to state3s.json...';
            button.disabled = true;

            const diffData = window.diffDataForCommit || {};
            if (Object.keys(diffData).length === 0) {
                resultEl.classList.remove('bg-blue-900/50');
                resultEl.classList.add('bg-green-900/50');
                resultEl.textContent = 'Nothing to commit. Scores are up to date.';
                button.disabled = true; 
                return;
            }

            // 1. Lấy SHA hiện tại của state3s.json (dùng cho update hoặc null cho create)
            const currentSha = await getFileSha(SCORE_API_URL);
            
            // 2. Commit nội dung mới
            const message = \`[SCM] Auto-commit scores v\${tournamentData.version || 'N/A'} at \${new Date().toISOString()}\`;
            const commitResult = await commitToGitHub(SCORE_API_URL, diffData, message, currentSha);

            // 3. Xử lý kết quả
            resultEl.classList.remove('bg-blue-900/50', 'bg-red-900/50', 'bg-green-900/50');
            if (commitResult.success) {
                resultEl.classList.add('bg-green-900/50', 'text-green-300');
                resultEl.textContent = \`✅ Success: \${commitResult.message}\`;
                // Sau khi commit thành công, reload để đồng bộ lại dữ liệu gốc/tỉ số
                await loadDataFromGitHub(); 
            } else {
                resultEl.classList.add('bg-red-900/50', 'text-red-300');
                resultEl.textContent = \`❌ ERROR: \${commitResult.message}. \${commitResult.detail || ''}\`;
                button.disabled = false; // Bật lại nút nếu commit lỗi
            }
        }
        
        /**
         * Commit thay đổi thông tin đội (state3.json) lên GitHub.
         */
        async function commitTeamChangesToGitHub() {
            const resultEl = document.getElementById('teamCommitResult');
            const button = document.getElementById('commitTeamButton');
            
            resultEl.classList.remove('hidden', 'bg-red-900/50', 'bg-green-900/50');
            resultEl.classList.add('bg-blue-900/50');
            resultEl.textContent = 'Commiting team details to state3.json...';
            button.disabled = true;

            // Dữ liệu mới cần commit là initialTournamentData đã chỉnh sửa
            const teamDataToCommit = initialTournamentData;
            if (!teamDataToCommit || !teamDataToCommit.tL) {
                 resultEl.classList.remove('bg-blue-900/50');
                 resultEl.classList.add('bg-red-900/50', 'text-red-300');
                 resultEl.textContent = '❌ ERROR: Initial tournament data is missing.';
                 button.disabled = false; 
                 return;
            }
            
            // 1. Lấy SHA hiện tại của state3.json (cần thiết cho update)
            const currentSha = await getFileSha(BASE_API_URL);
            if (!currentSha) {
                 resultEl.classList.remove('bg-blue-900/50');
                 resultEl.classList.add('bg-red-900/50', 'text-red-300');
                 resultEl.textContent = '❌ ERROR: Could not get SHA for state3.json. Token issue?';
                 button.disabled = false; 
                 return;
            }
            
            // 2. Commit nội dung mới (OVERWRITE state3.json)
            const message = \`[TCM] Updated team details v\${tournamentData.version || 'N/A'} at \${new Date().toISOString()}\`;
            const commitResult = await commitToGitHub(BASE_API_URL, teamDataToCommit, message, currentSha);

            // 3. Xử lý kết quả
            resultEl.classList.remove('bg-blue-900/50', 'bg-red-900/50', 'bg-green-900/50');
            if (commitResult.success) {
                resultEl.classList.add('bg-green-900/50', 'text-green-300');
                resultEl.textContent = \`✅ Success: \${commitResult.message}. Please RE-SYNC data (Tab Config) to apply changes globally.\`;
                // Sau khi commit thành công, không tự động loadDataFromGitHub để tránh mất tỉ số chưa commit.
                // Yêu cầu người dùng Re-Sync thủ công.
            } else {
                resultEl.classList.add('bg-red-900/50', 'text-red-300');
                resultEl.textContent = \`❌ ERROR: \${commitResult.message}. \${commitResult.detail || ''}\`;
            }
            button.disabled = false;
        }

        /**
         * Tự động commit tỉ số (state3s.json) sau lần tải đầu tiên nếu cần.
         * Không cập nhật UI (Quietly).
         */
        async function commitQuietly() {
            const diffData = window.diffDataForCommit || {};
            if (Object.keys(diffData).length === 0) return;

            console.log('Auto-committing initial score data...');

            const currentSha = await getFileSha(SCORE_API_URL);
            const message = \`[SCM:AUTO] Initial score commit v\${tournamentData.version || 'N/A'}\`;
            const commitResult = await commitToGitHub(SCORE_API_URL, diffData, message, currentSha);

            if (commitResult.success) {
                console.log(\`✅ Auto-commit successful. SHA: \${commitResult.message}\`);
                // Sau khi commit thành công, TẢI LẠI DỮ LIỆU ĐỂ CÓ SHA MỚI VÀ DỮ LIỆU GỐC
                await loadDataFromGitHub(); 
            } else {
                console.error(\`❌ Auto-commit failed: \${commitResult.message}\`);
            }
        }


        // =================================================================
        // HÀM RENDER GIAO DIỆN (UI RENDERING)
        // =================================================================

        /**
         * Render thông tin chi tiết về tất cả các đội.
         */
        function renderTeamList() {
            const listEl = document.getElementById('teamList');
            const mgmtListEl = document.getElementById('teamManagementList');
            if (!tournamentData || !tournamentData.tL) return;

            listEl.innerHTML = '';
            mgmtListEl.innerHTML = '';
            
            tournamentData.tL.forEach(team => {
                // RENDER TẠI TAB 'GENERAL'
                const teamDetail = getTeamDetailById(team.T) || {};
                const player1 = teamDetail.P ? teamDetail.P[0] : { name: 'N/A', pL: 'N/A', bY: 'N/A' };
                const player2 = teamDetail.P ? teamDetail.P[1] : { name: 'N/A', pL: 'N/A', bY: 'N/A' };
                
                // Card chi tiết đội (General Tab)
                listEl.innerHTML += \`
                    <div class="p-3 bg-[var(--card-bg)] rounded-lg shadow-md border border-[var(--border-color)]">
                        <h3 class="text-lg font-bold text-[var(--accent-color)] mb-2">\${team.Tn} (\${team.T})</h3>
                        <p class="text-sm text-gray-400 mb-2">Group: <span class="font-semibold text-[var(--group-header-text)]">\${team.G || 'N/A'}</span></p>
                        <div class="space-y-1 text-sm">
                            <p><span class="font-medium">\${player1.name}</span> (Level: \${player1.pL}, YOB: \${player1.bY})</p>
                            <p><span class="font-medium">\${player2.name}</span> (Level: \${player2.pL}, YOB: \${player2.bY})</p>
                        </div>
                    </div>
                \`;
                
                // RENDER TẠI TAB 'TEAM MANAGEMENT'
                const teamMgmtDiv = document.createElement('div');
                teamMgmtDiv.className = "p-4 bg-[var(--match-bg)] rounded-lg shadow-md border border-[var(--border-color)] space-y-3";
                teamMgmtDiv.innerHTML = \`
                    <h4 class="text-xl font-bold text-yellow-500 border-b border-[var(--border-color)] pb-2">\${team.T} - Group: \${team.G || 'N/A'}</h4>
                    
                    <div>
                        <label for="Tn-\${team.T}" class="block text-sm font-medium text-gray-400">Team Name (Tn)</label>
                        <input type="text" id="Tn-\${team.T}" value="\${teamDetail.Tn || ''}" class="text-input w-full p-2 rounded-md mt-1 text-sm" 
                            onchange="handleTeamDetailChange(this, '\${team.T}', 'Tn')">
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                        <div class="p-3 border border-[var(--border-color)] rounded-lg space-y-2">
                            <h5 class="font-semibold text-[var(--accent-color)]">Player 1 (\${player1.name})</h5>
                            
                            <div>
                                <label for="P1Name-\${team.T}" class="block text-xs font-medium text-gray-400">Name</label>
                                <input type="text" id="P1Name-\${team.T}" value="\${player1.name}" class="text-input w-full p-1 rounded-md mt-1 text-xs"
                                    onchange="handlePlayerDetailChange(this, '\${team.T}', 0, 'name')">
                            </div>
                            <div>
                                <label for="P1Level-\${team.T}" class="block text-xs font-medium text-gray-400">Level (pL)</label>
                                <input type="text" id="P1Level-\${team.T}" value="\${player1.pL}" class="text-input w-full p-1 rounded-md mt-1 text-xs"
                                    onchange="handlePlayerDetailChange(this, '\${team.T}', 0, 'pL')">
                            </div>
                            <div>
                                <label for="P1YOB-\${team.T}" class="block text-xs font-medium text-gray-400">YOB (bY)</label>
                                <input type="number" id="P1YOB-\${team.T}" value="\${player1.bY}" class="text-input w-full p-1 rounded-md mt-1 text-xs"
                                    onchange="handlePlayerDetailChange(this, '\${team.T}', 0, 'bY')">
                            </div>
                        </div>

                        <div class="p-3 border border-[var(--border-color)] rounded-lg space-y-2">
                            <h5 class="font-semibold text-[var(--accent-color)]">Player 2 (\${player2.name})</h5>
                            
                            <div>
                                <label for="P2Name-\${team.T}" class="block text-xs font-medium text-gray-400">Name</label>
                                <input type="text" id="P2Name-\${team.T}" value="\${player2.name}" class="text-input w-full p-1 rounded-md mt-1 text-xs"
                                    onchange="handlePlayerDetailChange(this, '\${team.T}', 1, 'name')">
                            </div>
                            <div>
                                <label for="P2Level-\${team.T}" class="block text-xs font-medium text-gray-400">Level (pL)</label>
                                <input type="text" id="P2Level-\${team.T}" value="\${player2.pL}" class="text-input w-full p-1 rounded-md mt-1 text-xs"
                                    onchange="handlePlayerDetailChange(this, '\${team.T}', 1, 'pL')">
                            </div>
                            <div>
                                <label for="P2YOB-\${team.T}" class="block text-xs font-medium text-gray-400">YOB (bY)</label>
                                <input type="number" id="P2YOB-\${team.T}" value="\${player2.bY}" class="text-input w-full p-1 rounded-md mt-1 text-xs"
                                    onchange="handlePlayerDetailChange(this, '\${team.T}', 1, 'bY')">
                            </div>
                        </div>
                    </div>
                \`;
                mgmtListEl.appendChild(teamMgmtDiv);
            });
        }
        
        /**
         * Xử lý thay đổi chi tiết đội (Tn).
         * Cập nhật vào initialTournamentData (chờ commit state3.json).
         */
        function handleTeamDetailChange(inputEl, teamId, field) {
            if (!initialTournamentData || !initialTournamentData.tL) return;
            
            const teamIndex = initialTournamentData.tL.findIndex(t => t.T === teamId);
            if (teamIndex !== -1) {
                // Cập nhật cả trường T trong Team List (tL) và trường T trong Team Table (tT) nếu có
                initialTournamentData.tL[teamIndex][field] = inputEl.value; 
                
                // **QUAN TRỌNG:** Phải cập nhật lại tournamentData (bản merged) để logic runAllLogic
                // và getTeamIdByTeamName hoạt động chính xác dựa trên Team Name (Tn) mới.
                // Điều này KHÔNG ảnh hưởng đến việc commit state3.json vì nó dùng initialTournamentData.
                tournamentData.tL[teamIndex][field] = inputEl.value; 

                // Tạm thời chạy lại logic để cập nhật giao diện (Mặc dù chưa commit state3.json)
                runAllLogic(); 
            }
        }
        
        /**
         * Xử lý thay đổi chi tiết người chơi (name, pL, bY).
         * Cập nhật vào initialTournamentData (chờ commit state3.json).
         */
        function handlePlayerDetailChange(inputEl, teamId, playerIndex, field) {
            if (!initialTournamentData || !initialTournamentData.tL) return;
            
            const team = initialTournamentData.tL.find(t => t.T === teamId);
            if (team && team.P && team.P[playerIndex]) {
                team.P[playerIndex][field] = inputEl.value;
                // Không cần runAllLogic vì thay đổi này chỉ ảnh hưởng đến tab General/Team Mgmt
                // Chỉ cần re-render team list để cập nhật tab General (optional)
                renderTeamList();
            }
        }

        /**
         * Tạo markup cho một trận đấu vòng bảng.
         * @param {Object} match - Đối tượng trận đấu.
         * @param {number} index - Index của trận đấu trong mảng.
         * @param {string} group - Tên nhóm ('A', 'B', 'C', 'D').
         * @returns {string} HTML markup.
         */
        function createGroupMatchMarkup(match, index, group) {
            const matchId = \`\${group}-\${index}\`;
            const scoreA = match.sA !== null && match.sA !== undefined ? match.sA : '';
            const scoreB = match.sB !== null && match.sB !== undefined ? match.sB : '';
            const isFinished = match.Wn !== null && match.Wn !== undefined;
            const teamAWinner = match.Wn === match.A;
            const teamBWinner = match.Wn === match.B;
            
            const teamAClasses = \`font-bold \${teamAWinner ? 'text-yellow-500' : ''}\`;
            const teamBClasses = \`font-bold \${teamBWinner ? 'text-yellow-500' : ''}\`;
            const inputClasses = 'score-input w-10 text-center p-1 rounded-md text-sm';

            return \`
                <div class="match-card flex items-center p-3">
                    <div class="text-xs text-gray-500 w-8 flex-shrink-0">Match \${index + 1}</div>
                    
                    <div class="flex-grow grid grid-cols-2 gap-2 items-center text-sm">
                        
                        <div class="flex items-center justify-end space-x-2">
                            <span class="\${teamAClasses}">\${match.A}</span>
                            <input type="number" id="\${matchId}-sA" 
                                value="\${scoreA}" 
                                class="\${inputClasses} \${isFinished && teamAWinner ? 'border-yellow-500 border-2' : ''}" 
                                min="0" 
                                oninput="handleScoreInput('\${matchId}', 'sA', '\${group}')">
                        </div>

                        <div class="flex items-center justify-start space-x-2">
                            <input type="number" id="\${matchId}-sB" 
                                value="\${scoreB}" 
                                class="\${inputClasses} \${isFinished && teamBWinner ? 'border-yellow-500 border-2' : ''}" 
                                min="0" 
                                oninput="handleScoreInput('\${matchId}', 'sB', '\${group}')">
                            <span class="\${teamBClasses}">\${match.B}</span>
                        </div>
                    </div>
                    
                </div>
            \`;
        }

        /**
         * Render danh sách các trận đấu vòng bảng.
         * @param {string} group - Tên nhóm ('A', 'B', 'C', 'D').
         */
        function renderGroupMatchList(group) {
            const matchesEl = document.getElementById(\`matches\${group}\`);
            const matchesKey = \`matches\${group}\`;

            if (!tournamentData || !tournamentData[matchesKey]) {
                 matchesEl.innerHTML = \`<div class="text-center p-4 text-gray-400">No matches data available for Group \${group}.</div>\`;
                 return;
            }

            let html = \`<h3 class="text-xl font-bold text-[var(--accent-color)] mb-3 border-b border-[var(--border-color)] pb-2">Group \${group} Matches</h3>
                        <div class="space-y-1">\`;

            tournamentData[matchesKey].forEach((match, index) => {
                html += createGroupMatchMarkup(match, index, group);
            });

            html += \`</div>\`;
            matchesEl.innerHTML = html;
        }

        /**
         * Xử lý nhập điểm cho trận đấu vòng bảng.
         * @param {string} matchId - ID trận đấu (e.g., 'A-0').
         * @param {string} scoreField - 'sA' hoặc 'sB'.
         * @param {string} group - 'A', 'B', 'C', 'D'.
         */
        function handleScoreInput(matchId, scoreField, group) {
            const [groupMatchKey, indexStr] = matchId.split('-');
            const index = parseInt(indexStr);
            const matchesKey = \`matches\${group}\`;

            const inputEl = document.getElementById(\`\${matchId}-\${scoreField}\`);
            let value = inputEl.value;

            // Chuyển đổi rỗng thành null, và đảm bảo là số nguyên
            const numericValue = value === '' ? null : parseInt(value) || 0;
            
            if (tournamentData && tournamentData[matchesKey] && tournamentData[matchesKey][index]) {
                const match = tournamentData[matchesKey][index];
                
                // Cập nhật giá trị số (hoặc null) vào đối tượng match
                match[scoreField] = numericValue;
                
                // Chạy lại logic để cập nhật bảng xếp hạng, Wn, và các vòng loại
                runAllLogic(); 

                // Tùy chỉnh: Cập nhật lại input element sau runAllLogic để hiển thị giá trị đã được chuẩn hóa (ví dụ: loại bỏ dấu phẩy)
                inputEl.value = match[scoreField] !== null ? match[scoreField] : '';
            }
        }
        // Đăng ký hàm handleScoreInput vào window để dùng trong event listener
        window.handleScoreInput = handleScoreInput;


        /**
         * Render bảng xếp hạng của một nhóm (Group Table).
         * @param {string} group - Tên nhóm ('A', 'B', 'C', 'D').
         */
        function renderGroupTable(group) {
            const tableEl = document.getElementById(\`table\${group}\`);
            const tableKey = \`table\${group}\`;
            
            if (!tournamentData || !tournamentData[tableKey]) {
                 tableEl.innerHTML = \`<div class="text-center p-4 text-gray-400">No table data available for Group \${group}.</div>\`;
                 return;
            }

            const groupTable = tournamentData[tableKey];
            
            let html = \`<h3 class="text-xl font-bold text-[var(--group-header-text)] mb-3 border-b border-[var(--border-color)] pb-2">Group \${group} Table</h3>
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-[var(--border-color)] text-sm">
                                <thead class="bg-[var(--match-bg)]">
                                    <tr>
                                        <th class="px-2 py-2 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">#</th>
                                        <th class="px-2 py-2 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Team</th>
                                        <th class="px-2 py-2 text-center text-xs font-medium text-gray-400 uppercase tracking-wider">W</th>
                                        <th class="px-2 py-2 text-center text-xs font-medium text-gray-400 uppercase tracking-wider">L</th>
                                        <th class="px-2 py-2 text-center text-xs font-medium text-gray-400 uppercase tracking-wider">PD</th>
                                        <th class="px-2 py-2 text-center text-xs font-medium text-gray-400 uppercase tracking-wider">PF</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-[var(--border-color)]">\`;

            groupTable.forEach((team, index) => {
                const rank = index + 1;
                const isQualifier = rank <= 2; // Giả sử 2 đội đầu vào vòng loại
                
                html += \`
                    <tr class="\${isQualifier ? 'bg-[var(--card-bg)] font-semibold border-l-4 border-yellow-500' : 'hover:bg-[var(--match-bg)]'}">
                        <td class="px-2 py-2 whitespace-nowrap text-center text-xs text-gray-400 \${isQualifier ? 'text-yellow-500 font-bold' : ''}">\${rank}</td>
                        <td class="px-2 py-2 whitespace-nowrap text-left text-gray-200">\${team.Tn || team.T || 'N/A'}</td>
                        <td class="px-2 py-2 whitespace-nowrap text-center">\${team.W}</td>
                        <td class="px-2 py-2 whitespace-nowrap text-center">\${team.L}</td>
                        <td class="px-2 py-2 whitespace-nowrap text-center">\${team.PD}</td>
                        <td class="px-2 py-2 whitespace-nowrap text-center">\${team.PF}</td>
                    </tr>
                \`;
            });

            html += \`</tbody></table></div>\`;
            tableEl.innerHTML = html;
        }

        /**
         * Tạo markup cho trận đấu vòng loại (Knockout).
         * @param {Object} match - Đối tượng trận đấu.
         * @param {string} roundName - 'Quarterfinal', 'Semifinal', 'Final'.
         * @param {number} matchIndex - Index của trận đấu trong vòng (0-based).
         * @returns {string} HTML markup.
         */
        function createKnockoutMatchMarkup(match, roundName, matchIndex) {
            const teamAId = match.tA;
            const teamBId = match.tB;
            
            // Tên đội/Placeholder hiển thị
            const teamAName = teamAId ? getTeamNameById(teamAId) : (match.pA ? \`W.\${match.pA}\` : 'TBD');
            const teamBName = teamBId ? getTeamNameById(teamBId) : (match.pB ? \`W.\${match.pB}\` : 'TBD');

            const matchId = \`\${roundName.toLowerCase()}-\${matchIndex}\`;
            const scoreA = match.sA !== null && match.sA !== undefined ? match.sA : '';
            const scoreB = match.sB !== null && match.sB !== undefined ? match.sB : '';
            const isFinished = match.Wn !== null && match.Wn !== undefined;
            
            const teamAWinner = match.Wn === teamAId;
            const teamBWinner = match.Wn === teamBId;

            const inputDisabled = !(teamAId && teamBId) ? 'disabled' : ''; // Chỉ cho phép nhập nếu có cả 2 đội

            const winnerText = match.Wn ? \`Winner: \${getTeamNameById(match.Wn)}\` : '';
            const winnerClasses = isFinished ? 'text-yellow-500 font-extrabold' : 'text-gray-500';

            const teamAClasses = \`font-bold \${teamAWinner ? 'text-yellow-500' : ''} \${!teamAId ? 'text-gray-500 italic' : 'text-[var(--text-color)]'}\`;
            const teamBClasses = \`font-bold \${teamBWinner ? 'text-yellow-500' : ''} \${!teamBId ? 'text-gray-500 italic' : 'text-[var(--text-color)]'}\`;
            const inputClasses = 'score-input w-12 text-center p-1 rounded-md text-sm';
            
            // Xử lý chung kết
            const isFinal = roundName === 'Final';
            const runnerUpText = isFinal && match.rU ? \`Runner-up: \${getTeamNameById(match.rU)}\` : '';
            const finalResults = isFinal && isFinished ? 
                \`
                <div class="mt-2 pt-2 border-t border-[var(--border-color)] text-xs font-semibold text-center">
                    <p class="\${winnerClasses}">CHAMPION: \${getTeamNameById(match.Wn)}</p>
                    <p class="text-gray-400">RUNNER-UP: \${getTeamNameById(match.rU)}</p>
                </div>
                \` : '';

            return \`
                <div class="match-card p-4 rounded-lg border-b-2 \${isFinal ? 'border-red-500 shadow-xl' : ''}">
                    <div class="text-xs text-gray-500 mb-2 font-semibold">\${roundName} \${isFinal ? '' : (matchIndex + 1)} (\${match.Pos})</div>
                    
                    <div class="space-y-3">
                        <div class="flex items-center justify-between">
                            <span class="\${teamAClasses} w-1/2 overflow-hidden whitespace-nowrap text-ellipsis">\${teamAName}</span>
                            <input type="number" id="\${matchId}-sA" 
                                value="\${scoreA}" 
                                class="\${inputClasses} \${isFinished && teamAWinner ? 'border-yellow-500 border-2' : ''}" 
                                min="0" 
                                \${inputDisabled}
                                oninput="handleKnockoutScoreInput(this, '\${matchId}', 'sA', '\${roundName.toLowerCase()}')">
                        </div>
                        
                        <div class="flex items-center justify-between">
                            <span class="\${teamBClasses} w-1/2 overflow-hidden whitespace-nowrap text-ellipsis">\${teamBName}</span>
                            <input type="number" id="\${matchId}-sB" 
                                value="\${scoreB}" 
                                class="\${inputClasses} \${isFinished && teamBWinner ? 'border-yellow-500 border-2' : ''}" 
                                min="0" 
                                \${inputDisabled}
                                oninput="handleKnockoutScoreInput(this, '\${matchId}', 'sB', '\${roundName.toLowerCase()}')">
                        </div>
                    </div>
                    
                    \${finalResults}

                </div>
            \`;
        }

        /**
         * Render các trận đấu vòng loại (Knockout).
         */
        function renderKnockoutMatches() {
            if (!tournamentData) return;

            const qfEl = document.getElementById('quarterfinals');
            const sfEl = document.getElementById('semifinals');
            const finalEl = document.getElementById('finalSection');
            const finalResultsEl = document.getElementById('finalResults');


            // 1. Tứ kết
            let qfHtml = \`<h3 class="text-2xl font-extrabold text-pink-500 mb-4 border-b border-[var(--border-color)] pb-2">Quarterfinals</h3>
                          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">\`;
            if (tournamentData.quarterfinals && tournamentData.quarterfinals.length > 0) {
                tournamentData.quarterfinals.forEach((match, index) => {
                    qfHtml += createKnockoutMatchMarkup(match, 'Quarterfinal', index);
                });
            } else {
                 qfHtml += \`<div class="md:col-span-2 lg:col-span-4 text-center p-4 text-gray-400">No Quarterfinal matches data available.</div>\`;
            }
            qfHtml += \`</div>\`;
            qfEl.innerHTML = qfHtml;

            // 2. Bán kết
            let sfHtml = \`<h3 class="text-2xl font-extrabold text-purple-500 mb-4 border-b border-[var(--border-color)] pt-4 pb-2">Semifinals</h3>
                          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">\`;
            if (tournamentData.semifinals && tournamentData.semifinals.length > 0) {
                 tournamentData.semifinals.forEach((match, index) => {
                     sfHtml += createKnockoutMatchMarkup(match, 'Semifinal', index);
                 });
            } else {
                 sfHtml += \`<div class="md:col-span-2 text-center p-4 text-gray-400">No Semifinal matches data available.</div>\`;
            }
            sfHtml += \`</div>\`;
            sfEl.innerHTML = sfHtml;

            // 3. Chung kết (Final Match Section)
            let finalHtml = \`<h3 class="text-2xl font-extrabold text-red-500 mb-4 border-b border-[var(--border-color)] pt-4 pb-2">Final</h3>
                            <div class="max-w-md mx-auto">\`;
            let finalResultHtml = \`<div class="text-center text-lg text-gray-400">Final match not finished.</div>\`;

            if (tournamentData.final) {
                 finalHtml += createKnockoutMatchMarkup(tournamentData.final, 'Final', 0);
                 
                 // Render Final Results (General Tab)
                 if (tournamentData.final.Wn && tournamentData.final.rU) {
                     const championName = getTeamNameById(tournamentData.final.Wn);
                     const runnerUpName = getTeamNameById(tournamentData.final.rU);
                     
                     finalResultHtml = \`
                         <div class="space-y-3">
                             <div class="bg-yellow-800/50 p-4 rounded-lg">
                                 <p class="text-xl font-extrabold text-yellow-300">CHAMPION</p>
                                 <p class="text-3xl font-extrabold text-yellow-100">\${championName}</p>
                                 <p class="text-xs text-gray-300 mt-1">Score: \${tournamentData.final.sA}-\${tournamentData.final.sB}</p>
                             </div>
                             <div class="bg-gray-700/50 p-3 rounded-lg">
                                 <p class="text-lg font-bold text-gray-300">RUNNER-UP</p>
                                 <p class="text-xl font-bold text-gray-100">\${runnerUpName}</p>
                             </div>
                         </div>
                     \`;
                 }
            } else {
                 finalHtml += \`<div class="text-center p-4 text-gray-400">No Final match data available.</div>\`;
            }
            finalHtml += \`</div>\`;
            finalEl.innerHTML = finalHtml;
            finalResultsEl.innerHTML = finalResultHtml;
        }

        /**
         * Xử lý nhập điểm cho trận đấu vòng loại (Knockout).
         * @param {HTMLElement} inputEl - Input element.
         * @param {string} matchId - ID trận đấu (e.g., 'quarterfinals-0').
         * @param {string} scoreField - 'sA' hoặc 'sB'.
         * @param {string} round - 'quarterfinals', 'semifinals', 'final'.
         */
        function handleKnockoutScoreInput(inputEl, matchId, scoreField, round) {
            const index = parseInt(matchId.split('-')[1]);
            let value = inputEl.value;
            const numericValue = value === '' ? null : parseInt(value) || 0;
            
            let targetMatch;
            if (round === 'final') {
                targetMatch = tournamentData.final;
            } else if (tournamentData[round] && tournamentData[round][index]) {
                targetMatch = tournamentData[round][index];
            } else {
                return;
            }
            
            // Cập nhật giá trị số (hoặc null) vào đối tượng match
            targetMatch[scoreField] = numericValue;
            
            // Chạy lại logic để cập nhật Wn, rU, và các trận đấu tiếp theo
            runAllLogic(); 

            // Cập nhật lại input element sau runAllLogic để hiển thị giá trị đã được chuẩn hóa
            inputEl.value = targetMatch[scoreField] !== null ? targetMatch[scoreField] : '';
        }
        // Đăng ký hàm handleKnockoutScoreInput vào window để dùng trong event listener
        window.handleKnockoutScoreInput = handleKnockoutScoreInput;

        /**
         * Render tất cả các phần giao diện.
         */
        function renderAllSections() {
            renderTeamList();
            renderGroupMatchList('A');
            renderGroupTable('A');
            renderGroupMatchList('B');
            renderGroupTable('B');
            renderGroupMatchList('C');
            renderGroupTable('C');
            renderGroupMatchList('D');
            renderGroupTable('D');
            renderKnockoutMatches();
            updateConfigUrls(); // Cập nhật URL config
        }
        
        // =================================================================
        // HÀM CHUYỂN TAB VÀ CHUYỂN ĐỘNG (TAB SWITCHING & GESTURE)
        // =================================================================

        /**
         * Chuyển đổi giữa các tab.
         * @param {string} tabId - ID của tab cần hiển thị.
         */
        function switchTab(tabId) {
            // Ẩn tất cả nội dung tab
            document.querySelectorAll('.tab-content').forEach(content => {
                content.style.display = 'none';
            });

            // Gỡ bỏ class 'active' khỏi tất cả button
            document.querySelectorAll('.tab-button').forEach(button => {
                button.classList.remove('active');
            });

            // Hiển thị nội dung tab được chọn
            const activeContent = document.getElementById(tabId);
            if (activeContent) {
                activeContent.style.display = 'grid'; // Sử dụng grid cho các tab nhóm
                if (tabId === 'General' || tabId === 'TeamManagement' || tabId === 'Knockout' || tabId === 'Configuration') {
                    activeContent.style.display = 'block';
                }
            }

            // Thêm class 'active' cho button được chọn
            const activeButton = document.querySelector(\`.tab-button[data-tab="\${tabId === 'TeamManagement' ? 'TeamMgmt' : tabId}"]\`);
            if (activeButton) {
                activeButton.classList.add('active');
            }
            
            currentTab = tabId;
            localStorage.setItem('currentTab', tabId);
        }
        
        /**
         * Xử lý cử chỉ vuốt (swipe) để chuyển tab.
         */
        function handleGesture() {
            const diffX = endX - startX;
            if (Math.abs(diffX) < 50) return; // Bỏ qua nếu chuyển động quá nhỏ

            const tabIds = ['General', 'TeamManagement', 'GroupA', 'GroupB', 'GroupC', 'GroupD', 'Knockout', 'Configuration'];
            const currentIndex = tabIds.indexOf(currentTab);

            if (currentIndex === -1) return; // Tab hiện tại không hợp lệ

            if (diffX > 0) {
                // Swipe phải (chuyển sang tab trước đó)
                const nextIndex = (currentIndex - 1 + tabIds.length) % tabIds.length;
                switchTab(tabIds[nextIndex]);
            } else {
                // Swipe trái (chuyển sang tab tiếp theo)
                const nextIndex = (currentIndex + 1) % tabIds.length;
                switchTab(tabIds[nextIndex]);
            }
        }
        
        // =================================================================
        // HÀM CẤU HÌNH VÀ CHỦ ĐỀ (CONFIGURATION & THEME)
        // =================================================================

        /**
         * Lưu GitHub Token vào Local Storage.
         */
        function saveToken() {
            const tokenInput = document.getElementById('githubToken');
            const token = tokenInput.value.trim();
            if (token) {
                localStorage.setItem('githubToken', token);
                alert('GitHub Token saved successfully! Please Re-sync data now.');
                tokenInput.value = '********'; // Mask the token
            } else {
                alert('Please enter your GitHub Personal Access Token.');
                localStorage.removeItem('githubToken');
            }
        }
        
        /**
         * Cập nhật các URL config trong tab Configuration.
         */
        function updateConfigUrls() {
            document.getElementById('baseApiUrl').value = BASE_API_URL;
            document.getElementById('scoreApiUrl').value = SCORE_API_URL;
            document.getElementById('staticDataUrl').value = STATIC_DATA_URL;
            document.getElementById('diffDataUrl').value = DIFF_DATA_URL;
        }
        
        /**
         * Chuyển đổi chế độ Dark/Light Mode.
         */
        function toggleTheme() {
            const body = document.body;
            const isDarkMode = !body.classList.toggle('light-mode');
            
            // Cập nhật icon
            document.getElementById('sunIcon').classList.toggle('hidden', isDarkMode);
            document.getElementById('moonIcon').classList.toggle('hidden', !isDarkMode);

            localStorage.setItem('theme', isDarkMode ? 'dark' : 'light');
        }

        // =================================================================
        // HÀM KHỞI TẠO (INITIALIZATION)
        // =================================================================

        /**
         * Khởi tạo ứng dụng khi trang được tải.
         */
        function initializeApp() {
            // 1. Tải và áp dụng Theme
            const savedTheme = localStorage.getItem('theme') || 'dark';
            const body = document.body;
            if (savedTheme === 'light') {
                body.classList.add('light-mode');
                document.getElementById('sunIcon').classList.remove('hidden');
                document.getElementById('moonIcon').classList.add('hidden');
            } else {
                document.getElementById('sunIcon').classList.add('hidden');
                document.getElementById('moonIcon').classList.remove('hidden');
            }

            // 2. Chuyển đến tab cuối cùng đã xem
            const savedTab = localStorage.getItem('currentTab') || 'General';
            switchTab(savedTab);
            
            // 3. Tải và ẩn Token (nếu có)
            if (localStorage.getItem('githubToken')) {
                 document.getElementById('githubToken').value = '********';
            }

            // Event listeners
            document.getElementById('themeToggle').addEventListener('click', toggleTheme);
            document.getElementById('app').addEventListener('touchstart', (e) => {
                // Đảm bảo không kích hoạt swipe khi chạm vào input
                if (e.target.classList.contains('score-input') || e.target.classList.contains('text-input')) return;
                startX = e.changedTouches[0].screenX;
            }, { passive: true });

            document.getElementById('app').addEventListener('touchend', (e) => {
                // Đảm bảo không kích hoạt swipe khi chạm vào input
                if (e.target.classList.contains('score-input') || e.target.classList.contains('text-input')) return;
                endX = e.changedTouches[0].screenX;
                handleGesture();
            }, { passive: true });
            
            // Modal button setup
            document.getElementById('confirmYes').onclick = window.reSyncStaticData;
            document.getElementById('confirmNo').onclick = () => document.getElementById('confirmationBox').classList.add('hidden');
            
            // Commit button listeners (Do the buttons are created in HTML, only need the function definitions)

            // Start data loading
            loadDataFromGitHub();
        }

        window.onload = initializeApp;
    </script>
</body>
</html>
