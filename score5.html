<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quản Lý Giải Đấu & Cập Nhật Thông Tin (GitHub Sync) V6.0 - Auto Commit</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100;400;700;900&display=swap" rel="stylesheet">
    <style>
        /* Base styles for Dark Mode */
        :root {
            --bg-color: #111827; /* Gray-900 */
            --text-color: #f3f4f6; /* Gray-100 */
            --card-bg: #1f2937; /* Gray-800 */
            --border-color: #374151; /* Gray-700 */
            --accent-color: #06b6d4; /* Cyan-500 */
            --match-bg: #1f2937;
            --input-bg: #4b5563; /* Gray-600 */
            --group-header-text: #60a5fa; /* Blue-400 */
        }
        
        /* Light Mode Overrides */
        .light-mode {
            --bg-color: #f9fafb; /* Gray-50 */
            --text-color: #111827; /* Gray-900 */
            --card-bg: #ffffff;
            --border-color: #e5e7eb; /* Gray-200 */
            --accent-color: #ef4444; /* Red-500 */
            --match-bg: #f3f4f6; /* Gray-100 */
            --input-bg: #ffffff;
            --group-header-text: #10b981; /* Emerald-500 */
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            transition: background-color 0.3s, color 0.3s;
        }
        .container {
            max-width: 1200px;
        }
        .score-input, .text-input {
            background-color: var(--input-bg);
            border: 1px solid var(--border-color);
            color: var(--text-color);
        }
        .score-input:focus, .text-input:focus {
            box-shadow: 0 0 0 3px var(--accent-color);
        }
        .tab-button {
            border-bottom-color: var(--border-color);
        }
        .tab-button.active {
            color: var(--accent-color);
            border-color: var(--accent-color);
            background-color: var(--card-bg);
        }
        .tab-content {
            display: none;
            background-color: var(--card-bg);
            border-radius: 0.75rem; /* rounded-xl */
            padding: 1.5rem; /* p-6 */
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); /* shadow-2xl */
        }
        /* Custom scrollbar */
        ::-webkit-scrollbar { height: 8px; }
        ::-webkit-scrollbar-thumb { background: var(--border-color); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #6b7280; }
        
        /* Specific content styles for brightness/clarity */
        .match-card {
            background-color: var(--match-bg);
            border-bottom: 1px solid var(--border-color);
        }
        .light-mode .match-card {
            background-color: #ffffff;
            border-bottom: 1px solid #e5e7eb;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
        }
        /* Modal Backdrop */
        .modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 50;
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <div id="app" class="container mx-auto">
        <header class="flex items-center justify-between mb-6">
            <div class="flex items-center">
                <svg class="w-10 h-10 md:w-12 md:h-12 text-[var(--accent-color)]" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 15.75l-4-4m0 0l4-4m-4 4h14M17 12a5 5 0 11-10 0 5 5 0 0110 0z"></path></svg>
                <div class="text-left ml-4">
                    <h1 class="text-xl md:text-3xl font-extrabold text-[var(--text-color)] leading-none">QUẢN LÝ GIẢI ĐẤU PICKLEBALL (V6.0)</h1>
                    <p class="text-xs md:text-sm text-[var(--accent-color)]">Cập Nhật Tỉ Số & Thông Tin Đội (GitHub Auto Sync)</p>
                </div>
            </div>
            
            <button id="themeToggle" onclick="toggleTheme()" class="p-3 rounded-full bg-[var(--card-bg)] shadow-md text-[var(--text-color)] hover:bg-[var(--border-color)] transition duration-200">
                <svg id="sunIcon" class="w-6 h-6 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>
                <svg id="moonIcon" class="w-6 h-6 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path></svg>
            </button>
        </header>

        <div id="statusMessage" class="text-center p-4 bg-blue-900/50 rounded-lg text-blue-300 font-semibold mb-6">
            Đang tải dữ liệu trạng thái từ GitHub...
        </div>
        
        <nav class="mb-8 border-b border-[var(--border-color)] overflow-x-auto whitespace-nowrap">
            <button class="tab-button py-3 px-4 md:px-6 text-sm md:text-base font-semibold border-b-2 border-transparent text-gray-400 hover:text-[var(--accent-color)] transition" onclick="switchTab('General')" data-tab="General">General</button>
            <button class="tab-button py-3 px-4 md:px-6 text-sm md:text-base font-semibold border-b-2 border-transparent text-gray-400 hover:text-[var(--accent-color)] transition" onclick="switchTab('TeamManagement')" data-tab="TeamManagement">Quản Lý Đội</button>
            <button class="tab-button py-3 px-4 md:px-6 text-sm md:text-base font-semibold border-b-2 border-transparent text-gray-400 hover:text-[var(--accent-color)] transition" onclick="switchTab('GroupA')" data-tab="GroupA">Group A</button>
            <button class="tab-button py-3 px-4 md:px-6 text-sm md:text-base font-semibold border-b-2 border-transparent text-gray-400 hover:text-[var(--accent-color)] transition" onclick="switchTab('GroupB')" data-tab="GroupB">Group B</button>
            <button class="tab-button py-3 px-4 md:px-6 text-sm md:text-base font-semibold border-b-2 border-transparent text-gray-400 hover:text-[var(--accent-color)] transition" onclick="switchTab('GroupC')" data-tab="GroupC">Group C</button>
            <button class="tab-button py-3 px-4 md:px-6 text-sm md:text-base font-semibold border-b-2 border-transparent text-gray-400 hover:text-[var(--accent-color)] transition" onclick="switchTab('GroupD')" data-tab="GroupD">Group D</button>
            <button class="tab-button py-3 px-4 md:px-6 text-sm md:text-base font-semibold border-b-2 border-transparent text-gray-400 hover:text-[var(--accent-color)] transition" onclick="switchTab('Knockout')" data-tab="Knockout">Knockout</button>
            <button class="tab-button py-3 px-4 md:px-6 text-sm md:text-base font-semibold border-b-2 border-transparent text-gray-400 hover:text-[var(--accent-color)] transition" onclick="switchTab('Configuration')" data-tab="Configuration">Cấu Hình</button>
        </nav>

        <div id="General" class="tab-content">
            <h2 class="text-3xl font-extrabold text-yellow-500 mb-6 border-b border-[var(--border-color)] pb-2">Final Results (Kết quả chung cuộc)</h2>
            
            <section id="finalResults" class="mb-10 p-4 rounded-xl shadow-lg bg-[var(--match-bg)]">
                <div class="text-center">
                    <p class="text-4xl font-black text-gray-500 mb-2">Chưa xác định</p>
                    <p class="text-lg text-gray-500">Nhà Vô Địch Giải Đấu Pickleball ITVTG Tournament 2025</p>
                </div>
            </section>
            
            <h2 class="text-3xl font-extrabold text-cyan-500 mb-6 border-b border-[var(--border-color)] pb-2">Giải ba đồng hạng (2 Đội thua Bán kết)</h2>
            <section id="thirdPlaceResults" class="mb-10 p-4 rounded-xl shadow-lg bg-[var(--match-bg)] grid grid-cols-1 md:grid-cols-2 gap-4">
                 <div class="text-center md:col-span-2 p-4 text-gray-500">
                    <p class="text-xl font-bold">Chưa xác định đội đoạt giải Ba đồng hạng (Cần hoàn thành 2 trận Bán kết)</p>
                </div>
            </section>

            <h2 class="text-3xl font-extrabold text-[var(--text-color)] mb-6 border-b border-[var(--border-color)] pb-2">Team List (Danh sách các đội)</h2>
            <section id="teamList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                </section>
        </div>
        
        <div id="TeamManagement" class="tab-content">
            <h2 class="text-3xl font-extrabold text-blue-500 mb-6 border-b border-[var(--border-color)] pb-2">Quản Lý Thông Tin Đội (Auto-Sync to **`state41s.json`**)</h2>
            <p class="text-sm text-gray-400 mb-4">Điều chỉnh **Tên đội (Tn)**, **Tên người chơi (name)**, **Cấp độ (pL)**, và **Năm sinh (bY)**. Thay đổi sẽ **tự động** được lưu vào `state41s.json` ngay sau khi nhập.</p>
            
            <button id="commitTeamToBaseButton" onclick="commitTeamChangesToGitHub()" class="w-full md:w-auto px-6 py-2 bg-red-600 hover:bg-red-700 text-white font-bold rounded-lg shadow-lg transition duration-300 mb-6 disabled:opacity-50">
                LƯU THÔNG TIN ĐỘI VÀO GỐC (`state41.json`) - THAO TÁC NGUY HIỂM!
            </button>
            
            <div id="teamCommitResult" class="mt-3 p-3 rounded-lg text-sm font-semibold hidden"></div>

            <section id="teamManagementList" class="space-y-6"></section>
        </div>


        <div id="GroupA" class="tab-content space-y-6">
            <button onclick="simulateScores('A')" class="w-full md:w-auto px-6 py-2 bg-yellow-600 hover:bg-yellow-700 text-white font-bold rounded-lg shadow-lg transition duration-300">
                GIẢ LẬP TỈ SỐ VÒNG BẢNG A
            </button>
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div id="tableA" class="lg:col-span-1"></div>
                <div id="matchesA" class="lg:col-span-2"></div>
            </div>
        </div>

        <div id="GroupB" class="tab-content space-y-6">
            <button onclick="simulateScores('B')" class="w-full md:w-auto px-6 py-2 bg-yellow-600 hover:bg-yellow-700 text-white font-bold rounded-lg shadow-lg transition duration-300">
                GIẢ LẬP TỈ SỐ VÒNG BẢNG B
            </button>
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div id="tableB" class="lg:col-span-1"></div>
                <div id="matchesB" class="lg:col-span-2"></div>
            </div>
        </div>

        <div id="GroupC" class="tab-content space-y-6">
             <button onclick="simulateScores('C')" class="w-full md:w-auto px-6 py-2 bg-yellow-600 hover:bg-yellow-700 text-white font-bold rounded-lg shadow-lg transition duration-300">
                GIẢ LẬP TỈ SỐ VÒNG BẢNG C
            </button>
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div id="tableC" class="lg:col-span-1"></div>
                <div id="matchesC" class="lg:col-span-2"></div>
            </div>
        </div>

        <div id="GroupD" class="tab-content space-y-6">
             <button onclick="simulateScores('D')" class="w-full md:w-auto px-6 py-2 bg-yellow-600 hover:bg-yellow-700 text-white font-bold rounded-lg shadow-lg transition duration-300">
                GIẢ LẬP TỈ SỐ VÒNG BẢNG D
            </button>
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div id="tableD" class="lg:col-span-1"></div>
                <div id="matchesD" class="lg:col-span-2"></div>
            </div>
        </div>

        <div id="Knockout" class="tab-content">
            <h2 class="text-3xl font-extrabold text-[var(--group-header-text)] mb-6 border-b border-[var(--border-color)] pb-2">Vòng Loại Trực Tiếp (Knockout Stage)</h2>
            <button onclick="simulateScores('Knockout')" class="w-full md:w-auto px-6 py-2 bg-red-600 hover:bg-red-700 text-white font-bold rounded-lg shadow-lg transition duration-300 mb-6">
                GIẢ LẬP TỈ SỐ VÒNG LOẠI (QF, SF, F)
            </button>
            <div id="quarterfinals" class="mb-6"></div>
            <div id="semifinals" class="mb-6"></div>
            <div id="finalMatchSection">
                <div id="finalSection"></div>
            </div>
        </div>

        <div id="Configuration" class="tab-content space-y-8">
            <h2 class="text-3xl font-extrabold text-red-500 mb-6 border-b border-[var(--border-color)] pb-2">Cấu Hình & Đồng Bộ Hóa (GitHub API)</h2>
            
             <section class="p-4 bg-red-900/20 rounded-lg border-l-4 border-red-500">
                <h3 class="text-xl font-bold text-red-400 mb-3 flex items-center">
                    <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-2a2 2 0 00-2-2H6a2 2 0 00-2 2v2a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path></svg>
                    1. GitHub Personal Access Token (PAT)
                </h3>
                <p class="text-sm text-red-300 mb-4 font-bold">CẢNH BÁO BẢO MẬT: Token này sẽ được lưu trữ trong trình duyệt. Chỉ sử dụng Token có phạm vi (Scope) nhỏ nhất. <span class="text-yellow-300">CẦN PHẢI CÓ QUYỀN **repo** (hoặc contents:write)</span>.</p>
                <input type="password" id="githubToken" 
                    class="score-input w-full p-2 rounded-md focus:ring-red-500 transition" 
                    placeholder="Dán GitHub PAT của bạn vào đây...">
                <button onclick="saveToken()" class="mt-2 px-4 py-1 bg-green-600 hover:bg-green-700 text-white text-sm font-bold rounded-lg transition duration-300">Lưu Token cục bộ</button>
            </section>

            <section class="p-4 bg-[var(--match-bg)] rounded-lg border-l-4 border-purple-500">
                <h3 class="text-xl font-bold text-[var(--group-header-text)] mb-3 flex items-center">
                    <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4"></path></svg>
                    2. Đồng Bộ Lại Trạng Thái Hoạt Động (**state41s.json**)
                </h3>
                <p class="text-gray-400 mb-4">Sử dụng Token đã lưu để **đẩy (commit) toàn bộ** trạng thái hiện tại (bao gồm cả tỉ số và xếp hạng đã tính) lên file `state41s.json`.</p>
                
                <button id="commitScoreButton" onclick="manualCommitActiveState()" class="w-full md:w-auto px-6 py-2 bg-purple-600 hover:bg-purple-700 text-white font-bold rounded-lg shadow-lg transition duration-300 mb-4 disabled:opacity-50">
                    ĐỒNG BỘ THỦ CÔNG LÊN STATE41S.JSON
                </button>

                <div id="scoreCommitResult" class="mt-3 p-3 rounded-lg text-sm font-semibold hidden"></div>
            </section>
            
             <section class="p-4 bg-[var(--match-bg)] rounded-lg border-l-4 border-green-500">
                 <h3 class="text-xl font-bold text-[var(--group-header-text)] mb-3 flex items-center">
                    <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                    3. Xuất Dữ Liệu Giải Đấu (state41.json Format)
                </h3>
                <p class="text-[var(--text-color)] mb-4">Tạo và tải về file JSON chứa toàn bộ trạng thái giải đấu hiện tại, bao gồm thông tin đội và tỉ số đã tính toán.</p>
                <button onclick="exportTournamentData()" class="md:w-auto px-6 py-2 bg-green-600 hover:bg-green-700 text-white font-bold rounded-lg shadow-lg transition duration-300">
                    TẢI XUỐNG TOÀN BỘ JSON
                </button>
                <div id="configExportResult" class="mt-3 p-3 rounded-lg text-sm font-semibold hidden"></div>
            </section>
            
            <section class="p-4 bg-[var(--match-bg)] rounded-lg border-l-4 border-red-500">
                <h3 class="text-xl font-bold text-red-400 mb-3 flex items-center">
                    <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                    4. Xóa (Reset) Tỉ Số Trận Đấu
                </h3>
                <p class="text-gray-400 mb-4">Chọn vòng đấu và nhấn nút để **XÓA TẤT CẢ** tỉ số đã nhập trong vòng đó về trạng thái trống (null).</p>
                
                <div class="flex flex-col md:flex-row space-y-3 md:space-y-0 md:space-x-4">
                    <select id="resetRoundSelector" class="text-input w-full md:w-1/2 p-2 rounded-md">
                        <option value="">-- Chọn Vòng Đấu --</option>
                        <option value="A">Vòng Bảng A</option>
                        <option value="B">Vòng Bảng B</option>
                        <option value="C">Vòng Bảng C</option>
                        <option value="D">Vòng Bảng D</option>
                        <option value="QF">Tứ Kết (QF)</option>
                        <option value="SF">Bán Kết (SF)</option>
                        <option value="F">Chung Kết (F)</option>
                    </select>
                    
                    <button onclick="confirmResetScores()" class="w-full md:w-auto px-6 py-2 bg-red-600 hover:bg-red-700 text-white font-bold rounded-lg shadow-lg transition duration-300 disabled:opacity-50">
                        XÓA TỈ SỐ ĐÃ CHỌN
                    </button>
                </div>
                <div id="resetResult" class="mt-3 p-3 rounded-lg text-sm font-semibold hidden"></div>
            </section>
            
            <section class="p-4 bg-[var(--match-bg)] rounded-lg border-l-4 border-yellow-500">
                 <h3 class="text-xl font-bold text-[var(--group-header-text)] mb-3 flex items-center">
                    <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>
                    5. Tùy Chọn Giao Diện & Đồng Bộ Lại
                </h3>
                <p class="text-[var(--text-color)] mb-4">Bạn có thể chuyển đổi giữa giao diện Sáng/Tối hoặc tải lại trạng thái online mới nhất.</p>
                <button onclick="document.getElementById('themeToggle').click()" class="md:w-auto px-6 py-2 bg-yellow-500 hover:bg-yellow-600 text-black font-bold rounded-lg shadow-lg transition duration-300 mr-4">
                    Chuyển Đổi Giao Diện (Hiện tại: <span id="currentThemeDisplay">Tối</span>)
                </button>
                <button id="reSyncButton" onclick="showConfirmationModal()" class="md:w-auto px-6 py-2 bg-red-600 hover:bg-red-700 text-white font-bold rounded-lg shadow-lg transition duration-300">
                    TẢI LẠI TỪ GITHUB
                </button>
            </section>

        </div>

    </div>
    
    <div id="confirmationBox" class="modal-backdrop hidden">
        <div class="bg-[var(--card-bg)] p-6 rounded-xl shadow-2xl w-11/12 max-w-sm border-t-4 border-red-500 text-[var(--text-color)]">
            <h4 class="text-xl font-bold text-red-400 mb-4">Xác Nhận Tải Lại Trạng Thái</h4>
            <p class="text-[var(--text-color)] mb-6">Bạn có chắc chắn muốn **TẢI LẠI TRẠNG THÁI** (bao gồm tỉ số, xếp hạng, tên đội) từ GitHub không? Điều này sẽ ghi đè trạng thái đang nhập cục bộ!</p>
            <div class="flex justify-end space-x-4">
                <button id="confirmNo" class="px-4 py-2 bg-gray-600 hover:bg-gray-500 text-white rounded-lg transition duration-150">Hủy bỏ</button>
                <button id="confirmYes" class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white font-bold rounded-lg transition duration-150">Xác nhận Tải lại</button>
            </div>
        </div>
    </div>

    <script>
        
        // ==============================================================================================================
        // GITHUB API CONFIGURATION & CORE DATA (V6.0 - Auto Commit)
        // ==============================================================================================================
        const GITHUB_REPO_OWNER = 'cqtin2024';
        const GITHUB_REPO_NAME = 'ITVTG';
        
        // Cấu hình cho file Trạng Thái Hoạt Động (Active State) - state41s.json
        const ACTIVE_FILE_PATH = 'data/state41s.json'; 
        const ACTIVE_API_URL = `https://api.github.com/repos/${GITHUB_REPO_OWNER}/${GITHUB_REPO_NAME}/contents/${ACTIVE_FILE_PATH}`;
        const ACTIVE_DATA_URL = `https://raw.githubusercontent.com/${GITHUB_REPO_OWNER}/${GITHUB_REPO_NAME}/main/${ACTIVE_FILE_PATH}`;

        // Cấu hình cho file Dữ liệu Gốc (Template/Backup) - state41.json
        const BASE_FILE_PATH = 'data/state41.json'; 
        const BASE_API_URL = `https://api.github.com/repos/${GITHUB_REPO_OWNER}/${GITHUB_REPO_NAME}/contents/${BASE_FILE_PATH}`;
        const BASE_DATA_URL = `https://raw.githubusercontent.com/${GITHUB_REPO_OWNER}/${GITHUB_REPO_NAME}/main/${BASE_FILE_PATH}`;

        const BRANCH = 'main';

        let tournamentData = null; // Dữ liệu trạng thái hiện tại (bao gồm cả tính toán)
        let initialBaseData = null; // Dữ liệu từ state41.json gốc (Template)
        let githubToken = ''; 
        let startX = 0; 
        let endX = 0;  
        const swipeThreshold = 75; 
        
        // Hàm chuyển đổi JSON sang Base64
        const jsonToBase64 = (json) => btoa(unescape(encodeURIComponent(JSON.stringify(json, null, 2))));
        
        // --- CHỨC NĂNG TƯƠNG TÁC GITHUB CHUNG ---

        function saveToken() {
            const tokenInput = document.getElementById('githubToken').value.trim();
            if (tokenInput.length > 0 && tokenInput !== '********') {
                githubToken = tokenInput;
                localStorage.setItem('githubToken', githubToken);
                showStatus('Token đã được lưu cục bộ. Auto-Commit đã kích hoạt.', 'success', 'scoreCommitResult');
                showStatus('Token đã được lưu cục bộ. Auto-Commit đã kích hoạt.', 'success', 'teamCommitResult');
                document.getElementById('githubToken').value = '********';
            } else if (tokenInput.length === 0) {
                 githubToken = '';
                 localStorage.removeItem('githubToken');
                 showStatus('Token đã bị xóa khỏi bộ nhớ cục bộ. KHÔNG THỂ COMMIT!', 'error', 'scoreCommitResult');
                 showStatus('Token đã bị xóa khỏi bộ nhớ cục bộ. KHÔNG THỂ COMMIT!', 'error', 'teamCommitResult');
                 document.getElementById('githubToken').value = '';
            } else {
                 showStatus('Vui lòng nhập Token mới hoặc Token đã được lưu.', 'info', 'scoreCommitResult');
                 showStatus('Vui lòng nhập Token mới hoặc Token đã được lưu.', 'info', 'teamCommitResult');
            }
        }
        
        function showStatus(message, type = 'info', elementId = 'statusMessage') {
            const statusElement = document.getElementById(elementId);
            if (!statusElement) return;

            statusElement.innerHTML = message;
            statusElement.classList.remove('hidden', 'bg-red-900/50', 'bg-green-900/50', 'bg-blue-900/50', 'bg-orange-900/50');
            
            if (type === 'success') {
                statusElement.classList.add('bg-green-900/50');
            } else if (type === 'error') {
                statusElement.classList.add('bg-red-900/50');
            } else if (type === 'warning') {
                 statusElement.classList.add('bg-orange-900/50');
            } else {
                 statusElement.classList.add('bg-blue-900/50');
            }
            statusElement.style.display = 'block';

            // Ẩn tự động sau 5s (trừ statusMessage và error)
            if (elementId !== 'statusMessage' && type !== 'error') {
                 setTimeout(() => statusElement.style.display = 'none', 5000);
            }
             // Hiển thị resetResult lâu hơn
            if (elementId === 'resetResult') {
                setTimeout(() => statusElement.style.display = 'none', 10000);
            }
        }
        
        async function getShaAndCommit(fileUrl, contentBase64, commitMessage, buttonId, resultElementId) {
            const pat = githubToken.trim();
            const commitButton = document.getElementById(buttonId);
            
            // Chỉ vô hiệu hóa và hiển thị trạng thái cho các nút COMMIT THỦ CÔNG
            const isManualCommit = (buttonId === 'commitScoreButton' || buttonId === 'commitTeamToBaseButton');

            if(isManualCommit) {
                commitButton.disabled = true;
                commitButton.textContent = 'Đang tiến hành...';
            } else {
                 showStatus('Đang tự động đồng bộ (Auto-Commit) lên GitHub...', 'info', 'statusMessage');
            }
            
            let sha = null;
            
            try {
                if(isManualCommit) showStatus('Đang lấy SHA hiện tại của file...', 'info', resultElementId);

                const shaResponse = await fetch(fileUrl + `?ref=${BRANCH}`, {
                    headers: { 'Authorization': `Bearer ${pat}` } 
                });

                if (shaResponse.status === 404) {
                    if(isManualCommit) showStatus('File chưa tồn tại trên nhánh, sẽ tạo mới.', 'info', resultElementId);
                    else console.log(`[Auto-Commit] File ${fileUrl} chưa tồn tại, sẽ tạo mới.`);
                } else if (shaResponse.status === 401) {
                    const errorJson = await shaResponse.json();
                    throw new Error(`401 Unauthorized: ${errorJson.message || 'Token không hợp lệ hoặc thiếu quyền "repo".'}`);
                } else if (!shaResponse.ok) {
                    const errorJson = await shaResponse.json();
                    throw new Error(`Lỗi API khi lấy SHA: ${shaResponse.status} - ${errorJson.message || shaResponse.statusText}`);
                } else {
                    const data = await shaResponse.json();
                    sha = data.sha;
                    if(isManualCommit) showStatus(`Đã lấy SHA file thành công. SHA: ${sha.substring(0, 10)}...`, 'info', resultElementId);
                }
                
                if(isManualCommit) commitButton.textContent = 'Đang Commit (PUT)...';
                
                const payload = {
                    message: commitMessage,
                    content: contentBase64,
                    branch: BRANCH
                };
                if (sha) {
                    payload.sha = sha; 
                }

                const commitResponse = await fetch(fileUrl, {
                    method: 'PUT',
                    headers: { 
                        'Authorization': `Bearer ${pat}`, 
                        'Content-Type': 'application/json',
                        'Accept': 'application/vnd.github.v3+json'
                    },
                    body: JSON.stringify(payload)
                });

                if (commitResponse.status === 401) {
                    const errorJson = await commitResponse.json();
                    throw new Error(`401 Unauthorized: ${errorJson.message || 'Token không hợp lệ hoặc thiếu quyền "repo". Vui lòng kiểm tra lại Token của bạn.'}`);
                } else if (!commitResponse.ok) {
                    const errorData = await commitResponse.json();
                    throw new Error(`Commit thất bại: Status ${commitResponse.status}. ${errorData.message || 'Lỗi không xác định.'}`);
                }

                const result = await commitResponse.json();
                
                // Cập nhật lại SHA mới cho lần commit tiếp theo (quan trọng cho auto-commit)
                if (tournamentData && tournamentData.metadata) {
                    tournamentData.metadata.sha = result.content.sha;
                }
                
                const successMessage = `COMMIT THÀNH CÔNG! Dữ liệu đã được cập nhật trên GitHub. Commit SHA: <a href="${result.commit.html_url}" target="_blank" class="text-white underline">${result.commit.sha.substring(0, 7)}</a>`;
                
                if(isManualCommit) showStatus(successMessage, 'success', resultElementId);
                else showStatus(`[Auto-Commit] Đồng bộ thành công: ${result.commit.sha.substring(0, 7)}`, 'success', 'statusMessage');
                
            } catch (error) {
                console.error("Lỗi Commit GitHub:", error);
                
                const errorMessage = `LỖI COMMIT: ${error.message}. Vui lòng kiểm tra Token và quyền truy cập.`;
                if(isManualCommit) showStatus(errorMessage, 'error', resultElementId);
                else showStatus(`[Auto-Commit FAILED] ${errorMessage}`, 'error', 'statusMessage');
            } finally {
                if(isManualCommit) {
                    if(buttonId === 'commitScoreButton') commitButton.textContent = 'ĐỒNG BỘ THỦ CÔNG LÊN STATE41S.JSON';
                    if(buttonId === 'commitTeamToBaseButton') commitButton.textContent = 'LƯU THÔNG TIN ĐỘI VÀO GỐC (`state41.json`) - THAO TÁC NGUY HIỂM!';
                    commitButton.disabled = false;
                }
            }
        }
        
        /**
         * Hợp nhất các mảng vòng đấu riêng thành mảng 'matches' chung (ĐƯỢC GỌI TRƯỚC KHI COMMIT)
         * @param {object} data - Dữ liệu giải đấu với các trường vòng đấu riêng biệt
         * @returns {object} Dữ liệu với mảng 'matches' đã hợp nhất
         */
        function unifyMatches(data) {
            const unifiedData = JSON.parse(JSON.stringify(data));
            unifiedData.matches = [];
            
            const rounds = ['matchesA', 'matchesB', 'matchesC', 'matchesD', 'quarterfinals', 'semifinals'];
            
            rounds.forEach(roundKey => {
                if (unifiedData[roundKey]) {
                    unifiedData.matches.push(...unifiedData[roundKey]);
                    delete unifiedData[roundKey];
                }
            });

            if (unifiedData.final) {
                unifiedData.matches.push(unifiedData.final);
                delete unifiedData.final;
            }
            
            return unifiedData;
        }
        
        /**
         * Chuẩn hóa dữ liệu trước khi COMMIT để giữ file JSON gọn gàng.
         * Loại bỏ các trường tính toán tạm thời (W, L, gR, mP, Pts) KHÔNG cần lưu trữ.
         * @param {object} data - Dữ liệu giải đấu hiện tại (đã tính toán)
         * @returns {object} Dữ liệu sạch sẵn sàng để commit
         */
        function unifyAndCleanData(data) {
            const cleanData = unifyMatches(data);
            
            // Loại bỏ các trường tính toán (temporary computed fields) trong tL
            if (cleanData.tL) {
                cleanData.tL = cleanData.tL.map(team => {
                    const cleanTeam = { ...team };
                    delete cleanTeam.W;
                    delete cleanTeam.L;
                    delete cleanTeam.gR;
                    delete cleanTeam.mP;
                    delete cleanTeam.GS;
                    delete cleanTeam.GC;
                    delete cleanTeam.Pts;
                    return cleanTeam;
                });
            }
            
            return cleanData;
        }

        // --- LOGIC TẢI VÀ XỬ LÝ DỮ LIỆU ---

        /**
         * Tách mảng 'matches' chung của state41.json thành các mảng vòng đấu riêng (matchesA, quarterfinals, final, v.v.)
         * @param {object} data - Dữ liệu giải đấu có trường 'matches'
         * @returns {object} Dữ liệu với các trường vòng đấu riêng biệt
         */
        function splitMatches(data) {
            const rounds = {
                matchesA: [], matchesB: [], matchesC: [], matchesD: [], 
                quarterfinals: [], semifinals: [], final: null
            };
            
            if (data.matches) {
                data.matches.forEach(match => {
                    if (match.Mc.startsWith('GA')) rounds.matchesA.push(match);
                    else if (match.Mc.startsWith('GB')) rounds.matchesB.push(match);
                    else if (match.Mc.startsWith('GC')) rounds.matchesC.push(match);
                    else if (match.Mc.startsWith('GD')) rounds.matchesD.push(match);
                    else if (match.Mc.startsWith('QF')) rounds.quarterfinals.push(match);
                    else if (match.Mc.startsWith('SF')) rounds.semifinals.push(match);
                    else if (match.Mc === 'F') rounds.final = match;
                });
            }

            // Xóa trường 'matches' cũ và thêm các trường mới
            const newData = { ...data };
            delete newData.matches;
            return { ...newData, ...rounds };
        }
        
        /**
         * Hàm chính để tải dữ liệu gốc (state41.json) và trạng thái hoạt động (state41s.json) từ GitHub.
         */
        window.loadDataFromGitHub = async function() {
            showStatus('Đang tải dữ liệu gốc và trạng thái hoạt động từ GitHub...', 'info', 'statusMessage');
            try {
                // 1. Tải BASE file (Template)
                const baseResponse = await fetch(BASE_DATA_URL);
                if (!baseResponse.ok) {
                    throw new Error(`Không thể tải dữ liệu gốc (state41.json). Status: ${baseResponse.status}`);
                }
                const baseData = await baseResponse.json();
                initialBaseData = JSON.parse(JSON.stringify(baseData)); 
                
                // 2. Tải ACTIVE file (state41s.json)
                const activeResponse = await fetch(ACTIVE_DATA_URL);
                let activeData = null;
                
                if (activeResponse.ok) {
                    activeData = await activeResponse.json();
                    showStatus('Đã tải trạng thái hoạt động (state41s.json) thành công.', 'info', 'statusMessage');
                } else if (activeResponse.status === 404) {
                    showStatus('Không tìm thấy state41s.json. Sử dụng state41.json làm mẫu và tự động đồng bộ lần đầu.', 'warning', 'statusMessage');
                } else {
                     console.error(`Lỗi khi tải state41s.json: ${activeResponse.status}`);
                     showStatus(`Lỗi ${activeResponse.status} khi tải state41s.json. Sử dụng state41.json làm mẫu.`, 'warning', 'statusMessage');
                }

                let mergedData = activeData || baseData;
                
                // Tách mảng matches thành các mảng vòng đấu riêng biệt (A, B, C, D, QF, SF, F)
                mergedData = splitMatches(mergedData);
                
                // 3. Lấy SHA của file ACTIVE để sử dụng cho lần commit tiếp theo (Chỉ cần lấy SHA của active file)
                const shaResponse = await fetch(ACTIVE_API_URL + `?ref=${BRANCH}`);
                let sha = null;
                if (shaResponse.ok) {
                    const data = await shaResponse.json();
                    sha = data.sha;
                }
                
                // Lưu SHA vào metadata để sử dụng trong commit tiếp theo
                mergedData.metadata = { sha: sha }; 

                // 4. Xử lý và Render dữ liệu
                processDataAndRender(mergedData);
                
                // 5. Commit lần đầu nếu chưa có active file (404)
                if (activeResponse.status === 404) {
                     await autoCommitActiveState('Initial sync from state41.json to state41s.json (V6.0)', true); // Commit lần đầu
                }
                
                showStatus('Đã tải và xử lý dữ liệu thành công! (V6.0)', 'success', 'statusMessage');
                switchTab('General'); 

            } catch (error) {
                console.error("Lỗi tải dữ liệu GitHub:", error);
                showStatus(`LỖI NGHIÊM TRỌNG: Không thể tải dữ liệu giải đấu. ${error.message}`, 'error', 'statusMessage');
            }
        }
        
        /**
         * Tự động COMMIT toàn bộ trạng thái hiện tại lên state41s.json
         * @param {string} commitMessage - Thông điệp commit
         * @param {boolean} isInitialCommit - Commit lần đầu (không cần token check)
         */
        window.autoCommitActiveState = async function(commitMessage, isInitialCommit = false) {
            if (!isInitialCommit) {
                githubToken = localStorage.getItem('githubToken') || ''; 
                if (!githubToken || githubToken.trim().length === 0) {
                    showStatus('CẢNH BÁO: Auto-Commit bị bỏ qua. Vui lòng nhập và lưu GitHub Token.', 'warning', 'statusMessage');
                    return;
                }
            }

            // Bỏ qua nếu dữ liệu không tồn tại
            if (!tournamentData) return; 

            // Chuẩn bị dữ liệu (unify và loại bỏ các trường tính toán)
            const commitData = unifyAndCleanData(tournamentData);
            
            // Thêm SHA vào payload
            const currentSha = tournamentData.metadata?.sha;
            if (currentSha) {
                commitData.metadata = { sha: currentSha }; 
            } else {
                 // Xóa metadata nếu không có SHA để tránh lỗi commit
                 delete commitData.metadata;
            }

            const base64Content = jsonToBase64(commitData);
            
            // Sử dụng một ID ảo cho nút COMMIT để hàm getShaAndCommit không vô hiệu hóa nút thật
            await getShaAndCommit(ACTIVE_API_URL, base64Content, commitMessage, 'autoCommitPlaceholder', 'statusMessage');
        }


        /**
         * Xử lý dữ liệu sau khi tải: Tính toán, Cập nhật vòng loại và Render UI
         * @param {object} data - Dữ liệu giải đấu đã hợp nhất tỉ số
         */
        function processDataAndRender(data) {
            tournamentData = data;
            
            // 1. Tính toán Bảng xếp hạng Vòng bảng
            data.tL = data.tL.map(team => calculateTeamStats(team, data));
            
            // 2. Sắp xếp và cập nhật gR
            ['A', 'B', 'C', 'D'].forEach(group => {
                const groupTeams = data.tL.filter(t => t.g === group);
                const sorted = calculateStandings(groupTeams);
                sorted.forEach((team, index) => {
                    const originalTeam = data.tL.find(t => t.T === team.T);
                    // Cập nhật các trường tính toán (rank, stats) trên team gốc
                    Object.assign(originalTeam, team); 
                    originalTeam.gR = index + 1; // 1st, 2nd, 3rd, 4th
                });
            });

            // 3. Cập nhật vòng Loại Trực Tiếp (QF, SF, F)
            updateKnockoutBrackets(data);

            // 4. Render UI
            renderGeneralTab(data);
            renderTeamManagementTab(data);
            ['A', 'B', 'C', 'D'].forEach(g => renderGroupTab(g, data));
            renderKnockoutTab(data);
            initializeMatchListeners(); // Thiết lập lại listeners sau khi render
        }

        // --- CORE CALCULATION LOGIC ---
        
        /**
         * Tính toán Stats (W, L, Pts, GS, GC) cho một đội dựa trên kết quả vòng bảng.
         * @param {object} team - Đối tượng đội
         * @param {object} data - Toàn bộ dữ liệu giải đấu
         * @returns {object} Đối tượng đội đã cập nhật stats
         */
        function calculateTeamStats(team, data) {
            // Khởi tạo các trường tính toán
            team.W = 0; team.L = 0; team.GS = 0; team.GC = 0; team.mP = 0; team.Pts = 0; 
            
            const groupMatches = data[`matches${team.g}`] || [];
            
            groupMatches.forEach(match => {
                if (match.sA === null || match.sB === null) return; // Bỏ qua trận chưa có tỉ số
                
                const isTeamA = match.teamA === team.T;
                const isTeamB = match.teamB === team.T;
                
                if (isTeamA || isTeamB) {
                    team.mP++;
                    
                    const sA = parseInt(match.sA);
                    const sB = parseInt(match.sB);
                    
                    if (isTeamA) {
                        team.GS += sA;
                        team.GC += sB;
                        if (sA > sB) {
                            team.W++;
                            team.Pts += 3; // 3 điểm cho trận thắng
                        } else if (sB > sA) {
                            team.L++;
                            team.Pts += 0; // 0 điểm cho trận thua
                        }
                    } else if (isTeamB) {
                        team.GS += sB;
                        team.GC += sA;
                        if (sB > sA) {
                            team.W++;
                            team.Pts += 3;
                        } else if (sA > sB) {
                            team.L++;
                            team.Pts += 0;
                        }
                    }
                }
            });
            
            return team;
        }

        /**
         * Tính toán Bảng xếp hạng Vòng bảng (sắp xếp).
         * @param {Array<object>} teams - Danh sách đội trong cùng một bảng
         * @returns {Array<object>} Danh sách đội đã sắp xếp
         */
        function calculateStandings(teams) {
            // Thứ tự ưu tiên: 1. Điểm (Pts) > 2. Hiệu số điểm (GS - GC) > 3. Điểm thắng (GS) > 4. Tên đội (Tn)
            return teams.sort((a, b) => {
                if (b.Pts !== a.Pts) return b.Pts - a.Pts;
                
                const diffA = a.GS - a.GC;
                const diffB = b.GS - b.GC;
                if (diffB !== diffA) return diffB - diffA;
                
                if (b.GS !== a.GS) return b.GS - a.GS;

                return a.Tn.localeCompare(b.Tn); 
            });
        }
        
        /**
         * Cập nhật các cặp đấu Vòng loại trực tiếp (QF, SF, F) dựa trên kết quả vòng bảng.
         * @param {object} data - Dữ liệu giải đấu đã được tính toán group rank (gR)
         */
        function updateKnockoutBrackets(data) {
            const teamsByGroup = (group) => {
                const teams = data.tL.filter(t => t.g === group);
                return teams.sort((a, b) => a.gR - b.gR);
            };

            const A = teamsByGroup('A');
            const B = teamsByGroup('B');
            const C = teamsByGroup('C');
            const D = teamsByGroup('D');

            const getWinner = (match) => match.winner || null;
            
            // Cập nhật Winner/Loser cho các trận đã có tỉ số (trong vòng QF, SF, F)
            const updateMatchWinner = (match) => {
                if (!match || match.sA === null || match.sB === null) {
                    delete match.winner; // Xóa winner nếu chưa có tỉ số
                    return;
                }

                const sA = parseInt(match.sA);
                const sB = parseInt(match.sB);

                if (sA > sB) {
                    match.winner = match.teamA;
                } else if (sB > sA) {
                    match.winner = match.teamB;
                } else {
                    delete match.winner; 
                }
            }
            
            // 1. Cập nhật kết quả các trận đấu đã có tỉ số trước
            data.quarterfinals.forEach(updateMatchWinner);
            data.semifinals.forEach(updateMatchWinner);
            if (data.final) updateMatchWinner(data.final);


            // 2. QF (Tứ kết)
            const qfMatches = data.quarterfinals;
            if (qfMatches.length >= 4) { // Chỉ xử lý 4 trận QF cơ bản
                // QF1: 1A vs 2B
                qfMatches[0].teamA = A[0]?.T || null; qfMatches[0].teamB = B[1]?.T || null;
                // QF2: 1B vs 2A
                qfMatches[1].teamA = B[0]?.T || null; qfMatches[1].teamB = A[1]?.T || null;
                // QF3: 1C vs 2D
                qfMatches[2].teamA = C[0]?.T || null; qfMatches[2].teamB = D[1]?.T || null;
                // QF4: 1D vs 2C
                qfMatches[3].teamA = D[0]?.T || null; qfMatches[3].teamB = C[1]?.T || null;
            }

            // 3. SF (Bán kết)
            const sfMatches = data.semifinals;
            if (sfMatches.length >= 2) {
                // SF1: Winner QF1 vs Winner QF3
                sfMatches[0].teamA = getWinner(qfMatches[0]);
                sfMatches[0].teamB = getWinner(qfMatches[2]);
                
                // SF2: Winner QF2 vs Winner QF4
                sfMatches[1].teamA = getWinner(qfMatches[1]);
                sfMatches[1].teamB = getWinner(qfMatches[3]);
            }
             sfMatches.forEach(updateMatchWinner);


            // 4. Final (Chung kết)
            const finalMatch = data.final;
            if (finalMatch) {
                // F: Winner SF1 vs Winner SF2
                finalMatch.teamA = getWinner(sfMatches[0]);
                finalMatch.teamB = getWinner(sfMatches[1]);
            }
            if(finalMatch) updateMatchWinner(finalMatch);
        }

        // --- LOGIC XẾP HẠNG CHUNG CUỘC (V6.0) ---

        /**
         * Lấy tên đội (Tn) từ Team ID (T)
         * @param {string} teamId - Mã đội
         * @returns {string} Tên đội rút gọn (Tn)
         */
        function getTeamName(teamId) {
            if (!tournamentData || !tournamentData.tL) return teamId;
            const team = tournamentData.tL.find(t => t.T === teamId);
            return team ? team.Tn : teamId;
        }
        
        /**
         * Xác định Vô địch, Á quân và Giải ba đồng hạng dựa trên kết quả Knockout.
         * @param {object} data - Dữ liệu giải đấu (tournamentData)
         * @returns {object} {champion, runnerUp, thirdPlace: []}
         */
        function determineFinalRanks(data) {
            const ranks = {
                champion: null,
                runnerUp: null,
                thirdPlace: [] // Thua Bán kết
            };
            
            // 1. Check for Final (F) match
            const finalMatch = data.final;
            if (finalMatch && finalMatch.winner) {
                ranks.champion = finalMatch.winner;
                
                // Á quân (Runner-up): Đội còn lại trong trận chung kết
                const loserF = (finalMatch.teamA !== finalMatch.winner) ? finalMatch.teamA : finalMatch.teamB;
                if (loserF) {
                    ranks.runnerUp = loserF;
                }
            }
            
            // 2. Check for Semifinals (SF) matches (for Joint 3rd place)
            const semifinals = data.semifinals;
            if (semifinals && semifinals.length === 2) {
                semifinals.forEach(match => {
                    // Nếu trận đấu có tỉ số VÀ có người thắng (nghĩa là có người thua)
                    if (match.sA !== null && match.sB !== null && match.winner && match.teamA && match.teamB) {
                         // Giải ba đồng hạng: Đội thua trong trận bán kết
                        const loserSF = (match.teamA !== match.winner) ? match.teamA : match.teamB;
                        if (loserSF && !ranks.thirdPlace.includes(loserSF)) {
                            ranks.thirdPlace.push(loserSF);
                        }
                    }
                });
            }

            // Giải quyết ID thành Tên (Tn) cho mục đích hiển thị
            ranks.champion = ranks.champion ? { id: ranks.champion, name: getTeamName(ranks.champion) } : null;
            ranks.runnerUp = ranks.runnerUp ? { id: ranks.runnerUp, name: getTeamName(ranks.runnerUp) } : null;
            ranks.thirdPlace = ranks.thirdPlace.map(id => ({ id: id, name: getTeamName(id) }));

            return ranks;
        }

        // --- RENDER FUNCTIONS ---
        
        // RENDER HELPER: Render input field
        function renderScoreInput(roundKey, index, team, score) {
            const isKnockout = ['quarterfinals', 'semifinals', 'final'].includes(roundKey);
            const side = team === 'A' ? 'A' : 'B';
            
            return `<input type="number" 
                data-round="${roundKey}" 
                data-index="${index}" 
                data-team="${side}" 
                value="${score !== null ? score : ''}"
                min="0"
                class="score-input w-12 text-center p-1 rounded-md text-sm transition focus:ring-[var(--accent-color)] ${isKnockout ? 'font-bold' : ''}" 
                onchange="updateScore('${roundKey}', ${index}, '${side}', this.value)">`;
        }

        // RENDER HELPER: Team Card for General Tab
        window.renderTeamCard = function(team) {
            const groupBadge = `<span class="px-2 py-0.5 text-xs font-bold rounded-full text-white ${team.gR === 1 ? 'bg-yellow-500' : team.gR === 2 ? 'bg-green-500' : 'bg-gray-500'}">${team.gR || '-'}</span>`;
            const diff = team.GS - team.GC;
            
            return `
                <div class="p-4 bg-[var(--match-bg)] rounded-xl shadow border border-[var(--border-color)]">
                    <div class="flex items-center justify-between mb-2">
                        <h3 class="text-lg font-bold text-[var(--text-color)]">${team.Tn}</h3>
                        <div class="flex space-x-2">
                            <span class="px-2 py-0.5 text-xs font-semibold rounded bg-[var(--group-header-text)] text-white">Group ${team.g}</span>
                            ${team.gR > 0 ? groupBadge : ''}
                        </div>
                    </div>
                    <p class="text-sm text-gray-400">P.Level: ${team.aPL.toFixed(1)} | Trận: ${team.mP} | Thắng: ${team.W} | Thua: ${team.L}</p>
                    <p class="text-sm text-gray-400">Stats: HS ${diff > 0 ? '+' : ''}${diff} | GS ${team.GS} - GC ${team.GC} | Điểm: <span class="font-bold text-lg text-red-400">${team.Pts}</span></p>
                </div>
            `;
        }
        
        function renderFinalResults(ranks) {
            // ... (Hàm này giữ nguyên)
            const finalResultsEl = document.getElementById('finalResults');
            const thirdPlaceResultsEl = document.getElementById('thirdPlaceResults');
            
            let finalHtml = '';
            let thirdHtml = '';

            // VÔ ĐỊCH & Á QUÂN
            if (ranks.champion) {
                finalHtml += `
                    <div class="text-center p-4 border-b border-[var(--border-color)] mb-4">
                        <p class="text-xs font-semibold text-yellow-400">NHÀ VÔ ĐỊCH</p>
                        <p class="text-4xl font-black text-yellow-500 mb-2">${ranks.champion.name}</p>
                        <p class="text-lg text-gray-500">Pickleball ITVTG Tournament 2025</p>
                    </div>
                `;
            } else {
                 finalHtml += `
                    <div class="text-center p-4 border-b border-[var(--border-color)] mb-4">
                        <p class="text-4xl font-black text-gray-500 mb-2">Chưa xác định</p>
                        <p class="text-lg text-gray-500">Nhà Vô Địch Giải Đấu Pickleball ITVTG Tournament 2025</p>
                    </div>
                `;
            }

            if (ranks.runnerUp) {
                finalHtml += `
                    <div class="text-center p-4 mt-4">
                        <p class="text-xs font-semibold text-gray-400">Á QUÂN (Đội thua Chung kết)</p>
                        <p class="text-2xl font-bold text-gray-300">${ranks.runnerUp.name}</p>
                    </div>
                `;
            } else if (ranks.champion) {
                 finalHtml += `<div class="text-center p-4 mt-4"><p class="text-2xl font-bold text-gray-500">Á Quân: Chưa xác định</p></div>`;
            }

            finalResultsEl.innerHTML = finalHtml;


            // GIẢI BA ĐỒNG HẠNG
            if (ranks.thirdPlace.length > 0) {
                thirdHtml = ranks.thirdPlace.map(team => `
                        <div class="text-center p-4 border border-[var(--border-color)] rounded-lg">
                            <p class="text-xl font-bold text-cyan-300">${team.name}</p>
                            <p class="text-xs font-semibold text-cyan-400">(Đội thua Bán kết)</p>
                        </div>
                    `).join('');
                
                // Nếu chỉ có 1 đội được xác định
                if (ranks.thirdPlace.length === 1) {
                     thirdHtml += `
                        <div class="text-center p-4 border border-[var(--border-color)] rounded-lg text-gray-500">
                            <p class="text-xl font-bold">... Chờ kết quả Bán kết còn lại</p>
                        </div>
                    `;
                }
            } else {
                thirdHtml = `<div class="text-center md:col-span-2 p-4 text-gray-500"><p class="text-xl font-bold">Chưa xác định đội đoạt giải Ba đồng hạng (Cần hoàn thành 2 trận Bán kết)</p></div>`;
            }
            
            thirdPlaceResultsEl.innerHTML = thirdHtml;
        }

        window.renderGeneralTab = function(data) {
            tournamentData = data; 
            
            // 1. Render Final Results (New Logic)
            const ranks = determineFinalRanks(data);
            renderFinalResults(ranks); 
            
            // 2. Render Team List
            const teamListEl = document.getElementById('teamList');
            if (!teamListEl) return;
            
            let htmlContent = '';
            
            const sortedTeams = [...data.tL].sort((a, b) => {
                if (a.g < b.g) return -1;
                if (a.g > b.g) return 1;
                return a.gR - b.gR; // Sort by Rank within the same group
            });

            if (window.renderTeamCard) {
                sortedTeams.forEach(team => {
                    htmlContent += renderTeamCard(team);
                });
            } else {
                 htmlContent = `<div class="md:col-span-3 text-red-400">Lỗi: Hàm renderTeamCard(team) chưa được định nghĩa.</div>`;
            }
            
            teamListEl.innerHTML = htmlContent;
        }

        // RENDER: Team Management Tab
        window.renderTeamManagementTab = function(data) {
            const teamManagementListEl = document.getElementById('teamManagementList');
            if (!teamManagementListEl) return;
            
            let htmlContent = '';
            
            data.tL.forEach(team => {
                htmlContent += `
                    <div class="p-4 bg-[var(--match-bg)] rounded-xl shadow border border-[var(--border-color)]">
                        <div class="flex flex-col md:flex-row md:items-center justify-between mb-3">
                            <h3 class="text-xl font-extrabold text-[var(--accent-color)] mb-2 md:mb-0">${team.T}: <input type="text" value="${team.Tn}" class="text-input p-1 rounded-md w-48 text-lg" onchange="updateTeamInfo('${team.T}', 'Tn', this.value)"></h3>
                            <span class="text-sm font-semibold text-gray-400">Group: ${team.g} | Avg PL: <span class="text-red-300">${team.aPL.toFixed(1)}</span></span>
                        </div>
                        
                        <div class="space-y-3">
                            ${team.P.map((player, pIndex) => `
                                <div class="flex flex-wrap items-center space-y-2 md:space-y-0 md:space-x-4 p-3 bg-gray-700/50 rounded-lg">
                                    <span class="text-sm font-bold w-full md:w-auto text-gray-300">Player ${pIndex + 1}</span>
                                    <div class="flex-1 min-w-[150px]">
                                        <label class="block text-xs text-gray-400">Tên:</label>
                                        <input type="text" value="${player.name}" class="text-input p-1 rounded-md w-full" onchange="updatePlayerInfo('${team.T}', ${pIndex}, 'name', this.value)">
                                    </div>
                                    <div class="w-16">
                                        <label class="block text-xs text-gray-400">PL:</label>
                                        <input type="number" step="0.5" min="2.0" max="7.0" value="${player.pL}" class="score-input p-1 rounded-md w-full" onchange="updatePlayerInfo('${team.T}', ${pIndex}, 'pL', this.value)">
                                    </div>
                                    <div class="w-16">
                                        <label class="block text-xs text-gray-400">Năm:</label>
                                        <input type="text" value="${player.bY}" class="text-input p-1 rounded-md w-full" onchange="updatePlayerInfo('${team.T}', ${pIndex}, 'bY', this.value)">
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            });
            
            teamManagementListEl.innerHTML = htmlContent;
        }

        // RENDER: Group Tab (Table & Matches)
        window.renderGroupTab = function(group, data) {
            // ... (Hàm này giữ nguyên logic hiển thị tên đội và bảng xếp hạng)
            const groupTeams = data.tL.filter(t => t.g === group);
            const sortedTeams = calculateStandings(groupTeams);
            const matches = data[`matches${group}`];
            
            // --- Render Table ---
            const tableEl = document.getElementById(`table${group}`);
            if (tableEl) {
                let tableHtml = `
                    <h3 class="text-xl font-bold text-[var(--group-header-text)] mb-3 border-b border-[var(--border-color)] pb-2">Bảng Xếp Hạng Bảng ${group}</h3>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm text-left text-[var(--text-color)]">
                            <thead class="text-xs uppercase bg-[var(--border-color)]">
                                <tr>
                                    <th scope="col" class="px-2 py-2">Hạng</th>
                                    <th scope="col" class="px-2 py-2">Đội</th>
                                    <th scope="col" class="px-2 py-2">Trận</th>
                                    <th scope="col" class="px-2 py-2">W</th>
                                    <th scope="col" class="px-2 py-2">L</th>
                                    <th scope="col" class="px-2 py-2">HS</th>
                                    <th scope="col" class="px-2 py-2">Điểm</th>
                                </tr>
                            </thead>
                            <tbody>`;
                
                sortedTeams.forEach((team, index) => {
                    const rankClass = index === 0 ? 'bg-yellow-900/40 text-yellow-300 font-bold' : index === 1 ? 'bg-green-900/40 text-green-300' : 'bg-[var(--card-bg)]';
                    const diff = team.GS - team.GC;
                    tableHtml += `
                                <tr class="border-b border-[var(--border-color)] ${rankClass}">
                                    <td class="px-2 py-2 font-bold">${index + 1}</td>
                                    <th scope="row" class="px-2 py-2 font-medium">${team.Tn}</th>
                                    <td class="px-2 py-2">${team.mP}</td>
                                    <td class="px-2 py-2">${team.W}</td>
                                    <td class="px-2 py-2">${team.L}</td>
                                    <td class="px-2 py-2">${diff > 0 ? '+' : ''}${diff}</td>
                                    <td class="px-2 py-2 font-extrabold text-red-400">${team.Pts}</td>
                                </tr>`;
                });
                
                tableHtml += `</tbody></table></div>`;
                tableEl.innerHTML = tableHtml;
            }

            // --- Render Matches ---
            const matchesEl = document.getElementById(`matches${group}`);
            if (matchesEl) {
                 let matchHtml = `
                    <h3 class="text-xl font-bold text-[var(--group-header-text)] mb-3 border-b border-[var(--border-color)] pb-2">Lịch Thi Đấu Bảng ${group}</h3>
                    <div class="space-y-3">
                `;
                
                matches.forEach((match, index) => {
                    const teamA = data.tL.find(t => t.T === match.teamA);
                    const teamB = data.tL.find(t => t.T === match.teamB);
                    const statusClass = match.sA !== null && match.sB !== null ? 'border-l-4 border-green-500' : 'border-l-4 border-gray-500';
                    
                    // Logic cập nhật để tránh undefined/null
                    const teamAName = teamA ? teamA.Tn : (match.teamA ? match.teamA : 'Chưa xác định');
                    const teamBName = teamB ? teamB.Tn : (match.teamB ? match.teamB : 'Chưa xác định');
                    

                    matchHtml += `
                        <div class="match-card p-3 rounded-xl shadow flex items-center justify-between ${statusClass}">
                            <div class="flex-shrink-0 text-sm font-semibold text-gray-500 w-12">${match.Mc}</div>
                            
                            <div class="flex-grow flex items-center justify-between mx-4 space-x-2">
                                <span class="font-bold text-right truncate w-28 md:w-40">${teamAName}</span>
                                
                                <div class="flex items-center space-x-1">
                                    ${renderScoreInput(`matches${group}`, index, 'A', match.sA)}
                                    <span class="font-bold text-gray-400">-</span>
                                    ${renderScoreInput(`matches${group}`, index, 'B', match.sB)}
                                </div>
                                
                                <span class="font-bold text-left truncate w-28 md:w-40">${teamBName}</span>
                            </div>
                            
                            <div class="flex-shrink-0 text-xs font-semibold text-gray-500 w-12 text-right">Court ${match.c}</div>
                        </div>
                    `;
                });
                
                matchHtml += `</div>`;
                matchesEl.innerHTML = matchHtml;
            }
        }

        // RENDER: Knockout Tab
        window.renderKnockoutTab = function(data) {
            // ... (Hàm này giữ nguyên)
            // --- Helper to render a match block ---
            const renderMatchBlock = (roundKey, index, match) => {
                const teamA = data.tL.find(t => t.T === match.teamA);
                const teamB = data.tL.find(t => t.T === match.teamB);
                const matchTitle = roundKey === 'final' ? 'Chung Kết' : roundKey === 'semifinals' ? `Bán Kết ${index+1}` : `Tứ Kết ${index+1}`;
                const statusClass = match.sA !== null && match.sB !== null ? 'border-l-4 border-yellow-500' : 'border-l-4 border-gray-500';
                const winnerName = match.winner ? getTeamName(match.winner) : 'Chưa xác định';
                // TBA (To Be Announced) được giữ lại cho vòng loại vì là tên đội sẽ được xác định sau
                const teamAName = match.teamA ? (teamA ? teamA.Tn : match.teamA) : 'TBA';
                const teamBName = match.teamB ? (teamB ? teamB.Tn : match.teamB) : 'TBA';


                return `
                    <div class="match-card p-4 rounded-xl shadow ${statusClass}">
                        <div class="flex items-center justify-between border-b border-[var(--border-color)] pb-2 mb-2">
                            <h4 class="text-lg font-bold text-[var(--accent-color)]">${matchTitle} (${match.Mc})</h4>
                            <span class="text-xs text-gray-400">Time: ${match.t} | Court: ${match.c}</span>
                        </div>
                        
                        <div class="space-y-3">
                            <div class="flex items-center justify-between">
                                <span class="text-base font-semibold w-1/3 truncate text-red-300">${teamAName}</span>
                                <div class="flex items-center space-x-1">
                                    ${renderScoreInput(roundKey, index, 'A', match.sA)}
                                    <span class="font-bold text-gray-400">-</span>
                                    ${renderScoreInput(roundKey, index, 'B', match.sB)}
                                </div>
                                <span class="text-base font-semibold w-1/3 truncate text-blue-300 text-right">${teamBName}</span>
                            </div>
                            
                            ${match.sA !== null && match.sB !== null ? 
                                `<div class="mt-2 text-center p-2 bg-green-900/30 rounded-lg">
                                    <span class="font-bold text-sm text-green-300">Thắng: ${winnerName}</span>
                                </div>` 
                                : ''}
                        </div>
                    </div>
                `;
            };

            // --- Render QF ---
            const qfEl = document.getElementById('quarterfinals');
            if (qfEl) {
                let html = '<h3 class="text-2xl font-bold text-red-400 mb-4">Tứ Kết (Quarterfinals)</h3>';
                html += '<div class="grid grid-cols-1 md:grid-cols-2 gap-4">';
                data.quarterfinals.forEach((match, index) => {
                    html += renderMatchBlock('quarterfinals', index, match);
                });
                html += '</div>';
                qfEl.innerHTML = html;
            }

            // --- Render SF ---
            const sfEl = document.getElementById('semifinals');
            if (sfEl) {
                let html = '<h3 class="text-2xl font-bold text-red-400 mt-6 mb-4">Bán Kết (Semifinals)</h3>';
                html += '<div class="grid grid-cols-1 md:grid-cols-2 gap-4">';
                data.semifinals.forEach((match, index) => {
                    html += renderMatchBlock('semifinals', index, match);
                });
                html += '</div>';
                sfEl.innerHTML = html;
            }

            // --- Render Final ---
            const finalEl = document.getElementById('finalSection');
            if (finalEl) {
                finalEl.innerHTML = `
                    <h3 class="text-2xl font-bold text-red-500 mt-6 mb-4 border-t border-[var(--border-color)] pt-4">Chung Kết (Final)</h3>
                    <div class="grid grid-cols-1 gap-4 max-w-lg mx-auto">
                        ${renderMatchBlock('final', 0, data.final)}
                    </div>
                `;
            }
        }
        
        // --- USER INTERACTION LOGIC (UPDATE DATA) ---

        /**
         * Cập nhật tỉ số trận đấu khi người dùng nhập.
         */
        window.updateScore = function(roundKey, index, team, value) {
            let score = value === '' ? null : parseInt(value);

            if (score !== null && (isNaN(score) || score < 0)) {
                showStatus('Lỗi: Điểm phải là số nguyên không âm.', 'error', 'statusMessage');
                return;
            }
            
            let match;
            if (roundKey === 'final') {
                match = tournamentData.final;
            } else {
                match = tournamentData[roundKey][index];
            }
            
            if (!match) return;

            if (team === 'A') {
                match.sA = score;
            } else if (team === 'B') {
                match.sB = score;
            }
            
            // Xử lý lại dữ liệu và render lại toàn bộ
            processDataAndRender(tournamentData);
            
            // Tự động COMMIT (Auto-Save)
            autoCommitActiveState('Auto update scores and recalculate ranks/knockout (V6.0)');
            showStatus('Tỉ số đã được cập nhật cục bộ và đang tự động đồng bộ lên GitHub...', 'warning', 'statusMessage');
        }

        /**
         * Cập nhật thông tin đội (Tn) trong tab Team Management
         */
        window.updateTeamInfo = function(teamId, field, value) {
            const team = tournamentData.tL.find(t => t.T === teamId);
            if (team) {
                team[field] = value;
                // Tự động COMMIT (Auto-Save)
                autoCommitActiveState('Auto update team nickname (Tn) (V6.0)');
                showStatus('Thông tin đội đã được cập nhật cục bộ và đang tự động đồng bộ lên GitHub...', 'warning', 'statusMessage');
                // Render lại để cập nhật Tn trên toàn bộ giao diện
                processDataAndRender(tournamentData);
            }
        }

        /**
         * Cập nhật thông tin người chơi (name, pL, bY) trong tab Team Management
         */
        window.updatePlayerInfo = function(teamId, pIndex, field, value) {
            const team = tournamentData.tL.find(t => t.T === teamId);
            if (team && team.P[pIndex]) {
                let finalValue = value;
                if (field === 'pL') {
                    finalValue = parseFloat(value);
                    if (isNaN(finalValue)) finalValue = team.P[pIndex].pL; 
                    
                    // Cập nhật lại aPL của đội
                    const otherPlayerPL = team.P[1 - pIndex].pL;
                    team.aPL = (finalValue + otherPlayerPL) / 2;
                }
                
                team.P[pIndex][field] = finalValue;
                
                // Render lại tab Team Management để cập nhật aPL và trạng thái
                renderTeamManagementTab(tournamentData); 
                
                // Tự động COMMIT (Auto-Save)
                autoCommitActiveState('Auto update player details (name, pL, bY) (V6.0)');
                showStatus('Thông tin người chơi đã được cập nhật cục bộ và đang tự động đồng bộ lên GitHub...', 'warning', 'statusMessage');
            }
        }


        // --- MANUAL COMMIT LOGIC ---

        // Nút "ĐỒNG BỘ THỦ CÔNG LÊN STATE41S.JSON"
        window.manualCommitActiveState = async function() {
            githubToken = localStorage.getItem('githubToken') || ''; 
            if (!githubToken || githubToken.trim().length === 0) {
                showStatus('Lỗi: Vui lòng nhập và lưu GitHub Token trước.', 'error', 'scoreCommitResult');
                return;
            }

            const commitMessage = 'Manual sync of active state (state41s.json - V6.0)';
            
            // Chuẩn bị dữ liệu (unify và loại bỏ các trường tính toán)
            const commitData = unifyAndCleanData(tournamentData);
            const currentSha = tournamentData.metadata?.sha;
            if (currentSha) {
                commitData.metadata = { sha: currentSha }; 
            } else {
                 delete commitData.metadata;
            }
            
            const base64Content = jsonToBase64(commitData);
            
            await getShaAndCommit(ACTIVE_API_URL, base64Content, commitMessage, 'commitScoreButton', 'scoreCommitResult');
        };

        // Nút "LƯU THÔNG TIN ĐỘI VÀO GỐC (`state41.json`) - THAO TÁC NGUY HIỂM!"
        window.commitTeamChangesToGitHub = async function() {
            githubToken = localStorage.getItem('githubToken') || ''; 
            if (!githubToken || githubToken.trim().length === 0) {
                showStatus('Lỗi: Vui lòng nhập và lưu GitHub Token trước.', 'error', 'teamCommitResult');
                return;
            }

            // Lấy lại dữ liệu gốc (initialBaseData) và cập nhật trường tL, sau đó commit lên BASE API
            const fullBaseData = JSON.parse(JSON.stringify(initialBaseData));

            // Chỉ cập nhật các trường liên quan đến Team List (tL) từ dữ liệu hiện tại (tournamentData)
            fullBaseData.tL = tournamentData.tL.map(team => ({
                 T: team.T, 
                 Tn: team.Tn, 
                 aPL: team.aPL, 
                 g: team.g,
                 s: team.s,
                 // Cập nhật P (người chơi)
                 P: team.P.map(player => ({
                    name: player.name,
                    bY: player.bY,
                    pL: player.pL,
                    ph: player.ph,
                    em: player.em,
                    gC: player.gC,
                    fC: player.fC,
                 }))
            }));
            
            // Giữ lại các trường score/match/metadata từ BASE data
            delete fullBaseData.metadata; 
            
            // Gộp mảng match lại thành 'matches' thống nhất trước khi commit BASE file
            const commitData = unifyMatches(fullBaseData);
            const base64Content = jsonToBase64(commitData);
            const commitMessage = 'Update base team details and overwrite state41.json via web app (V6.0)';

            if (!confirm("CẢNH BÁO: Thao tác này sẽ GHI ĐÈ TOÀN BỘ file state41.json (Template gốc) trên GitHub. Bạn có chắc chắn không?")) {
                showStatus("Thao tác cập nhật đội đã bị hủy.", 'info', 'teamCommitResult');
                return;
            }

            await getShaAndCommit(BASE_API_URL, base64Content, commitMessage, 'commitTeamToBaseButton', 'teamCommitResult');
            
            // Sau khi commit thành công, tải lại dữ liệu để đảm bảo đồng bộ
            await loadDataFromGitHub();
            switchTab('TeamManagement');
        };

        window.exportTournamentData = function() {
            if (!tournamentData) {
                showStatus('Lỗi: Không có dữ liệu để xuất.', 'error', 'configExportResult');
                return;
            }
            
            // 1. Chuẩn bị dữ liệu (unify và loại bỏ các trường tính toán)
            const exportData = unifyAndCleanData(tournamentData);
            
            // 2. Chuẩn bị file JSON
            const jsonString = JSON.stringify(exportData, null, 2);
            const blob = new Blob([jsonString], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            // 3. Tạo link download
            const a = document.createElement('a');
            a.href = url;
            const now = new Date();
            const dateStr = `${now.getFullYear()}${String(now.getMonth() + 1).padStart(2, '0')}${String(now.getDate()).padStart(2, '0')}_${String(now.getHours()).padStart(2, '0')}${String(now.getMinutes()).padStart(2, '0')}`;
            a.download = `state41_FULL_EXPORT_${dateStr}.json`;
            // 4. Kích hoạt download
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            showStatus('Đã xuất toàn bộ dữ liệu thành công!', 'success', 'configExportResult');
        }

        // --- SIMULATE SCORES & RESET ---
        
        // ... (Các hàm simulateScores, getSimulatedScore, confirmResetScores, resetScores giữ nguyên)
        /**
         * Tạo tỉ số ngẫu nhiên theo luật giới hạn điểm.
         * @param {boolean} isGroupMatch - True nếu là vòng bảng (Max 11), False nếu là vòng loại (Max 15).
         * @returns {{sA: number, sB: number}} Tỉ số ngẫu nhiên.
         */
        function getSimulatedScore(isGroupMatch) {
            const WIN_SCORE = isGroupMatch ? 11 : 15;
            const MAX_LOSS_SCORE = WIN_SCORE - 1; 

            const winner = Math.random() < 0.5 ? 'A' : 'B';
            let lossScore;
            // 80% trường hợp điểm thua nằm trong khoảng [5, MAX_LOSS_SCORE]
            if (Math.random() < 0.8) {
                 lossScore = Math.floor(Math.random() * (MAX_LOSS_SCORE - 5 + 1)) + 5; 
            } else {
                 // 20% trường hợp điểm thua nhỏ hơn 5
                lossScore = Math.floor(Math.random() * 5); 
            }
            
            // Đảm bảo không có tỉ số hòa trong giả lập
            lossScore = Math.min(lossScore, MAX_LOSS_SCORE);

            if (winner === 'A') {
                return { sA: WIN_SCORE, sB: lossScore };
            } else {
                return { sA: lossScore, sB: WIN_SCORE };
            }
        }

        window.simulateScores = function(roundType) {
            if (!tournamentData) return showStatus('Lỗi: Không có dữ liệu giải đấu.', 'error', 'statusMessage');
            let matchesToSimulate = [];
            let isGroup = false;
            let roundKey;
            
            if (roundType.length === 1 && ['A', 'B', 'C', 'D'].includes(roundType)) { 
                roundKey = `matches${roundType}`;
                matchesToSimulate = tournamentData[roundKey];
                isGroup = true;
            } else if (roundType === 'Knockout') { 
                // Giả lập theo thứ tự: QF -> SF -> F
                // 1. QF
                tournamentData.quarterfinals.forEach(match => {
                    if (match.teamA && match.teamB && (match.sA === null || match.sB === null)) {
                        const score = getSimulatedScore(false);
                        match.sA = score.sA;
                        match.sB = score.sB;
                    }
                });
                updateKnockoutBrackets(tournamentData);
                // 2. SF
                 tournamentData.semifinals.forEach(match => {
                    if (match.teamA && match.teamB && (match.sA === null || match.sB === null)) {
                        const score = getSimulatedScore(false);
                        match.sA = score.sA;
                        match.sB = score.sB;
                    }
                });
                updateKnockoutBrackets(tournamentData);
                // 3. Final
                const finalMatch = tournamentData.final;
                if (finalMatch && finalMatch.teamA && finalMatch.teamB && (finalMatch.sA === null || finalMatch.sB === null)) {
                    const score = getSimulatedScore(false);
                    finalMatch.sA = score.sA;
                    finalMatch.sB = score.sB;
                }
                updateKnockoutBrackets(tournamentData);
                
                showStatus('Đã giả lập tỉ số Vòng Loại Trực Tiếp (QF, SF, F).', 'warning', 'statusMessage');
                
                // Xử lý lại dữ liệu và render lại toàn bộ
                processDataAndRender(tournamentData);
                // Tự động COMMIT (Auto-Save)
                autoCommitActiveState('Auto commit simulated scores (Knockout - V6.0)');
                return;
            }

            if (!matchesToSimulate || matchesToSimulate.length === 0) return showStatus(`Không có trận đấu nào trong Bảng ${roundType} để giả lập.`, 'warning', 'statusMessage');

            matchesToSimulate.forEach(match => {
                // Chỉ giả lập cho trận chưa có tỉ số
                if (match.sA === null || match.sB === null) {
                    const score = getSimulatedScore(isGroup);
                    match.sA = score.sA;
                    match.sB = score.sB;
                }
            });

            showStatus(`Đã giả lập tỉ số Vòng Bảng ${roundType}.`, 'warning', 'statusMessage');
            
            // Xử lý lại dữ liệu và render lại toàn bộ
            processDataAndRender(tournamentData);
            // Tự động COMMIT (Auto-Save)
            autoCommitActiveState(`Auto commit simulated scores (Group ${roundType} - V6.0)`);
        }
        
        window.confirmResetScores = function() {
            const roundType = document.getElementById('resetRoundSelector').value;
            if (!roundType) {
                return showStatus('Vui lòng chọn vòng đấu muốn xóa tỉ số.', 'warning', 'resetResult');
            }
            
            if (confirm(`XÁC NHẬN: Bạn có chắc chắn muốn XÓA (Reset) TẤT CẢ tỉ số của vòng ${roundType} không?`)) {
                resetScores(roundType);
            } else {
                showStatus('Thao tác xóa tỉ số đã bị hủy.', 'info', 'resetResult');
            }
        }

        /**
         * Xóa tỉ số của một vòng đấu về null.
         * @param {string} roundType - Mã vòng đấu (A, B, C, D, QF, SF, F)
         */
        function resetScores(roundType) {
            const roundKeyMap = {
                'A': 'matchesA', 'B': 'matchesB', 'C': 'matchesC', 'D': 'matchesD',
                'QF': 'quarterfinals', 'SF': 'semifinals', 'F': 'final'
            };
            const key = roundKeyMap[roundType];
            
            if (!key || !tournamentData[key]) {
                return showStatus(`Lỗi: Vòng đấu ${roundType} không hợp lệ hoặc không tồn tại.`, 'error', 'resetResult');
            }

            if (key === 'final') {
                tournamentData.final.sA = null;
                tournamentData.final.sB = null;
            } else if (Array.isArray(tournamentData[key])) {
                tournamentData[key].forEach(match => {
                    match.sA = null;
                    match.sB = null;
                });
            }

            // Sau khi reset, xử lý lại dữ liệu và render
            processDataAndRender(tournamentData);
            document.getElementById('resetRoundSelector').value = '';
            
            // Tự động COMMIT (Auto-Save)
            autoCommitActiveState(`Auto commit score reset for ${roundType} (V6.0)`);
            showStatus(`Đã XÓA TẤT CẢ tỉ số của Vòng ${roundType} thành công và đang tự động đồng bộ.`, 'success', 'resetResult');
            switchTab('Configuration');
        }


        // --- THEME & NAVIGATION ---
        function applyTheme(theme) {
             // ... (Hàm này giữ nguyên)
            const body = document.body;
            body.classList.remove('light-mode');
            if (theme === 'light') {
                body.classList.add('light-mode');
                document.getElementById('sunIcon').classList.add('hidden');
                document.getElementById('moonIcon').classList.remove('hidden');
                document.getElementById('currentThemeDisplay').textContent = 'Sáng';
            } else {
                document.getElementById('sunIcon').classList.remove('hidden');
                document.getElementById('moonIcon').classList.add('hidden');
                document.getElementById('currentThemeDisplay').textContent = 'Tối';
            }
        }

        window.toggleTheme = function() {
            // ... (Hàm này giữ nguyên)
            const currentTheme = document.body.classList.contains('light-mode') ? 'light' : 'dark';
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            localStorage.setItem('theme', newTheme);
            applyTheme(newTheme);
        }

        window.switchTab = function(tabName) {
            // ... (Hàm này giữ nguyên)
            document.querySelectorAll('.tab-content').forEach(el => el.style.display = 'none');
            const targetTab = document.getElementById(tabName);
            if(targetTab) targetTab.style.display = 'block';

            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });

            const activeBtn = document.querySelector(`.tab-button[data-tab="${tabName}"]`);
            if (activeBtn) {
                 activeBtn.classList.add('active');
            }
        }

        function handleGesture() {
             // ... (Hàm này giữ nguyên)
            const diffX = endX - startX;
            if (Math.abs(diffX) > swipeThreshold) {
                const tabs = ['General', 'TeamManagement', 'GroupA', 'GroupB', 'GroupC', 'GroupD', 'Knockout', 'Configuration'];
                const currentTabName = document.querySelector('.tab-button.active')?.dataset.tab;
                const currentIndex = tabs.indexOf(currentTabName);
                
                if (currentIndex === -1) return;

                if (diffX > 0) { // Swipe right (Previous tab)
                    const prevIndex = currentIndex > 0 ? currentIndex - 1 : tabs.length - 1;
                    switchTab(tabs[prevIndex]);
                } else { // Swipe left (Next tab)
                    const nextIndex = currentIndex < tabs.length - 1 ? currentIndex + 1 : 0;
                    switchTab(tabs[nextIndex]);
                }
            }
        }

        window.showConfirmationModal = function() {
             // ... (Hàm này giữ nguyên)
            document.getElementById('confirmationBox').classList.remove('hidden');
        }

        window.reSyncStaticData = function() {
            // ... (Hàm này giữ nguyên)
            document.getElementById('confirmationBox').classList.add('hidden');
            loadDataFromGitHub();
        }
        
        // --- INITIALIZATION ---

        function initializeMatchListeners() {
            // Re-bind listeners if needed, currently done inline (onchange) in render functions.
        }

        window.initializeApp = function() {
            githubToken = localStorage.getItem('githubToken') || '';
            const savedTheme = localStorage.getItem('theme') || 'dark'; 
            applyTheme(savedTheme);

            if (githubToken) {
                 document.getElementById('githubToken').value = '********';
            }

            // Event listeners for theme toggle
            document.getElementById('themeToggle').addEventListener('click', toggleTheme);

            // Event listeners for swipe navigation (on the whole app container)
            document.getElementById('app').addEventListener('touchstart', (e) => {
                 if (e.target.closest('.score-input, .text-input')) return;
                startX = e.changedTouches[0].screenX;
            }, { passive: true });

            document.getElementById('app').addEventListener('touchend', (e) => {
                 if (e.target.closest('.score-input, .text-input')) return;
                endX = e.changedTouches[0].screenX;
                handleGesture();
            }, { passive: true });
            
            // Modal button setup
            document.getElementById('confirmYes').onclick = window.reSyncStaticData;
            document.getElementById('confirmNo').onclick = () => document.getElementById('confirmationBox').classList.add('hidden');

            loadDataFromGitHub();
        }

        window.onload = initializeApp;
    </script>
</body>
</html>
