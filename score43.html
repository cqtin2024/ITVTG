<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quản Lý Giải Đấu & Cập Nhật Thông Tin (GitHub Sync) V6.4 - DEV</title> 
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100;400;700;900&display=swap" rel="stylesheet">
    <style>
        /* Base styles for Dark Mode */
        :root {
            --bg-color: #111827; 
            --text-color: #f3f4f6; 
            --card-bg: #1f2937; 
            --border-color: #374151; 
            --accent-color: #06b6d4; 
            --match-bg: #1f2937;
            --input-bg: #4b5563; 
            --group-header-text: #60a5fa; 
        }
        
        /* Light Mode Overrides */
        .light-mode {
            --bg-color: #f9fafb; 
            --text-color: #111827; 
            --card-bg: #ffffff;
            --border-color: #e5e7eb; 
            --accent-color: #ef4444; 
            --match-bg: #f3f4f6; 
            --input-bg: #ffffff;
            --group-header-text: #10b981; 
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            transition: background-color 0.3s, color 0.3s;
        }
        .container {
            max-width: 1200px;
        }
        .score-input, .text-input {
            background-color: var(--input-bg);
            border: 1px solid var(--border-color);
            color: var(--text-color);
        }
        .score-input:focus, .text-input:focus {
            box-shadow: 0 0 0 3px var(--accent-color);
        }
        .tab-button {
            border-bottom-color: var(--border-color);
        }
        .tab-button.active {
            color: var(--accent-color);
            border-color: var(--accent-color);
            background-color: var(--card-bg);
        }
        .tab-content {
            display: none;
            background-color: var(--card-bg);
            border-radius: 0.75rem; 
            padding: 1.5rem; 
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); 
        }
        
        ::-webkit-scrollbar { height: 8px; }
        ::-webkit-scrollbar-thumb { background: var(--border-color); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #6b7280; }
        
        .match-card {
            background-color: var(--match-bg);
            border-bottom: 1px solid var(--border-color);
        }
        .light-mode .match-card {
            background-color: #ffffff;
            border-bottom: 1px solid #e5e7eb;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
        }
        .modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 50;
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <div id="app" class="container mx-auto">
        <header class="flex items-center justify-between mb-6">
            <div class="flex items-center">
                <svg class="w-10 h-10 md:w-12 md:h-12 text-[var(--accent-color)]" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 15.75l-4-4m0 0l4-4m-4 4h14M17 12a5 5 0 11-10 0 5 5 0 0110 0z"></path></svg>
                <div class="text-left ml-4">
                    <h1 class="text-xl md:text-3xl font-extrabold text-[var(--text-color)] leading-none">QUẢN LÝ GIẢI ĐẤU PICKLEBALL (V6.4)</h1>
                    <p class="text-xs md:text-sm text-[var(--accent-color)]">Cập Nhật Tỉ Số & Thông Tin Đội (GitHub Sync)</p>
                </div>
            </div>
            
            <button id="themeToggle" onclick="toggleTheme()" class="p-3 rounded-full bg-[var(--card-bg)] shadow-md text-[var(--text-color)] hover:bg-[var(--border-color)] transition duration-200">
                <svg id="sunIcon" class="w-6 h-6 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>
                <svg id="moonIcon" class="w-6 h-6 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path></svg>
            </button>
        </header>

        <div id="statusMessage" class="text-center p-4 bg-blue-900/50 rounded-lg text-blue-300 font-semibold mb-6">
            Đang tải dữ liệu trạng thái từ GitHub...
        </div>
        
        <nav class="mb-8 border-b border-[var(--border-color)] overflow-x-auto whitespace-nowrap">
            <button class="tab-button py-3 px-4 md:px-6 text-sm md:text-base font-semibold border-b-2 border-transparent text-gray-400 hover:text-[var(--accent-color)] transition" onclick="switchTab('General')" data-tab="General">General</button>
            <button class="tab-button py-3 px-4 md:px-6 text-sm md:text-base font-semibold border-b-2 border-transparent text-gray-400 hover:text-[var(--accent-color)] transition" onclick="switchTab('TeamManagement')" data-tab="TeamManagement">Quản Lý Đội</button>
            <button class="tab-button py-3 px-4 md:px-6 text-sm md:text-base font-semibold border-b-2 border-transparent text-gray-400 hover:text-[var(--accent-color)] transition" onclick="switchTab('GroupA')" data-tab="GroupA">Group A</button>
            <button class="tab-button py-3 px-4 md:px-6 text-sm md:text-base font-semibold border-b-2 border-transparent text-gray-400 hover:text-[var(--accent-color)] transition" onclick="switchTab('GroupB')" data-tab="GroupB">Group B</button>
            <button class="tab-button py-3 px-4 md:px-6 text-sm md:text-base font-semibold border-b-2 border-transparent text-gray-400 hover:text-[var(--accent-color)] transition" onclick="switchTab('GroupC')" data-tab="GroupC">Group C</button>
            <button class="tab-button py-3 px-4 md:px-6 text-sm md:text-base font-semibold border-b-2 border-transparent text-gray-400 hover:text-[var(--accent-color)] transition" onclick="switchTab('GroupD')" data-tab="GroupD">Group D</button>
            <button class="tab-button py-3 px-4 md:px-6 text-sm md:text-base font-semibold border-b-2 border-transparent text-gray-400 hover:text-[var(--accent-color)] transition" onclick="switchTab('Knockout')" data-tab="Knockout">Knockout</button>
            <button class="tab-button py-3 px-4 md:px-6 text-sm md:text-base font-semibold border-b-2 border-transparent text-gray-400 hover:text-[var(--accent-color)] transition" onclick="switchTab('Configuration')" data-tab="Configuration">Cấu Hình</button>
        </nav>

        <div id="General" class="tab-content">
             <h2 class="text-3xl font-extrabold text-yellow-500 mb-6 border-b border-[var(--border-color)] pb-2">Final Results (Kết quả chung cuộc)</h2>
            <section id="finalResults" class="mb-10 p-4 rounded-xl shadow-lg bg-[var(--match-bg)]">
                <div id="championDisplay" class="text-center">
                    <p class="text-4xl font-black text-yellow-500 mb-2">Chưa xác định</p>
                    <p class="text-lg text-yellow-500">Nhà Vô Địch Giải Đấu</p>
                </div>
                 <div id="runnerUpDisplay" class="text-center mt-4 border-t border-[var(--border-color)] pt-4">
                    <p class="text-2xl font-bold text-gray-400 mb-1">Chưa xác định</p>
                    <p class="text-md text-gray-400">Á Quân Giải Đấu</p>
                </div>
            </section>

            <h2 class="text-3xl font-extrabold text-[var(--text-color)] mb-6 border-b border-[var(--border-color)] pb-2">Team List (Danh sách các đội)</h2>
            <section id="teamList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                </section>
        </div>
        
        <div id="TeamManagement" class="tab-content">
            <h2 class="text-3xl font-extrabold text-blue-500 mb-6 border-b border-[var(--border-color)] pb-2">Quản Lý Thông Tin Đội (Lưu cục bộ)</h2>
            <p class="text-sm text-gray-400 mb-4">Điều chỉnh **Tên đội (Tn)**, **Tên người chơi (name)**, **Cấp độ (pL)**, và **Năm sinh (bY)**. Các thay đổi này chỉ được lưu cục bộ và **chỉ được đồng bộ lên GitHub khi bạn COMMIT TỈ SỐ** (sử dụng file `state41s.json`).</p>
            
            <button id="saveTeamLocalButton" onclick="saveTeamChangesToLocal()" class="w-full md:w-auto px-6 py-2 bg-yellow-600 hover:bg-yellow-700 text-white font-bold rounded-lg shadow-lg transition duration-300 mb-6">
                LƯU CÁC THAY ĐỔI ĐỘI CỤC BỘ (Không Commit)
            </button>
            
            <div id="teamCommitResult" class="mt-3 p-3 rounded-lg text-sm font-semibold hidden"></div>

            <section id="teamManagementList" class="space-y-6"></section>
        </div>


        <div id="GroupA" class="tab-content space-y-6">
            <button onclick="simulateScores('A')" class="w-full md:w-auto px-6 py-2 bg-yellow-600 hover:bg-yellow-700 text-white font-bold rounded-lg shadow-lg transition duration-300">
                GIẢ LẬP TỈ SỐ VÒNG BẢNG A
            </button>
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div id="tableA" class="lg:col-span-1"></div>
                <div id="matchesA" class="lg:col-span-2"></div>
            </div>
        </div>

        <div id="GroupB" class="tab-content space-y-6">
            <button onclick="simulateScores('B')" class="w-full md:w-auto px-6 py-2 bg-yellow-600 hover:bg-yellow-700 text-white font-bold rounded-lg shadow-lg transition duration-300">
                GIẢ LẬP TỈ SỐ VÒNG BẢNG B
            </button>
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div id="tableB" class="lg:col-span-1"></div>
                <div id="matchesB" class="lg:col-span-2"></div>
            </div>
        </div>

        <div id="GroupC" class="tab-content space-y-6">
             <button onclick="simulateScores('C')" class="w-full md:w-auto px-6 py-2 bg-yellow-600 hover:bg-yellow-700 text-white font-bold rounded-lg shadow-lg transition duration-300">
                GIẢ LẬP TỈ SỐ VÒNG BẢNG C
            </button>
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div id="tableC" class="lg:col-span-1"></div>
                <div id="matchesC" class="lg:col-span-2"></div>
            </div>
        </div>

        <div id="GroupD" class="tab-content space-y-6">
             <button onclick="simulateScores('D')" class="w-full md:w-auto px-6 py-2 bg-yellow-600 hover:bg-yellow-700 text-white font-bold rounded-lg shadow-lg transition duration-300">
                GIẢ LẬP TỈ SỐ VÒNG BẢNG D
            </button>
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div id="tableD" class="lg:col-span-1"></div>
                <div id="matchesD" class="lg:col-span-2"></div>
            </div>
        </div>

        <div id="Knockout" class="tab-content">
            <h2 class="text-3xl font-extrabold text-[var(--group-header-text)] mb-6 border-b border-[var(--border-color)] pb-2">Vòng Loại Trực Tiếp (Knockout Stage)</h2>
            <div class="flex flex-col md:flex-row space-y-3 md:space-y-0 md:space-x-4 mb-6">
                <button onclick="seedKnockoutMatches()" id="seedButton" class="w-full md:w-auto px-6 py-2 bg-green-600 hover:bg-green-700 text-white font-bold rounded-lg shadow-lg transition duration-300 disabled:opacity-50">
                    TỰ ĐỘNG XẾP CẶP TỨ KẾT (SEEDING)
                </button>
                <button onclick="simulateScores('Knockout')" class="w-full md:w-auto px-6 py-2 bg-red-600 hover:bg-red-700 text-white font-bold rounded-lg shadow-lg transition duration-300">
                    GIẢ LẬP TỈ SỐ VÒNG LOẠI (QF, SF, F)
                </button>
            </div>
            
            <div id="seedingStatus" class="p-3 bg-blue-900/30 text-blue-300 rounded-lg mb-6">
                Trạng thái Seeding: Chưa khởi tạo Tứ kết.
            </div>
            
            <div id="quarterfinals" class="mb-6"></div>
            <div id="semifinals" class="mb-6"></div>
            <div id="finalMatchSection">
                <div id="finalSection"></div>
            </div>
        </div>

        <div id="Configuration" class="tab-content space-y-8">
            <h2 class="text-3xl font-extrabold text-red-500 mb-6 border-b border-[var(--border-color)] pb-2">Cấu Hình & Đồng Bộ Hóa (GitHub API)</h2>
            
             <section class="p-4 bg-red-900/20 rounded-lg border-l-4 border-red-500">
                <h3 class="text-xl font-bold text-red-400 mb-3 flex items-center">
                    <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-2a2 2 0 00-2-2H6a2 2 0 00-2 2v2a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path></svg>
                    1. GitHub Personal Access Token (PAT)
                </h3>
                <p class="text-sm text-red-300 mb-4 font-bold">CẢNH BÁO BẢO MẬT: Token này sẽ được lưu trữ trong trình duyệt. Chỉ sử dụng Token có phạm vi (Scope) nhỏ nhất. <span class="text-yellow-300">CẦN PHẢI CÓ QUYỀN **repo** (hoặc contents:write)</span>.</p>
                <input type="password" id="githubToken" 
                    class="score-input w-full p-2 rounded-md focus:ring-red-500 transition" 
                    placeholder="Dán GitHub PAT của bạn vào đây...">
                <button onclick="saveToken()" class="mt-2 px-4 py-1 bg-green-600 hover:bg-green-700 text-white text-sm font-bold rounded-lg transition duration-300">Lưu Token cục bộ</button>
            </section>

            <section class="p-4 bg-[var(--match-bg)] rounded-lg border-l-4 border-purple-500">
                <h3 class="text-xl font-bold text-[var(--group-header-text)] mb-3 flex items-center">
                    <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4"></path></svg>
                    2. Cập Nhật Tỉ Số (Commit) lên **state41s.json**
                </h3>
                <p class="text-gray-400 mb-4">Sử dụng Token đã lưu để commit những tỉ số và thông tin đội **đã thay đổi** lên GitHub (file `state41s.json`).</p>
                
                <button id="commitScoreButton" onclick="commitScoreChangesToGitHub()" class="w-full md:w-auto px-6 py-2 bg-purple-600 hover:bg-purple-700 text-white font-bold rounded-lg shadow-lg transition duration-300 mb-4 disabled:opacity-50">
                    COMMIT TỈ SỐ & THAY ĐỔI ĐỘI
                </button>

                <div id="scoreCommitResult" class="mt-3 p-3 rounded-lg text-sm font-semibold hidden"></div>
            </section>
            
             <section class="p-4 bg-[var(--match-bg)] rounded-lg border-l-4 border-green-500">
                 <h3 class="text-xl font-bold text-[var(--group-header-text)] mb-3 flex items-center">
                    <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                    3. Xuất Dữ Liệu Giải Đấu (state41.json Format)
                </h3>
                <p class="text-[var(--text-color)] mb-4">Tạo và tải về file JSON chứa toàn bộ trạng thái giải đấu hiện tại, bao gồm thông tin đội và tỉ số đã tính toán.</p>
                <button onclick="exportTournamentData()" class="md:w-auto px-6 py-2 bg-green-600 hover:bg-green-700 text-white font-bold rounded-lg shadow-lg transition duration-300">
                    TẢI XUỐNG TOÀN BỘ JSON
                </button>
                <div id="configExportResult" class="mt-3 p-3 rounded-lg text-sm font-semibold hidden"></div>
            </section>
            
            <section class="p-4 bg-[var(--match-bg)] rounded-lg border-l-4 border-red-500">
                <h3 class="text-xl font-bold text-red-400 mb-3 flex items-center">
                    <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                    4. Xóa (Reset) Tỉ Số Trận Đấu
                </h3>
                <p class="text-gray-400 mb-4">Chọn vòng đấu và nhấn nút để **XÓA TẤT CẢ** tỉ số đã nhập trong vòng đó về trạng thái trống (null).</p>
                
                <div class="flex flex-col md:flex-row space-y-3 md:space-y-0 md:space-x-4">
                    <select id="resetRoundSelector" class="text-input w-full md:w-1/2 p-2 rounded-md">
                        <option value="">-- Chọn Vòng Đấu --</option>
                        <option value="A">Vòng Bảng A</option>
                        <option value="B">Vòng Bảng B</option>
                        <option value="C">Vòng Bảng C</option>
                        <option value="D">Vòng Bảng D</option>
                        <option value="QF">Tứ Kết (QF)</option>
                        <option value="SF">Bán Kết (SF)</option>
                        <option value="F">Chung Kết (F)</option>
                    </select>
                    
                    <button onclick="confirmResetScores()" class="w-full md:w-auto px-6 py-2 bg-red-600 hover:bg-red-700 text-white font-bold rounded-lg shadow-lg transition duration-300 disabled:opacity-50">
                        XÓA TỈ SỐ ĐÃ CHỌN
                    </button>
                </div>
                <div id="resetResult" class="mt-3 p-3 rounded-lg text-sm font-semibold hidden"></div>
            </section>
            
            <section class="p-4 bg-[var(--match-bg)] rounded-lg border-l-4 border-yellow-500">
                 <h3 class="text-xl font-bold text-[var(--group-header-text)] mb-3 flex items-center">
                    <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>
                    5. Tùy Chọn Giao Diện & Đồng Bộ Lại
                </h3>
                <p class="text-[var(--text-color)] mb-4">Bạn có thể chuyển đổi giữa giao diện Sáng/Tối hoặc tải lại trạng thái online mới nhất.</p>
                <button onclick="document.getElementById('themeToggle').click()" class="md:w-auto px-6 py-2 bg-yellow-500 hover:bg-yellow-600 text-black font-bold rounded-lg shadow-lg transition duration-300 mr-4">
                    Chuyển Đổi Giao Diện (Hiện tại: <span id="currentThemeDisplay">Tối</span>)
                </button>
                <button id="reSyncButton" onclick="showConfirmationModal()" class="md:w-auto px-6 py-2 bg-red-600 hover:bg-red-700 text-white font-bold rounded-lg shadow-lg transition duration-300">
                    Đồng Bộ Lại (Tải lại từ GitHub)
                </button>
            </section>

        </div>

    </div>
    
    <div id="confirmationBox" class="modal-backdrop hidden">
        <div class="bg-[var(--card-bg)] p-6 rounded-xl shadow-2xl w-11/12 max-w-sm border-t-4 border-red-500 text-[var(--text-color)]">
            <h4 class="text-xl font-bold text-red-400 mb-4">Xác Nhận Đồng Bộ Lại</h4>
            <p class="text-[var(--text-color)] mb-6">Bạn có chắc chắn muốn **ĐỒNG BỘ LẠI** trạng thái giải đấu về dữ liệu mới nhất từ GitHub không? Điều này sẽ ghi đè trạng thái đang nhập cục bộ!</p>
            <div class="flex justify-end space-x-4">
                <button id="confirmNo" class="px-4 py-2 bg-gray-600 hover:bg-gray-500 text-white rounded-lg transition duration-150">Hủy bỏ</button>
                <button id="confirmYes" class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white font-bold rounded-lg transition duration-150">Xác nhận Đồng bộ</button>
            </div>
        </div>
    </div>

    <script>
        
        // ==============================================================================================================
        // KHỐI CẤU HÌNH GITHUB API & DỮ LIỆU (Phiên bản V6.4)
        // ==============================================================================================================
        const GITHUB_REPO_OWNER = 'cqtin2024';
        const GITHUB_REPO_NAME = 'ITVTG';
        
        const SCORE_FILE_PATH = 'data/state41s.json'; 
        const SCORE_API_URL = `https://api.github.com/repos/${GITHUB_REPO_OWNER}/${GITHUB_REPO_NAME}/contents/${SCORE_FILE_PATH}`;
        const DIFF_DATA_URL = `https://raw.githubusercontent.com/${GITHUB_REPO_OWNER}/${GITHUB_REPO_NAME}/main/${SCORE_FILE_PATH}`;

        const BASE_FILE_PATH = 'data/state41.json'; 
        const BASE_API_URL = `https://api.github.com/repos/${GITHUB_REPO_OWNER}/${GITHUB_REPO_NAME}/contents/${BASE_FILE_PATH}`;
        const STATIC_DATA_URL = `https://raw.githubusercontent.com/${GITHUB_REPO_OWNER}/${GITHUB_REPO_NAME}/main/${BASE_FILE_PATH}`;

        const BRANCH = 'main';
        const HIGH_SCORE_LIMIT = 11; // 🚩 LUẬT MỚI V6.4: Điểm tối đa để thắng một trận đấu.

        let tournamentData = null; 
        let initialTournamentData = null; 
        let githubToken = ''; 
        let startX = 0; 
        let endX = 0;  
        const swipeThreshold = 75; 
        
        const jsonToBase64 = (json) => btoa(unescape(encodeURIComponent(JSON.stringify(json, null, 2))));
        
        // ==============================================================================================================
        // --- HÀM HỖ TRỢ DỮ LIỆU ---
        // ==============================================================================================================

        function showStatus(message, type = 'info', elementId = 'statusMessage') { /* ... (Giữ nguyên) ... */ }
        function switchTab(tabId) { /* ... (Giữ nguyên) ... */ }
        function applyTheme(theme) { /* ... (Giữ nguyên) ... */ }
        function toggleTheme() { /* ... (Giữ nguyên) ... */ }
        function getTeamInfo(teamID) {
            if (!tournamentData || !tournamentData.tL || !teamID) return { Tn: teamID, T: teamID, W: 0, L: 0, Pts: 0, gR: 0, P: [] };
            
            const team = tournamentData.tL.find(t => t.T === teamID);
            
            return team || { Tn: teamID, T: teamID, W: 0, L: 0, Pts: 0, gR: 0, P: [] }; 
        }

        function findMatchByCode(matchCode) {
            if (!tournamentData) return null;
            const rounds = ['matchesA', 'matchesB', 'matchesC', 'matchesD', 'quarterfinals', 'semifinals'];
            for (const round of rounds) {
                if (tournamentData[round]) {
                    const match = tournamentData[round].find(m => m.Mc === matchCode);
                    if (match) return match;
                }
            }
            if (tournamentData.final && tournamentData.final.Mc === matchCode) {
                return tournamentData.final;
            }
            return null;
        }

        // ==============================================================================================================
        // 🚩 V6.4: LOGIC TÍNH TOÁN & RÀNG BUỘC ĐIỂM SỐ
        // ==============================================================================================================
        
        /** V6.4: Áp dụng ràng buộc HS và tính toán Wn/rU */
        window.handleInputScore = function(inputElement, matchCode, teamSide) {
            const value = parseInt(inputElement.value);
            
            // 1. Ràng buộc cơ bản
            if (isNaN(value) || value < 0) {
                inputElement.value = '';
                return; 
            }
            
            let match = findMatchByCode(matchCode);
            if (!match) return;

            // Cập nhật giá trị vào tournamentData cục bộ
            if (teamSide === 'A') {
                match.sA = value;
            } else {
                match.sB = value;
            }

            // 2. RÀNG BUỘC LUẬT HS KHI CẢ HAI TỈ SỐ ĐÃ ĐƯỢC NHẬP
            if (match.sA !== null && match.sB !== null) {
                const scoreA = match.sA;
                const scoreB = match.sB;
                
                // Trận đấu chưa hoàn thành (Chưa đạt tới điểm thắng tuyệt đối)
                if (scoreA < HIGH_SCORE_LIMIT && scoreB < HIGH_SCORE_LIMIT) {
                    // Cho phép nhập tiếp, nhưng cảnh báo nếu một bên đã đạt HS
                    if (scoreA > scoreB && scoreA === HIGH_SCORE_LIMIT - 1 && scoreB < HIGH_SCORE_LIMIT - 1) {
                         // Cảnh báo: Tỉ số đang sát nút
                    }
                } 
                // Trận đấu đã hoàn thành (Một bên đạt HS)
                else {
                    const winnerScore = Math.max(scoreA, scoreB);
                    const loserScore = Math.min(scoreA, scoreB);
                    
                    // Ràng buộc 1: Đội thắng phải là HS
                    if (winnerScore !== HIGH_SCORE_LIMIT) {
                         showStatus(`Theo luật HS=${HIGH_SCORE_LIMIT}, tỉ số đội thắng phải là ${HIGH_SCORE_LIMIT}. Đang tự động chỉnh thành ${HIGH_SCORE_LIMIT}.`, 'warning', 'statusMessage');
                         
                         // Tự động chỉnh tỉ số đội thắng về HS
                         if (scoreA > scoreB) { match.sA = HIGH_SCORE_LIMIT; inputElement.value = HIGH_SCORE_LIMIT; }
                         else { match.sB = HIGH_SCORE_LIMIT; inputElement.value = HIGH_SCORE_LIMIT; }
                         
                    }
                    
                    // Ràng buộc 2: Đội thua phải là < HS
                    if (loserScore >= HIGH_SCORE_LIMIT) {
                         showStatus(`Lỗi logic: Đội thua không thể đạt tỉ số ${HIGH_SCORE_LIMIT} hoặc hơn khi trận đấu kết thúc. Đã reset tỉ số.`, 'error', 'statusMessage');
                         // Reset tỉ số
                         match.sA = null; match.sB = null;
                         document.getElementById(`score-input-${match.Mc}-A`).value = '';
                         document.getElementById(`score-input-${match.Mc}-B`).value = '';
                         return; // Dừng xử lý
                    }
                }
            }

            // 3. Tính toán lại Wn, thống kê, và render UI
            calculateWinnerLoser(match);
            renderAllData(); 
            showStatus('Tỉ số đã được lưu cục bộ. Vui lòng COMMIT (Tab Cấu hình) để đồng bộ lên GitHub.', 'info', 'statusMessage');
        };

        /** V6.3: Cập nhật Wn (Winner) và rU (Runner-Up) */
        function calculateWinnerLoser(match) {
            if (match.sA === null || match.sB === null || (match.sA === 0 && match.sB === 0)) {
                match.Wn = "";
                if (match.Mc === 'F') match.rU = "";
                return;
            }

            const scoreA = match.sA;
            const scoreB = match.sB;
            
            if (scoreA > scoreB) {
                match.Wn = match.A;
                if (match.Mc === 'F') match.rU = match.B;
            } else if (scoreB > scoreA) {
                match.Wn = match.B;
                if (match.Mc === 'F') match.rU = match.A;
            } else {
                match.Wn = "";
                if (match.Mc === 'F') match.rU = "";
            }
        }
        
        /** V6.4: Tính toán lại W, L, Pts và gR (Group Rank) cho tất cả các đội. */
        function calculateGroupStatsAndRanks() {
            if (!tournamentData || !tournamentData.tL) return;
            
            // 1. Reset thống kê cho tất cả đội
            tournamentData.tL.forEach(team => {
                team.W = 0;
                team.L = 0;
                team.Pts = 0;
                team.mP = 0; 
                team.gR = 0; // Reset Rank
            });

            // 2. Lặp qua tất cả các trận đấu Vòng Bảng để tính W, L, Pts
            const groupMatches = [...(tournamentData.matchesA || []), ...(tournamentData.matchesB || []), ...(tournamentData.matchesC || []), ...(tournamentData.matchesD || [])];
            
            groupMatches.forEach(match => {
                if (match.Wn) { // Chỉ tính toán nếu trận đấu đã có người thắng
                    const winnerTeam = tournamentData.tL.find(t => t.T === match.Wn);
                    const loserTeamCode = match.Wn === match.A ? match.B : match.A;
                    const loserTeam = tournamentData.tL.find(t => t.T === loserTeamCode);
                    
                    if (winnerTeam) {
                        winnerTeam.W += 1;
                        winnerTeam.Pts += 3; // Giả định 3 điểm cho trận thắng
                        winnerTeam.mP += 1;
                    }
                    if (loserTeam) {
                        loserTeam.L += 1;
                        loserTeam.mP += 1;
                    }
                }
            });

            // 3. Tính toán gR (Group Rank) cho từng nhóm
            const groupCodes = ['A', 'B', 'C', 'D'];
            groupCodes.forEach(code => {
                let groupTeams = tournamentData.tL.filter(t => t.g === code && t.mP > 0); // Chỉ xếp hạng đội đã thi đấu
                
                // Sắp xếp theo tiêu chí: Pts (cao nhất), W (cao nhất), L (thấp nhất)
                groupTeams.sort((a, b) => {
                    if ((b.Pts || 0) !== (a.Pts || 0)) return (b.Pts || 0) - (a.Pts || 0); // 1. Points
                    if ((b.W || 0) !== (a.W || 0)) return (b.W || 0) - (a.W || 0); // 2. Wins
                    return (a.L || 0) - (b.L || 0); // 3. Losses
                });
                
                // Gán gR
                groupTeams.forEach((team, index) => {
                    team.gR = index + 1;
                });
            });
        }

        // ==============================================================================================================
        // 🚩 V6.4: LOGIC TEAM MANAGEMENT & DIFF
        // ==============================================================================================================

        /**
         * V6.4: Lưu các thay đổi về thông tin đội (Tn, name, pL, bY) vào biến tournamentData cục bộ.
         */
        window.saveTeamChangesToLocal = function() {
            if (!tournamentData || !tournamentData.tL) {
                showStatus('Lỗi: Không có dữ liệu để lưu.', 'error', 'teamCommitResult');
                return;
            }
            
            let changesDetected = false;
            
            tournamentData.tL.forEach(team => {
                // Cập nhật Nickname (Tn)
                const tnInput = document.getElementById(`team-tn-${team.T}`);
                if (tnInput && tnInput.value !== team.Tn) {
                    team.Tn = tnInput.value;
                    changesDetected = true;
                }

                // Cập nhật thông tin Người chơi (name, pL, bY)
                team.P.forEach((player, index) => {
                    const nameInput = document.getElementById(`player-name-${team.T}-${index}`);
                    const pLInput = document.getElementById(`player-pl-${team.T}-${index}`);
                    const bYInput = document.getElementById(`player-by-${team.T}-${index}`);

                    if (nameInput && nameInput.value !== player.name) {
                        player.name = nameInput.value;
                        changesDetected = true;
                    }
                    // pL cần được parse thành float
                    if (pLInput && parseFloat(pLInput.value) !== player.pL) {
                        player.pL = parseFloat(pLInput.value);
                        changesDetected = true;
                    }
                    if (bYInput && bYInput.value !== player.bY) {
                        player.bY = bYInput.value;
                        changesDetected = true;
                    }
                });
            });
            
            if (changesDetected) {
                renderAllData(); 
                showStatus('Đã lưu các thay đổi đội CỤC BỘ vào bộ nhớ trình duyệt. Vui lòng COMMIT TỈ SỐ (Tab Cấu hình) để đồng bộ lên GitHub.', 'success', 'teamCommitResult');
            } else {
                showStatus('Không có thay đổi nào được phát hiện để lưu.', 'info', 'teamCommitResult');
            }
        }
        
        /**
         * V6.4: Lọc ra những thay đổi (diff) (tỉ số + team info) giữa dữ liệu hiện tại và dữ liệu khởi tạo.
         */
        function getDiffData() {
             if (!tournamentData || !initialTournamentData) return null;

             let diff = {};
             let diffFound = false;
             
             // 1. So sánh Tỉ số (sA, sB) trong các trận đấu (Matches Diff)
             // [Logic so sánh tỉ số (đã có) - Giữ nguyên]

             // 2. So sánh thông tin đội (tL Diff) - LOGIC MỚI V6.4
             const teamDiff = [];
             tournamentData.tL.forEach((currentTeam, index) => {
                 const initialTeam = initialTournamentData.tL[index];

                 // So sánh các trường có thể chỉnh sửa: Tn, P
                 // Dùng JSON.stringify để so sánh mảng P
                 if (currentTeam.Tn !== initialTeam.Tn || JSON.stringify(currentTeam.P) !== JSON.stringify(initialTeam.P)) {
                     // Chỉ thêm các trường cần thiết để cập nhật lên state41s.json
                     teamDiff.push({ 
                         T: currentTeam.T,
                         Tn: currentTeam.Tn,
                         P: currentTeam.P,
                         gR: currentTeam.gR,
                     });
                     diffFound = true;
                 }
             });

             if (teamDiff.length > 0) {
                 diff.tL = teamDiff;
             }
             
             // Gộp tất cả diff (tỉ số và team) vào đối tượng diff và trả về
             if (diffFound || (diff.matchesA || diff.matchesB || diff.matchesC || diff.matchesD || diff.quarterfinals || diff.semifinals || diff.final)) {
                  // ... (Logic gán lại matchesDiff vào diff)
                  return diff;
             }

             return null;
        }


        // ==============================================================================================================
        // 🚩 V6.4: LOGIC KNOCKOUT SEEDING & UI RENDERING
        // ==============================================================================================================
        
        /**
         * V6.4: Tự động điền các cặp Tứ Kết (Quarterfinals) dựa trên luật Seeding.
         */
        window.seedKnockoutMatches = function() {
            if (!tournamentData || !tournamentData.tL) {
                 return showStatus('Lỗi: Không có dữ liệu đội để Seeding.', 'error', 'seedingStatus');
            }

            // Luật Seeding mặc định: 1A vs 2B, 1C vs 2D, 1B vs 2A, 1D vs 2C
            const seedingOrder = [
                { Mc: 'QF1', A_Group: 'A', A_Rank: 1, B_Group: 'B', B_Rank: 2 }, 
                { Mc: 'QF2', A_Group: 'C', A_Rank: 1, B_Group: 'D', B_Rank: 2 }, 
                { Mc: 'QF3', A_Group: 'B', A_Rank: 1, B_Group: 'A', B_Rank: 2 }, 
                { Mc: 'QF4', A_Group: 'D', A_Rank: 1, B_Group: 'C', B_Rank: 2 }  
            ];
            
            // ... (Logic khởi tạo tournamentData.quarterfinals nếu cần) ...
            
            let allTeamsFound = true;
            let seededCount = 0;
            
            seedingOrder.forEach(seed => {
                const teamA = getTeamInfo(getGroupRankedTeam(seed.A_Group, seed.A_Rank)); // Lấy Team ID
                const teamB = getTeamInfo(getGroupRankedTeam(seed.B_Group, seed.B_Rank)); // Lấy Team ID

                if (teamA.T && teamB.T) {
                    const qfMatch = tournamentData.quarterfinals.find(m => m.Mc === seed.Mc);
                    if (qfMatch) {
                        qfMatch.A = teamA.T;
                        qfMatch.B = teamB.T;
                        seededCount++;
                    }
                } else {
                    allTeamsFound = false;
                }
            });

            if (allTeamsFound) {
                showStatus(`XẾP CẶP TỨ KẾT THÀNH CÔNG: Đã điền ${seededCount} cặp đấu. Vui lòng COMMIT THÔNG TIN ĐỘI để lưu thay đổi này vào BASE file.`, 'success', 'seedingStatus');
            } else {
                 showStatus(`XẾP CẶP TỨ KẾT CHƯA HOÀN THÀNH: Thiếu đội xếp hạng (gR) từ một hoặc nhiều Bảng đấu. Cần hoàn thành tỉ số Vòng Bảng và tính toán lại xếp hạng trước.`, 'warning', 'seedingStatus');
            }
            
            updateSemiFinalSeeding(); 
            renderAllData();
        }

        /** V6.4: Cập nhật cặp Bán kết (SF) và Chung kết (F) */
        function updateSemiFinalSeeding() {
             // ... (Logic giữ nguyên, đảm bảo cập nhật Wn/rU từ các vòng trước) ...
        }

        // ==============================================================================================================
        // 🚩 V6.4: RENDERING CORE
        // ==============================================================================================================

        /** V6.4: Render danh sách đội chi tiết lên Tab General (FIX LỖI) */
        function renderTeamList() {
            const container = document.getElementById('teamList');
            if (!container || !tournamentData || !tournamentData.tL) return;
            
            container.innerHTML = ''; 

            tournamentData.tL.forEach(team => {
                const teamElement = document.createElement('div');
                teamElement.className = 'p-4 rounded-xl shadow-lg bg-[var(--match-bg)] border border-[var(--border-color)] hover:border-[var(--accent-color)] transition duration-200';
                
                let playerDetails = team.P.map(player => `
                    <span class="text-xs text-gray-400">👤 ${player.name} (${player.pL})</span>
                `).join('<br>');
                
                const stats = `
                    <div class="mt-2 pt-2 border-t border-[var(--border-color)] text-sm">
                        <span class="text-green-400 font-bold">Thắng: ${team.W || 0}</span> | 
                        <span class="text-red-400 font-bold">Thua: ${team.L || 0}</span> | 
                        <span class="text-blue-400 font-bold">Điểm: ${team.Pts || 0}</span> |
                        <span class="text-yellow-400 font-bold">Hạng (gR): ${team.gR || 'N/A'}</span>
                    </div>
                `;
                
                teamElement.innerHTML = `
                    <h3 class="text-xl font-bold text-[var(--accent-color)]">${team.T} (${team.Tn})</h3>
                    <p class="text-sm text-gray-400 mb-2">Group ${team.g} | Level ${team.aPL}</p>
                    <div class="space-y-1">${playerDetails}</div>
                    ${stats}
                `;
                container.appendChild(teamElement);
            });
        }

        /** V6.4: Render bảng xếp hạng Vòng Bảng (FIX LỖI HIỂN THỊ '0') */
        function renderGroupTables(groupCode) {
            const containerId = `table${groupCode}`;
            const container = document.getElementById(containerId);
            if (!container || !tournamentData || !tournamentData.tL) return;

            const teams = tournamentData.tL
                .filter(team => team.g === groupCode)
                .sort((a, b) => (a.gR || 99) - (b.gR || 99));

            let tableHtml = `
                <h3 class="text-xl md:text-2xl font-bold text-[var(--group-header-text)] mb-4">
                    Bảng Xếp Hạng Bảng ${groupCode}
                </h3>
                <div class="bg-[var(--match-bg)] rounded-lg shadow-lg overflow-hidden">
                    <table class="min-w-full divide-y divide-[var(--border-color)]">
                        <thead class="bg-[var(--card-bg)]">
                            <tr>
                                <th class="px-2 py-2 text-center text-xs font-medium text-gray-400 uppercase tracking-wider">Hạng</th>
                                <th class="px-2 py-2 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Đội</th>
                                <th class="px-2 py-2 text-center text-xs font-medium text-gray-400 uppercase tracking-wider">T</th>
                                <th class="px-2 py-2 text-center text-xs font-medium text-gray-400 uppercase tracking-wider">B</th>
                                <th class="px-2 py-2 text-center text-xs font-medium text-gray-400 uppercase tracking-wider">Điểm</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-[var(--border-color)]">
            `;

            teams.forEach(team => {
                tableHtml += `
                    <tr class="hover:bg-[var(--card-bg)] transition duration-150">
                        <td class="px-2 py-1 border-b border-[var(--border-color)] text-center text-lg font-bold ${team.gR === 1 || team.gR === 2 ? 'text-green-500' : 'text-gray-400'}">${team.gR || 'N/A'}</td>
                        <td class="px-2 py-1 border-b border-[var(--border-color)] font-semibold text-sm">${team.Tn}</td>
                        <td class="px-2 py-1 border-b border-[var(--border-color)] text-center text-sm">${team.W || 0}</td>
                        <td class="px-2 py-1 border-b border-[var(--border-color)] text-center text-sm">${team.L || 0}</td>
                        <td class="px-2 py-1 border-b border-[var(--border-color)] text-center font-bold text-yellow-400 text-sm">${team.Pts || 0}</td>
                    </tr>
                `;
            });

            tableHtml += `
                        </tbody>
                    </table>
                </div>
            `;
            container.innerHTML = tableHtml;
        }


        /** V6.4: Render danh sách trận đấu Vòng Bảng (FIX LỖI HIỂN THỊ Tn, t, c) */
        function renderGroupMatches(groupCode) {
            const containerId = `matches${groupCode}`;
            const container = document.getElementById(containerId);
            if (!container || !tournamentData) return;

            const matches = tournamentData[`matches${groupCode}`];
            if (!matches) {
                container.innerHTML = `<p class="text-center text-gray-500">Chưa có dữ liệu trận đấu cho Bảng ${groupCode}.</p>`;
                return;
            }

            container.innerHTML = `
                <h3 class="text-xl md:text-2xl font-bold text-[var(--group-header-text)] mb-4">
                    Danh Sách Trận Đấu Bảng ${groupCode}
                </h3>
                <button onclick="commitScoreChangesToGitHub()" class="w-full md:w-auto px-4 py-2 bg-purple-600 hover:bg-purple-700 text-white font-bold rounded-lg shadow-lg transition duration-300 mb-4 text-sm disabled:opacity-50">
                    COMMIT TỈ SỐ & THAY ĐỔI ĐỘI
                </button>
            `;

            matches.forEach((match) => {
                // Lấy thông tin đội chi tiết
                const teamAInfo = getTeamInfo(match.A);
                const teamBInfo = getTeamInfo(match.B);

                // Xác định lớp màu cho đội thắng/thua
                const classA = match.Wn === match.A ? 'font-black text-green-400' : (match.Wn === match.B ? 'text-red-400 opacity-75' : 'font-semibold');
                const classB = match.Wn === match.B ? 'font-black text-green-400' : (match.Wn === match.A ? 'text-red-400 opacity-75' : 'font-semibold');

                const matchHtml = `
                    <div class="match-card p-3 rounded-lg flex flex-col md:flex-row items-center justify-between mb-2 transition duration-150" data-match-id="${match.Mc}">
                        
                        <div class="flex-shrink-0 text-xs text-gray-400 mb-2 md:mb-0 md:w-[20%] text-center md:text-left">
                            <span class="block font-bold text-[var(--accent-color)]">${match.t || 'N/A'}</span>
                            <span class="block">${match.c || 'N/A'}</span>
                        </div>
                        
                        <div class="flex flex-col space-y-2 w-full md:w-[80%]">
                            
                            <div class="flex items-center justify-between">
                                <span class="text-sm md:text-base w-3/4 truncate ${classA}" title="${teamAInfo.Tn}">${teamAInfo.Tn} (${match.A})</span>
                                <input type="number" 
                                        class="score-input w-1/4 max-w-[60px] p-1 text-center rounded-md text-sm" 
                                        value="${match.sA !== null ? match.sA : ''}" 
                                        min="0" 
                                        id="score-input-${match.Mc}-A"
                                        data-match="${match.Mc}" 
                                        data-team="A" 
                                        onchange="handleInputScore(this, '${match.Mc}', 'A')"
                                        placeholder="0">
                            </div>
                            
                            <div class="flex items-center justify-between">
                                <span class="text-sm md:text-base w-3/4 truncate ${classB}" title="${teamBInfo.Tn}">${teamBInfo.Tn} (${match.B})</span>
                                <input type="number" 
                                        class="score-input w-1/4 max-w-[60px] p-1 text-center rounded-md text-sm" 
                                        value="${match.sB !== null ? match.sB : ''}" 
                                        min="0" 
                                        id="score-input-${match.Mc}-B"
                                        data-match="${match.Mc}" 
                                        data-team="B" 
                                        onchange="handleInputScore(this, '${match.Mc}', 'B')"
                                        placeholder="0">
                            </div>
                        </div>
                    </div>
                `;
                container.innerHTML += matchHtml;
            });
        }

        // ... (renderKnockoutMatches, renderTeamManagement, renderFinalResults - cần gọi)

        /** Hàm chính để render lại toàn bộ giao diện sau khi thay đổi dữ liệu */
        function renderAllData() { 
             console.log("Rendering all data for V6.4..."); 
             
             // 1. Hợp nhất tất cả các trận đấu và tính toán Wn/rU
             const allRounds = [...(tournamentData.matchesA || []), ...(tournamentData.matchesB || []), ...(tournamentData.matchesC || []), ...(tournamentData.matchesD || []), ...(tournamentData.quarterfinals || []), ...(tournamentData.semifinals || []), tournamentData.final];
             allRounds.forEach(match => match && calculateWinnerLoser(match));
             
             // 2. TÍNH TOÁN THỐNG KÊ VÒNG BẢNG (FIX LỖI HIỂN THỊ '0')
             calculateGroupStatsAndRanks(); 
             
             // 3. Cập nhật Seeding cho các vòng loại
             updateSemiFinalSeeding(); 
             
             // 4. Render các thành phần UI (FIX LỖI ĐỒNG BỘ)
             renderFinalResults(); 
             renderTeamList(); 
             renderTeamManagement(); // Cần render lại để cập nhật Tn, Name

             renderGroupTables('A'); renderGroupMatches('A'); 
             renderGroupTables('B'); renderGroupMatches('B'); 
             renderGroupTables('C'); renderGroupMatches('C'); 
             renderGroupTables('D'); renderGroupMatches('D'); 
             
             // ... (Logic vô hiệu hóa nút Seeding - giữ nguyên)
        }
        
        // ... (Các hàm loadDataFromGitHub, initializeApp, etc.)

        window.onload = initializeApp;
    </script>
</body>
</html>
