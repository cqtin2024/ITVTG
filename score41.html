<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quản Lý Giải Đấu & Cập Nhật Thông Tin (GitHub Sync) V4</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100;400;700;900&display=swap" rel="stylesheet">
    <style>
        /* Base styles for Dark Mode */
        :root {
            --bg-color: #111827; /* Gray-900 */
            --text-color: #f3f4f6; /* Gray-100 */
            --card-bg: #1f2937; /* Gray-800 */
            --border-color: #374151; /* Gray-700 */
            --accent-color: #06b6d4; /* Cyan-500 */
            --match-bg: #1f2937;
            --input-bg: #4b5563; /* Gray-600 */
            --group-header-text: #60a5fa; /* Blue-400 */
        }
        
        /* Light Mode Overrides */
        .light-mode {
            --bg-color: #f9fafb; /* Gray-50 */
            --text-color: #111827; /* Gray-900 */
            --card-bg: #ffffff; /* White */
            --border-color: #d1d5db; /* Gray-300 */
            --accent-color: #0d9488; /* Teal-600 */
            --match-bg: #f3f4f6; /* Gray-100 */
            --input-bg: #e5e7eb; /* Gray-200 */
            --group-header-text: #1d4ed8; /* Blue-700 */
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: 'Inter', sans-serif;
            transition: background-color 0.3s;
        }

        .tab-button {
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            font-weight: 700;
            color: var(--text-color);
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            transition: background-color 0.2s, border-color 0.2s;
        }

        .tab-button:hover {
            background-color: var(--border-color);
        }

        .tab-button.active {
            background-color: var(--accent-color);
            color: var(--bg-color);
            border-color: var(--accent-color);
        }

        .tab-content {
            padding-top: 1rem;
        }
        
        .score-input {
            background-color: var(--input-bg);
            color: var(--text-color);
            border: 1px solid var(--border-color);
        }
        
        .score-input:disabled {
            background-color: #374151; /* Gray-700 */
            color: #9ca3af; /* Gray-400 */
            cursor: not-allowed;
        }
        
        .text-input {
            background-color: var(--input-bg);
            color: var(--text-color);
            border: 1px solid var(--border-color);
            width: 100%;
        }

        /* Custom scrollbar for better visibility */
        .overflow-x-auto::-webkit-scrollbar {
            height: 8px;
        }
        
        .overflow-x-auto::-webkit-scrollbar-thumb {
            background: var(--accent-color);
            border-radius: 4px;
        }
        
        .overflow-x-auto::-webkit-scrollbar-track {
            background: var(--border-color);
        }
    </style>
</head>
<body class="min-h-screen">
    <div id="app" class="max-w-4xl mx-auto p-4 md:p-8">
        <header class="mb-6">
            <h1 class="text-3xl font-black text-white mb-2 flex justify-between items-center">
                <span>ITVTG SCOREBOARD V4</span>
                <button id="themeToggle" class="p-2 rounded-full bg-gray-700 hover:bg-gray-600 transition duration-150" title="Chuyển đổi chủ đề">
                    <svg id="moonIcon" class="w-6 h-6 text-yellow-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path></svg>
                    <svg id="sunIcon" class="w-6 h-6 text-yellow-400 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>
                </button>
            </h1>
            <p class="text-sm text-gray-400">Công cụ Quản lý Dữ liệu và Tỉ số Giải Đấu (Dữ liệu chung: `tL`, `matches`, `teamStandings`)</p>
            
            <div id="statusMessage" class="mt-3 p-3 text-sm text-white font-medium rounded-lg hidden" role="alert"></div>
        </header>

        <nav class="mb-6 overflow-x-auto">
            <div class="flex space-x-2 pb-2">
                <button class="tab-button active" data-tab="General" onclick="switchTab('General')">Tổng Quan</button>
                <button class="tab-button" data-tab="GroupA" onclick="switchTab('GroupA')">Bảng A</button>
                <button class="tab-button" data-tab="GroupB" onclick="switchTab('GroupB')">Bảng B</button>
                <button class="tab-button" data-tab="GroupC" onclick="switchTab('GroupC')">Bảng C</button>
                <button class="tab-button" data-tab="GroupD" onclick="switchTab('GroupD')">Bảng D</button>
                <button class="tab-button" data-tab="Knockout" onclick="switchTab('Knockout')">Vòng Loại</button>
                <button class="tab-button" data-tab="TeamManagement" onclick="switchTab('TeamManagement')">QL Đội</button>
                <button class="tab-button" data-tab="Config" onclick="switchTab('Config')">Cấu Hình</button>
            </div>
        </nav>

        <div id="General" class="tab-content">
            <h2 class="text-2xl font-extrabold text-[var(--accent-color)] mb-4 border-b border-[var(--border-color)] pb-2">Thông Tin Giải Đấu</h2>
            <div id="finalResults" class="mb-8">
                </div>
            
            <h2 class="text-2xl font-extrabold text-[var(--accent-color)] mb-4 border-b border-[var(--border-color)] pb-2">Danh Sách Đội</h2>
            <div id="teamList" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                </div>
        </div>

        <div id="GroupA" class="tab-content hidden grid-cols-1 lg:grid-cols-2 gap-6">
            <div id="tableA">
                </div>
            <div id="matchesA">
                </div>
        </div>

        <div id="GroupB" class="tab-content hidden grid-cols-1 lg:grid-cols-2 gap-6">
            <div id="tableB">
                </div>
            <div id="matchesB">
                </div>
        </div>

        <div id="GroupC" class="tab-content hidden grid-cols-1 lg:grid-cols-2 gap-6">
            <div id="tableC">
                </div>
            <div id="matchesC">
                </div>
        </div>

        <div id="GroupD" class="tab-content hidden grid-cols-1 lg:grid-cols-2 gap-6">
            <div id="tableD">
                </div>
            <div id="matchesD">
                </div>
        </div>

        <div id="Knockout" class="tab-content hidden grid-cols-1 lg:grid-cols-3 gap-6">
            <div id="quarterfinals" class="lg:col-span-1">
                </div>
            <div id="semifinals" class="lg:col-span-1">
                </div>
            <div id="finalSection" class="lg:col-span-1">
                </div>
        </div>

        <div id="TeamManagement" class="tab-content hidden">
            <h2 class="text-2xl font-extrabold text-blue-400 mb-4 border-b border-[var(--border-color)] pb-2">Quản Lý Chi Tiết Đội (Ghi đè `state4.json`)</h2>
            <div id="teamManagementList" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                </div>
            <div class="mt-6 p-4 bg-red-900/40 rounded-lg border border-red-700">
                <p class="font-bold text-red-300 mb-2">Cảnh báo:</p>
                <p class="text-sm text-red-200">Thao tác này sẽ **ghi đè** toàn bộ file `state4.json` trên GitHub. Chỉ sử dụng khi bạn chắc chắn muốn cập nhật tên đội/người chơi/thông tin cơ bản của giải đấu. KHÔNG dùng để cập nhật tỉ số.</p>
                <button id="commitTeamButton" onclick="commitTeamChangesToGitHub()" class="mt-3 w-full py-2 bg-red-600 hover:bg-red-700 text-white font-bold rounded-lg transition duration-200 disabled:bg-red-800">CẬP NHẬT THÔNG TIN ĐỘI (Ghi đè state4.json)</button>
                <div id="teamCommitResult" class="mt-3 p-3 text-sm text-white font-medium rounded-lg hidden"></div>
            </div>
        </div>

        <div id="Config" class="tab-content hidden">
            <h2 class="text-2xl font-extrabold text-[var(--accent-color)] mb-4 border-b border-[var(--border-color)] pb-2">Cấu Hình & Đồng Bộ GitHub</h2>
            
            <div class="p-6 bg-[var(--card-bg)] rounded-lg shadow-xl mb-6 border border-[var(--border-color)]">
                <h3 class="text-xl font-bold text-[var(--group-header-text)] mb-3">1. GitHub Personal Access Token (PAT)</h3>
                <input type="password" id="githubToken" placeholder="Nhập GitHub PAT (cần quyền repo)" class="text-input p-3 rounded-lg mb-3" onchange="saveToken()">
                <button onclick="saveToken()" class="w-full py-2 bg-green-600 hover:bg-green-700 text-white font-bold rounded-lg transition duration-200">LƯU/CẬP NHẬT Token</button>
            </div>

            <div class="p-6 bg-[var(--card-bg)] rounded-lg shadow-xl mb-6 border border-[var(--border-color)]">
                <h3 class="text-xl font-bold text-[var(--group-header-text)] mb-3">2. COMMIT TỈ SỐ (Chỉ lưu thay đổi vào `state4s.json`)</h3>
                <p class="text-sm text-gray-400 mb-4">Nhấn nút này để đồng bộ **tất cả tỉ số đã thay đổi** với dữ liệu gốc lên GitHub.</p>
                <button id="commitScoreButton" onclick="commitScoreChangesToGitHub()" class="w-full py-2 bg-[var(--accent-color)] hover:bg-cyan-600 text-white font-bold rounded-lg transition duration-200 disabled:bg-gray-600">COMMIT TỈ SỐ ĐÃ THAY ĐỔI</button>
                <div id="scoreCommitResult" class="mt-3 p-3 text-sm text-white font-medium rounded-lg hidden"></div>
            </div>
            
            <div class="p-6 bg-[var(--card-bg)] rounded-lg shadow-xl mb-6 border border-yellow-500/50">
                <h3 class="text-xl font-bold text-yellow-500 mb-3">3. Đồng Bộ Lại Dữ Liệu</h3>
                <p class="text-sm text-gray-400 mb-4">Tải lại dữ liệu gốc từ GitHub. Sử dụng khi có lỗi hoặc người khác vừa cập nhật data.</p>
                <button onclick="showConfirmationModal()" class="w-full py-2 bg-yellow-600 hover:bg-yellow-700 text-white font-bold rounded-lg transition duration-200">ĐỒNG BỘ LẠI (RE-SYNC)</button>
            </div>
        </div>
        
        <div id="confirmationBox" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 hidden z-50">
            <div class="bg-[var(--card-bg)] p-6 rounded-lg shadow-2xl max-w-sm w-full border border-[var(--border-color)]">
                <p class="text-lg font-bold text-red-500 mb-4">Xác Nhận Đồng Bộ Lại</p>
                <p class="text-sm mb-6">Thao tác này sẽ xóa **toàn bộ tỉ số chưa COMMIT** của bạn và tải lại dữ liệu mới nhất từ GitHub. Bạn có chắc chắn muốn tiếp tục?</p>
                <div class="flex justify-end space-x-3">
                    <button id="confirmNo" class="py-2 px-4 bg-gray-600 hover:bg-gray-700 rounded-lg text-white font-medium transition">Hủy</button>
                    <button id="confirmYes" class="py-2 px-4 bg-red-600 hover:bg-red-700 rounded-lg text-white font-medium transition">Đồng Bộ Ngay</button>
                </div>
            </div>
        </div>

    </div>

    <script>
        /*
        * ==============================================================================================================
        * KHỐI MÃ JAVASCRIPT ĐÃ CẬP NHẬT (Refactored for state41.json)
        * Dữ liệu mới: tL, matches, teamStandings
        * ==============================================================================================================
        */
        const GITHUB_REPO_OWNER = 'cqtin2024';
        const GITHUB_REPO_NAME = 'ITVTG';

        // state4s.json: Chỉ lưu các cập nhật tỉ số (sA, sB) bằng index trong mảng 'matches'
        const SCORE_FILE_PATH = 'data/state4s.json'; 
        const SCORE_API_URL = `https://api.github.com/repos/${GITHUB_REPO_OWNER}/${GITHUB_REPO_NAME}/contents/${SCORE_FILE_PATH}`;
        const DIFF_DATA_URL = `https://raw.githubusercontent.com/${GITHUB_REPO_OWNER}/${GITHUB_REPO_NAME}/main/${SCORE_FILE_PATH}`;

        // state4.json: Lưu dữ liệu gốc (tL, teamStandings, matches, TournamentInfo)
        const BASE_FILE_PATH = 'data/state4.json'; 
        const BASE_API_URL = `https://api.github.com/repos/${GITHUB_REPO_OWNER}/${GITHUB_REPO_NAME}/contents/${BASE_FILE_PATH}`;
        const STATIC_DATA_URL = `https://raw.githubusercontent.com/${GITHUB_REPO_OWNER}/${GITHUB_REPO_NAME}/main/${BASE_FILE_PATH}`;

        const BRANCH = 'main';

        let Tdata = null; // Live Tournament Data
        let Idata = null; // Initial Tournament Data (Base for calculating diff)
        let githubToken = ''; 
        let startX = 0; 
        let endX = 0;   
        const swipeThreshold = 75; 
        const groupCodes = ['GA', 'GB', 'GC', 'GD'];
        const knockoutCodes = ['QF', 'SF', 'F'];


        // Hàm chuyển đổi JSON sang Base64
        const jsonToBase64 = (json) => btoa(unescape(encodeURIComponent(JSON.stringify(json, null, 2))));

        // --- CHỨC NĂNG TƯƠNG TÁC GITHUB CHUNG ---

        function saveToken() {
            const tokenInput = document.getElementById('githubToken').value.trim();
            if (tokenInput.length > 0 && tokenInput !== '********') {
                githubToken = tokenInput;
                localStorage.setItem('githubToken', githubToken);
                showStatus('Token đã được lưu cục bộ. Hãy thử COMMIT.', 'success', 'scoreCommitResult');
                showStatus('Token đã được lưu cục bộ. Hãy thử COMMIT.', 'success', 'teamCommitResult');
                document.getElementById('githubToken').value = '********';
            } else if (tokenInput.length === 0) {
                 githubToken = '';
                 localStorage.removeItem('githubToken');
                 showStatus('Token đã bị xóa khỏi bộ nhớ cục bộ.', 'info', 'scoreCommitResult');
                 showStatus('Token đã bị xóa khỏi bộ nhớ cục bộ.', 'info', 'teamCommitResult');
                 document.getElementById('githubToken').value = '';
            } else {
                 showStatus('Vui lòng nhập Token mới hoặc Token đã được lưu.', 'info', 'scoreCommitResult');
                 showStatus('Vui lòng nhập Token mới hoặc Token đã được lưu.', 'info', 'teamCommitResult');
            }
        }

        function showStatus(message, type = 'info', elementId = 'statusMessage') {
            const statusElement = document.getElementById(elementId);
            if (!statusElement) return;

            statusElement.innerHTML = message;
            statusElement.classList.remove('hidden', 'bg-red-900/50', 'bg-green-900/50', 'bg-blue-900/50', 'bg-orange-900/50');
            
            if (type === 'success') {
                statusElement.classList.add('bg-green-900/50');
            } else if (type === 'error') {
                statusElement.classList.add('bg-red-900/50');
            } else if (type === 'warning') {
                 statusElement.classList.add('bg-orange-900/50');
            } else {
                 statusElement.classList.add('bg-blue-900/50');
            }
            statusElement.style.display = 'block';

            if (type !== 'error') {
                setTimeout(() => statusElement.style.display = 'none', 5000);
            }
        }

        async function getShaAndCommit(fileUrl, contentBase64, commitMessage, buttonId, resultElementId) {
            const pat = githubToken.trim();
            const commitButton = document.getElementById(buttonId);
            commitButton.disabled = true;
            commitButton.textContent = 'Đang tiến hành...';

            let sha = null;
            
            try {
                showStatus('Đang lấy SHA hiện tại của file...', 'info', resultElementId);

                const shaResponse = await fetch(fileUrl + `?ref=${BRANCH}`, {
                    headers: { 'Authorization': `Bearer ${pat}` }
                });

                if (shaResponse.status === 404) {
                    showStatus('File chưa tồn tại trên nhánh, sẽ tạo mới.', 'info', resultElementId);
                } else if (shaResponse.status === 401) {
                    const errorJson = await shaResponse.json();
                    throw new Error(`401 Unauthorized: ${errorJson.message || 'Token không hợp lệ hoặc thiếu quyền "repo".'}`);
                } else if (!shaResponse.ok) {
                    const errorJson = await shaResponse.json();
                    throw new Error(`Lỗi API khi lấy SHA: ${shaResponse.status} - ${errorJson.message || shaResponse.statusText}`);
                } else {
                    const data = await shaResponse.json();
                    sha = data.sha;
                    showStatus(`Đã lấy SHA file thành công. SHA: ${sha.substring(0, 10)}...`, 'info', resultElementId);
                }
                
                commitButton.textContent = 'Đang Commit (PUT)...';
                
                const payload = {
                    message: commitMessage,
                    content: contentBase64,
                    branch: BRANCH
                };
                if (sha) {
                    payload.sha = sha;
                }

                const commitResponse = await fetch(fileUrl, {
                    method: 'PUT',
                    headers: { 
                        'Authorization': `Bearer ${pat}`,
                        'Content-Type': 'application/json',
                        'Accept': 'application/vnd.github.v3+json'
                    },
                    body: JSON.stringify(payload)
                });

                if (commitResponse.status === 401) {
                    const errorJson = await commitResponse.json();
                    throw new Error(`401 Unauthorized: ${errorJson.message || 'Token không hợp lệ hoặc thiếu quyền "repo". Vui lòng kiểm tra lại Token của bạn.'}`);
                } else if (!commitResponse.ok) {
                    const errorData = await commitResponse.json();
                    throw new Error(`Commit thất bại: Status ${commitResponse.status}. ${errorData.message || 'Lỗi không xác định.'}`);
                }

                const result = await commitResponse.json();
                showStatus(`COMMIT THÀNH CÔNG! Dữ liệu đã được cập nhật trên GitHub. <br>Commit SHA: <a href="${result.commit.html_url}" target="_blank" class="text-white underline">${result.commit.sha.substring(0, 7)}</a>`, 'success', resultElementId);
                
            } catch (error) {
                console.error("Lỗi Commit GitHub:", error);
                showStatus(`LỖI COMMIT: ${error.message}`, 'error', resultElementId);
            } finally {
                if(buttonId === 'commitScoreButton') commitButton.textContent = 'COMMIT TỈ SỐ ĐÃ THAY ĐỔI';
                if(buttonId === 'commitTeamButton') commitButton.textContent = 'CẬP NHẬT THÔNG TIN ĐỘI (Ghi đè state4.json)';
                commitButton.disabled = false;
            }
        }


        // --- LOGIC CẬP NHẬT ĐIỂM SỐ (state4s.json) ---

        /**
         * Tạo dữ liệu diff chỉ chứa các tỉ số đã thay đổi so với dữ liệu gốc (Idata).
         * Dùng index trong mảng matches chung để xác định vị trí.
         */
        function getDiffData() {
            if (!Tdata || !Idata || !Tdata.matches || !Idata.matches) return null;

            const diffData = {
                matches_updates: []
            };
            
            Tdata.matches.forEach((liveMatch, index) => {
                const initialMatch = Idata.matches[index];

                // Chỉ so sánh sA và sB (Tỉ số)
                if (liveMatch.sA !== initialMatch.sA || liveMatch.sB !== initialMatch.sB) {
                    diffData.matches_updates.push({
                        i: index, 
                        sA: liveMatch.sA,
                        sB: liveMatch.sB
                    });
                }
            });

            if (diffData.matches_updates.length > 0) {
                return diffData;
            }
            return null;
        }

        window.commitScoreChangesToGitHub = async function() {
            githubToken = localStorage.getItem('githubToken') || ''; 
            if (!githubToken || githubToken.trim().length === 0) {
                showStatus('Lỗi: Vui lòng nhập và lưu GitHub Token trước.', 'error', 'scoreCommitResult');
                return;
            }

            const diffData = getDiffData();
            
            if (!diffData) {
                showStatus('Không có thay đổi tỉ số nào được ghi nhận so với dữ liệu gốc.', 'info', 'scoreCommitResult');
                return;
            }
            
            const base64Content = jsonToBase64(diffData);
            const commitMessage = 'Update match scores via web app (state4s.json - New Structure)';
            
            await getShaAndCommit(SCORE_API_URL, base64Content, commitMessage, 'commitScoreButton', 'scoreCommitResult');
        };

        // --- LOGIC CẬP NHẬT THÔNG TIN ĐỘI (state4.json) ---

        window.commitTeamChangesToGitHub = async function() {
            githubToken = localStorage.getItem('githubToken') || ''; 
            if (!githubToken || githubToken.trim().length === 0) {
                showStatus('Lỗi: Vui lòng nhập và lưu GitHub Token trước.', 'error', 'teamCommitResult');
                return;
            }

            // Lấy toàn bộ dữ liệu hiện tại trong Idata, chỉ ghi đè tL và các tên đội liên quan.
            const fullCommitData = { 
                TournamentInfo: Idata.TournamentInfo, 
                // Cập nhật Tn trong teamStandings theo tL (vì tL là nơi người dùng chỉnh sửa)
                teamStandings: Idata.teamStandings.map(s => ({ 
                    ...s, 
                    Tn: Tdata.tL.find(t => t.T === s.T)?.Tn || s.Tn
                })),
                // Cập nhật tên đội trong trận đấu theo Tn mới
                matches: Idata.matches.map(m => {
                     const teamA = Tdata.tL.find(t => t.Tn === m.A) || {};
                     const teamB = Tdata.tL.find(t => t.Tn === m.B) || {};
                     // Nếu A/B là tên đội (Tn), cập nhật nó. Nếu là mã (W.QF1), giữ nguyên.
                     return {
                         ...m,
                         A: teamA.Tn || m.A,
                         B: teamB.Tn || m.B
                     };
                }),
                tL: Tdata.tL // Ghi đè tL (danh sách đội chi tiết)
            };

            // Giữ lại key_legend nếu có
            if (Idata.key_legend) {
                fullCommitData.key_legend = Idata.key_legend;
            }

            const base64Content = jsonToBase64(fullCommitData);
            const commitMessage = 'Update team details and overwrite state4.json via web app (New Structure)';
            
            if (!confirm("CẢNH BÁO: Thao tác này sẽ GHI ĐÈ TOÀN BỘ file state4.json trên GitHub với thông tin đội mới nhất (tL). Bạn có chắc chắn không?")) {
                showStatus("Thao tác cập nhật đội đã bị hủy.", 'info', 'teamCommitResult');
                return;
            }

            await getShaAndCommit(BASE_API_URL, base64Content, commitMessage, 'commitTeamButton', 'teamCommitResult');
            
            await loadDataFromGitHub();
            switchTab('TeamManagement');
        };

        // --- HÀM HỖ TRỢ CHUNG ---
        async function fetchWithRetry(url, options = {}, maxRetries = 3) {
            let lastError = null;
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(url, options);
                    if (response.status === 404) {
                        return null; 
                    }
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status} for ${url}`);
                    }
                    return response;
                } catch (error) {
                    lastError = error;
                    const delay = Math.pow(2, i) * 500; 
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
            console.error(`Failed to fetch data from ${url} after multiple retries.`, lastError);
            throw lastError;
        }

        function getMatchWinner(scoreA, scoreB) {
            const sA = parseInt(scoreA);
            const sB = parseInt(scoreB);
            if (sA > sB) return 'A';
            if (sB > sA) return 'B';
            return 'Chưa có';
        }

        /**
         * Lọc mảng matches theo Group Code (GA, GB, GC, GD, QF, SF, F)
         * @param {Array} matches - Mảng Tdata.matches
         * @param {string} prefix - Ví dụ: 'GA', 'QF', 'F'
         * @returns {Array} Mảng các trận đấu đã lọc
         */
        function filterMatchesByCode(matches, prefix) {
            return matches.filter(match => match.Mc.startsWith(prefix));
        }

        // --- LOGIC HỢP NHẤT DỮ LIỆU ---

        /**
         * Hợp nhất tỉ số cập nhật từ diffData (state4s.json) vào baseData (matches)
         */
        function mergeUpdates(baseData, diffData) {
            if (!diffData || !baseData.matches || !diffData.matches_updates) return baseData;

            diffData.matches_updates.forEach(update => {
                const matchIndex = update.i;
                if (baseData.matches[matchIndex]) {
                    // Chỉ cập nhật sA và sB
                    if (update.sA !== undefined) baseData.matches[matchIndex].sA = update.sA;
                    if (update.sB !== undefined) baseData.matches[matchIndex].sB = update.sB;
                    // Xóa Wn để tính toán lại
                    baseData.matches[matchIndex].Wn = 'Chưa có'; 
                }
            });
            return baseData;
        }


        // --- TẢI DỮ LIỆU TỪ GITHUB ---

        async function loadDataFromGitHub() {
            const loadingMessage = document.getElementById('statusMessage');
            loadingMessage.textContent = "Đang tải dữ liệu gốc (state4.json)...";
            loadingMessage.classList.remove('hidden', 'bg-red-900/50', 'bg-orange-900/50', 'bg-green-900/50');
            loadingMessage.classList.add('bg-blue-900/50');

            let baseData = null;
            let diffData = null;
            
            try {
                const baseResponse = await fetchWithRetry(STATIC_DATA_URL);
                if (!baseResponse) throw new Error("Không thể tải dữ liệu gốc từ state4.json.");
                
                baseData = await baseResponse.json(); 
                
                // Gán dữ liệu gốc (state4.json)
                Idata = JSON.parse(JSON.stringify(baseData)); 
                
                loadingMessage.textContent = "Đã tải state4.json. Đang kiểm tra cập nhật (state4s.json)...";

                const diffResponse = await fetchWithRetry(DIFF_DATA_URL);
                if (diffResponse) {
                     diffData = await diffResponse.json();
                     let liveData = JSON.parse(JSON.stringify(baseData)); 
                     Tdata = mergeUpdates(liveData, diffData);
                     loadingMessage.textContent = "Đã hợp nhất dữ liệu thành công từ state4s.json.";
                } else {
                     Tdata = baseData;
                     loadingMessage.textContent = "Đã tải dữ liệu gốc (state4.json). Không có file cập nhật state4s.json.";
                }

                loadingMessage.classList.add('bg-green-900/50');
                loadingMessage.classList.remove('bg-blue-900/50');
                
                recalculateTournamentState();
                renderUI(); // Gọi renderUI sau khi tải và tính toán lại

                setTimeout(() => loadingMessage.classList.add('hidden'), 2000);

            } catch (error) {
                console.error("LỖI KHÔNG THỂ TẢI DỮ LIỆU TỪ GITHUB:", error);
                loadingMessage.textContent = "LỖI FATAL: Không thể tải dữ liệu giải đấu từ GitHub.";
                loadingMessage.classList.add('bg-red-900/50');
                loadingMessage.classList.remove('bg-blue-900/50', 'bg-green-900/50');
            }
        }

        // Global function to show confirmation modal (Không thay đổi)
        window.showConfirmationModal = function() {
            document.getElementById('confirmationBox').classList.remove('hidden');
        }

        // Global function to handle re-sync button click logic (Không thay đổi)
        window.reSyncStaticData = async function() {
            document.getElementById('confirmationBox').classList.add('hidden');
            await loadDataFromGitHub();
        };


        // --- Score Calculation & Progression ---

        /**
         * Tính toán lại bảng xếp hạng (Group Standings) dựa trên mảng matches chung.
         * Cập nhật trực tiếp vào Tdata.teamStandings.
         * @param {string} group - Mã bảng đấu (A, B, C, D)
         */
        function calculateGroupStandings(group) {
            const groupMatches = filterMatchesByCode(Tdata.matches, 'G' + group);
            // Dùng Tdata.teamStandings làm base, lọc theo g
            const standingsMap = Tdata.teamStandings
                .filter(s => s.g === group)
                .reduce((map, s) => {
                    // Đảm bảo các trường tính toán lại được reset
                    map[s.Tn] = { ...s, W: 0, L: 0, HS: 0, Pts: 0, mP: 0, scoreDiff: 0, gR: 0 }; 
                    return map;
                }, {});

            groupMatches.forEach(match => {
                const sA = parseInt(match.sA) || 0;
                const sB = parseInt(match.sB) || 0;
                const isPlayed = (sA !== 0) || (sB !== 0);

                if (!standingsMap[match.A] || !standingsMap[match.B]) return; 

                if (isPlayed) {
                    standingsMap[match.A].HS = Math.max(standingsMap[match.A].HS, sA);
                    standingsMap[match.B].HS = Math.max(standingsMap[match.B].HS, sB);

                    standingsMap[match.A].scoreDiff += (sA - sB);
                    standingsMap[match.B].scoreDiff += (sB - sA);

                    standingsMap[match.A].mP++;
                    standingsMap[match.B].mP++;
                }

                const winnerCode = getMatchWinner(sA, sB);
                let winnerName = 'Chưa có';

                if (winnerCode === 'A') {
                    standingsMap[match.A].W++;
                    standingsMap[match.A].Pts += 3;
                    standingsMap[match.B].L++;
                    winnerName = match.A;
                } else if (winnerCode === 'B') {
                    standingsMap[match.B].W++;
                    standingsMap[match.B].Pts += 3;
                    standingsMap[match.A].L++;
                    winnerName = match.B;
                } 
                match.Wn = winnerName; // Cập nhật Wn ngay vào match object
            });

            const sortedStandings = Object.values(standingsMap).sort((a, b) => {
                if (b.W !== a.W) return b.W - a.W;
                if (b.Pts !== a.Pts) return b.Pts - a.Pts;
                if (b.scoreDiff !== a.scoreDiff) return b.scoreDiff - a.scoreDiff;
                if (b.HS !== a.HS) return b.HS - a.HS;
                return a.Tn.localeCompare(b.Tn); // Dùng Tn (Nickname) để sắp xếp nếu tất cả chỉ số bằng nhau
            });
            
            // Cập nhật gR (Group Rank) và gán lại vào Tdata.teamStandings
            sortedStandings.forEach((team, index) => {
                team.gR = index + 1;
                // Tìm và cập nhật team trong mảng Tdata.teamStandings gốc
                const originalIndex = Tdata.teamStandings.findIndex(s => s.T === team.T);
                if (originalIndex !== -1) {
                    // Cập nhật các trường tính toán
                    Tdata.teamStandings[originalIndex].gR = team.gR;
                    Tdata.teamStandings[originalIndex].W = team.W;
                    Tdata.teamStandings[originalIndex].L = team.L;
                    Tdata.teamStandings[originalIndex].Pts = team.Pts;
                    Tdata.teamStandings[originalIndex].scoreDiff = team.scoreDiff;
                    Tdata.teamStandings[originalIndex].HS = team.HS;
                    Tdata.teamStandings[originalIndex].mP = team.mP;
                }
            });

            return sortedStandings;
        }

        /**
         * Cập nhật tiến trình vòng loại (QF, SF, F)
         * Dùng Tdata.teamStandings và Tdata.matches
         */
        function updateKnockoutProgression(data) {
            const fullStandings = data.teamStandings;
            // Lấy tên đội theo xếp hạng
            const getRankedTeam = (group, rank) => fullStandings.find(s => s.g === group && s.gR === rank)?.Tn || `[${group}${rank}_Chờ]`;
            // Lấy trận đấu theo mã
            const getMatchByCode = (code) => data.matches.find(m => m.Mc === code);

            const calculateMatchWinnerName = (match) => {
                const winnerCode = getMatchWinner(match.sA, match.sB);
                return winnerCode === 'A' ? match.A : (winnerCode === 'B' ? match.B : 'Chưa có');
            };
            const getLoser = (match) => {
                 const winnerName = calculateMatchWinnerName(match);
                 if (winnerName === match.A) return match.B;
                 if (winnerName === match.B) return match.A;
                 return 'Chưa có';
            };

            // QF
            const qf1 = getMatchByCode('QF1'); 
            qf1.A = getRankedTeam('A', 1); qf1.B = getRankedTeam('B', 2); 
            qf1.Wn = calculateMatchWinnerName(qf1);
            
            const qf2 = getMatchByCode('QF2'); 
            qf2.A = getRankedTeam('C', 1); qf2.B = getRankedTeam('D', 2); 
            qf2.Wn = calculateMatchWinnerName(qf2);
            
            const qf3 = getMatchByCode('QF3'); 
            qf3.A = getRankedTeam('B', 1); qf3.B = getRankedTeam('A', 2); 
            qf3.Wn = calculateMatchWinnerName(qf3);
            
            const qf4 = getMatchByCode('QF4'); 
            qf4.A = getRankedTeam('D', 1); qf4.B = getRankedTeam('C', 2); 
            qf4.Wn = calculateMatchWinnerName(qf4);
            
            // SF
            const sf1 = getMatchByCode('SF1'); 
            sf1.A = qf1.Wn; sf1.B = qf2.Wn; 
            sf1.Wn = calculateMatchWinnerName(sf1);
            
            const sf2 = getMatchByCode('SF2'); 
            sf2.A = qf3.Wn; sf2.B = qf4.Wn; 
            sf2.Wn = calculateMatchWinnerName(sf2);

            // Final
            const finalMatch = getMatchByCode('F');
            finalMatch.A = sf1.Wn;
            finalMatch.B = sf2.Wn;
            finalMatch.Wn = calculateMatchWinnerName(finalMatch);
            finalMatch.rU = getLoser(finalMatch); // Cập nhật rU (Runner-Up)

            // Final Standings (Lưu kết quả vào Tdata)
            data.champion = finalMatch.Wn === 'Chưa có' ? 'Đang chờ...' : finalMatch.Wn;
            data.runnerUp = finalMatch.rU === 'Chưa có' ? 'Đang chờ...' : finalMatch.rU;
            data.thirdPlace1 = getLoser(sf1) === 'Chưa có' ? 'Đang chờ...' : getLoser(sf1);
            data.thirdPlace2 = getLoser(sf2) === 'Chưa có' ? 'Đang chờ...' : getLoser(sf2);
        }

        function recalculateTournamentState() {
            if (!Tdata) return;
            
            // 1. Tính toán lại bảng xếp hạng cho từng bảng
            ['A', 'B', 'C', 'D'].forEach(group => {
                calculateGroupStandings(group);
            });

            // 2. Cập nhật tiến trình vòng loại
            updateKnockoutProgression(Tdata);
        }


        // --- Rendering Functions ---

        function renderTeams(teams) {
            const listHtml = teams.map(team => `
                <div class="bg-[var(--match-bg)] p-4 rounded-lg shadow-xl mb-4 border border-[var(--border-color)]">
                    <h3 class="text-xl font-bold text-[var(--group-header-text)] mb-2 flex justify-between items-center">${team.Tn} <span class="text-sm font-normal text-gray-400">Bảng ${team.g}</span></h3>
                    <div class="grid grid-cols-1 gap-2 text-sm text-gray-300">
                        ${team.P.map(p => `
                            <div class="p-2 border border-[var(--border-color)] rounded-md">
                                <p class="font-semibold text-[var(--text-color)]">${p.name}</p>
                                <p>Cấp độ: <span class="text-green-400">${p.pL}</span> | NS: ${p.bY}</p>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `).join('');
            document.getElementById('teamList').innerHTML = listHtml;
        }

        function renderTeamManagement(teams) {
            const listHtml = teams.map((team, teamIndex) => `
                <div class="bg-[var(--match-bg)] p-4 rounded-lg shadow-xl mb-4 border border-blue-500/50">
                    <h3 class="text-xl font-bold text-blue-400 mb-3">
                        Đội: <input type="text" value="${team.Tn}" data-team-index="${teamIndex}" data-field="Tn" class="text-input p-1 rounded-md text-base font-bold w-1/2">
                        <span class="text-sm font-normal text-gray-400 ml-4">Bảng ${team.g}</span>
                    </h3>
                    <div class="grid grid-cols-1 gap-4 text-sm text-gray-300">
                        ${team.P.map((p, playerIndex) => `
                            <div class="p-3 border border-[var(--border-color)] rounded-md space-y-2">
                                <p class="font-semibold text-gray-300">Người chơi ${playerIndex + 1}:</p>
                                <div class="flex items-center space-x-2">
                                    <label class="w-1/4">Tên:</label>
                                    <input type="text" value="${p.name}" data-team-index="${teamIndex}" data-player-index="${playerIndex}" data-field="name" class="text-input p-1 rounded-md flex-1">
                                </div>
                                <div class="flex items-center space-x-2">
                                    <label class="w-1/4">Cấp độ (pL):</label>
                                    <input type="text" value="${p.pL}" data-team-index="${teamIndex}" data-player-index="${playerIndex}" data-field="pL" class="text-input p-1 rounded-md w-1/4">
                                </div>
                                <div class="flex items-center space-x-2">
                                    <label class="w-1/4">Năm sinh (bY):</label>
                                    <input type="number" value="${p.bY}" data-team-index="${teamIndex}" data-player-index="${playerIndex}" data-field="bY" class="text-input p-1 rounded-md w-1/4">
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `).join('');
            document.getElementById('teamManagementList').innerHTML = listHtml;
            
            document.querySelectorAll('#teamManagementList input').forEach(input => {
                input.removeEventListener('change', handleTeamDataChange);
                input.addEventListener('change', handleTeamDataChange);
            });
        }

        function handleTeamDataChange(event) {
            const input = event.target;
            const teamIndex = parseInt(input.getAttribute('data-team-index'));
            const playerIndex = input.getAttribute('data-player-index'); 
            const field = input.getAttribute('data-field');

            if (!Tdata || !Tdata.tL[teamIndex]) return;

            if (field === 'Tn') {
                Tdata.tL[teamIndex].Tn = input.value;
            } else if (playerIndex !== null) {
                const pIndex = parseInt(playerIndex);
                if (Tdata.tL[teamIndex].P[pIndex]) {
                    if(field === 'bY') {
                       Tdata.tL[teamIndex].P[pIndex][field] = String(parseInt(input.value) || 0);
                    } else {
                       Tdata.tL[teamIndex].P[pIndex][field] = input.value;
                    }
                }
            }
            
            renderTeams(Tdata.tL);
            
            showStatus("Thay đổi thông tin đội đã được ghi nhận cục bộ. Nhấn **'CẬP NHẬT THÔNG TIN ĐỘI'** để ghi đè state4.json.", 'warning', 'teamCommitResult');
        }

        function renderStandings(groupName, fullStandings) {
            const standings = fullStandings.filter(s => s.g === groupName).sort((a, b) => a.gR - b.gR);

            // Sử dụng ID HTML đã có sẵn: tableA, tableB, ...
            const tableId = `table${groupName}`;
            const tableHtml = `
                <div class="p-4 rounded-lg shadow-xl h-full bg-[var(--match-bg)] border border-[var(--border-color)]">
                    <h3 class="text-xl font-bold text-[var(--group-header-text)] mb-3">Bảng Xếp Hạng Bảng ${groupName}</h3>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-[var(--border-color)]">
                            <thead class="bg-[var(--border-color)]">
                                <tr>
                                    <th class="px-2 py-2 text-left text-xs font-medium text-gray-200 uppercase tracking-wider">Hạng</th>
                                    <th class="px-2 py-2 text-left text-xs font-medium text-gray-200 uppercase tracking-wider">Đội</th>
                                    <th class="px-2 py-2 text-center text-xs font-medium text-gray-200 uppercase tracking-wider">T</th>
                                    <th class="px-2 py-2 text-center text-xs font-medium text-gray-200 uppercase tracking-wider">B</th>
                                    <th class="px-2 py-2 text-center text-xs font-medium text-gray-200 uppercase tracking-wider">Điểm</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-[var(--border-color)]">
                                ${standings.map(team => `
                                    <tr class="${team.gR <= 2 && team.gR > 0 ? 'bg-green-600/30' : 'bg-[var(--card-bg)]'}">
                                        <td class="px-2 py-2 whitespace-nowrap font-medium ${team.gR === 1 ? 'text-yellow-400' : (team.gR === 2 ? 'text-green-400' : 'text-[var(--text-color)]')}">${team.gR || '-'}</td>
                                        <td class="px-2 py-2 whitespace-nowrap text-sm text-[var(--text-color)]">${team.Tn}</td>
                                        <td class="px-2 py-2 whitespace-nowrap text-sm text-center text-green-500">${team.W}</td>
                                        <td class="px-2 py-2 whitespace-nowrap text-sm text-center text-red-500">${team.L}</td>
                                        <td class="px-2 py-2 whitespace-nowrap text-sm text-center font-bold text-[var(--accent-color)]">${team.Pts}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                    <p class="mt-2 text-xs text-gray-500">2 đội đứng đầu vào Tứ kết.</p>
                </div>
            `;
            document.getElementById(tableId).innerHTML = tableHtml;
        }

        /**
         * Render trận đấu từ mảng matches chung
         * @param {string} id - ID HTML của container (matchesA, quarterfinals, finalSection)
         * @param {string} prefix - Mã trận đấu ('GA', 'QF', 'F')
         * @param {string} title - Tiêu đề
         */
        function renderMatches(id, prefix, title) {
            const matches = filterMatchesByCode(Tdata.matches, prefix);

            const listHtml = matches.map(match => {
                // Tìm index của trận đấu trong mảng Tdata.matches gốc để dùng cho data-attribute
                const globalIndex = Tdata.matches.findIndex(m => m.Mc === match.Mc);

                const winnerName = match.A ? match.Wn || 'Chưa có' : 'Đang chờ...';
                const winnerClass = winnerName === match.A || winnerName === match.B ? 'text-yellow-400 font-bold' : 'text-[var(--text-color)]';
                const winnerBg = winnerName === match.A || winnerName === match.B ? 'bg-green-700/20' : 'bg-[var(--match-bg)]';
                
                // Disable input nếu đội chưa được xác định (ví dụ: W.A, R.B, W.QF1)
                const disabled = match.A.includes('Chờ') || match.B.includes('Chờ') || match.A.includes('[') || match.B.includes('['); 

                return `
                    <div class="match-card p-3 mb-2 rounded-lg ${winnerBg} shadow-md border border-[var(--border-color)]">
                        <p class="text-xs text-gray-400 mb-1 flex justify-between">
                            <span>Trận: ${match.Mc}</span>
                            <span>${match.t} | Sân ${match.c}</span>
                        </p>
                        <div class="flex items-center justify-between font-semibold">
                            <div class="flex-1 text-left ${winnerName === match.A ? winnerClass : 'text-[var(--text-color)]'} text-sm sm:text-base">
                                ${match.A}
                            </div>
                            
                            <input type="number" min="0" value="${match.sA}" data-match-global-index="${globalIndex}" data-team="A"
                                class="score-input w-10 h-7 md:w-12 md:h-8 text-center rounded-md mx-1 md:mx-2 focus:ring-2 focus:ring-[var(--accent-color)] transition duration-150 text-sm" ${disabled ? 'disabled' : ''}>

                            <span class="text-sm md:text-lg text-gray-400 mx-1">-</span>

                            <input type="number" min="0" value="${match.sB}" data-match-global-index="${globalIndex}" data-team="B"
                                class="score-input w-10 h-7 md:w-12 md:h-8 text-center rounded-md mx-1 md:mx-2 focus:ring-2 focus:ring-[var(--accent-color)] transition duration-150 text-sm" ${disabled ? 'disabled' : ''}>
                            
                            <div class="flex-1 text-right ${winnerName === match.B ? winnerClass : 'text-[var(--text-color)]'} text-sm sm:text-base">
                                ${match.B}
                            </div>
                        </div>
                        <p class="text-center text-xs mt-1 text-gray-500">
                            Thắng: <span class="font-bold text-green-400">${winnerName}</span>
                        </p>
                    </div>
                `;
            }).join('');

            let sectionTitle = title;
            document.getElementById(id).innerHTML = `
                <h2 class="text-2xl font-extrabold text-[var(--accent-color)] mb-4 border-b border-[var(--border-color)] pb-2">${sectionTitle}</h2>
                <div class="grid grid-cols-1 gap-4">
                    ${listHtml}
                </div>
            `;
            
            // Thêm lại event listener sau khi render
            document.getElementById(id).querySelectorAll('.score-input').forEach(input => {
                if (!input.disabled) {
                    input.removeEventListener('change', handleScoreChange);
                    input.addEventListener('change', handleScoreChange);
                }
            });
        }

        function renderFinalResults(data) {
            document.getElementById('finalResults').innerHTML = `
                <h2 class="text-xl font-extrabold text-yellow-500 mb-4">Kết Quả Chung Cuộc</h2>
                <div class="space-y-3">
                    <div class="p-3 bg-yellow-900/40 rounded-lg border-l-4 border-yellow-400">
                        <p class="text-xs text-yellow-300">Vô Địch (1st Place)</p>
                        <p class="text-2xl font-black text-white">${data.champion || 'Đang chờ...'}</p>
                    </div>
                    <div class="p-3 bg-gray-700/40 rounded-lg border-l-4 border-gray-400">
                        <p class="text-xs text-gray-300">Á Quân (2nd Place)</p>
                        <p class="text-xl font-black text-white">${data.runnerUp || 'Đang chờ...'}</p>
                    </div>
                    <div class="p-3 bg-green-700/40 rounded-lg border-l-4 border-green-400">
                        <p class="text-xs text-green-300">Đồng Hạng 3 (Joint 3rd Place)</p>
                        <p class="text-lg font-black text-white">${data.thirdPlace1 || 'Đang chờ...'} & ${data.thirdPlace2 || 'Đang chờ...'}</p>
                    </div>
                </div>
            `;
        }

        // --- Main Rendering & Event Handling ---

        function renderUI() {
            if (!Tdata) return;
            
            // 1. Render tab Tổng Quan
            renderTeams(Tdata.tL);
            renderFinalResults(Tdata);
            
            // 2. Render tất cả Bảng Xếp Hạng (A, B, C, D)
            renderStandings('A', Tdata.teamStandings);
            renderStandings('B', Tdata.teamStandings);
            renderStandings('C', Tdata.teamStandings);
            renderStandings('D', Tdata.teamStandings);

            // 3. Render tất cả Trận Đấu Vòng Bảng
            renderMatches('matchesA', 'GA', 'Nhập Tỉ Số Bảng A (Group A Score Entry)');
            renderMatches('matchesB', 'GB', 'Nhập Tỉ Số Bảng B (Group B Score Entry)');
            renderMatches('matchesC', 'GC', 'Nhập Tỉ Số Bảng C (Group C Score Entry)');
            renderMatches('matchesD', 'GD', 'Nhập Tỉ Số Bảng D (Group D Score Entry)');

            // 4. Render tất cả Trận Đấu Vòng Loại
            renderMatches('quarterfinals', 'QF', 'Tứ Kết (Quarterfinals)');
            renderMatches('semifinals', 'SF', 'Bán Kết (Seminfinals)');
            renderMatches('finalSection', 'F', 'Chung Kết (Final)');

            // 5. Gán lại event listener cho tất cả input score
            document.querySelectorAll('.score-input').forEach(input => {
                if (!input.disabled) {
                    input.removeEventListener('change', handleScoreChange);
                    input.addEventListener('change', handleScoreChange);
                }
            });

            // 6. Nếu đang ở tab quản lý đội, render lại nó (để thấy thay đổi tên đội nếu có)
            if (document.querySelector('.tab-button[data-tab="TeamManagement"]').classList.contains('active')) {
                 renderTeamManagement(Tdata.tL);
            }
            
            // 7. Giữ nguyên tab đang hiển thị
            if (!document.querySelector('.tab-button.active')) {
                 switchTab('General');
            }
        }

        function handleScoreChange(event) {
            const input = event.target;
            let score = parseInt(input.value);
            if (isNaN(score) || score < 0) {
                score = 0;
                input.value = 0;
            }

            // Lấy index toàn cục trong mảng Tdata.matches
            const globalIndex = parseInt(input.getAttribute('data-match-global-index'));
            const team = input.getAttribute('data-team');
            
            if (!Tdata || !Tdata.matches[globalIndex]) {
                console.error("Lỗi: Không tìm thấy trận đấu mục tiêu.");
                return;
            }

            const targetMatch = Tdata.matches[globalIndex];
            const scoreKey = team === 'A' ? 'sA' : 'sB';
            
            targetMatch[scoreKey] = String(score);
            targetMatch.Wn = 'Chưa có'; // Xóa Wn để tính toán lại

            recalculateTournamentState();
            renderUI();
            
            showStatus("Thay đổi đã được ghi nhận cục bộ! Nhấn **'COMMIT TỈ SỐ'** trong tab **Cấu Hình** để cập nhật online.", 'warning', 'scoreCommitResult');
        }


        // --- Init Functions ---
        function getCurrentTabIndex() {
            const tabs = Array.from(document.querySelectorAll('.tab-button'));
            return tabs.findIndex(tab => tab.classList.contains('active'));
        }

        function handleGesture() {
            const tabs = Array.from(document.querySelectorAll('.tab-button'));
            const currentIndex = getCurrentTabIndex();
            
            if (currentIndex === -1) return; 

            if (startX - endX > swipeThreshold) {
                if (currentIndex < tabs.length - 1) {
                    tabs[currentIndex + 1].click();
                }
            } else if (endX - startX > swipeThreshold) {
                if (currentIndex > 0) {
                    tabs[currentIndex - 1].click();
                }
            }
            startX = 0;
            endX = 0;
        }

        window.switchTab = function(tabName) {
            document.querySelectorAll('.tab-content').forEach(content => {
                content.style.display = 'none';
            });
            document.querySelectorAll('.tab-button').forEach(button => {
                button.classList.remove('active');
            });
            
            const activeContent = document.getElementById(tabName);
            if (activeContent) {
                if (tabName.startsWith('Group') || tabName === 'Knockout') {
                    activeContent.style.display = 'grid';
                } else {
                    activeContent.style.display = 'block';
                }
            }
            const activeButton = document.querySelector(`.tab-button[data-tab="${tabName}"]`);
            if (activeButton) {
                activeButton.classList.add('active');
            }
            
            // Re-render team management form khi chuyển sang tab này
            if (tabName === 'TeamManagement' && Tdata) {
                renderTeamManagement(Tdata.tL);
            }
        }

        function applyTheme(theme) {
            const isDarkMode = theme === 'dark';
            document.body.classList.toggle('light-mode', !isDarkMode);
            document.getElementById('moonIcon').classList.toggle('hidden', !isDarkMode);
            document.getElementById('sunIcon').classList.toggle('hidden', isDarkMode);
            // Cập nhật theme toggle
            const themeToggleBtn = document.getElementById('themeToggle');
            if(themeToggleBtn) themeToggleBtn.title = isDarkMode ? 'Chuyển sang Chủ đề Sáng' : 'Chuyển sang Chủ đề Tối';
            localStorage.setItem('theme', theme);
        }

        function toggleTheme() {
            const currentTheme = localStorage.getItem('theme') === 'light' ? 'dark' : 'light';
            applyTheme(currentTheme);
        }

        function initializeApp() {
            githubToken = localStorage.getItem('githubToken') || '';
            const savedTheme = localStorage.getItem('theme') || 'dark'; 
            applyTheme(savedTheme);

            if (githubToken) {
                 document.getElementById('githubToken').value = '********';
            }

            document.getElementById('themeToggle').addEventListener('click', toggleTheme);
            document.getElementById('app').addEventListener('touchstart', (e) => {
                if (e.target.classList.contains('score-input') || e.target.classList.contains('text-input')) return;
                startX = e.changedTouches[0].screenX;
            }, { passive: true });

            document.getElementById('app').addEventListener('touchend', (e) => {
                if (e.target.classList.contains('score-input') || e.target.classList.contains('text-input')) return;
                endX = e.changedTouches[0].screenX;
                handleGesture();
            }, { passive: true });
            
            document.getElementById('confirmYes').onclick = window.reSyncStaticData;
            document.getElementById('confirmNo').onclick = () => document.getElementById('confirmationBox').classList.add('hidden');

            loadDataFromGitHub();
        }

        window.onload = initializeApp;
    </script>
</body>
</html>
