<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qu·∫£n L√Ω Gi·∫£i ƒê·∫•u & C·∫≠p Nh·∫≠t Th√¥ng Tin (GitHub Sync) V4.2.2</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100;400;700;900&display=swap" rel="stylesheet">
    <style>
        /* Base styles for Dark Mode */
        :root {
            --bg-color: #111827; /* Gray-900 */
            --text-color: #f3f4f6; /* Gray-100 */
            --card-bg: #1f2937; /* Gray-800 */
            --border-color: #374151; /* Gray-700 */
            --accent-color: #06b6d4; /* Cyan-500 */
            --match-bg: #1f2937;
            --input-bg: #4b5563; /* Gray-600 */
            --group-header-text: #60a5fa; /* Blue-400 */
        }
        
        /* Light Mode Overrides */
        .light-mode {
            --bg-color: #f9fafb; /* Gray-50 */
            --text-color: #111827; /* Gray-900 */
            --card-bg: #ffffff;
            --border-color: #e5e7eb; /* Gray-200 */
            --accent-color: #ef4444; /* Red-500 */
            --match-bg: #f3f4f6; /* Gray-100 */
            --input-bg: #ffffff;
            --group-header-text: #10b981; /* Emerald-500 */
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            transition: background-color 0.3s, color 0.3s;
        }
        .container {
            max-width: 1200px;
        }
        .score-input, .text-input {
            background-color: var(--input-bg);
            border: 1px solid var(--border-color);
            color: var(--text-color);
        }
        .score-input:focus, .text-input:focus {
            box-shadow: 0 0 0 3px var(--accent-color);
        }
        .tab-button {
            border-bottom-color: var(--border-color);
        }
        .tab-button.active {
            color: var(--accent-color);
            border-color: var(--accent-color);
            background-color: var(--card-bg);
        }
        .tab-content {
            display: none;
            background-color: var(--card-bg);
            border-radius: 0.75rem; /* rounded-xl */
            padding: 1.5rem; /* p-6 */
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); /* shadow-2xl */
        }
        /* Custom scrollbar */
        ::-webkit-scrollbar { height: 8px; }
        ::-webkit-scrollbar-thumb { background: var(--border-color); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #6b7280; }
        
        /* Specific content styles for brightness/clarity */
        .match-card {
            background-color: var(--match-bg);
            border-bottom: 1px solid var(--border-color);
        }
        .light-mode .match-card {
            background-color: #ffffff;
            border-bottom: 1px solid #e5e7eb;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
        }
        /* Modal Backdrop */
        .modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 50;
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <div id="app" class="container mx-auto">
        <header class="flex items-center justify-between mb-6">
            <div class="flex items-center">
                <svg class="w-10 h-10 md:w-12 md:h-12 text-[var(--accent-color)]" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 15.75l-4-4m0 0l4-4m-4 4h14M17 12a5 5 0 11-10 0 5 5 0 0110 0z"></path></svg>
                <div class="text-left ml-4">
                    <h1 class="text-xl md:text-3xl font-extrabold text-[var(--text-color)] leading-none">QU·∫¢N L√ù GI·∫¢I ƒê·∫§U PICKLEBALL (V4.2.2)</h1>
                    <p class="text-xs md:text-sm text-[var(--accent-color)]">C·∫≠p Nh·∫≠t T·ªâ S·ªë & Th√¥ng Tin ƒê·ªôi (GitHub Sync)</p>
                </div>
            </div>
            
            <button id="themeToggle" onclick="toggleTheme()" class="p-3 rounded-full bg-[var(--card-bg)] shadow-md text-[var(--text-color)] hover:bg-[var(--border-color)] transition duration-200">
                <svg id="sunIcon" class="w-6 h-6 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>
                <svg id="moonIcon" class="w-6 h-6 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path></svg>
            </button>
        </header>

        <div id="statusMessage" class="text-center p-4 bg-blue-900/50 rounded-lg text-blue-300 font-semibold mb-6">
            ƒêang t·∫£i d·ªØ li·ªáu tr·∫°ng th√°i t·ª´ GitHub...
        </div>
        
        <nav class="mb-8 border-b border-[var(--border-color)] overflow-x-auto whitespace-nowrap">
            <button class="tab-button py-3 px-4 md:px-6 text-sm md:text-base font-semibold border-b-2 border-transparent text-gray-400 hover:text-[var(--accent-color)] transition" onclick="switchTab('General')" data-tab="General">General</button>
            <button class="tab-button py-3 px-4 md:px-6 text-sm md:text-base font-semibold border-b-2 border-transparent text-gray-400 hover:text-[var(--accent-color)] transition" onclick="switchTab('TeamManagement')" data-tab="TeamManagement">Qu·∫£n L√Ω ƒê·ªôi</button>
            <button class="tab-button py-3 px-4 md:px-6 text-sm md:text-base font-semibold border-b-2 border-transparent text-gray-400 hover:text-[var(--accent-color)] transition" onclick="switchTab('GroupA')" data-tab="GroupA">Group A</button>
            <button class="tab-button py-3 px-4 md:px-6 text-sm md:text-base font-semibold border-b-2 border-transparent text-gray-400 hover:text-[var(--accent-color)] transition" onclick="switchTab('GroupB')" data-tab="GroupB">Group B</button>
            <button class="tab-button py-3 px-4 md:px-6 text-sm md:text-base font-semibold border-b-2 border-transparent text-gray-400 hover:text-[var(--accent-color)] transition" onclick="switchTab('GroupC')" data-tab="GroupC">Group C</button>
            <button class="tab-button py-3 px-4 md:px-6 text-sm md:text-base font-semibold border-b-2 border-transparent text-gray-400 hover:text-[var(--accent-color)] transition" onclick="switchTab('GroupD')" data-tab="GroupD">Group D</button>
            <button class="tab-button py-3 px-4 md:px-6 text-sm md:text-base font-semibold border-b-2 border-transparent text-gray-400 hover:text-[var(--accent-color)] transition" onclick="switchTab('Knockout')" data-tab="Knockout">Knockout</button>
            <button class="tab-button py-3 px-4 md:px-6 text-sm md:text-base font-semibold border-b-2 border-transparent text-gray-400 hover:text-[var(--accent-color)] transition" onclick="switchTab('Configuration')" data-tab="Configuration">C·∫•u H√¨nh</button>
        </nav>

        <div id="General" class="tab-content">
             <h2 class="text-3xl font-extrabold text-yellow-500 mb-6 border-b border-[var(--border-color)] pb-2">Final Results (K·∫øt qu·∫£ chung cu·ªôc)</h2>
            <section id="finalResults" class="mb-10 p-4 rounded-xl shadow-lg bg-[var(--match-bg)]"></section>

            <h2 class="text-3xl font-extrabold text-[var(--text-color)] mb-6 border-b border-[var(--border-color)] pb-2">Team List (Danh s√°ch c√°c ƒë·ªôi)</h2>
            <section id="teamList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                </section>
        </div>
        
        <div id="TeamManagement" class="tab-content">
            <h2 class="text-3xl font-extrabold text-blue-500 mb-6 border-b border-[var(--border-color)] pb-2">Qu·∫£n L√Ω Th√¥ng Tin ƒê·ªôi (C·∫≠p nh·∫≠t **`state41.json`**)</h2>
            <p class="text-sm text-gray-400 mb-4">ƒêi·ªÅu ch·ªânh **T√™n ƒë·ªôi (Tn)**, **T√™n ng∆∞·ªùi ch∆°i (name)**, **C·∫•p ƒë·ªô (pL)**, v√† **NƒÉm sinh (bY)**. Sau khi ch·ªânh s·ª≠a, h√£y nh·∫•n **C·∫¨P NH·∫¨T TH√îNG TIN** ƒë·ªÉ ghi ƒë√® `state41.json`.</p>
            
            <button id="commitTeamButton" onclick="commitTeamChangesToGitHub()" class="w-full md:w-auto px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-lg shadow-lg transition duration-300 mb-6 disabled:opacity-50">
                C·∫¨P NH·∫¨T TH√îNG TIN ƒê·ªòI (Ghi ƒë√® state41.json)
            </button>
            
            <div id="teamCommitResult" class="mt-3 p-3 rounded-lg text-sm font-semibold hidden"></div>

            <section id="teamManagementList" class="space-y-6"></section>
        </div>


        <div id="GroupA" class="tab-content grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div id="tableA" class="lg:col-span-1"></div>
            <div id="matchesA" class="lg:col-span-2"></div>
        </div>

        <div id="GroupB" class="tab-content grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div id="tableB" class="lg:col-span-1"></div>
            <div id="matchesB" class="lg:col-span-2"></div>
        </div>

        <div id="GroupC" class="tab-content grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div id="tableC" class="lg:col-span-1"></div>
            <div id="matchesC" class="lg:col-span-2"></div>
        </div>

        <div id="GroupD" class="tab-content grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div id="tableD" class="lg:col-span-1"></div>
            <div id="matchesD" class="lg:col-span-2"></div>
        </div>

        <div id="Knockout" class="tab-content">
            <h2 class="text-3xl font-extrabold text-[var(--group-header-text)] mb-6 border-b border-[var(--border-color)] pb-2">V√≤ng Lo·∫°i Tr·ª±c Ti·∫øp (Knockout Stage)</h2>
            <div id="quarterfinals" class="mb-6"></div>
            <div id="semifinals" class="mb-6"></div>
            <div id="finalMatchSection">
                <div id="finalSection"></div>
            </div>
        </div>

        <div id="Configuration" class="tab-content space-y-8">
            <h2 class="text-3xl font-extrabold text-red-500 mb-6 border-b border-[var(--border-color)] pb-2">C·∫•u H√¨nh & ƒê·ªìng B·ªô H√≥a (GitHub API)</h2>
            
             <section class="p-4 bg-red-900/20 rounded-lg border-l-4 border-red-500">
                <h3 class="text-xl font-bold text-red-400 mb-3 flex items-center">
                    <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-2a2 2 0 00-2-2H6a2 2 0 00-2 2v2a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path></svg>
                    1. GitHub Personal Access Token (PAT)
                </h3>
                <p class="text-sm text-red-300 mb-4 font-bold">C·∫¢NH B√ÅO B·∫¢O M·∫¨T: Token n√†y s·∫Ω ƒë∆∞·ª£c l∆∞u tr·ªØ trong tr√¨nh duy·ªát. Ch·ªâ s·ª≠ d·ª•ng Token c√≥ ph·∫°m vi (Scope) nh·ªè nh·∫•t. <span class="text-yellow-300">C·∫¶N PH·∫¢I C√ì QUY·ªÄN **repo** (ho·∫∑c contents:write)</span>.</p>
                <input type="password" id="githubToken" 
                    class="score-input w-full p-2 rounded-md focus:ring-red-500 transition" 
                    placeholder="D√°n GitHub PAT c·ªßa b·∫°n v√†o ƒë√¢y...">
                <button onclick="saveToken()" class="mt-2 px-4 py-1 bg-green-600 hover:bg-green-700 text-white text-sm font-bold rounded-lg transition duration-300">L∆∞u Token c·ª•c b·ªô</button>
            </section>

            <section class="p-4 bg-[var(--match-bg)] rounded-lg border-l-4 border-purple-500">
                <h3 class="text-xl font-bold text-[var(--group-header-text)] mb-3 flex items-center">
                    <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4"></path></svg>
                    2. C·∫≠p Nh·∫≠t T·ªâ S·ªë (Commit) l√™n **state41s.json**
                </h3>
                <p class="text-gray-400 mb-4">S·ª≠ d·ª•ng Token ƒë√£ l∆∞u ƒë·ªÉ commit nh·ªØng t·ªâ s·ªë **ƒë√£ thay ƒë·ªïi** l√™n GitHub (file `state41s.json`).</p>
                
                <button id="commitScoreButton" onclick="commitScoreChangesToGitHub()" class="w-full md:w-auto px-6 py-2 bg-purple-600 hover:bg-purple-700 text-white font-bold rounded-lg shadow-lg transition duration-300 mb-4 disabled:opacity-50">
                    COMMIT T·ªà S·ªê ƒê√É THAY ƒê·ªîI
                </button>

                <div id="scoreCommitResult" class="mt-3 p-3 rounded-lg text-sm font-semibold hidden"></div>
            </section>
            
            <section class="p-4 bg-[var(--match-bg)] rounded-lg border-l-4 border-yellow-500">
                 <h3 class="text-xl font-bold text-[var(--group-header-text)] mb-3 flex items-center">
                    <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>
                    3. T√πy Ch·ªçn Giao Di·ªán & ƒê·ªìng B·ªô L·∫°i
                </h3>
                <p class="text-[var(--text-color)] mb-4">B·∫°n c√≥ th·ªÉ chuy·ªÉn ƒë·ªïi gi·ªØa giao di·ªán S√°ng/T·ªëi ho·∫∑c t·∫£i l·∫°i tr·∫°ng th√°i online m·ªõi nh·∫•t.</p>
                <button onclick="document.getElementById('themeToggle').click()" class="md:w-auto px-6 py-2 bg-yellow-500 hover:bg-yellow-600 text-black font-bold rounded-lg shadow-lg transition duration-300 mr-4">
                    Chuy·ªÉn ƒê·ªïi Giao Di·ªán (Hi·ªán t·∫°i: <span id="currentThemeDisplay">T·ªëi</span>)
                </button>
                <button id="reSyncButton" onclick="showConfirmationModal()" class="md:w-auto px-6 py-2 bg-red-600 hover:bg-red-700 text-white font-bold rounded-lg shadow-lg transition duration-300">
                    ƒê·ªìng B·ªô L·∫°i (T·∫£i l·∫°i t·ª´ GitHub)
                </button>
            </section>

        </div>

    </div>
    
    <div id="confirmationBox" class="modal-backdrop hidden">
        <div class="bg-[var(--card-bg)] p-6 rounded-xl shadow-2xl w-11/12 max-w-sm border-t-4 border-red-500 text-[var(--text-color)]">
            <h4 class="text-xl font-bold text-red-400 mb-4">X√°c Nh·∫≠n ƒê·ªìng B·ªô L·∫°i</h4>
            <p class="text-[var(--text-color)] mb-6">B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën **ƒê·ªíNG B·ªò L·∫†I** tr·∫°ng th√°i gi·∫£i ƒë·∫•u v·ªÅ d·ªØ li·ªáu m·ªõi nh·∫•t t·ª´ GitHub kh√¥ng? ƒêi·ªÅu n√†y s·∫Ω ghi ƒë√® tr·∫°ng th√°i ƒëang nh·∫≠p c·ª•c b·ªô!</p>
            <div class="flex justify-end space-x-4">
                <button id="confirmNo" class="px-4 py-2 bg-gray-600 hover:bg-gray-500 text-white rounded-lg transition duration-150">H·ªßy b·ªè</button>
                <button id="confirmYes" class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white font-bold rounded-lg transition duration-150">X√°c nh·∫≠n ƒê·ªìng b·ªô</button>
            </div>
        </div>
    </div>

    <script>
        
        // ==============================================================================================================
        // KH·ªêI C·∫§U H√åNH GITHUB API & D·ªÆ LI·ªÜU (Phi√™n b·∫£n V4.2.2 - Fix logic t√≠nh to√°n/render)
        // ==============================================================================================================
        const GITHUB_REPO_OWNER = 'cqtin2024';
        const GITHUB_REPO_NAME = 'ITVTG';
        
        // C·∫•u h√¨nh cho file ƒêi·ªÉm s·ªë (diff) - state41s.json
        const SCORE_FILE_PATH = 'data/state41s.json'; 
        const SCORE_API_URL = `https://api.github.com/repos/${GITHUB_REPO_OWNER}/${GITHUB_REPO_NAME}/contents/${SCORE_FILE_PATH}`;
        const DIFF_DATA_URL = `https://raw.githubusercontent.com/${GITHUB_REPO_OWNER}/${GITHUB_REPO_NAME}/main/${SCORE_FILE_PATH}`;

        // C·∫•u h√¨nh cho file D·ªØ li·ªáu G·ªëc (Team/Init) - state41.json
        const BASE_FILE_PATH = 'data/state41.json'; 
        const BASE_API_URL = `https://api.github.com/repos/${GITHUB_REPO_OWNER}/${GITHUB_REPO_NAME}/contents/${BASE_FILE_PATH}`;
        const STATIC_DATA_URL = `https://raw.githubusercontent.com/${GITHUB_REPO_OWNER}/${GITHUB_REPO_NAME}/main/${BASE_FILE_PATH}`;

        const BRANCH = 'main';

        let tournamentData = null; 
        let initialTournamentData = null; 
        let githubToken = ''; 
        let startX = 0; 
        let endX = 0;  
        const swipeThreshold = 75; 
        
        // H√†m chuy·ªÉn ƒë·ªïi JSON sang Base64
        const jsonToBase64 = (json) => btoa(unescape(encodeURIComponent(JSON.stringify(json, null, 2))));
        
        // --- CH·ª®C NƒÇNG T∆Ø∆†NG T√ÅC GITHUB CHUNG ---

        function saveToken() {
            const tokenInput = document.getElementById('githubToken').value.trim();
            if (tokenInput.length > 0 && tokenInput !== '********') {
                githubToken = tokenInput;
                localStorage.setItem('githubToken', githubToken);
                showStatus('Token ƒë√£ ƒë∆∞·ª£c l∆∞u c·ª•c b·ªô. H√£y th·ª≠ COMMIT.', 'success', 'scoreCommitResult');
                showStatus('Token ƒë√£ ƒë∆∞·ª£c l∆∞u c·ª•c b·ªô. H√£y th·ª≠ COMMIT.', 'success', 'teamCommitResult');
                document.getElementById('githubToken').value = '********';
            } else if (tokenInput.length === 0) {
                 githubToken = '';
                 localStorage.removeItem('githubToken');
                 showStatus('Token ƒë√£ b·ªã x√≥a kh·ªèi b·ªô nh·ªõ c·ª•c b·ªô.', 'info', 'scoreCommitResult');
                 showStatus('Token ƒë√£ b·ªã x√≥a kh·ªèi b·ªô nh·ªõ c·ª•c b·ªô.', 'info', 'teamCommitResult');
                 document.getElementById('githubToken').value = '';
            } else {
                 showStatus('Vui l√≤ng nh·∫≠p Token m·ªõi ho·∫∑c Token ƒë√£ ƒë∆∞·ª£c l∆∞u.', 'info', 'scoreCommitResult');
                 showStatus('Vui l√≤ng nh·∫≠p Token m·ªõi ho·∫∑c Token ƒë√£ ƒë∆∞·ª£c l∆∞u.', 'info', 'teamCommitResult');
            }
        }
        
        function showStatus(message, type = 'info', elementId = 'statusMessage') {
            const statusElement = document.getElementById(elementId);
            if (!statusElement) return;

            statusElement.innerHTML = message;
            statusElement.classList.remove('hidden', 'bg-red-900/50', 'bg-green-900/50', 'bg-blue-900/50', 'bg-orange-900/50');
            
            if (type === 'success') {
                statusElement.classList.add('bg-green-900/50');
            } else if (type === 'error') {
                statusElement.classList.add('bg-red-900/50');
            } else if (type === 'warning') {
                 statusElement.classList.add('bg-orange-900/50');
            } else {
                 statusElement.classList.add('bg-blue-900/50');
            }
            statusElement.style.display = 'block';

            if (type !== 'error') {
                setTimeout(() => statusElement.style.display = 'none', 5000);
            }
        }
        
        async function getShaAndCommit(fileUrl, contentBase64, commitMessage, buttonId, resultElementId) {
            const pat = githubToken.trim();
            const commitButton = document.getElementById(buttonId);
            commitButton.disabled = true;
            commitButton.textContent = 'ƒêang ti·∫øn h√†nh...';

            let sha = null;
            
            try {
                showStatus('ƒêang l·∫•y SHA hi·ªán t·∫°i c·ªßa file...', 'info', resultElementId);

                const shaResponse = await fetch(fileUrl + `?ref=${BRANCH}`, {
                    headers: { 'Authorization': `Bearer ${pat}` } 
                });

                if (shaResponse.status === 404) {
                    showStatus('File ch∆∞a t·ªìn t·∫°i tr√™n nh√°nh, s·∫Ω t·∫°o m·ªõi.', 'info', resultElementId);
                } else if (shaResponse.status === 401) {
                    const errorJson = await shaResponse.json();
                    throw new Error(`401 Unauthorized: ${errorJson.message || 'Token kh√¥ng h·ª£p l·ªá ho·∫∑c thi·∫øu quy·ªÅn "repo".'}`);
                } else if (!shaResponse.ok) {
                    const errorJson = await shaResponse.json();
                    throw new Error(`L·ªói API khi l·∫•y SHA: ${shaResponse.status} - ${errorJson.message || shaResponse.statusText}`);
                } else {
                    const data = await shaResponse.json();
                    sha = data.sha;
                    showStatus(`ƒê√£ l·∫•y SHA file th√†nh c√¥ng. SHA: ${sha.substring(0, 10)}...`, 'info', resultElementId);
                }
                
                commitButton.textContent = 'ƒêang Commit (PUT)...';
                
                const payload = {
                    message: commitMessage,
                    content: contentBase64,
                    branch: BRANCH
                };
                if (sha) {
                    payload.sha = sha; 
                }

                const commitResponse = await fetch(fileUrl, {
                    method: 'PUT',
                    headers: { 
                        'Authorization': `Bearer ${pat}`, 
                        'Content-Type': 'application/json',
                        'Accept': 'application/vnd.github.v3+json'
                    },
                    body: JSON.stringify(payload)
                });

                if (commitResponse.status === 401) {
                    const errorJson = await commitResponse.json();
                    throw new Error(`401 Unauthorized: ${errorJson.message || 'Token kh√¥ng h·ª£p l·ªá ho·∫∑c thi·∫øu quy·ªÅn "repo". Vui l√≤ng ki·ªÉm tra l·∫°i Token c·ªßa b·∫°n.'}`);
                } else if (!commitResponse.ok) {
                    const errorData = await commitResponse.json();
                    throw new Error(`Commit th·∫•t b·∫°i: Status ${commitResponse.status}. ${errorData.message || 'L·ªói kh√¥ng x√°c ƒë·ªãnh.'}`);
                }

                const result = await commitResponse.json();
                showStatus(`COMMIT TH√ÄNH C√îNG! D·ªØ li·ªáu ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t tr√™n GitHub. <br>Commit SHA: <a href="${result.commit.html_url}" target="_blank" class="text-white underline">${result.commit.sha.substring(0, 7)}</a>`, 'success', resultElementId);
                
            } catch (error) {
                console.error("L·ªói Commit GitHub:", error);
                showStatus(`L·ªñI COMMIT: ${error.message}`, 'error', resultElementId);
            } finally {
                if(buttonId === 'commitScoreButton') commitButton.textContent = 'COMMIT T·ªà S·ªê ƒê√É THAY ƒê·ªîI';
                if(buttonId === 'commitTeamButton') commitButton.textContent = 'C·∫¨P NH·∫¨T TH√îNG TIN ƒê·ªòI (Ghi ƒë√® state41.json)';
                commitButton.disabled = false;
            }
        }
        
        // --- LOGIC C·∫¨P NH·∫¨T ƒêI·ªÇM S·ªê (state41s.json) ---

        function getDiffData() {
            if (!tournamentData || !initialTournamentData) return null;

            // Bao g·ªìm t·∫•t c·∫£ c√°c v√≤ng ƒë·∫•u
            const rounds = ['matchesA', 'matchesB', 'matchesC', 'matchesD', 'quarterfinals', 'semifinals', 'final'];
            
            const diffData = {};
            
            const compareMatches = (liveMatch, initialMatch) => 
                liveMatch.sA !== initialMatch.sA || liveMatch.sB !== initialMatch.sB;

            rounds.forEach(roundKey => {
                const liveRound = tournamentData[roundKey];
                const initialRound = initialTournamentData[roundKey];

                if (!liveRound) return; 

                if (roundKey === 'final') {
                    // Final l√† m·ªôt object, kh√¥ng ph·∫£i array
                    const initialFinal = initialRound || { sA: null, sB: null };
                    if (liveRound && compareMatches(liveRound, initialFinal)) {
                        diffData[roundKey] = {
                            sA: liveRound.sA,
                            sB: liveRound.sB
                        };
                    }
                    return;
                }
                
                const modifiedMatches = [];
                liveRound.forEach((liveMatch, index) => {
                    const initialMatch = initialRound ? initialRound[index] : null;

                    if (initialMatch && compareMatches(liveMatch, initialMatch)) {
                        modifiedMatches.push({
                            i: index, 
                            sA: liveMatch.sA,
                            sB: liveMatch.sB
                        });
                    }
                });

                if (modifiedMatches.length > 0) {
                    diffData[roundKey] = modifiedMatches;
                }
            });
            return diffData;
        }

        window.commitScoreChangesToGitHub = async function() {
            githubToken = localStorage.getItem('githubToken') || ''; 
            if (!githubToken || githubToken.trim().length === 0) {
                showStatus('L·ªói: Vui l√≤ng nh·∫≠p v√† l∆∞u GitHub Token tr∆∞·ªõc.', 'error', 'scoreCommitResult');
                return;
            }

            const diffData = getDiffData();
            
            if (Object.keys(diffData).length === 0) {
                showStatus('Kh√¥ng c√≥ thay ƒë·ªïi t·ªâ s·ªë n√†o ƒë∆∞·ª£c ghi nh·∫≠n so v·ªõi d·ªØ li·ªáu g·ªëc.', 'info', 'scoreCommitResult');
                return;
            }
            
            const base64Content = jsonToBase64(diffData);
            const commitMessage = 'Update match scores via web app (state41s.json - V4.2.2)';
            
            await getShaAndCommit(SCORE_API_URL, base64Content, commitMessage, 'commitScoreButton', 'scoreCommitResult');
        };

        // --- LOGIC C·∫¨P NH·∫¨T TH√îNG TIN ƒê·ªòI (state41.json) ---
        
        window.commitTeamChangesToGitHub = async function() {
            githubToken = localStorage.getItem('githubToken') || ''; 
            if (!githubToken || githubToken.trim().length === 0) {
                showStatus('L·ªói: Vui l√≤ng nh·∫≠p v√† l∆∞u GitHub Token tr∆∞·ªõc.', 'error', 'teamCommitResult');
                return;
            }

            const fullTeamData = JSON.parse(JSON.stringify(initialTournamentData));

            // Ch·ªâ c·∫≠p nh·∫≠t c√°c tr∆∞·ªùng li√™n quan ƒë·∫øn Team List (tL), lo·∫°i b·ªè c√°c tr∆∞·ªùng t√≠nh to√°n
            fullTeamData.tL = tournamentData.tL.map(team => ({
                 T: team.T, 
                 Tn: team.Tn, 
                 aPL: team.aPL, 
                 g: team.g,
                 s: team.s,
                 P: team.P
            }));

            // FIX C·∫§U TR√öC V4.2: G·ªôp m·∫£ng match l·∫°i th√†nh 'matches' th·ªëng nh·∫•t tr∆∞·ªõc khi commit BASE file
            const commitData = unifyMatches(fullTeamData);
            
            const base64Content = jsonToBase64(commitData);
            const commitMessage = 'Update team details and overwrite state41.json via web app (V4.2.2)';
            
            if (!confirm("C·∫¢NH B√ÅO: Thao t√°c n√†y s·∫Ω GHI ƒê√à TO√ÄN B·ªò file state41.json tr√™n GitHub. B·∫°n c√≥ ch·∫Øc ch·∫Øn kh√¥ng?")) {
                showStatus("Thao t√°c c·∫≠p nh·∫≠t ƒë·ªôi ƒë√£ b·ªã h·ªßy.", 'info', 'teamCommitResult');
                return;
            }

            await getShaAndCommit(BASE_API_URL, base64Content, commitMessage, 'commitTeamButton', 'teamCommitResult');
            
            await loadDataFromGitHub();
            switchTab('TeamManagement');
        }

        // --- H√ÄM H·ªñ TR·ª¢ CHUNG ---

        async function fetchWithRetry(url, options = {}, maxRetries = 3) {
            let lastError = null;
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(url, options);
                    if (response.status === 404) {
                        return null; 
                    }
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status} for ${url}`);
                    }
                    return response;
                } catch (error) {
                    lastError = error;
                    const delay = Math.pow(2, i) * 500; 
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
            console.error(`Failed to fetch data from ${url} after multiple retries.`, lastError);
            throw lastError;
        }

        function getMatchWinner(scoreA, scoreB) {
            const sA = parseInt(scoreA);
            const sB = parseInt(scoreB);
            if (isNaN(sA) || isNaN(sB)) return null; // Tr·∫£ v·ªÅ null thay v√¨ 'Ch∆∞a c√≥' ƒë·ªÉ ƒë∆°n gi·∫£n h√≥a logic
            if (sA > sB) return 'A';
            if (sB > sA) return 'B';
            return 'H√≤a';
        }

        function getTeamByT(teamId) {
            return tournamentData.tL.find(t => t.T === teamId);
        }

        function getTeamByGroupAndRank(group, rank) {
            const teamsInGroup = tournamentData.tL.filter(t => t.g === group);
            return teamsInGroup.sort((a, b) => a.gR - b.gR).find(t => t.gR === rank);
        }

        // --- LOGIC H·ª¢P NH·∫§T D·ªÆ LI·ªÜU ---

        function mergeUpdates(baseData, diffData) {
            if (!diffData || !baseData) return baseData;

            const rounds = ['matchesA', 'matchesB', 'matchesC', 'matchesD', 'quarterfinals', 'semifinals', 'final'];

            rounds.forEach(roundKey => {
                if (!diffData[roundKey]) return;

                if (roundKey === 'final') {
                    if (baseData.final && diffData.final.sA !== undefined) baseData.final.sA = diffData.final.sA;
                    if (baseData.final && diffData.final.sB !== undefined) baseData.final.sB = diffData.final.sB;
                    return;
                }

                const diffMatches = diffData[roundKey]; 
                const baseMatches = baseData[roundKey];

                if (baseMatches && Array.isArray(diffMatches)) {
                    diffMatches.forEach(update => {
                        const matchIndex = update.i;
                        if (baseMatches[matchIndex]) {
                            if (update.sA !== undefined) baseMatches[matchIndex].sA = update.sA;
                            if (update.sB !== undefined) baseMatches[matchIndex].sB = update.sB;
                            baseMatches[matchIndex].Wn = getMatchWinner(baseMatches[matchIndex].sA, baseMatches[matchIndex].sB);
                        }
                    });
                }
            });
            return baseData;
        }
        
        // =========================================================================
        // V4.2 FIX: X·ª≠ l√Ω m·∫£ng 'matches' th·ªëng nh·∫•t
        // =========================================================================

        function splitUnifiedMatches(data) {
            if (data.matches && Array.isArray(data.matches)) {
                data.matchesA = data.matches.filter(m => m.Mc && m.Mc.startsWith('GA'));
                data.matchesB = data.matches.filter(m => m.Mc && m.Mc.startsWith('GB'));
                data.matchesC = data.matches.filter(m => m.Mc && m.Mc.startsWith('GC'));
                data.matchesD = data.matches.filter(m => m.Mc && m.Mc.startsWith('GD'));

                data.quarterfinals = data.matches.filter(m => m.Mc && m.Mc.startsWith('QF'));
                data.semifinals = data.matches.filter(m => m.Mc && m.Mc.startsWith('SF'));
                data.final = data.matches.find(m => m.Mc === 'F') || { Mc: 'F', A: 'SF1 WN', B: 'SF2 WN', sA: null, sB: null, Wn: null }; 

                delete data.matches; 
            }
            return data;
        }

        function unifyMatches(data) {
            if (data.matchesA) {
                const unified = [
                    ...(data.matchesA || []),
                    ...(data.matchesB || []),
                    ...(data.matchesC || []),
                    ...(data.matchesD || []),
                    ...(data.quarterfinals || []),
                    ...(data.semifinals || []),
                ];
                if (data.final && data.final.Mc === 'F') { 
                    unified.push(data.final);
                }
                
                // Sort by Match Code (Mc) for consistency: GA1...GA6, GB1..., QF1..., SF1..., F
                data.matches = unified.sort((a, b) => {
                    if (a.Mc < b.Mc) return -1;
                    if (a.Mc > b.Mc) return 1;
                    return 0;
                });
                
                // Remove temporary keys
                delete data.matchesA;
                delete data.matchesB;
                delete data.matchesC;
                delete data.matchesD;
                delete data.quarterfinals;
                delete data.semifinals;
                delete data.final;
            }
            return data;
        }

        // --- T·∫¢I D·ªÆ LI·ªÜU T·ª™ GITHUB ---
        
        async function loadDataFromGitHub() {
            const loadingMessage = document.getElementById('statusMessage');
            loadingMessage.textContent = "ƒêang t·∫£i d·ªØ li·ªáu g·ªëc (state41.json)...";
            loadingMessage.classList.remove('hidden', 'bg-red-900/50', 'bg-orange-900/50', 'bg-green-900/50');
            loadingMessage.classList.add('bg-blue-900/50');

            let baseData = null;
            let diffData = null;
            
            try {
                // 1. T·∫£i D·ªØ li·ªáu G·ªëc (state41.json)
                const baseResponse = await fetchWithRetry(STATIC_DATA_URL);
                if (!baseResponse) throw new Error("Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu g·ªëc t·ª´ state41.json.");
                
                baseData = await baseResponse.json(); 
                
                // V4.2 FIX: T√°ch m·∫£ng matches th·ªëng nh·∫•t th√†nh c√°c m·∫£ng nh·ªè h∆°n
                baseData = splitUnifiedMatches(baseData); 
                
                // V4.2.1 FIX: Kh·ªüi t·∫°o c√°c tr∆∞·ªùng x·∫øp h·∫°ng b·ªã thi·∫øu (N·∫øu kh√¥ng c√≥ trong JSON g·ªëc)
                baseData.tL.forEach(team => {
                    team.W = team.W || 0;
                    team.L = team.L || 0;
                    team.mP = team.mP || 0;
                    team.gR = team.gR || 0;
                    team.GS = team.GS || 0; 
                    team.GC = team.GC || 0;
                });

                initialTournamentData = JSON.parse(JSON.stringify(baseData)); 
                
                loadingMessage.textContent = "ƒê√£ t·∫£i state41.json. ƒêang ki·ªÉm tra c·∫≠p nh·∫≠t (state41s.json)...";

                // 2. T·∫£i D·ªØ li·ªáu C·∫≠p nh·∫≠t (state41s.json)
                const diffResponse = await fetchWithRetry(DIFF_DATA_URL);
                if (diffResponse) {
                     diffData = await diffResponse.json(); 
                     loadingMessage.textContent = `ƒê√£ t·∫£i state41s.json (${Object.keys(diffData).length} m·ª•c c·∫≠p nh·∫≠t). ƒêang h·ª£p nh·∫•t...`;
                } else {
                     loadingMessage.textContent = "Kh√¥ng t√¨m th·∫•y state41s.json. B·ªè qua c·∫≠p nh·∫≠t t·ªâ s·ªë.";
                }

                // 3. H·ª£p nh·∫•t d·ªØ li·ªáu
                tournamentData = mergeUpdates(baseData, diffData);
                
                // 4. T√≠nh to√°n v√† hi·ªÉn th·ªã l·∫ßn ƒë·∫ßu
                await calculateAndRenderAll();
                switchTab(localStorage.getItem('activeTab') || 'General');

                showStatus('ƒê·ªíNG B·ªò TH√ÄNH C√îNG! D·ªØ li·ªáu ƒë√£ s·∫µn s√†ng.', 'success');

            } catch (error) {
                console.error("L·ªói t·∫£i d·ªØ li·ªáu:", error);
                showStatus(`L·ªñI NGHI√äM TR·ªåNG KHI T·∫¢I D·ªÆ LI·ªÜU: ${error.message}. Vui l√≤ng ki·ªÉm tra file JSON v√† k·∫øt n·ªëi GitHub.`, 'error');
            }
        }
        
        window.reSyncStaticData = function() {
            document.getElementById('confirmationBox').classList.add('hidden');
            loadDataFromGitHub();
        }

        // --- LOGIC T√çNH TO√ÅN & RENDER ---
        
        function calculateStandings(matches, groupName) {
            // L·∫•y danh s√°ch ƒë·ªôi cho b·∫£ng x·∫øp h·∫°ng n√†y
            const teamsToCalculate = tournamentData.tL.filter(t => t.g === groupName);

            // Kh·ªüi t·∫°o/reset stats cho c√°c ƒë·ªôi trong group n√†y tr∆∞·ªõc khi t√≠nh
            teamsToCalculate.forEach(t => { 
                t.W = 0; 
                t.L = 0; 
                t.mP = 0;
                t.GS = 0; 
                t.GC = 0;
                t.gR = 0;
            });
            
            const teamStats = {};
            teamsToCalculate.forEach(t => teamStats[t.T] = { 
                T: t.T, 
                Tn: t.Tn, 
                W: 0, 
                L: 0, 
                mP: 0, 
                GS: 0, 
                GC: 0 
            });

            matches.forEach(match => {
                const sA = parseInt(match.sA);
                const sB = parseInt(match.sB);

                if (!isNaN(sA) && !isNaN(sB)) {
                    const teamA = match.A;
                    const teamB = match.B;

                    if (!teamStats[teamA] || !teamStats[teamB]) return; 

                    // Update Matches Played
                    teamStats[teamA].mP += 1;
                    teamStats[teamB].mP += 1;

                    // Update Scores
                    teamStats[teamA].GS += sA;
                    teamStats[teamA].GC += sB;
                    teamStats[teamB].GS += sB;
                    teamStats[teamB].GC += sA;

                    // Update Wins/Losses
                    if (sA > sB) {
                        teamStats[teamA].W += 1;
                        teamStats[teamB].L += 1;
                    } else if (sB > sA) {
                        teamStats[teamB].W += 1;
                        teamStats[teamA].L += 1;
                    }
                }
            });

            // Convert object to array for sorting
            let standings = Object.values(teamStats);

            // Calculate Score Difference (Diff)
            standings.forEach(t => {
                t.Diff = t.GS - t.GC;
            });

            // Sort logic (Priorities: 1. Wins, 2. Score Diff, 3. Games Scored)
            standings.sort((a, b) => {
                if (b.W !== a.W) return b.W - a.W;
                if (b.Diff !== a.Diff) return b.Diff - a.Diff;
                return b.GS - a.GS;
            });

            // Assign Rank (gR) and merge back into tournamentData.tL
            standings.forEach((t, index) => {
                t.gR = index + 1;
                const fullTeam = tournamentData.tL.find(ts => ts.T === t.T);
                if (fullTeam) {
                    fullTeam.W = t.W;
                    fullTeam.L = t.L;
                    fullTeam.mP = t.mP;
                    fullTeam.gR = t.gR;
                    fullTeam.GS = t.GS;
                    fullTeam.GC = t.GC;
                }
            });

            return standings;
        }

        function determineQuarterfinalists() {
            const groups = ['A', 'B', 'C', 'D'];
            const winners = {}; // Stores { Group: { W1: TeamID, W2: TeamID } }

            groups.forEach(group => {
                // S·ª≠ d·ª•ng tournamentData.tL ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t gR
                const groupTeams = tournamentData.tL.filter(t => t.g === group);
                // S·∫Øp x·∫øp l·∫°i theo gR
                const sortedTeams = groupTeams.sort((a, b) => a.gR - b.gR);

                const firstPlace = sortedTeams.find(t => t.gR === 1);
                const secondPlace = sortedTeams.find(t => t.gR === 2);
                
                // ƒê·∫£m b·∫£o tr·∫£ v·ªÅ placeholder n·∫øu ch∆∞a c√≥ ƒë·ªôi ƒë·ªß ƒëi·ªÅu ki·ªán
                winners[group] = {
                    W1: firstPlace ? firstPlace.T : `${group}1`,
                    W2: secondPlace ? secondPlace.T : `${group}2`
                };
            });

            // C·∫≠p nh·∫≠t ƒë·ªôi v√†o QF
            updateKnockoutMatch('QF1', winners.A.W1, winners.B.W2);
            updateKnockoutMatch('QF2', winners.B.W1, winners.A.W2);
            updateKnockoutMatch('QF3', winners.C.W1, winners.D.W2);
            updateKnockoutMatch('QF4', winners.D.W1, winners.C.W2);
        }

        function updateKnockoutMatch(matchCode, teamA, teamB) {
            let match;
            const round = matchCode.startsWith('QF') ? tournamentData.quarterfinals : 
                          matchCode.startsWith('SF') ? tournamentData.semifinals : 
                          matchCode === 'F' ? tournamentData.final : null;

            if (matchCode === 'F') {
                match = tournamentData.final; // Final is an object, not an array
            } else {
                match = round ? round.find(m => m.Mc === matchCode) : null;
            }

            if (match) {
                // Logic c·∫≠p nh·∫≠t t√™n ƒë·ªôi: CH·ªà c·∫≠p nh·∫≠t n·∫øu match ch∆∞a ƒë∆∞·ª£c ch∆°i ho·∫∑c team hi·ªán t·∫°i l√† placeholder
                const isPlaceholderA = match.A.endsWith('WN') || !getTeamByT(match.A);
                const isPlaceholderB = match.B.endsWith('WN') || !getTeamByT(match.B);

                if (match.sA === null && match.sB === null) {
                    match.A = teamA;
                    match.B = teamB;
                } else {
                     if (isPlaceholderA) { 
                        match.A = teamA;
                    }
                    if (isPlaceholderB) {
                        match.B = teamB;
                    }
                }
                match.Wn = getMatchWinner(match.sA, match.sB);

                // C·∫≠p nh·∫≠t v√≤ng b√°n k·∫øt v√† chung k·∫øt
                if (match.Wn && match.Wn !== 'H√≤a') {
                    const winnerId = match.Wn === 'A' ? match.A : match.B;
                    const winnerPlaceholder = `${matchCode} WN`;

                    if (matchCode.startsWith('QF')) {
                        // C·∫≠p nh·∫≠t b√°n k·∫øt
                        const sfMatch = tournamentData.semifinals.find(sf => sf.A === winnerPlaceholder || sf.B === winnerPlaceholder);
                        if (sfMatch) {
                            if (sfMatch.A === winnerPlaceholder) sfMatch.A = winnerId;
                            if (sfMatch.B === winnerPlaceholder) sfMatch.B = winnerId;
                        }
                    } else if (matchCode.startsWith('SF')) {
                        // C·∫≠p nh·∫≠t chung k·∫øt
                        if (tournamentData.final) {
                             if (tournamentData.final.A === winnerPlaceholder) tournamentData.final.A = winnerId;
                             if (tournamentData.final.B === winnerPlaceholder) tournamentData.final.B = winnerId;
                        }
                    } else if (matchCode === 'F' && match.Wn) {
                         // C·∫≠p nh·∫≠t k·∫øt qu·∫£ chung cu·ªôc (General Tab)
                         const winnerTeam = getTeamByT(winnerId);
                         const finalResultsElement = document.getElementById('finalResults');
                         if (finalResultsElement) {
                             finalResultsElement.innerHTML = `
                                <div class="text-center">
                                    <p class="text-4xl font-black text-yellow-500 mb-2">üèÜ ${winnerTeam ? winnerTeam.Tn : winnerId} üèÜ</p>
                                    <p class="text-lg text-gray-300">Nh√† V√¥ ƒê·ªãch Gi·∫£i ƒê·∫•u Pickleball ITVTG Tournament 2025</p>
                                </div>
                             `;
                         }
                    }
                }
            }
        }
        
        async function calculateAndRenderAll() {
            if (!tournamentData) return;

            // 1. T√≠nh to√°n b·∫£ng x·∫øp h·∫°ng v√≤ng b·∫£ng (B·∫ÆT BU·ªòC CH·∫†Y ƒê·∫¶U TI√äN)
            const groups = ['A', 'B', 'C', 'D'];
            groups.forEach(group => {
                const matches = tournamentData[`matches${group}`];
                // T√≠nh to√°n v√† C·∫¨P NH·∫¨T TR·ª∞C TI·∫æP v√†o tournamentData.tL (bao g·ªìm gR)
                const standings = calculateStandings(matches, group); 
                renderMatches(matches, group); // Render l·∫°i ƒë·ªÉ c·∫≠p nh·∫≠t ng∆∞·ªùi th·∫Øng cu·ªôc
                renderTable(standings, group); // Render b·∫£ng x·∫øp h·∫°ng theo gR m·ªõi
            });

            // 2. C·∫≠p nh·∫≠t ƒë·ªôi v√†o v√≤ng lo·∫°i tr·ª±c ti·∫øp (D·ª±a tr√™n gR ƒë√£ t√≠nh)
            determineQuarterfinalists();
            
            // 3. C·∫≠p nh·∫≠t k·∫øt qu·∫£ Knockout (ƒë·ªÉ ƒë·∫£m b·∫£o nh√°nh ƒë·∫•u ƒë∆∞·ª£c update)
            ['QF1', 'QF2', 'QF3', 'QF4'].forEach(mc => {
                const match = tournamentData.quarterfinals.find(m => m.Mc === mc);
                if (match) updateKnockoutMatch(match.Mc, match.A, match.B);
            });
            
            ['SF1', 'SF2'].forEach(mc => {
                const match = tournamentData.semifinals.find(m => m.Mc === mc);
                if (match) updateKnockoutMatch(match.Mc, match.A, match.B);
            });
            
            // 4. C·∫≠p nh·∫≠t k·∫øt qu·∫£ chung cu·ªôc (d·ª±a tr√™n k·∫øt qu·∫£ F)
            if (tournamentData.final) {
                 updateKnockoutMatch('F', tournamentData.final.A, tournamentData.final.B);
            }

            // 5. Render Knockout
            renderKnockout();

            // 6. Render Team List & Management (N·∫øu c·∫ßn)
            renderTeamList();
            renderTeamManagementList();
        }

        // --- LOGIC RENDER C√ÅC TH√ÄNH PH·∫¶N ---
        
        function handleScoreChange(event, matchCode, teamKey, index) {
            let matchesArray;
            let match;
            
            // X√°c ƒë·ªãnh m·∫£ng matches
            if (matchCode.startsWith('GA')) matchesArray = tournamentData.matchesA;
            else if (matchCode.startsWith('GB')) matchesArray = tournamentData.matchesB;
            else if (matchCode.startsWith('GC')) matchesArray = tournamentData.matchesC;
            else if (matchCode.startsWith('GD')) matchesArray = tournamentData.matchesD;
            else if (matchCode.startsWith('QF')) matchesArray = tournamentData.quarterfinals;
            else if (matchCode.startsWith('SF')) matchesArray = tournamentData.semifinals;
            
            if (matchCode === 'F') {
                match = tournamentData.final;
            } else {
                match = matchesArray ? matchesArray[index] : null;
            }

            if (match) {
                const inputValue = event.target.value.trim();
                const newScore = inputValue === '' ? null : parseInt(inputValue);
                
                // C·∫≠p nh·∫≠t t·ªâ s·ªë m·ªõi
                match[teamKey] = newScore;
                
                // V4.2.2 FIX LOGIC: Ki·ªÉm tra ƒëi·ªÅu ki·ªán k·∫øt th√∫c tr·∫≠n (11 ƒëi·ªÉm, ƒë·ªëi th·ªß < 11)
                const sA = match.sA;
                const sB = match.sB;

                if (!matchCode.startsWith('QF') && !matchCode.startsWith('SF') && matchCode !== 'F') {
                    // √Åp d·ª•ng lu·∫≠t 11 ƒëi·ªÉm cho v√≤ng b·∫£ng
                    if (sA !== null && sB === null && sA >= 11) {
                         match.sB = 0; // Bu·ªôc ƒë·ªôi B = 0 n·∫øu ƒë·ªôi A ƒë·∫°t 11 ƒëi·ªÉm v√† ƒë·ªôi B ch∆∞a c√≥ ƒëi·ªÉm
                    } else if (sB !== null && sA === null && sB >= 11) {
                         match.sA = 0; // Bu·ªôc ƒë·ªôi A = 0 n·∫øu ƒë·ªôi B ƒë·∫°t 11 ƒëi·ªÉm v√† ƒë·ªôi A ch∆∞a c√≥ ƒëi·ªÉm
                    }
                } else {
                    // √Åp d·ª•ng lu·∫≠t 11 ƒëi·ªÉm cho knockout (ch·ªâ khi c·∫£ hai ƒë·ªÅu ƒë√£ c√≥ ƒëi·ªÉm)
                    // Ho·∫∑c c√°c quy t·∫Øc kh√°c cho v√≤ng lo·∫°i tr·ª±c ti·∫øp (v√≠ d·ª•: best of 3/5, nh∆∞ng ·ªü ƒë√¢y ch·ªâ l√† 1 game)
                }

                // C·∫≠p nh·∫≠t ng∆∞·ªùi th·∫Øng cu·ªôc (Wn) v√† recalculate
                match.Wn = getMatchWinner(match.sA, match.sB);

                // C·∫ßn re-calculate to√†n b·ªô ƒë·ªÉ c·∫≠p nh·∫≠t b·∫£ng x·∫øp h·∫°ng v√† nh√°nh Knockout
                calculateAndRenderAll(); 

                // Sau khi t√≠nh to√°n v√† render, c·∫≠p nh·∫≠t l·∫°i gi√° tr·ªã input n·∫øu c√≥ thay ƒë·ªïi (do bu·ªôc v·ªÅ 0)
                if (matchCode.startsWith('G')) {
                    const currentMatch = tournamentData[`matches${matchCode.charAt(1)}`][index];
                     event.target.value = currentMatch[teamKey] !== null ? currentMatch[teamKey] : '';
                }
            }
        }


        function renderMatches(matches, group) {
            const containerId = `matches${group}`;
            const container = document.getElementById(containerId);
            if (!container) return;

            let html = `<h3 class="text-xl font-bold mb-4 text-[var(--group-header-text)]">V√≤ng B·∫£ng ${group} (Matches)</h3>`;

            if (!matches || matches.length === 0) {
                html += '<p class="text-gray-500">Ch∆∞a c√≥ tr·∫≠n ƒë·∫•u n√†o ƒë∆∞·ª£c l√™n l·ªãch.</p>';
            } else {
                matches.forEach((match, index) => {
                    const teamA = getTeamByT(match.A);
                    const teamB = getTeamByT(match.B);

                    const winnerNickname = match.Wn === 'A' && teamA ? teamA.Tn : 
                                           match.Wn === 'B' && teamB ? teamB.Tn : 
                                           '';
                    
                    const teamA_Tn = teamA ? teamA.Tn : match.A;
                    const teamB_Tn = teamB ? teamB.Tn : match.B;
                    
                    const winnerText = match.Wn ? `Th·∫Øng: ${winnerNickname}` : 'Ch∆∞a k·∫øt th√∫c';

                    html += `
                        <div class="match-card p-3 mb-3 rounded-lg flex items-center justify-between">
                            <div class="flex-1 text-left pr-2">
                                <p class="text-sm font-semibold">${match.Mc} (${match.c})</p>
                                <p class="text-xs text-gray-400">${match.t || ''}</p>
                            </div>
                            <div class="flex-1 text-center font-bold">
                                <p class="text-lg text-yellow-400">${teamA_Tn}</p>
                            </div>
                            <div class="flex-shrink-0 flex items-center space-x-2 mx-4">
                                <input type="number" value="${match.sA !== null ? match.sA : ''}" 
                                       onchange="handleScoreChange(event, '${match.Mc}', 'sA', ${index})"
                                       class="score-input w-12 text-center rounded-md" min="0" max="15">
                                <span class="font-bold text-lg">vs</span>
                                <input type="number" value="${match.sB !== null ? match.sB : ''}" 
                                       onchange="handleScoreChange(event, '${match.Mc}', 'sB', ${index})"
                                       class="score-input w-12 text-center rounded-md" min="0" max="15">
                            </div>
                            <div class="flex-1 text-center font-bold">
                                <p class="text-lg text-cyan-400">${teamB_Tn}</p>
                            </div>
                            <div class="flex-1 text-right pl-2 text-sm text-green-500 font-semibold match-winner">
                                ${winnerText}
                            </div>
                        </div>
                    `;
                });
            }
            container.innerHTML = html;
        }

        function renderTable(standings, group) {
            const container = document.getElementById(`table${group}`);
            if (!container) return;

            let html = `<h3 class="text-xl font-bold mb-4 text-[var(--group-header-text)]">B·∫£ng X·∫øp H·∫°ng Group ${group}</h3>`;

            if (!standings || standings.length === 0) {
                 html += '<p class="text-gray-500">Ch∆∞a c√≥ d·ªØ li·ªáu b·∫£ng x·∫øp h·∫°ng.</p>';
            } else {
                html += `
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-[var(--border-color)]">
                            <thead>
                                <tr class="text-xs font-medium uppercase tracking-wider text-gray-400">
                                    <th class="px-2 py-3 text-left">H·∫°ng</th>
                                    <th class="px-3 py-3 text-left">ƒê·ªôi</th>
                                    <th class="px-3 py-3 text-center">T</th>
                                    <th class="px-3 py-3 text-center">B</th>
                                    <th class="px-3 py-3 text-center">HS</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-[var(--border-color)]">
                `;
                
                // V4.2.2 Fix: S·∫Øp x·∫øp standings m·ªôt l·∫ßn n·ªØa theo gR tr∆∞·ªõc khi render (ch·ªâ ƒë·ªÉ ƒë·∫£m b·∫£o)
                const sortedStandings = standings.sort((a, b) => a.gR - b.gR);

                sortedStandings.forEach(team => {
                    const diff = team.GS - team.GC;
                    const diffClass = diff > 0 ? 'text-green-400' : diff < 0 ? 'text-red-400' : 'text-gray-400';
                    html += `
                        <tr class="text-sm font-semibold">
                            <td class="px-2 py-4 whitespace-nowrap text-lg font-extrabold text-[var(--accent-color)]">${team.gR || '-'}</td>
                            <td class="px-3 py-4 whitespace-nowrap">${team.Tn}</td>
                            <td class="px-3 py-4 whitespace-nowrap text-center text-green-500">${team.W}</td>
                            <td class="px-3 py-4 whitespace-nowrap text-center text-red-500">${team.L}</td>
                            <td class="px-3 py-4 whitespace-nowrap text-center ${diffClass}">${diff}</td>
                        </tr>
                    `;
                });
                html += `
                            </tbody>
                        </table>
                    </div>
                `;
            }

            container.innerHTML = html;
        }
        
        function renderKnockout() {
            const renderKnockoutMatch = (match, index, roundName) => {
                const teamA = getTeamByT(match.A);
                const teamB = getTeamByT(match.B);
                
                const teamA_Tn = teamA ? teamA.Tn : match.A;
                const teamB_Tn = teamB ? teamB.Tn : match.B;

                const winnerNickname = match.Wn === 'A' && teamA ? teamA.Tn : 
                                       match.Wn === 'B' && teamB ? teamB.Tn : 
                                       '';
                const containerName = roundName.toLowerCase().replace(/\s/g, '');
                const winnerText = match.Wn ? `Th·∫Øng: ${winnerNickname}` : 'Ch∆∞a k·∫øt th√∫c';


                return `
                    <div class="match-card p-3 mb-3 rounded-lg flex items-center justify-between">
                        <div class="flex-1 text-left pr-2">
                            <p class="text-sm font-semibold text-yellow-400">${match.Mc} (${match.c || 'TBH'})</p>
                            <p class="text-xs text-gray-400">${match.t || ''}</p>
                        </div>
                        <div class="flex-1 text-center font-bold">
                            <p class="text-lg text-yellow-400">${teamA_Tn}</p>
                        </div>
                        <div class="flex-shrink-0 flex items-center space-x-2 mx-4">
                            <input type="number" value="${match.sA !== null ? match.sA : ''}" 
                                   onchange="handleScoreChange(event, '${match.Mc}', 'sA', ${index})"
                                   class="score-input w-12 text-center rounded-md" min="0" max="15">
                            <span class="font-bold text-lg">vs</span>
                            <input type="number" value="${match.sB !== null ? match.sB : ''}" 
                                   onchange="handleScoreChange(event, '${match.Mc}', 'sB', ${index})"
                                   class="score-input w-12 text-center rounded-md" min="0" max="15">
                        </div>
                        <div class="flex-1 text-center font-bold">
                            <p class="text-lg text-cyan-400">${teamB_Tn}</p>
                        </div>
                        <div class="flex-1 text-right pl-2 text-sm text-green-500 font-semibold match-winner">
                            ${winnerText}
                        </div>
                    </div>
                `;
            };

            // Quarterfinals
            let qfHtml = `<h3 class="text-xl font-bold mb-4 text-orange-400">T·ª© K·∫øt (Quarter Finals)</h3>`;
            tournamentData.quarterfinals.forEach((match, index) => {
                qfHtml += renderKnockoutMatch(match, index, 'quarterfinals');
            });
            document.getElementById('quarterfinals').innerHTML = qfHtml;

            // Semifinals
            let sfHtml = `<h3 class="text-xl font-bold mb-4 text-pink-400">B√°n K·∫øt (Semi Finals)</h3>`;
            tournamentData.semifinals.forEach((match, index) => {
                sfHtml += renderKnockoutMatch(match, index, 'semifinals');
            });
            document.getElementById('semifinals').innerHTML = sfHtml;

            // Final
            let finalHtml = `<h3 class="text-xl font-bold mb-4 text-yellow-500">Chung K·∫øt (Final)</h3>`;
            finalHtml += renderKnockoutMatch(tournamentData.final, -1, 'final'); // Index -1 for object
            document.getElementById('finalSection').innerHTML = finalHtml;
        }

        function renderTeamList() {
             const container = document.getElementById('teamList');
             if (!container || !tournamentData || !tournamentData.tL) return;

             let html = '';
             tournamentData.tL.forEach(team => {
                 const players = team.P.map(p => `
                     <li class="text-xs text-gray-400">
                         ${p.name} (${p.bY}, Lv ${p.pL})
                     </li>
                 `).join('');

                 html += `
                    <div class="p-4 bg-[var(--card-bg)] rounded-lg border border-[var(--border-color)]">
                        <h4 class="text-xl font-extrabold text-[var(--accent-color)]">${team.Tn} <span class="text-sm font-normal text-gray-400">(${team.g})</span></h4>
                        <p class="text-sm text-yellow-400 mb-2">C·∫•p ƒë·ªô TB: ${team.aPL}</p>
                        <ul class="list-disc list-inside space-y-1">
                            ${players}
                        </ul>
                    </div>
                 `;
             });
             container.innerHTML = html;
        }
        
        function handleTeamDataChange(event, teamT, playerIndex, field) {
            const team = tournamentData.tL.find(t => t.T === teamT);
            if (!team) return;

            if (playerIndex === -1) { 
                // Team nickname (Tn)
                team[field] = event.target.value;
            } else if (playerIndex >= 0) { 
                // Player field (name, bY, pL)
                const player = team.P[playerIndex];
                if (field === 'pL') {
                    player[field] = parseFloat(event.target.value) || 0;
                } else {
                    player[field] = event.target.value;
                }
            }

             // Recalculate average pick level (aPL)
            if (field === 'pL') {
                const totalPL = team.P.reduce((sum, p) => sum + (parseFloat(p.pL) || 0), 0);
                team.aPL = team.P.length > 0 ? (totalPL / team.P.length).toFixed(1) : 0;
                // Update the displayed aPL
                const aPLElement = document.getElementById(`aPL-${teamT}`);
                if(aPLElement) aPLElement.textContent = team.aPL;
            }
        }
        
        function renderTeamManagementList() {
            const container = document.getElementById('teamManagementList');
            if (!container || !tournamentData || !tournamentData.tL) return;

            let html = '';
            tournamentData.tL.forEach(team => {
                const groupColor = team.g === 'A' ? 'text-green-500' : team.g === 'B' ? 'text-blue-500' : team.g === 'C' ? 'text-purple-500' : 'text-yellow-500';

                let playersHtml = '';
                team.P.forEach((player, pIndex) => {
                    playersHtml += `
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 p-3 bg-[var(--match-bg)] rounded-lg border border-[var(--border-color)] mb-3">
                            <div class="col-span-1 md:col-span-2">
                                <label class="block text-xs font-medium text-gray-400">T√™n Ng∆∞·ªùi Ch∆°i:</label>
                                <input type="text" value="${player.name}" 
                                       onchange="handleTeamDataChange(event, '${team.T}', ${pIndex}, 'name')"
                                       class="text-input w-full p-2 rounded-md">
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-gray-400">NƒÉm Sinh (bY):</label>
                                <input type="text" value="${player.bY}" 
                                       onchange="handleTeamDataChange(event, '${team.T}', ${pIndex}, 'bY')"
                                       class="text-input w-full p-2 rounded-md">
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-gray-400">C·∫•p ƒê·ªô (pL):</label>
                                <input type="number" step="0.5" value="${player.pL}" 
                                       onchange="handleTeamDataChange(event, '${team.T}', ${pIndex}, 'pL')"
                                       class="text-input w-full p-2 rounded-md" min="1.0" max="5.0">
                            </div>
                        </div>
                    `;
                });

                html += `
                    <div class="p-6 bg-[var(--card-bg)] rounded-xl shadow-lg border-l-4 border-l-[var(--accent-color)]">
                        <div class="flex justify-between items-center mb-4 border-b border-[var(--border-color)] pb-3">
                            <h4 class="text-2xl font-extrabold ${groupColor}">Group ${team.g} - ${team.T}</h4>
                            <p class="text-lg font-bold text-yellow-400">aPL: <span id="aPL-${team.T}">${team.aPL}</span></p>
                        </div>
                        
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-400">T√™n ƒê·ªôi R√∫t G·ªçn (Tn):</label>
                            <input type="text" value="${team.Tn}" 
                                   onchange="handleTeamDataChange(event, '${team.T}', -1, 'Tn')"
                                   class="text-input w-full p-2 rounded-md text-lg font-bold mt-1">
                        </div>

                        <h5 class="text-md font-semibold text-[var(--accent-color)] mt-6 mb-3">Th√¥ng Tin Ng∆∞·ªùi Ch∆°i:</h5>
                        ${playersHtml}
                    </div>
                `;
            });
            container.innerHTML = html;
        }


        // --- UI & INITIALIZATION ---

        function switchTab(tabId) {
            const tabs = ['General', 'TeamManagement', 'GroupA', 'GroupB', 'GroupC', 'GroupD', 'Knockout', 'Configuration'];
            tabs.forEach(id => {
                const tabElement = document.getElementById(id);
                const buttonElement = document.querySelector(`[data-tab="${id}"]`);
                if (tabElement) tabElement.style.display = id === tabId ? 'block' : 'none';
                if (buttonElement) buttonElement.classList.toggle('active', id === tabId);
            });
            localStorage.setItem('activeTab', tabId);
        }

        function toggleTheme() {
            const currentTheme = document.body.classList.contains('light-mode') ? 'light' : 'dark';
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            applyTheme(newTheme);
            localStorage.setItem('theme', newTheme);
        }

        function applyTheme(theme) {
            document.body.classList.toggle('light-mode', theme === 'light');
            document.getElementById('sunIcon').classList.toggle('hidden', theme === 'dark');
            document.getElementById('moonIcon').classList.toggle('hidden', theme === 'light');
            document.getElementById('currentThemeDisplay').textContent = theme === 'dark' ? 'T·ªëi' : 'S√°ng';
        }
        
        function handleGesture() {
            if (Math.abs(startX - endX) > swipeThreshold) {
                const currentTab = localStorage.getItem('activeTab') || 'General';
                const tabs = ['General', 'TeamManagement', 'GroupA', 'GroupB', 'GroupC', 'GroupD', 'Knockout', 'Configuration'];
                const currentIndex = tabs.indexOf(currentTab);

                if (currentIndex === -1) return;

                if (startX > endX) { // Swipe Left (Next tab)
                    const nextIndex = (currentIndex + 1) % tabs.length;
                    switchTab(tabs[nextIndex]);
                } else if (startX < endX) { // Swipe Right (Previous tab)
                    const prevIndex = (currentIndex - 1 + tabs.length) % tabs.length;
                    switchTab(tabs[prevIndex]);
                }
            }
        }
        
        function showConfirmationModal() {
            document.getElementById('confirmationBox').classList.remove('hidden');
        }

        function initializeApp() {
            githubToken = localStorage.getItem('githubToken') || '';
            const savedTheme = localStorage.getItem('theme') || 'dark'; 
            applyTheme(savedTheme);

            if (githubToken) {
                 document.getElementById('githubToken').value = '********';
            }

            // Event listeners for theme toggle
            document.getElementById('themeToggle').addEventListener('click', toggleTheme);

            // Event listeners for swipe navigation (on the whole app container)
            document.getElementById('app').addEventListener('touchstart', (e) => {
                // Ignore if touching an input field
                if (e.target.closest('.score-input, .text-input')) return;
                startX = e.changedTouches[0].screenX;
            }, { passive: true });

            document.getElementById('app').addEventListener('touchend', (e) => {
                // Ignore if touching an input field
                if (e.target.closest('.score-input, .text-input')) return;
                endX = e.changedTouches[0].screenX;
                handleGesture();
            }, { passive: true });
            
            // Modal button setup
            document.getElementById('confirmYes').onclick = window.reSyncStaticData;
            document.getElementById('confirmNo').onclick = () => document.getElementById('confirmationBox').classList.add('hidden');

            loadDataFromGitHub();
        }

        window.onload = initializeApp;
    </script>
</body>
</html>
