<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quản Lý Giải Đấu & Cập Nhật Thông Tin (GitHub Sync) V4.3.3 </title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100;400;700;900&display=swap" rel="stylesheet">
    <style>
        /* Base styles for Dark Mode */
        :root {
            --bg-color: #111827; /* Gray-900 */
            --text-color: #f3f4f6; /* Gray-100 */
            --card-bg: #1f2937; /* Gray-800 */
            --border-color: #374151; /* Gray-700 */
            --accent-color: #06b6d4; /* Cyan-500 */
            --match-bg: #1f2937;
            --input-bg: #4b5563; /* Gray-600 */
            --group-header-text: #60a5fa; /* Blue-400 */
        }
        
        /* Light Mode Overrides */
        .light-mode {
            --bg-color: #f9fafb; /* Gray-50 */
            --text-color: #111827; /* Gray-900 */
            --card-bg: #ffffff;
            --border-color: #e5e7eb; /* Gray-200 */
            --accent-color: #ef4444; /* Red-500 */
            --match-bg: #f3f4f6; /* Gray-100 */
            --input-bg: #ffffff;
            --group-header-text: #10b981; /* Emerald-500 */
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            transition: background-color 0.3s, color 0.3s;
        }
        .container {
            max-width: 1200px;
        }
        .score-input, .text-input {
            background-color: var(--input-bg);
            border: 1px solid var(--border-color);
            color: var(--text-color);
        }
        .score-input:focus, .text-input:focus {
            box-shadow: 0 0 0 3px var(--accent-color);
        }
        .tab-button {
            border-bottom-color: var(--border-color);
        }
        .tab-button.active {
            color: var(--accent-color);
            border-color: var(--accent-color);
            background-color: var(--card-bg);
        }
        .tab-content {
            display: none;
            background-color: var(--card-bg);
            border-radius: 0.75rem; /* rounded-xl */
            padding: 1.5rem; /* p-6 */
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); /* shadow-2xl */
        }
        /* Custom scrollbar */
        ::-webkit-scrollbar { height: 8px; }
        ::-webkit-scrollbar-thumb { background: var(--border-color); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #6b7280; }
        
        /* Specific content styles for brightness/clarity */
        .match-card {
            background-color: var(--match-bg);
            border-bottom: 1px solid var(--border-color);
        }
        .light-mode .match-card {
            background-color: #ffffff;
            border-bottom: 1px solid #e5e7eb;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
        }
        /* Modal Backdrop */
        .modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 50;
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <div id="app" class="container mx-auto">
        <header class="flex items-center justify-between mb-6">
            <div class="flex items-center">
                <svg class="w-10 h-10 md:w-12 md:h-12 text-[var(--accent-color)]" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 15.75l-4-4m0 0l4-4m-4 4h14M17 12a5 5 0 11-10 0 5 5 0 0110 0z"></path></svg>
                <div class="text-left ml-4">
                    <h1 class="text-xl md:text-3xl font-extrabold text-[var(--text-color)] leading-none">QUẢN LÝ GIẢI ĐẤU PICKLEBALL (V4.3.3)</h1>
                    <p class="text-xs md:text-sm text-[var(--accent-color)]">Cập Nhật Tỉ Số & Thông Tin Đội (GitHub Sync)  V4.3.3 </p>
                </div>
            </div>
            
            <button id="themeToggle" onclick="toggleTheme()" class="p-3 rounded-full bg-[var(--card-bg)] shadow-md text-[var(--text-color)] hover:bg-[var(--border-color)] transition duration-200">
                <svg id="sunIcon" class="w-6 h-6 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>
                <svg id="moonIcon" class="w-6 h-6 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path></svg>
            </button>
        </header>

        <div id="statusMessage" class="text-center p-4 bg-blue-900/50 rounded-lg text-blue-300 font-semibold mb-6">
            Đang tải dữ liệu trạng thái từ GitHub...
        </div>
        
        <nav class="mb-8 border-b border-[var(--border-color)] overflow-x-auto whitespace-nowrap">
            <button class="tab-button py-3 px-4 md:px-6 text-sm md:text-base font-semibold border-b-2 border-transparent text-gray-400 hover:text-[var(--accent-color)] transition" onclick="switchTab('General')" data-tab="General">General</button>
            <button class="tab-button py-3 px-4 md:px-6 text-sm md:text-base font-semibold border-b-2 border-transparent text-gray-400 hover:text-[var(--accent-color)] transition" onclick="switchTab('TeamManagement')" data-tab="TeamManagement">Quản Lý Đội</button>
            <button class="tab-button py-3 px-4 md:px-6 text-sm md:text-base font-semibold border-b-2 border-transparent text-gray-400 hover:text-[var(--accent-color)] transition" onclick="switchTab('GroupA')" data-tab="GroupA">Group A</button>
            <button class="tab-button py-3 px-4 md:px-6 text-sm md:text-base font-semibold border-b-2 border-transparent text-gray-400 hover:text-[var(--accent-color)] transition" onclick="switchTab('GroupB')" data-tab="GroupB">Group B</button>
            <button class="tab-button py-3 px-4 md:px-6 text-sm md:text-base font-semibold border-b-2 border-transparent text-gray-400 hover:text-[var(--accent-color)] transition" onclick="switchTab('GroupC')" data-tab="GroupC">Group C</button>
            <button class="tab-button py-3 px-4 md:px-6 text-sm md:text-base font-semibold border-b-2 border-transparent text-gray-400 hover:text-[var(--accent-color)] transition" onclick="switchTab('GroupD')" data-tab="GroupD">Group D</button>
            <button class="tab-button py-3 px-4 md:px-6 text-sm md:text-base font-semibold border-b-2 border-transparent text-gray-400 hover:text-[var(--accent-color)] transition" onclick="switchTab('Knockout')" data-tab="Knockout">Knockout</button>
            <button class="tab-button py-3 px-4 md:px-6 text-sm md:text-base font-semibold border-b-2 border-transparent text-gray-400 hover:text-[var(--accent-color)] transition" onclick="switchTab('Configuration')" data-tab="Configuration">Cấu Hình</button>
        </nav>

        <div id="General" class="tab-content">
             <h2 class="text-3xl font-extrabold text-yellow-500 mb-6 border-b border-[var(--border-color)] pb-2">Final Results (Kết quả chung cuộc)</h2>
            <section id="finalResults" class="mb-10 p-4 rounded-xl shadow-lg bg-[var(--match-bg)]">
                <div class="text-center">
                    <p class="text-4xl font-black text-gray-500 mb-2">Chưa xác định</p>
                    <p class="text-lg text-gray-500">Nhà Vô Địch Giải Đấu Pickleball ITVTG Tournament 2025</p>
                </div>
            </section>

            <h2 class="text-3xl font-extrabold text-[var(--text-color)] mb-6 border-b border-[var(--border-color)] pb-2">Team List (Danh sách các đội)</h2>
            <section id="teamList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                </section>
        </div>
        
        <div id="TeamManagement" class="tab-content">
            <h2 class="text-3xl font-extrabold text-blue-500 mb-6 border-b border-[var(--border-color)] pb-2">Quản Lý Thông Tin Đội (Cập nhật **`state41.json`**)</h2>
            <p class="text-sm text-gray-400 mb-4">Điều chỉnh **Tên đội (Tn)**, **Tên người chơi (name)**, **Cấp độ (pL)**, và **Năm sinh (bY)**. Sau khi chỉnh sửa, hãy nhấn **CẬP NHẬT THÔNG TIN** để ghi đè `state41.json`.</p>
            
            <button id="commitTeamButton" onclick="commitTeamChangesToGitHub()" class="w-full md:w-auto px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-lg shadow-lg transition duration-300 mb-6 disabled:opacity-50">
                CẬP NHẬT THÔNG TIN ĐỘI (Ghi đè state41.json)
            </button>
            
            <div id="teamCommitResult" class="mt-3 p-3 rounded-lg text-sm font-semibold hidden"></div>

            <section id="teamManagementList" class="space-y-6"></section>
        </div>


        <div id="GroupA" class="tab-content space-y-6">
            <button onclick="simulateScores('A')" class="w-full md:w-auto px-6 py-2 bg-yellow-600 hover:bg-yellow-700 text-white font-bold rounded-lg shadow-lg transition duration-300">
                GIẢ LẬP TỈ SỐ VÒNG BẢNG A
            </button>
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div id="tableA" class="lg:col-span-1"></div>
                <div id="matchesA" class="lg:col-span-2"></div>
            </div>
        </div>

        <div id="GroupB" class="tab-content space-y-6">
            <button onclick="simulateScores('B')" class="w-full md:w-auto px-6 py-2 bg-yellow-600 hover:bg-yellow-700 text-white font-bold rounded-lg shadow-lg transition duration-300">
                GIẢ LẬP TỈ SỐ VÒNG BẢNG B
            </button>
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div id="tableB" class="lg:col-span-1"></div>
                <div id="matchesB" class="lg:col-span-2"></div>
            </div>
        </div>

        <div id="GroupC" class="tab-content space-y-6">
             <button onclick="simulateScores('C')" class="w-full md:w-auto px-6 py-2 bg-yellow-600 hover:bg-yellow-700 text-white font-bold rounded-lg shadow-lg transition duration-300">
                GIẢ LẬP TỈ SỐ VÒNG BẢNG C
            </button>
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div id="tableC" class="lg:col-span-1"></div>
                <div id="matchesC" class="lg:col-span-2"></div>
            </div>
        </div>

        <div id="GroupD" class="tab-content space-y-6">
             <button onclick="simulateScores('D')" class="w-full md:w-auto px-6 py-2 bg-yellow-600 hover:bg-yellow-700 text-white font-bold rounded-lg shadow-lg transition duration-300">
                GIẢ LẬP TỈ SỐ VÒNG BẢNG D
            </button>
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div id="tableD" class="lg:col-span-1"></div>
                <div id="matchesD" class="lg:col-span-2"></div>
            </div>
        </div>

        <div id="Knockout" class="tab-content">
            <h2 class="text-3xl font-extrabold text-[var(--group-header-text)] mb-6 border-b border-[var(--border-color)] pb-2">Vòng Loại Trực Tiếp (Knockout Stage)</h2>
            <button onclick="simulateScores('Knockout')" class="w-full md:w-auto px-6 py-2 bg-red-600 hover:bg-red-700 text-white font-bold rounded-lg shadow-lg transition duration-300 mb-6">
                GIẢ LẬP TỈ SỐ VÒNG LOẠI (QF, SF, F)
            </button>
            <div id="quarterfinals" class="mb-6"></div>
            <div id="semifinals" class="mb-6"></div>
            <div id="finalMatchSection">
                <div id="finalSection"></div>
            </div>
        </div>

        <div id="Configuration" class="tab-content space-y-8">
            <h2 class="text-3xl font-extrabold text-red-500 mb-6 border-b border-[var(--border-color)] pb-2">Cấu Hình & Đồng Bộ Hóa (GitHub API)</h2>
            
             <section class="p-4 bg-red-900/20 rounded-lg border-l-4 border-red-500">
                <h3 class="text-xl font-bold text-red-400 mb-3 flex items-center">
                    <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-2a2 2 0 00-2-2H6a2 2 0 00-2 2v2a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path></svg>
                    1. GitHub Personal Access Token (PAT)
                </h3>
                <p class="text-sm text-red-300 mb-4 font-bold">CẢNH BÁO BẢO MẬT: Token này sẽ được lưu trữ trong trình duyệt. Chỉ sử dụng Token có phạm vi (Scope) nhỏ nhất. <span class="text-yellow-300">CẦN PHẢI CÓ QUYỀN **repo** (hoặc contents:write)</span>.</p>
                <input type="password" id="githubToken" 
                    class="score-input w-full p-2 rounded-md focus:ring-red-500 transition" 
                    placeholder="Dán GitHub PAT của bạn vào đây...">
                <button onclick="saveToken()" class="mt-2 px-4 py-1 bg-green-600 hover:bg-green-700 text-white text-sm font-bold rounded-lg transition duration-300">Lưu Token cục bộ</button>
            </section>

            <section class="p-4 bg-[var(--match-bg)] rounded-lg border-l-4 border-purple-500">
                <h3 class="text-xl font-bold text-[var(--group-header-text)] mb-3 flex items-center">
                    <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4"></path></svg>
                    2. Cập Nhật Tỉ Số (Commit) lên **state41s.json**
                </h3>
                <p class="text-gray-400 mb-4">Sử dụng Token đã lưu để commit những tỉ số **đã thay đổi** lên GitHub (file `state41s.json`).</p>
                
                <button id="commitScoreButton" onclick="commitScoreChangesToGitHub()" class="w-full md:w-auto px-6 py-2 bg-purple-600 hover:bg-purple-700 text-white font-bold rounded-lg shadow-lg transition duration-300 mb-4 disabled:opacity-50">
                    COMMIT TỈ SỐ ĐÃ THAY ĐỔI
                </button>

                <div id="scoreCommitResult" class="mt-3 p-3 rounded-lg text-sm font-semibold hidden"></div>
            </section>
            
             <section class="p-4 bg-[var(--match-bg)] rounded-lg border-l-4 border-green-500">
                 <h3 class="text-xl font-bold text-[var(--group-header-text)] mb-3 flex items-center">
                    <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                    3. Xuất Dữ Liệu Giải Đấu (state41.json Format)
                </h3>
                <p class="text-[var(--text-color)] mb-4">Tạo và tải về file JSON chứa toàn bộ trạng thái giải đấu hiện tại, bao gồm thông tin đội và tỉ số đã tính toán.</p>
                <button onclick="exportTournamentData()" class="md:w-auto px-6 py-2 bg-green-600 hover:bg-green-700 text-white font-bold rounded-lg shadow-lg transition duration-300">
                    TẢI XUỐNG TOÀN BỘ JSON
                </button>
                <div id="configExportResult" class="mt-3 p-3 rounded-lg text-sm font-semibold hidden"></div>
            </section>
            
            <section class="p-4 bg-[var(--match-bg)] rounded-lg border-l-4 border-red-500">
                <h3 class="text-xl font-bold text-red-400 mb-3 flex items-center">
                    <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                    4. Xóa (Reset) Tỉ Số Trận Đấu
                </h3>
                <p class="text-gray-400 mb-4">Chọn vòng đấu và nhấn nút để **XÓA TẤT CẢ** tỉ số đã nhập trong vòng đó về trạng thái trống (null).</p>
                
                <div class="flex flex-col md:flex-row space-y-3 md:space-y-0 md:space-x-4">
                    <select id="resetRoundSelector" class="text-input w-full md:w-1/2 p-2 rounded-md">
                        <option value="">-- Chọn Vòng Đấu --</option>
                        <option value="A">Vòng Bảng A</option>
                        <option value="B">Vòng Bảng B</option>
                        <option value="C">Vòng Bảng C</option>
                        <option value="D">Vòng Bảng D</option>
                        <option value="QF">Tứ Kết (QF)</option>
                        <option value="SF">Bán Kết (SF)</option>
                        <option value="F">Chung Kết (F)</option>
                    </select>
                    
                    <button onclick="confirmResetScores()" class="w-full md:w-auto px-6 py-2 bg-red-600 hover:bg-red-700 text-white font-bold rounded-lg shadow-lg transition duration-300 disabled:opacity-50">
                        XÓA TỈ SỐ ĐÃ CHỌN
                    </button>
                </div>
                <div id="resetResult" class="mt-3 p-3 rounded-lg text-sm font-semibold hidden"></div>
            </section>
            
            <section class="p-4 bg-[var(--match-bg)] rounded-lg border-l-4 border-yellow-500">
                 <h3 class="text-xl font-bold text-[var(--group-header-text)] mb-3 flex items-center">
                    <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>
                    5. Tùy Chọn Giao Diện & Đồng Bộ Lại
                </h3>
                <p class="text-[var(--text-color)] mb-4">Bạn có thể chuyển đổi giữa giao diện Sáng/Tối hoặc tải lại trạng thái online mới nhất.</p>
                <button onclick="document.getElementById('themeToggle').click()" class="md:w-auto px-6 py-2 bg-yellow-500 hover:bg-yellow-600 text-black font-bold rounded-lg shadow-lg transition duration-300 mr-4">
                    Chuyển Đổi Giao Diện (Hiện tại: <span id="currentThemeDisplay">Tối</span>)
                </button>
                <button id="reSyncButton" onclick="showConfirmationModal()" class="md:w-auto px-6 py-2 bg-red-600 hover:bg-red-700 text-white font-bold rounded-lg shadow-lg transition duration-300">
                    Đồng Bộ Lại (Tải lại từ GitHub)
                </button>
            </section>

        </div>

    </div>
    
    <div id="confirmationBox" class="modal-backdrop hidden">
        <div class="bg-[var(--card-bg)] p-6 rounded-xl shadow-2xl w-11/12 max-w-sm border-t-4 border-red-500 text-[var(--text-color)]">
            <h4 class="text-xl font-bold text-red-400 mb-4">Xác Nhận Đồng Bộ Lại</h4>
            <p class="text-[var(--text-color)] mb-6">Bạn có chắc chắn muốn **ĐỒNG BỘ LẠI** trạng thái giải đấu về dữ liệu mới nhất từ GitHub không? Điều này sẽ ghi đè trạng thái đang nhập cục bộ!</p>
            <div class="flex justify-end space-x-4">
                <button id="confirmNo" class="px-4 py-2 bg-gray-600 hover:bg-gray-500 text-white rounded-lg transition duration-150">Hủy bỏ</button>
                <button id="confirmYes" class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white font-bold rounded-lg transition duration-150">Xác nhận Đồng bộ</button>
            </div>
        </div>
    </div>

    <script>
        
        // ==============================================================================================================
        // KHỐI CẤU HÌNH GITHUB API & DỮ LIỆU (Phiên bản V4.3.3 - FIX LIVE STANDINGS)
        // ==============================================================================================================
        const GITHUB_REPO_OWNER = 'cqtin2024';
        const GITHUB_REPO_NAME = 'ITVTG';
        
        // Cấu hình cho file Điểm số (diff) - state41s.json
        const SCORE_FILE_PATH = 'data/state41s.json'; 
        const SCORE_API_URL = `https://api.github.com/repos/${GITHUB_REPO_OWNER}/${GITHUB_REPO_NAME}/contents/${SCORE_FILE_PATH}`;
        const DIFF_DATA_URL = `https://raw.githubusercontent.com/${GITHUB_REPO_OWNER}/${GITHUB_REPO_NAME}/main/${SCORE_FILE_PATH}`;

        // Cấu hình cho file Dữ liệu Gốc (Team/Init) - state41.json
        const BASE_FILE_PATH = 'data/state41.json'; 
        const BASE_API_URL = `https://api.github.com/repos/${GITHUB_REPO_OWNER}/${GITHUB_REPO_NAME}/contents/${BASE_FILE_PATH}`;
        const STATIC_DATA_URL = `https://raw.githubusercontent.com/${GITHUB_REPO_OWNER}/${GITHUB_REPO_NAME}/main/${BASE_FILE_PATH}`;

        const BRANCH = 'main';

        let tournamentData = null; 
        let initialTournamentData = null; 
        let githubToken = ''; 
        let startX = 0; 
        let endX = 0;  
        const swipeThreshold = 75; 
        
        // Hàm chuyển đổi JSON sang Base64
        const jsonToBase64 = (json) => btoa(unescape(encodeURIComponent(JSON.stringify(json, null, 2))));
        
        // --- CHỨC NĂNG TƯƠNG TÁC GITHUB CHUNG ---

        function saveToken() {
            const tokenInput = document.getElementById('githubToken').value.trim();
            if (tokenInput.length > 0 && tokenInput !== '********') {
                githubToken = tokenInput;
                localStorage.setItem('githubToken', githubToken);
                showStatus('Token đã được lưu cục bộ. Hãy thử COMMIT.', 'success', 'scoreCommitResult');
                showStatus('Token đã được lưu cục bộ. Hãy thử COMMIT.', 'success', 'teamCommitResult');
                document.getElementById('githubToken').value = '********';
            } else if (tokenInput.length === 0) {
                 githubToken = '';
                 localStorage.removeItem('githubToken');
                 showStatus('Token đã bị xóa khỏi bộ nhớ cục bộ.', 'info', 'scoreCommitResult');
                 showStatus('Token đã bị xóa khỏi bộ nhớ cục bộ.', 'info', 'teamCommitResult');
                 document.getElementById('githubToken').value = '';
            } else {
                 showStatus('Vui lòng nhập Token mới hoặc Token đã được lưu.', 'info', 'scoreCommitResult');
                 showStatus('Vui lòng nhập Token mới hoặc Token đã được lưu.', 'info', 'teamCommitResult');
            }
        }
        
        function showStatus(message, type = 'info', elementId = 'statusMessage') {
            const statusElement = document.getElementById(elementId);
            if (!statusElement) return;

            statusElement.innerHTML = message;
            statusElement.classList.remove('hidden', 'bg-red-900/50', 'bg-green-900/50', 'bg-blue-900/50', 'bg-orange-900/50');
            
            if (type === 'success') {
                statusElement.classList.add('bg-green-900/50');
            } else if (type === 'error') {
                statusElement.classList.add('bg-red-900/50');
            } else if (type === 'warning') {
                 statusElement.classList.add('bg-orange-900/50');
            } else {
                 statusElement.classList.add('bg-blue-900/50');
            }
            statusElement.style.display = 'block';

            // Không ẩn cảnh báo lỗi nhập điểm
            if (elementId !== 'scoreError' && type !== 'error' && elementId !== 'resetResult') {
                setTimeout(() => statusElement.style.display = 'none', 5000);
            }
            // Hiển thị resetResult lâu hơn
            if (elementId === 'resetResult') {
                setTimeout(() => statusElement.style.display = 'none', 10000);
            }
        }
        
        async function getShaAndCommit(fileUrl, contentBase64, commitMessage, buttonId, resultElementId) {
            const pat = githubToken.trim();
            const commitButton = document.getElementById(buttonId);
            commitButton.disabled = true;
            commitButton.textContent = 'Đang tiến hành...';

            let sha = null;
            
            try {
                showStatus('Đang lấy SHA hiện tại của file...', 'info', resultElementId);

                const shaResponse = await fetch(fileUrl + `?ref=${BRANCH}`, {
                    headers: { 'Authorization': `Bearer ${pat}` } 
                });

                if (shaResponse.status === 404) {
                    showStatus('File chưa tồn tại trên nhánh, sẽ tạo mới.', 'info', resultElementId);
                } else if (shaResponse.status === 401) {
                    const errorJson = await shaResponse.json();
                    throw new Error(`401 Unauthorized: ${errorJson.message || 'Token không hợp lệ hoặc thiếu quyền "repo".'}`);
                } else if (!shaResponse.ok) {
                    const errorJson = await shaResponse.json();
                    throw new Error(`Lỗi API khi lấy SHA: ${shaResponse.status} - ${errorJson.message || shaResponse.statusText}`);
                } else {
                    const data = await shaResponse.json();
                    sha = data.sha;
                    showStatus(`Đã lấy SHA file thành công. SHA: ${sha.substring(0, 10)}...`, 'info', resultElementId);
                }
                
                commitButton.textContent = 'Đang Commit (PUT)...';
                
                const payload = {
                    message: commitMessage,
                    content: contentBase64,
                    branch: BRANCH
                };
                if (sha) {
                    payload.sha = sha; 
                }

                const commitResponse = await fetch(fileUrl, {
                    method: 'PUT',
                    headers: { 
                        'Authorization': `Bearer ${pat}`, 
                        'Content-Type': 'application/json',
                        'Accept': 'application/vnd.github.v3+json'
                    },
                    body: JSON.stringify(payload)
                });

                if (commitResponse.status === 401) {
                    const errorJson = await commitResponse.json();
                    throw new Error(`401 Unauthorized: ${errorJson.message || 'Token không hợp lệ hoặc thiếu quyền "repo". Vui lòng kiểm tra lại Token của bạn.'}`);
                } else if (!commitResponse.ok) {
                    const errorData = await commitResponse.json();
                    throw new Error(`Commit thất bại: Status ${commitResponse.status}. ${errorData.message || 'Lỗi không xác định.'}`);
                }

                const result = await commitResponse.json();
                showStatus(`COMMIT THÀNH CÔNG! Dữ liệu đã được cập nhật trên GitHub. <br>Commit SHA: <a href="${result.commit.html_url}" target="_blank" class="text-white underline">${result.commit.sha.substring(0, 7)}</a>`, 'success', resultElementId);
                
            } catch (error) {
                console.error("Lỗi Commit GitHub:", error);
                showStatus(`LỖI COMMIT: ${error.message}`, 'error', resultElementId);
            } finally {
                if(buttonId === 'commitScoreButton') commitButton.textContent = 'COMMIT TỈ SỐ ĐÃ THAY ĐỔI';
                if(buttonId === 'commitTeamButton') commitButton.textContent = 'CẬP NHẬT THÔNG TIN ĐỘI (Ghi đè state41.json)';
                commitButton.disabled = false;
            }
        }
        
        // --- LOGIC CẬP NHẬT ĐIỂM SỐ (state41s.json) ---

        function getDiffData() {
            if (!tournamentData || !initialTournamentData) return null;

            // Bao gồm tất cả các vòng đấu
            const rounds = ['matchesA', 'matchesB', 'matchesC', 'matchesD', 'quarterfinals', 'semifinals', 'final'];
            
            const diffData = {};
            
            // Hàm so sánh tỉ số (để biết đã thay đổi so với initial chưa)
            const compareMatches = (liveMatch, initialMatch) => 
                liveMatch.sA !== initialMatch.sA || liveMatch.sB !== initialMatch.sB;

            rounds.forEach(roundKey => {
                if (!tournamentData[roundKey]) return; 

                const liveRound = tournamentData[roundKey];
                const initialRound = initialTournamentData[roundKey];
                
                // Trường hợp đặc biệt: Final (là object)
                if (roundKey === 'final') {
                    const initialFinal = initialRound || { sA: null, sB: null };
                    // Nếu tỉ số hiện tại khác initial HOẶC tỉ số hiện tại là null (đã reset)
                    if (compareMatches(liveRound, initialFinal) || (liveRound.sA === null && liveRound.sB === null && (initialFinal.sA !== null || initialFinal.sB !== null))) {
                        diffData[roundKey] = {
                            sA: liveRound.sA,
                            sB: liveRound.sB
                        };
                    }
                    return;
                }
                
                // Trường hợp chung: Vòng bảng và Knockout (là array)
                const modifiedMatches = [];
                liveRound.forEach((liveMatch, index) => {
                    const initialMatch = initialRound ? initialRound[index] : null;

                    if (initialMatch && (compareMatches(liveMatch, initialMatch) || (liveMatch.sA === null && liveMatch.sB === null && (initialMatch.sA !== null || initialMatch.sB !== null)))) {
                        modifiedMatches.push({
                            i: index, 
                            sA: liveMatch.sA,
                            sB: liveMatch.sB
                        });
                    }
                });

                if (modifiedMatches.length > 0) {
                    diffData[roundKey] = modifiedMatches;
                }
            });
            return diffData;
        }

        window.commitScoreChangesToGitHub = async function() {
            githubToken = localStorage.getItem('githubToken') || ''; 
            if (!githubToken || githubToken.trim().length === 0) {
                showStatus('Lỗi: Vui lòng nhập và lưu GitHub Token trước.', 'error', 'scoreCommitResult');
                return;
            }

            const diffData = getDiffData();
            
            if (Object.keys(diffData).length === 0) {
                showStatus('Không có thay đổi tỉ số nào được ghi nhận so với dữ liệu gốc.', 'info', 'scoreCommitResult');
                return;
            }
            
            const base64Content = jsonToBase64(diffData);
            const commitMessage = 'Update match scores via web app (state41s.json - V4.3.3)'; // Version updated
            
            await getShaAndCommit(SCORE_API_URL, base64Content, commitMessage, 'commitScoreButton', 'scoreCommitResult');
        };

        // --- LOGIC CẬP NHẬT THÔNG TIN ĐỘI (state41.json) ---
        
        window.commitTeamChangesToGitHub = async function() {
            githubToken = localStorage.getItem('githubToken') || ''; 
            if (!githubToken || githubToken.trim().length === 0) {
                showStatus('Lỗi: Vui lòng nhập và lưu GitHub Token trước.', 'error', 'teamCommitResult');
                return;
            }

            // Dùng dữ liệu gốc (initialTournamentData) để tránh commit các trường tính toán từ state41s.json
            const fullTeamData = JSON.parse(JSON.stringify(initialTournamentData));

            // Chỉ cập nhật các trường liên quan đến Team List (tL) từ dữ liệu hiện tại (tournamentData)
            fullTeamData.tL = tournamentData.tL.map(team => ({
                 T: team.T, 
                 Tn: team.Tn, 
                 aPL: team.aPL, 
                 g: team.g,
                 s: team.s,
                 // Lấy lại các trường Rank (gR), W, L, mP, GS, GC từ dữ liệu hiện tại nếu nó đã được tính
                 W: team.W || 0,
                 L: team.L || 0,
                 mP: team.mP || 0,
                 gR: team.gR || 0,
                 GS: team.GS || 0,
                 GC: team.GC || 0,
                 P: team.P // P already contains updated name/pL/bY etc.
            }));

            // FIX CẤU TRÚC V4.2: Gộp mảng match lại thành 'matches' thống nhất trước khi commit BASE file
            // ** Cần đảm bảo hàm unifyMatches đã được định nghĩa **
            const commitData = unifyMatches(fullTeamData);
            const base64Content = jsonToBase64(commitData);
            const commitMessage = 'Update team details and overwrite state41.json via web app (V4.3.3)'; // Version updated

            if (!confirm("CẢNH BÁO: Thao tác này sẽ GHI ĐÈ TOÀN BỘ file state41.json trên GitHub. Bạn có chắc chắn không?")) {
                showStatus("Thao tác cập nhật đội đã bị hủy.", 'info', 'teamCommitResult');
                return;
            }

            await getShaAndCommit(BASE_API_URL, base64Content, commitMessage, 'commitTeamButton', 'teamCommitResult');

            // Sau khi commit thành công, tải lại dữ liệu để đảm bảo đồng bộ
            await loadDataFromGitHub();
            switchTab('TeamManagement');
        }

        // --- HÀM TIỆN ÍCH CHO TÍNH TOÁN V4.3.3 ---
        
        /**
         * Hàm tiện ích để xác định roundKey từ matchCode
         */
        function getRoundKeyFromMatchCode(matchCode) {
            if (!matchCode) return null;
            if (matchCode.startsWith('G')) {
                return `matches${matchCode.charAt(1)}`; // matchesA, matchesB, ...
            } else if (matchCode.startsWith('Q')) {
                return 'quarterfinals';
            } else if (matchCode.startsWith('S')) {
                return 'semifinals';
            } else if (matchCode.startsWith('F')) {
                return 'final';
            }
            return null;
        }

        
        // =========================================================================
        // PHẦN SỬA LỖI V4.3.3: Tái tính toán và Re-render Bảng xếp hạng sau khi nhập tỉ số
        // =========================================================================

        /**
         * Hàm xử lý khi tỉ số được thay đổi trên giao diện
         * Đã bổ sung logic Tái tính toán (recalculate) và Tái hiển thị (re-render)
         * Bảng xếp hạng Vòng Bảng ngay lập tức.
         */
        window.handleScoreChange = function(event) {
            const input = event.target;
            const matchCode = input.getAttribute('data-match');
            const teamIndex = input.getAttribute('data-team');
            // Đảm bảo giá trị là số hoặc null nếu rỗng
            const newScore = input.value.trim() === '' ? null : (parseInt(input.value) || 0);

            // --- BƯỚC 1: Cập nhật trạng thái Tỉ số cục bộ ---
            const roundKey = getRoundKeyFromMatchCode(matchCode);
            if (roundKey && tournamentData && tournamentData[roundKey]) {
                const isFinal = roundKey === 'final';
                let match;
                
                if (isFinal) {
                    match = tournamentData[roundKey];
                } else {
                    // Cập nhật cho Vòng Bảng/Knockout Array (Tìm theo Mc)
                    match = tournamentData[roundKey].find(m => m.Mc === matchCode);
                }
                    
                if (match) {
                    if (teamIndex === 'h') {
                        match.sA = newScore;
                    } else if (teamIndex === 'a') {
                        match.sB = newScore;
                    }
                }
            }


            // --- BƯỚC 2: Kích hoạt Tái tính toán và Tái hiển thị (FIXED LOGIC V4.3.3) ---
            
            if (matchCode.startsWith('G')) { // Vòng Bảng
                const groupCode = matchCode.charAt(1); 

                // 1. Tái tính toán Bảng xếp hạng (cập nhật W, L, Pts, gR)
                if (window.calculateGroupStandings) {
                    window.calculateGroupStandings(groupCode);
                }

                // 2. Tái hiển thị Bảng xếp hạng (hiển thị lại HTML)
                if (window.renderGroupStandingTable) {
                    window.renderGroupStandingTable(groupCode);
                }
            }
            
            // Cập nhật nhánh Knockout khi tỉ số vòng loại thay đổi
            if (matchCode.startsWith('Q') || matchCode.startsWith('S') || matchCode.startsWith('F')) {
                 if (window.updateKnockoutBrackets) {
                    window.updateKnockoutBrackets();
                }
            }
            
            // Tùy chọn: Tái hiển thị kết quả Final/General
            if (window.renderFinalResults) {
                window.renderFinalResults();
            }
        };


        // --- LOGIC XUẤT DỮ LIỆU JSON ---
        window.exportTournamentData = function() {
            if (!tournamentData) {
                showStatus('Lỗi: Không có dữ liệu để xuất.', 'error', 'configExportResult');
                return;
            }
            // 1. Tạo bản sao của dữ liệu hiện tại
            let exportData = JSON.parse(JSON.stringify(tournamentData));
            // 2. Hợp nhất tất cả các trận đấu vào mảng 'matches' duy nhất (đúng định dạng state41.json)
            // ** Cần đảm bảo hàm unifyMatches đã được định nghĩa **
            exportData = unifyMatches(exportData); 
            // 3. Chuẩn bị file JSON
            const jsonString = JSON.stringify(exportData, null, 2);
            const blob = new Blob([jsonString], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            // 4. Tạo link download
            const a = document.createElement('a');
            a.href = url;
            const now = new Date();
            const dateStr = `${now.getFullYear()}${String(now.getMonth() + 1).padStart(2, '0')}${String(now.getDate()).padStart(2, '0')}_${String(now.getHours()).padStart(2, '0')}${String(now.getMinutes()).padStart(2, '0')}`;
            a.download = `state41_FULL_EXPORT_${dateStr}.json`;
            // 5. Kích hoạt download
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            showStatus('Đã xuất toàn bộ dữ liệu thành công!', 'success', 'configExportResult');
        }

        // --- LOGIC GIẢ LẬP TỈ SỐ (Random Score) ---
        /**
         * Tạo tỉ số ngẫu nhiên theo luật giới hạn điểm.
         * @param {boolean} isGroupMatch - True nếu là vòng bảng (Max 11), False nếu là vòng loại (Max 15).
         * @returns {{sA: number, sB: number}} Tỉ số ngẫu nhiên.
         */
        function getSimulatedScore(isGroupMatch) {
            const WIN_SCORE = isGroupMatch ? 11 : 15;
            const MAX_LOSS_SCORE = WIN_SCORE - 1; 

            // Chọn ngẫu nhiên đội thắng
            const winner = Math.random() < 0.5 ? 'A' : 'B';

            // Điểm đội thua phải < điểm đội thắng (WIN_SCORE) và <= MAX_LOSS_SCORE
            const lossScore = Math.floor(Math.random() * (MAX_LOSS_SCORE + 1)); // Random từ 0 đến MAX_LOSS_SCORE

            if (winner === 'A') {
                return { sA: WIN_SCORE, sB: lossScore };
            } else {
                return { sA: lossScore, sB: WIN_SCORE };
            }
        }

        window.simulateScores = function(roundType) {
            if (!tournamentData) return showStatus('Lỗi: Không có dữ liệu giải đấu.', 'error', 'statusMessage');

            let matchesToSimulate = [];
            let isGroup = false;

            if (roundType.length === 1 && ['A', 'B', 'C', 'D'].includes(roundType)) { 
                // Vòng bảng
                matchesToSimulate = tournamentData[`matches${roundType}`];
                isGroup = true;
                if (!matchesToSimulate || matchesToSimulate.length === 0) return showStatus(`Không có trận đấu nào trong Bảng ${roundType} để giả lập.`, 'warning', 'statusMessage');
            } else if (roundType === 'Knockout') { 
                // Vòng loại trực tiếp
                // Lọc bỏ match.final nếu nó là null
                const finalMatchArray = tournamentData.final ? [tournamentData.final] : [];
                matchesToSimulate = [
                    ...(tournamentData.quarterfinals || []), 
                    ...(tournamentData.semifinals || []), 
                    ...finalMatchArray
                ].filter(m => m && (m.tA !== 'TBD' || m.tB !== 'TBD')); // Chỉ giả lập trận đã có đội
                
                if (matchesToSimulate.length === 0) return showStatus('Không có trận đấu Vòng Loại nào có đủ đội để giả lập.', 'warning', 'statusMessage');
            } else {
                return showStatus('Vòng đấu không hợp lệ.', 'error', 'statusMessage');
            }

            let groupCode = isGroup ? roundType : null;
            let changesMade = false;

            matchesToSimulate.forEach(match => {
                // Chỉ giả lập cho các trận chưa có tỉ số hoặc đang có tỉ số khác 11/15
                if (match.sA === null || match.sB === null || (match.sA < (isGroup ? 11 : 15) && match.sB < (isGroup ? 11 : 15))) {
                    if (match.tA !== 'TBD' && match.tB !== 'TBD') {
                        const newScore = getSimulatedScore(isGroup);
                        match.sA = newScore.sA;
                        match.sB = newScore.sB;
                        changesMade = true;
                    }
                }
            });

            if (changesMade) {
                // Gọi lại toàn bộ quy trình tính toán và hiển thị
                if (window.calculateAllData) {
                    window.calculateAllData();
                } else {
                    console.warn('Hàm calculateAllData không tìm thấy. Không thể cập nhật Standings/Knockout.');
                }

                // Tái hiển thị tab hiện tại
                if (groupCode) {
                    // Cập nhật lại HTML của Vòng Bảng
                    if (window.renderGroupMatches) window.renderGroupMatches(groupCode);
                    if (window.renderGroupStandingTable) window.renderGroupStandingTable(groupCode);
                } else if (roundType === 'Knockout') {
                    // Cập nhật lại HTML của Knockout
                    if (window.renderKnockoutMatches) window.renderKnockoutMatches();
                }

                // Tái hiển thị Final Results
                if (window.renderFinalResults) window.renderFinalResults();

                showStatus(`Đã giả lập thành công ${matchesToSimulate.length} trận đấu cho ${groupCode ? 'Bảng ' + groupCode : 'Vòng Loại'}.`, 'success', 'statusMessage');
            } else {
                 showStatus(`Không có trận đấu nào trong ${groupCode ? 'Bảng ' + groupCode : 'Vòng Loại'} cần giả lập (tất cả đã hoàn thành).`, 'info', 'statusMessage');
            }
        };

        // --- LOGIC RESET ĐIỂM SỐ ---
        window.resetScores = function(round) {
            if (!tournamentData) return showStatus('Lỗi: Không có dữ liệu giải đấu.', 'error', 'resetResult');

            let roundsToReset = [];
            let groupCode = null;

            if (round.length === 1) { // Group A, B, C, D
                roundsToReset.push(`matches${round}`);
                groupCode = round;
            } else if (round === 'QF' || round === 'SF' || round === 'F') { // Knockout
                if (round === 'QF') roundsToReset.push('quarterfinals');
                if (round === 'SF') roundsToReset.push('semifinals');
                if (round === 'F') roundsToReset.push('final');
            } else {
                return showStatus('Vòng đấu cần reset không hợp lệ.', 'error', 'resetResult');
            }

            let changesMade = false;
            
            roundsToReset.forEach(roundKey => {
                const roundData = tournamentData[roundKey];

                if (!roundData) return;

                if (Array.isArray(roundData)) {
                    roundData.forEach(match => {
                        if (match.sA !== null || match.sB !== null) {
                            match.sA = null;
                            match.sB = null;
                            changesMade = true;
                        }
                    });
                } else if (roundKey === 'final' && roundData.sA !== null || roundData.sB !== null) {
                    roundData.sA = null;
                    roundData.sB = null;
                    changesMade = true;
                }
            });

            if (changesMade) {
                // Tái tính toán và Tái hiển thị
                if (window.calculateAllData) {
                    window.calculateAllData();
                } else {
                    console.warn('Hàm calculateAllData không tìm thấy. Không thể cập nhật Standings/Knockout.');
                }
                
                // Tái hiển thị tab hiện tại
                if (groupCode) {
                    if (window.renderGroupMatches) window.renderGroupMatches(groupCode);
                    if (window.renderGroupStandingTable) window.renderGroupStandingTable(groupCode);
                    switchTab(`Group${groupCode}`);
                } else {
                    if (window.renderKnockoutMatches) window.renderKnockoutMatches();
                    switchTab('Knockout');
                }
                 // Tái hiển thị Final Results
                if (window.renderFinalResults) window.renderFinalResults();

                showStatus(`Đã **XÓA THÀNH CÔNG** tỉ số của Vòng ${round}. Vui lòng nhấn **COMMIT TỈ SỐ** để lưu lên GitHub.`, 'success', 'resetResult');
            } else {
                 showStatus(`Không có tỉ số nào để xóa trong Vòng ${round}.`, 'info', 'resetResult');
            }
        }

        window.confirmResetScores = function() {
            const round = document.getElementById('resetRoundSelector').value;
            if (!round) {
                return showStatus('Vui lòng chọn một vòng đấu để xóa tỉ số.', 'warning', 'resetResult');
            }
            if (confirm(`Xác nhận xóa TẤT CẢ tỉ số của Vòng ${round}? Thao tác này KHÔNG thể hoàn tác (trước khi Commit).`)) {
                resetScores(round);
            }
        }
        
        // --- LOGIC GIAO DIỆN & TẢI DỮ LIỆU ---

        function switchTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(content => {
                content.style.display = 'none';
            });
            document.getElementById(tabId).style.display = 'block';

            document.querySelectorAll('.tab-button').forEach(button => {
                button.classList.remove('active');
            });
            document.querySelector(`.tab-button[data-tab="${tabId}"]`).classList.add('active');
            
             // Gọi hàm render tương ứng khi chuyển tab
            if (window.renderTabContent) {
                window.renderTabContent(tabId);
            } else {
                console.warn('renderTabContent function is missing.');
            }
        }
        
        // Hàm này giả định đã tồn tại trong code gốc và được sử dụng để chuyển đổi tab
        // Cần đảm bảo hàm này được gọi khi tab được chuyển
        window.renderTabContent = function(tabId) {
            // Giả định các hàm render chi tiết đã tồn tại:
            if (tabId === 'GroupA') { 
                if (window.renderGroupStandingTable) window.renderGroupStandingTable('A');
                if (window.renderGroupMatches) window.renderGroupMatches('A');
            } else if (tabId === 'GroupB') {
                if (window.renderGroupStandingTable) window.renderGroupStandingTable('B');
                if (window.renderGroupMatches) window.renderGroupMatches('B');
            } else if (tabId === 'GroupC') {
                if (window.renderGroupStandingTable) window.renderGroupStandingTable('C');
                if (window.renderGroupMatches) window.renderGroupMatches('C');
            } else if (tabId === 'GroupD') {
                if (window.renderGroupStandingTable) window.renderGroupStandingTable('D');
                if (window.renderGroupMatches) window.renderGroupMatches('D');
            } else if (tabId === 'Knockout') {
                 if (window.renderKnockoutMatches) window.renderKnockoutMatches();
            } else if (tabId === 'General') {
                 if (window.renderTeamList) window.renderTeamList();
                 if (window.renderFinalResults) window.renderFinalResults();
            } else if (tabId === 'TeamManagement') {
                 if (window.renderTeamManagement) window.renderTeamManagement();
            }
        }


        // Thao tác đồng bộ lại (tải lại toàn bộ dữ liệu online)
        window.reSyncStaticData = function() {
            document.getElementById('confirmationBox').classList.add('hidden');
            showStatus('Đang đồng bộ lại dữ liệu từ GitHub...', 'info');
            loadDataFromGitHub(true); // Tải lại toàn bộ dữ liệu gốc
        };
        
        function showConfirmationModal() {
            document.getElementById('confirmationBox').classList.remove('hidden');
        }

        function applyTheme(theme) {
            if (theme === 'light') {
                document.body.classList.add('light-mode');
                document.getElementById('sunIcon').classList.remove('hidden');
                document.getElementById('moonIcon').classList.add('hidden');
            } else {
                document.body.classList.remove('light-mode');
                document.getElementById('sunIcon').classList.add('hidden');
                document.getElementById('moonIcon').classList.remove('hidden');
            }
            localStorage.setItem('theme', theme);
            document.getElementById('currentThemeDisplay').textContent = theme === 'dark' ? 'Tối' : 'Sáng';
        }

        function toggleTheme() {
            const currentTheme = document.body.classList.contains('light-mode') ? 'light' : 'dark';
            applyTheme(currentTheme === 'dark' ? 'light' : 'dark');
        }
        
        // Cần đảm bảo hàm này được định nghĩa ở đâu đó trong code gốc
        function unifyMatches(data) {
             // Hàm này cần chuyển các mảng matchesA, matchesB, ... quarterfinals, semifinals thành một mảng 'matches' duy nhất
             // Do code gốc không có, giả định nó trả về dữ liệu phù hợp với commit team
             return data; 
        }

        // === SWIPE NAVIGATION ===

        function handleGesture() {
            const diff = startX - endX;
            if (Math.abs(diff) > swipeThreshold) {
                const tabs = Array.from(document.querySelectorAll('.tab-button')).map(btn => btn.getAttribute('data-tab'));
                const activeTabButton = document.querySelector('.tab-button.active');
                if (!activeTabButton) return;
                
                const currentTabId = activeTabButton.getAttribute('data-tab');
                const currentIndex = tabs.indexOf(currentTabId);
                let newIndex = -1;

                if (diff > 0) { // Swipe Left -> Next Tab
                    newIndex = currentIndex + 1;
                } else { // Swipe Right -> Prev Tab
                    newIndex = currentIndex - 1;
                }

                if (newIndex >= 0 && newIndex < tabs.length) {
                    switchTab(tabs[newIndex]);
                }
            }
            // Reset swipe tracking
            startX = 0;
            endX = 0;
        }

        // --- HÀM TẢI DỮ LIỆU CHÍNH ---

        async function loadDataFromGitHub(forceReload = false) {
            try {
                showStatus('Đang tải dữ liệu gốc (state41.json)...');
                const [baseResponse, diffResponse] = await Promise.all([
                    fetch(STATIC_DATA_URL),
                    fetch(DIFF_DATA_URL)
                ]);

                if (!baseResponse.ok) {
                    throw new Error(`Lỗi tải state41.json: ${baseResponse.status}`);
                }

                let baseData = await baseResponse.json();
                initialTournamentData = JSON.parse(JSON.stringify(baseData)); // Lưu bản gốc

                // Tách matches từ baseData nếu cần (nếu nó được gộp)
                if (baseData.matches && Array.isArray(baseData.matches)) {
                    // Logic tách matches thành matchesA, matchesB, ... quarterfinals, semifinals, final
                    // Giả định logic này đã tồn tại trong code gốc
                    // Gán tạm:
                    baseData.matchesA = baseData.matches.filter(m => m.Mc && m.Mc.startsWith('GA'));
                    baseData.matchesB = baseData.matches.filter(m => m.Mc && m.Mc.startsWith('GB'));
                    baseData.matchesC = baseData.matches.filter(m => m.Mc && m.Mc.startsWith('GC'));
                    baseData.matchesD = baseData.matches.filter(m => m.Mc && m.Mc.startsWith('GD'));
                    baseData.quarterfinals = baseData.matches.filter(m => m.Mc && m.Mc.startsWith('QF'));
                    baseData.semifinals = baseData.matches.filter(m => m.Mc && m.Mc.startsWith('SF'));
                    baseData.final = baseData.matches.find(m => m.Mc === 'F'); // Hoặc logic phức tạp hơn
                    // Xóa mảng matches gốc
                    delete baseData.matches;
                }


                let diffData = {};
                if (diffResponse.ok) {
                    diffData = await diffResponse.json();
                }

                // MERGE: Hợp nhất diffData (state41s.json) vào baseData (state41.json)
                tournamentData = mergeScores(baseData, diffData);

                showStatus('Đã tải và hợp nhất dữ liệu thành công. Đang tính toán kết quả...');

                // CALCULATE: Tính toán lại toàn bộ dữ liệu (W, L, Pts, gR, Knockout winners)
                if (window.calculateAllData) {
                    window.calculateAllData();
                } else {
                    console.warn('Hàm calculateAllData không tìm thấy. Kết quả xếp hạng/knockout sẽ không chính xác.');
                }
                
                showStatus('Sẵn sàng. Dữ liệu đã được đồng bộ từ GitHub.', 'success');
                switchTab(localStorage.getItem('lastTab') || 'General');

            } catch (error) {
                console.error("Lỗi tải dữ liệu GitHub:", error);
                showStatus(`LỖI: Không thể tải dữ liệu giải đấu. Chi tiết: ${error.message}`, 'error');
            }
        }
        
        // Cần đảm bảo hàm mergeScores được định nghĩa ở đâu đó trong code gốc
        function mergeScores(base, diff) {
            // Giả định hàm này thực hiện việc hợp nhất scores từ diff vào base
            // Dùng logic merge cơ bản:
            for (const roundKey in diff) {
                const diffRound = diff[roundKey];
                const baseRound = base[roundKey];

                if (!baseRound) continue;

                if (roundKey === 'final') {
                    baseRound.sA = diffRound.sA;
                    baseRound.sB = diffRound.sB;
                } else if (Array.isArray(diffRound)) {
                    diffRound.forEach(diffMatch => {
                        if (baseRound[diffMatch.i]) {
                            baseRound[diffMatch.i].sA = diffMatch.sA;
                            baseRound[diffMatch.i].sB = diffMatch.sB;
                        }
                    });
                }
            }
            return base;
        }

        // --- KHỞI TẠO ---
        
        function initializeApp() {
            // Tải token và theme
            githubToken = localStorage.getItem('githubToken') || '';
            const savedTheme = localStorage.getItem('theme') || 'dark'; 
            applyTheme(savedTheme);

            if (githubToken) {
                 document.getElementById('githubToken').value = '********';
            }

            // Event listeners for theme toggle
            document.getElementById('themeToggle').addEventListener('click', toggleTheme);

            // Thêm Event Listener cho tất cả ô nhập tỉ số
            document.querySelectorAll('.score-input').forEach(input => {
                input.addEventListener('input', window.handleScoreChange); 
                // Sử dụng 'input' thay vì 'change' để phản hồi tức thì hơn
            });
            
            // Event listeners for swipe navigation (on the whole app container)
            document.getElementById('app').addEventListener('touchstart', (e) => {
                // Ignore if touching an input field
                if (e.target.closest('.score-input, .text-input')) return;
                startX = e.changedTouches[0].screenX;
            }, { passive: true });

            document.getElementById('app').addEventListener('touchend', (e) => {
                // Ignore if touching an input field
                if (e.target.closest('.score-input, .text-input')) return;
                endX = e.changedTouches[0].screenX;
                handleGesture();
            }, { passive: true });
            
            // Modal button setup
            document.getElementById('confirmYes').onclick = window.reSyncStaticData;
            document.getElementById('confirmNo').onclick = () => document.getElementById('confirmationBox').classList.add('hidden');

            loadDataFromGitHub();
        }

        window.onload = initializeApp;
    </script>
</body>
</html>
