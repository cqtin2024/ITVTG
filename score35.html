<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qu·∫£n L√Ω Gi·∫£i ƒê·∫•u & C·∫≠p Nh·∫≠t Th√¥ng Tin (GitHub Sync)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100;400;700;900&display=swap" rel="stylesheet">
    <style>
        /* Base styles for Dark Mode */
        :root {
            --bg-color: #111827; /* Gray-900 */
            --text-color: #f3f4f6; /* Gray-100 */
            --card-bg: #1f2937; /* Gray-800 */
            --border-color: #374151; /* Gray-700 */
            --accent-color: #06b6d4; /* Cyan-500 */
            --match-bg: #1f2937;
            --input-bg: #4b5563; /* Gray-600 */
            --group-header-text: #60a5fa; /* Blue-400 */
        }
        
        /* Light Mode Overrides */
        .light-mode {
            --bg-color: #f9fafb; /* Gray-50 */
            --text-color: #111827; /* Gray-900 */
            --card-bg: #ffffff;
            --border-color: #e5e7eb; /* Gray-200 */
            --accent-color: #ef4444; /* Red-500 */
            --match-bg: #f3f4f6; /* Gray-100 */
            --input-bg: #ffffff;
            --group-header-text: #10b981; /* Emerald-500 */
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            transition: background-color 0.3s, color 0.3s;
        }
        .container {
            max-width: 1200px;
        }
        .score-input, .text-input {
            background-color: var(--input-bg);
            border: 1px solid var(--border-color);
            color: var(--text-color);
        }
        .score-input:focus, .text-input:focus {
            box-shadow: 0 0 0 3px var(--accent-color);
        }
        .score-input:disabled, .text-input:disabled {
            background-color: #374151; /* Gray-700 */
            opacity: 0.7;
            cursor: not-allowed;
        }
        .tab-button {
            border-bottom-color: var(--border-color);
        }
        .tab-button.active {
            color: var(--accent-color);
            border-color: var(--accent-color);
            background-color: var(--card-bg);
        }
        .tab-content {
            display: none;
            background-color: var(--card-bg);
            border-radius: 0.75rem; /* rounded-xl */
            padding: 1.5rem; /* p-6 */
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); /* shadow-2xl */
        }
        /* Custom scrollbar */
        ::-webkit-scrollbar-thumb { background: var(--border-color); }
        ::-webkit-scrollbar-thumb:hover { background: #6b7280; }
        
        /* Specific content styles for brightness/clarity */
        .match-card {
            background-color: var(--match-bg);
            border-bottom: 1px solid var(--border-color);
        }
        .light-mode .match-card {
            background-color: #ffffff;
            border-bottom: 1px solid #e5e7eb;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
        }
        /* Modal Backdrop */
        .modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 50;
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <div id="app" class="container mx-auto">
        <header class="flex items-center justify-between mb-6">
            <div class="flex items-center">
                <svg class="w-10 h-10 md:w-12 md:h-12 text-[var(--accent-color)]" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 15.75l-4-4m0 0l4-4m-4 4h14M17 12a5 5 0 11-10 0 5 5 0 0110 0z"></path></svg>
                <div class="text-left ml-4">
                    <h1 class="text-xl md:text-3xl font-extrabold text-[var(--text-color)] leading-none">QU·∫¢N L√ù GI·∫¢I ƒê·∫§U PICKLEBALL</h1>
                    <p class="text-xs md:text-sm text-[var(--accent-color)]">C·∫≠p Nh·∫≠t T·ªâ S·ªë & Th√¥ng Tin ƒê·ªôi (GitHub Sync)</p>
                </div>
            </div>
            
            <button id="themeToggle" class="p-3 rounded-full bg-[var(--card-bg)] shadow-md text-[var(--text-color)] hover:bg-[var(--border-color)] transition duration-200">
                <svg id="sunIcon" class="w-6 h-6 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>
                <svg id="moonIcon" class="w-6 h-6 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path></svg>
            </button>
        </header>

        <div id="statusMessage" class="text-center p-4 bg-blue-900/50 rounded-lg text-blue-300 font-semibold mb-6">
            ƒêang t·∫£i d·ªØ li·ªáu tr·∫°ng th√°i t·ª´ GitHub...
        </div>
        
        <nav class="mb-8 border-b border-[var(--border-color)] overflow-x-auto whitespace-nowrap">
            <button class="tab-button py-3 px-4 md:px-6 text-sm md:text-base font-semibold border-b-2 border-transparent text-gray-400 hover:text-[var(--accent-color)] transition" onclick="switchTab('General')" data-tab="General">General</button>
            <button class="tab-button py-3 px-4 md:px-6 text-sm md:text-base font-semibold border-b-2 border-transparent text-gray-400 hover:text-[var(--accent-color)] transition" onclick="switchTab('TeamManagement')" data-tab="TeamManagement">Qu·∫£n L√Ω ƒê·ªôi</button>
            <button class="tab-button py-3 px-4 md:px-6 text-sm md:text-base font-semibold border-b-2 border-transparent text-gray-400 hover:text-[var(--accent-color)] transition" onclick="switchTab('GroupA')" data-tab="GroupA">Group A</button>
            <button class="tab-button py-3 px-4 md:px-6 text-sm md:text-base font-semibold border-b-2 border-transparent text-gray-400 hover:text-[var(--accent-color)] transition" onclick="switchTab('GroupB')" data-tab="GroupB">Group B</button>
            <button class="tab-button py-3 px-4 md:px-6 text-sm md:text-base font-semibold border-b-2 border-transparent text-gray-400 hover:text-[var(--accent-color)] transition" onclick="switchTab('GroupC')" data-tab="GroupC">Group C</button>
            <button class="tab-button py-3 px-4 md:px-6 text-sm md:text-base font-semibold border-b-2 border-transparent text-gray-400 hover:text-[var(--accent-color)] transition" onclick="switchTab('GroupD')" data-tab="GroupD">Group D</button>
            <button class="tab-button py-3 px-4 md:px-6 text-sm md:text-base font-semibold border-b-2 border-transparent text-gray-400 hover:text-[var(--accent-color)] transition" onclick="switchTab('Knockout')" data-tab="Knockout">Knockout</button>
            <button class="tab-button py-3 px-4 md:px-6 text-sm md:text-base font-semibold border-b-2 border-transparent text-gray-400 hover:text-[var(--accent-color)] transition" onclick="switchTab('Configuration')" data-tab="Configuration">C·∫•u H√¨nh</button>
        </nav>

        <div id="General" class="tab-content">
             <h2 class="text-3xl font-extrabold text-yellow-500 mb-6 border-b border-[var(--border-color)] pb-2">Final Results (K·∫øt qu·∫£ chung cu·ªôc)</h2>
            <section id="finalResults" class="mb-10 p-4 rounded-xl shadow-lg bg-[var(--match-bg)]"></section>

            <h2 class="text-3xl font-extrabold text-[var(--text-color)] mb-6 border-b border-[var(--border-color)] pb-2">Team List (Danh s√°ch c√°c ƒë·ªôi)</h2>
            <section id="teamList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                </section>
        </div>
        
        <div id="TeamManagement" class="tab-content">
            <h2 class="text-3xl font-extrabold text-blue-500 mb-6 border-b border-[var(--border-color)] pb-2">Qu·∫£n L√Ω Th√¥ng Tin ƒê·ªôi (C·∫≠p nh·∫≠t `state3.json`)</h2>
            <p class="text-sm text-gray-400 mb-4">ƒêi·ªÅu ch·ªânh **T√™n ƒë·ªôi (Tn)**, **T√™n ng∆∞·ªùi ch∆°i (name)**, **C·∫•p ƒë·ªô (pL)**, v√† **NƒÉm sinh (bY)**. Sau khi ch·ªânh s·ª≠a, h√£y nh·∫•n **C·∫¨P NH·∫¨T TH√îNG TIN** ƒë·ªÉ ghi ƒë√® `state3.json`.</p>
            
            <button id="commitTeamButton" onclick="commitTeamChangesToGitHub()" class="w-full md:w-auto px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-lg shadow-lg transition duration-300 mb-6 disabled:opacity-50">
                C·∫¨P NH·∫¨T TH√îNG TIN ƒê·ªòI (Ghi ƒë√® state3.json)
            </button>
            
            <div id="teamCommitResult" class="mt-3 p-3 rounded-lg text-sm font-semibold hidden"></div>

            <section id="teamManagementList" class="space-y-6"></section>
        </div>


        <div id="GroupA" class="tab-content grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div id="tableA" class="lg:col-span-1"></div>
            <div id="matchesA" class="lg:col-span-2"></div>
        </div>

        <div id="GroupB" class="tab-content grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div id="tableB" class="lg:col-span-1"></div>
            <div id="matchesB" class="lg:col-span-2"></div>
        </div>

        <div id="GroupC" class="tab-content grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div id="tableC" class="lg:col-span-1"></div>
            <div id="matchesC" class="lg:col-span-2"></div>
        </div>

        <div id="GroupD" class="tab-content grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div id="tableD" class="lg:col-span-1"></div>
            <div id="matchesD" class="lg:col-span-2"></div>
        </div>

        <div id="Knockout" class="tab-content">
            <div id="quarterfinals" class="mb-6"></div>
            <div id="semifinals" class="mb-6"></div>
            <div id="finalMatchSection">
                <div id="finalSection"></div>
            </div>
        </div>

        <div id="Configuration" class="tab-content space-y-8">
            <h2 class="text-3xl font-extrabold text-red-500 mb-6 border-b border-[var(--border-color)] pb-2">C·∫•u H√¨nh & ƒê·ªìng B·ªô H√≥a (GitHub API)</h2>
            
             <section class="p-4 bg-red-900/20 rounded-lg border-l-4 border-red-500">
                 <h3 class="text-xl font-bold text-red-400 mb-3 flex items-center">
                    <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-2a2 2 0 00-2-2H6a2 2 0 00-2 2v2a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path></svg> 1. GitHub Personal Access Token (PAT) </h3>
                 <p class="text-sm text-red-300 mb-4 font-bold">C·∫¢NH B√ÅO B·∫¢O M·∫¨T: Token n√†y s·∫Ω ƒë∆∞·ª£c l∆∞u tr·ªØ trong tr√¨nh duy·ªát. Ch·ªâ s·ª≠ d·ª•ng Token c√≥ ph·∫°m vi (Scope) nh·ªè nh·∫•t. <span class="text-yellow-300">C·∫¶N PH·∫¢I C√ì QUY·ªÄN **repo** (ho·∫∑c contents:write)</span>.</p>
                 <input type="password" id="githubToken" class="score-input w-full p-2 rounded-md focus:ring-red-500" placeholder="D√°n GitHub PAT c·ªßa b·∫°n v√†o ƒë√¢y...">
                 <button onclick="saveToken()" class="mt-2 w-full px-4 py-2 bg-red-600 hover:bg-red-700 text-white font-bold rounded-lg transition duration-300">L∆∞u Token</button>
             </section>

             <section class="p-4 bg-green-900/20 rounded-lg border-l-4 border-green-500">
                 <h3 class="text-xl font-bold text-green-400 mb-3 flex items-center">
                    <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg> 2. Export & Commit T·ªâ S·ªë L√™n GitHub (state3s.json) 
                 </h3>
                 <p class="text-sm text-gray-400 mb-4">
                     T·ªâ s·ªë m·ªõi nh·∫•t ƒëang ƒë∆∞·ª£c l∆∞u tr·ªØ ·ªü <span id="currentStatus" class="font-bold text-yellow-300">...</span>
                 </p>
                 <button id="commitScoreButton" onclick="commitScoreChangesToGitHub()" class="w-full px-6 py-2 bg-green-600 hover:bg-green-700 text-white font-bold rounded-lg shadow-lg transition duration-300 disabled:opacity-50">
                     EXPORT & COMMIT T·∫§T C·∫¢ T·ªà S·ªê (Ghi ƒë√® state3s.json)
                 </button>
                 <div id="scoreCommitResult" class="mt-3 p-3 rounded-lg text-sm font-semibold hidden"></div>
             </section>

             <section class="p-4 bg-blue-900/20 rounded-lg border-l-4 border-blue-500">
                 <h3 class="text-xl font-bold text-blue-400 mb-3 flex items-center">
                    <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11.133 11l-1.46-1.46M12 21a9 9 0 100-18 9 9 0 000 18z"></path></svg> 3. ƒê·ªìng B·ªô L·∫°i D·ªØ Li·ªáu G·ªëc
                 </h3>
                 <p class="text-sm text-gray-400 mb-4">
                     B·∫•m n√∫t n√†y ƒë·ªÉ t·∫£i l·∫°i `state3.json` v√† `state3s.json` t·ª´ GitHub, b·ªè qua m·ªçi thay ƒë·ªïi ch∆∞a ƒë∆∞·ª£c commit.
                 </p>
                 <button onclick="document.getElementById('confirmationBox').classList.remove('hidden')" class="w-full px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-lg shadow-lg transition duration-300">
                     ƒê·ªíNG B·ªò L·∫†I (T·∫£i l·∫°i t·ª´ GitHub)
                 </button>
             </section>

             <section class="p-4 bg-[var(--card-bg)] rounded-lg border-l-4 border-gray-500 space-y-4">
                <h3 class="text-xl font-bold text-gray-400 mb-3">4. C·∫•u h√¨nh URL (N√¢ng cao)</h3>
                <div class="space-y-2">
                    <label for="baseApiUrl" class="block text-sm font-medium text-gray-400">BASE_API_URL (state3.json)</label>
                    <input type="text" id="baseApiUrl" class="text-input w-full p-2 rounded-md" placeholder="URL API GitHub cho state3.json" disabled>
                </div>
                <div class="space-y-2">
                    <label for="scoreApiUrl" class="block text-sm font-medium text-gray-400">SCORE_API_URL (state3s.json)</label>
                    <input type="text" id="scoreApiUrl" class="text-input w-full p-2 rounded-md" placeholder="URL API GitHub cho state3s.json" disabled>
                </div>
                <div class="space-y-2">
                    <label for="staticDataUrl" class="block text-sm font-medium text-gray-400">STATIC_DATA_URL (Raw state3.json)</label>
                    <input type="text" id="staticDataUrl" class="text-input w-full p-2 rounded-md" placeholder="URL Raw Content cho state3.json" disabled>
                </div>
                <div class="space-y-2">
                    <label for="diffDataUrl" class="block text-sm font-medium text-gray-400">DIFF_DATA_URL (Raw state3s.json)</label>
                    <input type="text" id="diffDataUrl" class="text-input w-full p-2 rounded-md" placeholder="URL Raw Content cho state3s.json" disabled>
                </div>
             </section>
        </div>


        <div id="confirmationBox" class="modal-backdrop hidden">
            <div class="bg-[var(--card-bg)] p-8 rounded-xl shadow-2xl max-w-sm w-full">
                <h3 class="text-xl font-bold text-red-500 mb-4">X√°c nh·∫≠n ƒê·ªìng b·ªô L·∫°i</h3>
                <p class="text-gray-300 mb-6">B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën T·∫£i l·∫°i (Re-sync) d·ªØ li·ªáu g·ªëc t·ª´ GitHub kh√¥ng? H√†nh ƒë·ªông n√†y s·∫Ω **x√≥a b·ªè m·ªçi thay ƒë·ªïi t·ªâ s·ªë ch∆∞a ƒë∆∞·ª£c COMMIT**.</p>
                <div class="flex justify-end space-x-4">
                    <button id="confirmNo" class="px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white rounded-lg transition">H·ªßy</button>
                    <button id="confirmYes" class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white font-bold rounded-lg transition">X√°c nh·∫≠n T·∫£i l·∫°i</button>
                </div>
            </div>
        </div>

    </div>

    <script>
        // =================================================================
        // H·∫∞NG S·ªê C·∫§U H√åNH (CONSTANTS)
        // Thay ƒë·ªïi c√°c h·∫±ng s·ªë n√†y ƒë·ªÉ tr·ªè ƒë·∫øn kho l∆∞u tr·ªØ GitHub c·ªßa b·∫°n
        // =================================================================
        const REPO_OWNER = 'cqtin2024'; // T√™n ng∆∞·ªùi d√πng ho·∫∑c t·ªï ch·ª©c GitHub
        const REPO_NAME = 'ITVTG'; // T√™n kho l∆∞u tr·ªØ
        const BRANCH = 'main'; // T√™n nh√°nh

        // Base URLs (Kh√¥ng c·∫ßn thay ƒë·ªïi tr·ª´ khi c·∫•u tr√∫c GitHub kh√°c)
        const BASE_API_URL = `https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/data/state3.json`;
        const SCORE_API_URL = `https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/data/state3s.json`;
        
        // Raw Content URLs (S·ª≠ d·ª•ng ƒë·ªÉ t·∫£i d·ªØ li·ªáu)
        const STATIC_DATA_URL = `https://raw.githubusercontent.com/${REPO_OWNER}/${REPO_NAME}/${BRANCH}/data/state3.json`;
        const DIFF_DATA_URL = `https://raw.githubusercontent.com/${REPO_OWNER}/${REPO_NAME}/${BRANCH}/data/state3s.json`;


        // =================================================================
        // BI·∫æN TO√ÄN C·ª§C V√Ä TR·∫†NG TH√ÅI
        // =================================================================
        let githubToken = '';
        let tournamentData = null; // D·ªØ li·ªáu ƒë√£ h·ª£p nh·∫•t (g·ªëc + t·ªâ s·ªë)
        let initialTournamentData = null; // D·ªØ li·ªáu g·ªëc (ch·ªâ state3.json)
        let currentTab = 'General';
        let startX = 0;
        let endX = 0;


        // =================================================================
        // H√ÄM CHUNG V√Ä TI·ªÜN √çCH
        // =================================================================

        /**
         * Chuy·ªÉn ƒë·ªïi ƒë·ªëi t∆∞·ª£ng JS th√†nh Base64 string cho GitHub API.
         * @param {Object} data 
         * @returns {string} Base64 string
         */
        function jsonToBase64(data) {
            const jsonString = JSON.stringify(data, null, 2);
            return btoa(unescape(encodeURIComponent(jsonString)));
        }

        /**
         * Chuy·ªÉn ƒë·ªïi Base64 string th√†nh ƒë·ªëi t∆∞·ª£ng JS.
         * @param {string} base64 
         * @returns {Object} JSON object
         */
        function base64ToJson(base64) {
             const jsonString = decodeURIComponent(escape(atob(base64)));
             return JSON.parse(jsonString);
        }

        // --- C√ÅC H√ÄM TRA C·ª®U ƒê·ªòI ƒê√É ƒê∆Ø·ª¢C CHU·∫®N H√ìA D·ª∞A TR√äN C·∫§U TR√öC JSON M·ªöI ---
        
        /**
         * L·∫•y ID c·ªßa ƒë·ªôi (T) d·ª±a tr√™n t√™n ƒë·ªôi d√πng trong match object (Tn/D).
         * ASSUMPTION: The team name string in match object (A/B) is stored in the team.Tn field in tL.
         * @param {string} teamName - T√™n ƒë·ªôi ƒë·∫ßy ƒë·ªß (e.g., "Duy H∆∞ng-Minh T√∫").
         * @returns {string|null} M√£ ƒë·ªôi (T) ho·∫∑c null.
         */
        function getTeamIdByTeamName(teamName) {
            if (!tournamentData || !tournamentData.tL) return null;
            // D√πng D ƒë·ªÉ tra c·ª©u n·∫øu Tn b·ªã thi·∫øu ho·∫∑c d√πng ƒë·ªÉ hi·ªÉn th·ªã kh√°c
            for (const team of tournamentData.tL) {
                // ∆Øu ti√™n so s√°nh v·ªõi Tn (T√™n r√∫t g·ªçn/ƒë·ªãnh danh)
                if (team.Tn === teamName) {
                    return team.T;
                }
            }
            return null;
        }
        
        /**
         * L·∫•y t√™n r√∫t g·ªçn c·ªßa ƒë·ªôi (Tn) d·ª±a tr√™n ID.
         * @param {string} teamId - M√£ ƒë·ªôi (T).
         * @returns {string|null} T√™n r√∫t g·ªçn (Tn) ho·∫∑c M√£ ƒë·ªôi n·∫øu kh√¥ng t√¨m th·∫•y.
         */
        function getTeamNameById(teamId) {
             if (!tournamentData || !tournamentData.tL) return teamId;
             for (const team of tournamentData.tL) {
                 if (team.T === teamId) {
                     return team.Tn;
                 }
             }
             return teamId;
         }

        // ------------------------------------------------------------------------

        /**
         * H·ª£p nh·∫•t d·ªØ li·ªáu t·ªâ s·ªë v√†o d·ªØ li·ªáu gi·∫£i ƒë·∫•u ch√≠nh.
         * @param {Object} baseData - D·ªØ li·ªáu state3.json.
         * @param {Object} diffData - D·ªØ li·ªáu state3s.json.
         * @returns {Object} D·ªØ li·ªáu ƒë√£ h·ª£p nh·∫•t.
         */
        function mergeData(baseData, diffData) {
            const merged = JSON.parse(JSON.stringify(baseData)); // Deep copy base
            
            if (!diffData) return merged;

            // 1. Merge group match scores (matchesA-D)
            ['A', 'B', 'C', 'D'].forEach(group => {
                const matchesKey = `matches${group}`;
                if (merged[matchesKey] && diffData[matchesKey]) {
                    merged[matchesKey] = merged[matchesKey].map((match, index) => {
                        const diffMatch = diffData[matchesKey][index];
                        if (diffMatch) {
                            // Merge only score and winner/loser fields
                            return { 
                                ...match, 
                                sA: diffMatch.sA !== undefined ? diffMatch.sA : match.sA,
                                sB: diffMatch.sB !== undefined ? diffMatch.sB : match.sB,
                                Wn: diffMatch.Wn !== undefined ? diffMatch.Wn : match.Wn,
                                rU: diffMatch.rU !== undefined ? diffMatch.rU : match.rU,
                            };
                        }
                        return match;
                    });
                }
            });

            // 2. Merge knockout scores
            ['quarterfinals', 'semifinals'].forEach(round => {
                if (merged[round] && diffData[round]) {
                     merged[round] = merged[round].map((match, index) => {
                         const diffMatch = diffData[round][index];
                         if (diffMatch) {
                             return { 
                                 ...match, 
                                 sA: diffMatch.sA !== undefined ? diffMatch.sA : match.sA,
                                 sB: diffMatch.sB !== undefined ? diffMatch.sB : match.sB,
                                 Wn: diffMatch.Wn !== undefined ? diffMatch.Wn : match.Wn,
                                 rU: diffMatch.rU !== undefined ? diffMatch.rU : match.rU,
                             };
                         }
                         return match;
                     });
                 }
            });
            
            // 3. Merge final score
            if (merged.final && diffData.final) {
                merged.final = { ...merged.final, ...diffData.final };
            }

            return merged;
        }

        /**
         * X√°c ƒë·ªãnh ƒë·ªôi th·∫Øng v√† c·∫≠p nh·∫≠t tr∆∞·ªùng Wn.
         * D√πng cho c·∫£ v√≤ng b·∫£ng (isGroupMatch=true, d√πng A/B l√† t√™n ƒë·ªôi) v√† v√≤ng lo·∫°i (isGroupMatch=false, d√πng tA/tB l√† ID).
         * @param {Object} match - ƒê·ªëi t∆∞·ª£ng tr·∫≠n ƒë·∫•u.
         * @param {boolean} isGroupMatch - True n·∫øu l√† tr·∫≠n v√≤ng b·∫£ng (d√πng A, B, Wn strings), False n·∫øu l√† v√≤ng lo·∫°i (d√πng tA, tB, Wn IDs).
         */
        function calculateWinner(match, isGroupMatch) {
            const scoreA = parseInt(match.sA) || 0;
            const scoreB = parseInt(match.sB) || 0;

            let teamA, teamB;
            if (isGroupMatch) {
                teamA = match.A; // Team Name string
                teamB = match.B; // Team Name string
            } else {
                teamA = match.tA; // Team ID (T)
                teamB = match.tB; // Team ID (T)
            }
            
            // Ch·ªâ t√≠nh th·∫Øng thua n·∫øu c√≥ t·ªâ s·ªë kh√°c 0
            if (scoreA > scoreB) {
                match.Wn = teamA;
            } else if (scoreB > scoreA) {
                match.Wn = teamB;
            } else {
                match.Wn = null; // H√≤a ho·∫∑c ch∆∞a ƒë·∫•u
            }
        }
        
        /**
         * L·∫•y th√¥ng tin chi ti·∫øt ng∆∞·ªùi ch∆°i d·ª±a tr√™n m√£ ƒë·ªôi (T)
         * @param {string} teamId - M√£ ƒë·ªôi (T)
         * @returns {Object|null} Th√¥ng tin ƒë·ªôi ho·∫∑c null
         */
        function getTeamDetailById(teamId) {
            if (!initialTournamentData || !initialTournamentData.tL) return null;
            return initialTournamentData.tL.find(team => team.T === teamId) || null;
        }


        // =================================================================
        // H√ÄM LOGIC GI·∫¢I ƒê·∫§U
        // =================================================================

        /**
         * T√≠nh to√°n l·∫°i th·ªëng k√™ v√≤ng b·∫£ng (W, L, Pts) v√† s·∫Øp x·∫øp.
         */
        function recalculateAndSortGroupTables() {
            if (!tournamentData) return;

            const groups = ['A', 'B', 'C', 'D'];

            groups.forEach(group => {
                const matchesKey = `matches${group}`;
                const tableKey = `table${group}`;
                const groupMatches = tournamentData[matchesKey] || [];
                let groupTable = tournamentData[tableKey] || [];
                
                // 1. Reset stats for teams in this group
                const teamStats = {}; // { 'T1': { W: 0, L: 0, Pts: 0, mP: 0 }, ...}
                groupTable.forEach(team => {
                    // D√πng team.T (ID) l√†m key
                    teamStats[team.T] = { W: 0, L: 0, Pts: 0, mP: 0 };
                });
                
                // 2. Aggregate stats from matches
                groupMatches.forEach(match => {
                    // Calculate Winner (Wn is the name string)
                    calculateWinner(match, true); 

                    // Get team IDs for stat update
                    const teamAId = getTeamIdByTeamName(match.A); // Get ID from Team Name string
                    const teamBId = getTeamIdByTeamName(match.B); // Get ID from Team Name string
                    const winnerName = match.Wn;
                    // L·∫•y ID c·ªßa ƒë·ªôi th·∫Øng (d√πng t√™n ƒë·ªôi)
                    const winnerId = winnerName ? getTeamIdByTeamName(winnerName) : null; 
                    
                    if (teamAId && teamBId && teamStats[teamAId] && teamStats[teamBId]) {
                         // C·∫≠p nh·∫≠t stats
                         if (winnerId === teamAId) {
                             teamStats[teamAId].W += 1; teamStats[teamAId].Pts += 3; teamStats[teamAId].mP += 1;
                             teamStats[teamBId].L += 1; teamStats[teamBId].mP += 1;
                         } else if (winnerId === teamBId) {
                             teamStats[teamBId].W += 1; teamStats[teamBId].Pts += 3; teamStats[teamBId].mP += 1;
                             teamStats[teamAId].L += 1; teamStats[teamAId].mP += 1;
                         } else if (match.sA !== null || match.sB !== null) {
                              // Tr∆∞·ªùng h·ª£p ƒë√£ c√≥ t·ªâ s·ªë nh∆∞ng h√≤a ho·∫∑c ch∆∞a t√≠nh ƒë∆∞·ª£c Wn
                             teamStats[teamAId].mP += 1;
                             teamStats[teamBId].mP += 1;
                         }
                    }
                });
                
                // 3. Update table with new stats
                groupTable = groupTable.map(team => {
                    const stats = teamStats[team.T];
                    if (stats) {
                        return { 
                            ...team, 
                            W: stats.W, 
                            L: stats.L, 
                            Pts: stats.Pts, 
                            mP: stats.mP 
                        };
                    }
                    return team;
                });
                
                // 4. Sort the table
                groupTable.sort((a, b) => {
                    if (b.W !== a.W) return b.W - a.W; // ∆Øu ti√™n s·ªë tr·∫≠n th·∫Øng
                    if (b.Pts !== a.Pts) return b.Pts - a.Pts; // Sau ƒë√≥ l√† t·ªïng ƒëi·ªÉm
                    return 0; 
                });
                
                tournamentData[tableKey] = groupTable;
                
                // 5. Update team list (tL) D-Tn based on position
                // Logic c·∫≠p nh·∫≠t t√™n ƒë·ªôi D theo v·ªã tr√≠ ƒë·ªÉ hi·ªÉn th·ªã ƒë√∫ng tr√™n b·∫£ng x·∫øp h·∫°ng (team.D = team.Tn)
                const sortedTeamIds = groupTable.map(team => team.T);
                tournamentData.tL = tournamentData.tL.map(team => {
                    if (sortedTeamIds.includes(team.T)) {
                        // C·∫≠p nh·∫≠t D = Tn theo y√™u c·∫ßu c≈©
                        return { ...team, D: team.Tn };
                    }
                    return team;
                });
            });
        }


        /**
         * C·∫≠p nh·∫≠t th√¥ng tin c√°c tr·∫≠n ƒë·∫•u v√≤ng lo·∫°i (t·ª© k·∫øt, b√°n k·∫øt, chung k·∫øt).
         * @param {string} round - 'quarterfinals', 'semifinals', 'final'
         */
        function updateKnockoutMatches(round) {
            if (!tournamentData || !tournamentData[round]) return;

            const matches = Array.isArray(tournamentData[round]) ? tournamentData[round] : [tournamentData[round]];

            matches.forEach(match => {
                const teamAId = match.tA; // V√≤ng lo·∫°i d√πng T (ID)
                const teamBId = match.tB;

                if (teamAId && teamBId) {
                    // C·∫≠p nh·∫≠t Winner/Loser (Wn l√† ID c·ªßa ƒë·ªôi th·∫Øng)
                    calculateWinner(match, false); // false for knockout match (uses tA/tB, sets Wn to ID)
                    
                    if (round === 'final' && match.Wn) {
                         // C·∫≠p nh·∫≠t ƒë·ªôi √Å qu√¢n cho tr·∫≠n chung k·∫øt
                         match.rU = match.Wn === teamAId ? teamBId : teamAId;
                    }

                    // C·∫≠p nh·∫≠t ƒë·ªôi ƒëi ti·∫øp (Ch·ªâ √°p d·ª•ng cho T·ª© k·∫øt v√† B√°n k·∫øt)
                    if (round !== 'final' && match.Wn) {
                        const winner = match.Wn;
                        const nextRound = round === 'quarterfinals' ? tournamentData.semifinals : tournamentData.final;
                        
                        // Logic t√¨m v√† c·∫≠p nh·∫≠t T√™n ƒë·ªôi cho v√≤ng ti·∫øp theo (d·ª±a tr√™n Pos)
                        if (Array.isArray(nextRound)) {
                            const nextMatch = nextRound.find(m => m.pA === match.Pos || m.pB === match.Pos);
                            if (nextMatch) {
                                if (nextMatch.pA === match.Pos) {
                                    nextMatch.tA = winner;
                                } else if (nextMatch.pB === match.Pos) {
                                    nextMatch.tB = winner;
                                }
                            }
                        } else if (round === 'semifinals' && match.Wn) {
                            // B√°n k·∫øt 1 (pos 1) ƒëi v√†o A c·ªßa chung k·∫øt (final)
                            if (match.Pos === 1) {
                                nextRound.tA = winner;
                            } else if (match.Pos === 2) {
                                // B√°n k·∫øt 2 (pos 2) ƒëi v√†o B c·ªßa chung k·∫øt (final)
                                nextRound.tB = winner;
                            }
                        }
                    }
                }
            });
        }
        
        /**
         * Ch·∫°y t·∫•t c·∫£ c√°c logic t√≠nh to√°n l·∫°i sau khi t·ªâ s·ªë m·ªõi ƒë∆∞·ª£c nh·∫≠p.
         */
        function runAllLogic() {
            recalculateAndSortGroupTables();
            updateKnockoutMatches('quarterfinals');
            updateKnockoutMatches('semifinals');
            updateKnockoutMatches('final');
            renderAllSections();
            updateDiffData(); // Chu·∫©n b·ªã d·ªØ li·ªáu ƒë·ªÉ commit t·ªâ s·ªë
        }

        /**
         * Chu·∫©n b·ªã d·ªØ li·ªáu t·ªâ s·ªë thay ƒë·ªïi (state3s.json) ƒë·ªÉ commit.
         */
        function updateDiffData() {
            if (!tournamentData || !initialTournamentData) return;
            
            const diffData = {};
            const keysToCheck = [
                'matchesA', 'matchesB', 'matchesC', 'matchesD',
                'quarterfinals', 'semifinals', 'final'
            ];

            keysToCheck.forEach(key => {
                if (tournamentData[key]) {
                    const currentData = Array.isArray(tournamentData[key]) ? tournamentData[key] : [tournamentData[key]];
                    const initialData = Array.isArray(initialTournamentData[key]) ? initialTournamentData[key] : [initialTournamentData[key]];
                    const diffArray = [];

                    currentData.forEach((currentMatch, index) => {
                        const initialMatch = initialData[index];
                        const diffMatch = {};
                        let isDiff = false;
                        
                        // Ch·ªâ commit nh·ªØng field c·∫ßn thi·∫øt
                        const fieldsToCompare = ['sA', 'sB', 'Wn', 'rU'];
                        
                        fieldsToCompare.forEach(field => {
                            // So s√°nh d·ª±a tr√™n gi√° tr·ªã (bao g·ªìm null)
                            if (String(currentMatch[field]) !== String(initialMatch[field])) {
                                // Ch·ªâ g√°n gi√° tr·ªã n·∫øu n√≥ kh√°c, bao g·ªìm c·∫£ null
                                if (currentMatch[field] !== undefined) {
                                     diffMatch[field] = currentMatch[field];
                                }
                                isDiff = true;
                            }
                        });

                        if (isDiff) {
                            // ƒê·∫£m b·∫£o array c√≥ ƒë·ªß ƒë·ªô d√†i ƒë·ªÉ index kh·ªõp
                            diffArray[index] = diffMatch;
                        } else {
                            // ƒê·∫∑t m·ªôt placeholder n·∫øu kh√¥ng c√≥ diff, ƒë·ªÉ ƒë·∫£m b·∫£o index kh·ªõp khi c·∫ßn
                            diffArray[index] = {};
                        }
                    });

                    // L·ªçc b·ªè placeholder r·ªóng (diffArray[index] = {})
                    let finalDiffData;
                    if (key === 'final') {
                         // Chung k·∫øt l√† ƒë·ªëi t∆∞·ª£ng, ch·ªâ l·∫•y ph·∫ßn t·ª≠ ƒë·∫ßu ti√™n n·∫øu n√≥ c√≥ thay ƒë·ªïi
                         if (diffArray[0] && Object.keys(diffArray[0]).length > 0) {
                              finalDiffData = diffArray[0];
                         }
                    } else {
                        // V√≤ng b·∫£ng/lo·∫°i l√† m·∫£ng, ch·ªâ gi·ªØ l·∫°i c√°c ph·∫ßn t·ª≠ c√≥ thay ƒë·ªïi
                        // T·∫°o m·ªôt m·∫£ng m·ªõi ch·ªâ ch·ª©a c√°c ph·∫ßn t·ª≠ c√≥ kh√°c bi·ªát (t·ª©c l√† kh√¥ng ph·∫£i {})
                         const hasDiff = diffArray.some(item => Object.keys(item).length > 0);
                         if (hasDiff) {
                            // ƒê·∫£m b·∫£o m·∫£ng gi·ªØ nguy√™n index b·∫±ng c√°ch gi·ªØ l·∫°i {} cho c√°c tr·∫≠n kh√¥ng ƒë·ªïi
                            finalDiffData = diffArray;
                         }
                    }

                    if (finalDiffData && Object.keys(finalDiffData).length > 0) {
                        diffData[key] = finalDiffData;
                    }
                }
            });

            // G√°n d·ªØ li·ªáu t·ªâ s·ªë thay ƒë·ªïi v√†o window object ƒë·ªÉ d·ªÖ d√†ng truy c·∫≠p khi commit
            window.diffDataForCommit = diffData;
            
            // C·∫≠p nh·∫≠t tr·∫°ng th√°i hi·ªÉn th·ªã
            const statusElement = document.getElementById('currentStatus');
            if (statusElement) {
                const diffKeys = Object.keys(diffData);
                if (diffKeys.length > 0) {
                    statusElement.classList.remove('text-yellow-300');
                    statusElement.classList.add('text-red-500');
                    statusElement.textContent = `C√ì THAY ƒê·ªîI CH∆ØA L∆ØU (${diffKeys.join(', ')})`;
                } else {
                    statusElement.classList.remove('text-red-500');
                    statusElement.classList.add('text-yellow-300');
                    statusElement.textContent = `ƒê√É ƒê·ªíNG B·ªò (Kh√¥ng c√≥ thay ƒë·ªïi t·ªâ s·ªë)`;
                }
            }
        }


        // =================================================================
        // H√ÄM T·∫¢I D·ªÆ LI·ªÜU
        // =================================================================

        /**
         * T·∫£i d·ªØ li·ªáu t·ª´ m·ªôt URL.
         * @param {string} url - URL c·ªßa file JSON.
         * @returns {Promise<Object|null>} D·ªØ li·ªáu JSON ho·∫∑c null n·∫øu th·∫•t b·∫°i.
         */
        async function fetchData(url) {
            try {
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                return data;
            } catch (error) {
                console.error(`Error fetching data from ${url}:`, error);
                document.getElementById('statusMessage').textContent = `‚ùå L·ªói t·∫£i d·ªØ li·ªáu t·ª´ GitHub: ${url}`;
                document.getElementById('statusMessage').classList.remove('bg-blue-900/50', 'text-blue-300');
                document.getElementById('statusMessage').classList.add('bg-red-900/50', 'text-red-300');
                return null;
            }
        }

        /**
         * T·∫£i d·ªØ li·ªáu tr·∫°ng th√°i (base v√† diff) t·ª´ GitHub v√† kh·ªüi t·∫°o ·ª©ng d·ª•ng.
         */
        async function loadDataFromGitHub() {
            document.getElementById('statusMessage').textContent = 'ƒêang t·∫£i d·ªØ li·ªáu tr·∫°ng th√°i t·ª´ GitHub...';
            document.getElementById('statusMessage').classList.remove('bg-red-900/50', 'text-red-300');
            document.getElementById('statusMessage').classList.add('bg-blue-900/50', 'text-blue-300');
            
            const baseDataPromise = fetchData(STATIC_DATA_URL); // state3.json
            const diffDataPromise = fetchData(DIFF_DATA_URL); // state3s.json
            
            const [baseData, diffData] = await Promise.all([baseDataPromise, diffDataPromise]);
            
            if (baseData) {
                initialTournamentData = baseData;
                tournamentData = mergeData(baseData, diffData);
                
                runAllLogic(); // T√≠nh to√°n l·∫°i v√† render
                
                document.getElementById('statusMessage').textContent = '‚úÖ ƒê√£ t·∫£i v√† h·ª£p nh·∫•t d·ªØ li·ªáu th√†nh c√¥ng.';
                document.getElementById('statusMessage').classList.remove('bg-blue-900/50', 'text-blue-300');
                document.getElementById('statusMessage').classList.add('bg-green-900/50', 'text-green-300');
            } else {
                 document.getElementById('statusMessage').textContent = '‚ùå KH√îNG TH·ªÇ t·∫£i d·ªØ li·ªáu g·ªëc (state3.json). Vui l√≤ng ki·ªÉm tra console.';
            }
        }
        
        /**
         * H√†m t·∫£i l·∫°i d·ªØ li·ªáu g·ªëc t·ª´ GitHub (Th·ªß c√¥ng).
         */
        window.reSyncStaticData = async function() {
            document.getElementById('confirmationBox').classList.add('hidden');
            document.getElementById('statusMessage').textContent = 'üîÑ ƒêang ƒë·ªìng b·ªô l·∫°i d·ªØ li·ªáu g·ªëc t·ª´ GitHub...';
            document.getElementById('statusMessage').classList.remove('bg-green-900/50', 'text-green-300', 'bg-red-900/50', 'text-red-300');
            document.getElementById('statusMessage').classList.add('bg-blue-900/50', 'text-blue-300');
            
            await loadDataFromGitHub();
        }


        // =================================================================
        // H√ÄM RENDER (HI·ªÇN TH·ªä GIAO DI·ªÜN)
        // =================================================================

        /**
         * Render th√¥ng tin v√≤ng b·∫£ng (b·∫£ng x·∫øp h·∫°ng v√† tr·∫≠n ƒë·∫•u).
         * @param {string} group - T√™n b·∫£ng ('A', 'B', 'C', 'D').
         */
        function renderGroupSection(group) {
            if (!tournamentData) return;

            const tableElement = document.getElementById(`table${group}`);
            const matchesElement = document.getElementById(`matches${group}`);
            const tableData = tournamentData[`table${group}`];
            const matchesData = tournamentData[`matches${group}`];
            const legend = tournamentData.key_legend;

            // ------------------
            // 1. Render Table
            // ------------------
            if (tableData && tableElement) {
                let html = `<h2 class="text-2xl font-extrabold text-[var(--group-header-text)] mb-4 border-b border-[var(--border-color)] pb-2">B·∫£ng ${group} - X·∫øp H·∫°ng</h2>`;
                html += `<div class="overflow-x-auto bg-[var(--match-bg)] rounded-lg shadow-xl">`;
                html += `<table class="min-w-full divide-y divide-[var(--border-color)]">`;
                
                // Header
                html += `<thead><tr>`;
                html += `<th class="px-3 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">#</th>`;
                html += `<th class="px-3 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">TEAM</th>`; 
                html += `<th class="px-3 py-3 text-center text-xs font-medium text-gray-400 uppercase tracking-wider">${legend.W}</th>`;
                html += `<th class="px-3 py-3 text-center text-xs font-medium text-gray-400 uppercase tracking-wider">${legend.L}</th>`;
                html += `<th class="px-3 py-3 text-center text-xs font-medium text-gray-400 uppercase tracking-wider">${legend.Pts}</th>`;
                html += `</tr></thead>`;
                
                // Body
                html += `<tbody class="divide-y divide-[var(--border-color)]">`;
                tableData.forEach((team, index) => {
                    const rank = index + 1;
                    const isQualified = rank <= 2; // Gi·∫£ s·ª≠ Top 2 ƒëi ti·∫øp
                    const rowClasses = isQualified ? 'bg-green-900/30 text-green-300 font-bold' : 'hover:bg-[var(--border-color)]';
                    
                    html += `<tr class="${rowClasses} transition duration-150">`;
                    html += `<td class="px-3 py-3 whitespace-nowrap text-center text-sm">${rank}</td>`;
                    // D√πng team.D ƒë·ªÉ hi·ªÉn th·ªã t√™n ƒë·ªôi
                    html += `<td class="px-3 py-3 whitespace-nowrap text-sm font-medium">${team.D}</td>`; 
                    html += `<td class="px-3 py-3 whitespace-nowrap text-center text-sm">${team.W}</td>`;
                    html += `<td class="px-3 py-3 whitespace-nowrap text-center text-sm">${team.L}</td>`;
                    html += `<td class="px-3 py-3 whitespace-nowrap text-center text-sm">${team.Pts}</td>`;
                    html += `</tr>`;
                });
                html += `</tbody></table></div>`;
                
                tableElement.innerHTML = html;
            }

            // ------------------
            // 2. Render Matches
            // ------------------
            if (matchesData && matchesElement) {
                let html = `<h2 class="text-2xl font-extrabold text-[var(--group-header-text)] mb-4 border-b border-[var(--border-color)] pb-2">B·∫£ng ${group} - Tr·∫≠n ƒë·∫•u</h2>`;
                html += `<div class="space-y-3">`;

                matchesData.forEach((match, index) => {
                    // C·∫•u tr√∫c m·ªõi d√πng A v√† B l√†m t√™n ƒë·ªôi
                    const teamA = match.A; 
                    const teamB = match.B;
                    
                    const scoreA = match.sA !== undefined ? match.sA : '';
                    const scoreB = match.sB !== undefined ? match.sB : '';
                    const matchId = `${group}-${index}`;
                    
                    // Wn l√† t√™n ƒë·ªôi th·∫Øng (string)
                    const isCompleted = match.Wn !== null && match.Wn !== undefined && match.Wn !== '';
                    const winnerClassA = isCompleted && match.Wn === teamA ? 'font-extrabold text-[var(--accent-color)]' : 'font-medium';
                    const winnerClassB = isCompleted && match.Wn === teamB ? 'font-extrabold text-[var(--accent-color)]' : 'font-medium';
                    const winnerIconA = isCompleted && match.Wn === teamA ? 'üèÜ' : '';
                    const winnerIconB = isCompleted && match.Wn === teamB ? 'üèÜ' : '';
                    
                    // Th√™m th√¥ng tin th·ªùi gian (t) v√† s√¢n (c)
                    const timeCourt = (match.t && match.c) ? ` (${match.t} - ${match.c})` : '';

                    html += `
                        <div class="match-card p-4 rounded-lg shadow-md border-2 ${isCompleted ? 'border-green-600/50' : 'border-[var(--border-color)]'}">
                            <h3 class="text-lg font-bold mb-3">Match ${index + 1}${timeCourt}</h3>
                            <div class="grid grid-cols-5 gap-2 items-center text-center">
                                
                                <div class="col-span-2 text-left ${winnerClassA}">${winnerIconA} ${teamA}</div>
                                
                                <div>
                                    <input type="number" id="scoreA-${matchId}" value="${scoreA}" 
                                           class="score-input w-full p-2 rounded-md text-center text-lg" 
                                           onchange="updateMatchScore('${group}', ${index}, 'A', this.value)">
                                </div>
                                
                                <span class="text-xl font-bold text-[var(--accent-color)]"> - </span>
                                
                                <div>
                                    <input type="number" id="scoreB-${matchId}" value="${scoreB}" 
                                           class="score-input w-full p-2 rounded-md text-center text-lg" 
                                           onchange="updateMatchScore('${group}', ${index}, 'B', this.value)">
                                </div>
                                
                                <div class="col-span-2 text-right ${winnerClassB}">${teamB} ${winnerIconB}</div>
                            </div>
                        </div>`;
                });
                
                html += `</div>`;
                matchesElement.innerHTML = html;
            }
        }

        /**
         * Render th√¥ng tin v√≤ng lo·∫°i tr·ª±c ti·∫øp.
         * @param {string} round - 'quarterfinals', 'semifinals', 'final'
         */
        function renderKnockoutRound(round) {
            if (!tournamentData) return;

            const roundData = tournamentData[round];
            const element = document.getElementById(round);
            
            if (!roundData || !element) return;
            
            const isFinal = round === 'final';
            const matches = Array.isArray(roundData) ? roundData : [roundData];
            const roundTitle = isFinal ? 'Chung K·∫øt' : 
                                 (round === 'semifinals' ? 'B√°n K·∫øt' : 'T·ª© K·∫øt');
                                 
            let html = `<h2 class="text-3xl font-extrabold text-purple-500 mb-4 border-b border-[var(--border-color)] pb-2">${roundTitle}</h2>`;
            html += `<div class="grid grid-cols-1 md:grid-cols-2 gap-4">`;
            
            matches.forEach((match, index) => {
                const teamAId = match.tA; // V√≤ng lo·∫°i d√πng T (ID)
                const teamBId = match.tB;
                const matchPos = match.Pos || (index + 1);
                // V√≤ng lo·∫°i v·∫´n d√πng ID, n√™n ta d√πng getTeamNameById
                const teamAName = getTeamNameById(teamAId) || 'TBD';
                const teamBName = getTeamNameById(teamBId) || 'TBD';
                
                const scoreA = match.sA !== undefined ? match.sA : '';
                const scoreB = match.sB !== undefined ? match.sB : '';
                const matchId = `${round}-${matchPos}`;
                
                // V√≤ng lo·∫°i Wn l√† ID
                const isCompleted = match.Wn !== null && match.Wn !== undefined && teamAName !== 'TBD' && teamBName !== 'TBD';
                const winnerClassA = isCompleted && match.Wn === teamAId ? 'font-extrabold text-[var(--accent-color)]' : 'font-medium';
                const winnerClassB = isCompleted && match.Wn === teamBId ? 'font-extrabold text-[var(--accent-color)]' : 'font-medium';
                const winnerIconA = isCompleted && match.Wn === teamAId ? 'üëë' : '';
                const winnerIconB = isCompleted && match.Wn === teamBId ? 'üëë' : '';
                
                const title = isFinal ? 'Tr·∫≠n Chung K·∫øt' : `${roundTitle} ${matchPos}`;
                const teamADisplay = teamAName === 'TBD' ? `(Winner ${match.pA})` : teamAName;
                const teamBDisplay = teamBName === 'TBD' ? `(Winner ${match.pB})` : teamBName;
                
                html += `
                    <div class="match-card p-4 rounded-lg shadow-lg border-2 ${isCompleted ? 'border-purple-600' : 'border-gray-700'}">
                        <h3 class="text-xl font-bold mb-3">${title}</h3>
                        <div class="grid grid-cols-5 gap-2 items-center text-center">
                            
                            <div class="col-span-2 text-left ${winnerClassA}">${winnerIconA} ${teamADisplay}</div>
                            
                            <div>
                                <input type="number" id="scoreA-${matchId}" value="${scoreA}" 
                                       class="score-input w-full p-2 rounded-md text-center text-lg" 
                                       onchange="updateKnockoutScore('${round}', ${index}, 'A', this.value)">
                            </div>
                            
                            <span class="text-xl font-bold text-purple-500"> - </span>
                            
                            <div>
                                <input type="number" id="scoreB-${matchId}" value="${scoreB}" 
                                       class="score-input w-full p-2 rounded-md text-center text-lg" 
                                       onchange="updateKnockoutScore('${round}', ${index}, 'B', this.value)">
                            </div>
                            
                            <div class="col-span-2 text-right ${winnerClassB}">${teamBDisplay} ${winnerIconB}</div>
                        </div>
                    </div>`;
            });
            
            html += `</div>`;
            element.innerHTML = html;
        }
        
        /**
         * Render th√¥ng tin ƒë·ªôi v√¥ ƒë·ªãch v√† √° qu√¢n.
         */
        function renderFinalResults() {
             if (!tournamentData || !tournamentData.final) return;
             
             const finalMatch = tournamentData.final;
             const winnerId = finalMatch.Wn;
             const runnerUpId = finalMatch.rU;
             
             // V√≤ng lo·∫°i d√πng ID
             const winnerName = getTeamNameById(winnerId);
             const runnerUpName = getTeamNameById(runnerUpId);
             
             let html = ``;
             
             if (winnerName && runnerUpName) {
                 html += `
                     <div class="text-center space-y-4">
                         <div class="p-6 bg-yellow-900/40 rounded-lg">
                             <p class="text-sm font-semibold text-yellow-300">V√î ƒê·ªäCH</p>
                             <h3 class="text-4xl font-extrabold text-yellow-400 mt-1">${winnerName} ü•á</h3>
                         </div>
                         <div class="p-6 bg-gray-700/40 rounded-lg">
                             <p class="text-sm font-semibold text-gray-300">√Å QU√ÇN</p>
                             <h3 class="text-4xl font-extrabold text-gray-400 mt-1">${runnerUpName} ü•à</h3>
                         </div>
                     </div>
                 `;
             } else {
                 html += `<p class="text-center text-lg text-gray-400">Ch∆∞a c√≥ k·∫øt qu·∫£ chung cu·ªôc.</p>`;
             }
             
             document.getElementById('finalResults').innerHTML = html;
        }

        /**
         * Render danh s√°ch c√°c ƒë·ªôi v√† th√¥ng tin c√° nh√¢n.
         */
        function renderTeamList() {
            if (!tournamentData || !tournamentData.tL) return;
            
            const teamListElement = document.getElementById('teamList');
            let html = '';
            
            tournamentData.tL.forEach(team => {
                const player1 = team.P[0];
                const player2 = team.P[1];
                const teamLevel = team.aPL || 'N/A';
                
                html += `
                    <div class="p-4 bg-[var(--card-bg)] rounded-xl shadow-lg border-l-4 border-[var(--accent-color)]">
                        <h3 class="text-xl font-bold text-[var(--accent-color)] mb-2">${team.Tn} (${team.D})</h3>
                        <p class="text-sm text-gray-400 mb-3">Level: <span class="font-bold">${teamLevel}</span></p>
                        
                        <div class="space-y-2">
                            <p class="text-sm">
                                <span class="font-semibold">${player1.name}</span> (Level: ${player1.pL}, SN: ${player1.bY})
                            </p>
                            <p class="text-sm">
                                <span class="font-semibold">${player2.name}</span> (Level: ${player2.pL}, SN: ${player2.bY})
                            </p>
                        </div>
                    </div>
                `;
            });
            
            teamListElement.innerHTML = html;
        }
        
        /**
         * Render giao di·ªán qu·∫£n l√Ω th√¥ng tin ƒë·ªôi.
         */
        function renderTeamManagement() {
             if (!initialTournamentData || !initialTournamentData.tL) return;

             const teamListElement = document.getElementById('teamManagementList');
             let html = '';

             initialTournamentData.tL.forEach((team, teamIndex) => {
                 const player1 = team.P[0];
                 const player2 = team.P[1];
                 const teamId = team.T;

                 html += `
                     <div class="p-4 bg-[var(--match-bg)] rounded-xl shadow-lg border-l-4 border-blue-500 space-y-3">
                         <h3 class="text-xl font-bold text-blue-400">Team ID: ${teamId}</h3>
                         
                         <div>
                             <label for="team-tn-${teamId}" class="block text-sm font-medium text-gray-400">T√™n r√∫t g·ªçn (Tn)</label>
                             <input type="text" id="team-tn-${teamId}" value="${team.Tn || ''}" 
                                    class="text-input w-full p-2 rounded-md" 
                                    onchange="updateTeamDetail('${teamId}', 'Tn', this.value)">
                         </div>
                         
                         <div class="border-t border-gray-700 pt-3 space-y-2">
                             <h4 class="text-md font-semibold text-gray-300">Ng∆∞·ªùi ch∆°i 1 (P[0])</h4>
                             <label for="p1-name-${teamId}" class="block text-sm font-medium text-gray-500">T√™n (name)</label>
                             <input type="text" id="p1-name-${teamId}" value="${player1.name || ''}" 
                                    class="text-input w-full p-2 rounded-md" 
                                    onchange="updatePlayerDetail('${teamId}', 0, 'name', this.value)">
                             
                             <label for="p1-pl-${teamId}" class="block text-sm font-medium text-gray-500">C·∫•p ƒë·ªô (pL)</label>
                             <input type="number" id="p1-pl-${teamId}" value="${player1.pL || ''}" 
                                    class="text-input w-full p-2 rounded-md" 
                                    onchange="updatePlayerDetail('${teamId}', 0, 'pL', this.value)">

                             <label for="p1-by-${teamId}" class="block text-sm font-medium text-gray-500">NƒÉm sinh (bY)</label>
                             <input type="number" id="p1-by-${teamId}" value="${player1.bY || ''}" 
                                    class="text-input w-full p-2 rounded-md" 
                                    onchange="updatePlayerDetail('${teamId}', 0, 'bY', this.value)">
                         </div>

                         <div class="border-t border-gray-700 pt-3 space-y-2">
                             <h4 class="text-md font-semibold text-gray-300">Ng∆∞·ªùi ch∆°i 2 (P[1])</h4>
                             <label for="p2-name-${teamId}" class="block text-sm font-medium text-gray-500">T√™n (name)</label>
                             <input type="text" id="p2-name-${teamId}" value="${player2.name || ''}" 
                                    class="text-input w-full p-2 rounded-md" 
                                    onchange="updatePlayerDetail('${teamId}', 1, 'name', this.value)">
                             
                             <label for="p2-pl-${teamId}" class="block text-sm font-medium text-gray-500">C·∫•p ƒë·ªô (pL)</label>
                             <input type="number" id="p2-pl-${teamId}" value="${player2.pL || ''}" 
                                    class="text-input w-full p-2 rounded-md" 
                                    onchange="updatePlayerDetail('${teamId}', 1, 'pL', this.value)">
                             
                             <label for="p2-by-${teamId}" class="block text-sm font-medium text-gray-500">NƒÉm sinh (bY)</label>
                             <input type="number" id="p2-by-${teamId}" value="${player2.bY || ''}" 
                                    class="text-input w-full p-2 rounded-md" 
                                    onchange="updatePlayerDetail('${teamId}', 1, 'bY', this.value)">
                         </div>
                     </div>
                 `;
             });

             teamListElement.innerHTML = html;
        }

        /**
         * Render to√†n b·ªô giao di·ªán sau khi d·ªØ li·ªáu ƒë√£ ƒë∆∞·ª£c t√≠nh to√°n l·∫°i.
         */
        function renderAllSections() {
            renderFinalResults();
            renderTeamList();
            renderTeamManagement();
            renderGroupSection('A');
            renderGroupSection('B');
            renderGroupSection('C');
            renderGroupSection('D');
            renderKnockoutRound('quarterfinals');
            renderKnockoutRound('semifinals');
            
            // Final match needs a separate element for the single match
            const finalSection = document.getElementById('finalSection');
            if (finalSection) {
                 finalSection.innerHTML = '';
                 const finalData = tournamentData.final;
                 if (finalData) {
                      let html = `
                          <h2 class="text-3xl font-extrabold text-purple-500 mb-4 border-b border-[var(--border-color)] pb-2">Chung K·∫øt</h2>
                          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                      `;
                      
                      const match = finalData;
                      const index = 0;
                      const round = 'final';
                      const matchPos = match.Pos || (index + 1);
                      const teamAId = match.tA;
                      const teamBId = match.tB;
                      // V√≤ng lo·∫°i d√πng ID
                      const teamAName = getTeamNameById(teamAId) || 'TBD';
                      const teamBName = getTeamNameById(teamBId) || 'TBD';
                      
                      const scoreA = match.sA !== undefined ? match.sA : '';
                      const scoreB = match.sB !== undefined ? match.sB : '';
                      const matchId = `${round}-${matchPos}`;
                      
                      const isCompleted = match.Wn !== null && match.Wn !== undefined && teamAName !== 'TBD' && teamBName !== 'TBD';
                      const winnerClassA = isCompleted && match.Wn === teamAId ? 'font-extrabold text-yellow-400' : 'font-medium';
                      const winnerClassB = isCompleted && match.Wn === teamBId ? 'font-extrabold text-yellow-400' : 'font-medium';
                      const winnerIconA = isCompleted && match.Wn === teamAId ? 'üëë' : '';
                      const winnerIconB = isCompleted && match.Wn === teamBId ? 'üëë' : '';
                      const runnerUpIconA = isCompleted && match.rU === teamAId ? 'ü•à' : '';
                      const runnerUpIconB = isCompleted && match.rU === teamBId ? 'ü•à' : '';
                      
                      const teamADisplay = teamAName === 'TBD' ? `(Winner ${match.pA})` : teamAName;
                      const teamBDisplay = teamBName === 'TBD' ? `(Winner ${match.pB})` : teamBName;
                      
                      html += `
                          <div class="match-card p-4 rounded-lg shadow-lg border-2 ${isCompleted ? 'border-yellow-600' : 'border-gray-700'} md:col-span-2">
                              <h3 class="text-xl font-bold mb-3">Tr·∫≠n Chung K·∫øt (FINALS)</h3>
                              <div class="grid grid-cols-5 gap-2 items-center text-center">
                                  
                                  <div class="col-span-2 text-left ${winnerClassA}">${winnerIconA}${runnerUpIconA} ${teamADisplay}</div>
                                  
                                  <div>
                                      <input type="number" id="scoreA-${matchId}" value="${scoreA}" 
                                             class="score-input w-full p-2 rounded-md text-center text-lg" 
                                             onchange="updateKnockoutScore('${round}', ${index}, 'A', this.value)">
                                  </div>
                                  
                                  <span class="text-xl font-bold text-yellow-500"> - </span>
                                  
                                  <div>
                                      <input type="number" id="scoreB-${matchId}" value="${scoreB}" 
                                             class="score-input w-full p-2 rounded-md text-center text-lg" 
                                             onchange="updateKnockoutScore('${round}', ${index}, 'B', this.value)">
                                  </div>
                                  
                                  <div class="col-span-2 text-right ${winnerClassB}">${teamBDisplay} ${winnerIconB}${runnerUpIconB}</div>
                              </div>
                          </div>`;
                          
                       html += `</div>`;
                       finalSection.innerHTML = html;
                 }
            }
            
            // C·∫≠p nh·∫≠t URL C·∫•u h√¨nh
            document.getElementById('baseApiUrl').value = BASE_API_URL;
            document.getElementById('scoreApiUrl').value = SCORE_API_URL;
            document.getElementById('staticDataUrl').value = STATIC_DATA_URL;
            document.getElementById('diffDataUrl').value = DIFF_DATA_URL;

            // K√≠ch ho·∫°t tab ƒë·∫ßu ti√™n n·∫øu ch∆∞a c√≥ tab n√†o ho·∫°t ƒë·ªông
            if (!document.querySelector('.tab-button.active')) {
                switchTab('General');
            }
        }


        // =================================================================
        // H√ÄM C·∫¨P NH·∫¨T D·ªÆ LI·ªÜU T·∫†M TH·ªúI (LOCAL)
        // =================================================================

        /**
         * C·∫≠p nh·∫≠t t·ªâ s·ªë tr·∫≠n ƒë·∫•u v√≤ng b·∫£ng (t·∫°m th·ªùi)
         * @param {string} group - T√™n b·∫£ng ('A', 'B', 'C', 'D').
         * @param {number} index - Index c·ªßa tr·∫≠n ƒë·∫•u.
         * @param {string} team - 'A' ho·∫∑c 'B'.
         * @param {string} value - Gi√° tr·ªã t·ªâ s·ªë.
         */
        function updateMatchScore(group, index, team, value) {
            if (!tournamentData) return;
            const matchesKey = `matches${group}`;
            const field = team === 'A' ? 'sA' : 'sB';
            
            // ƒê·∫£m b·∫£o gi√° tr·ªã l√† s·ªë ho·∫∑c null
            const scoreValue = value.trim() === '' ? null : parseInt(value);

            if (tournamentData[matchesKey] && tournamentData[matchesKey][index]) {
                tournamentData[matchesKey][index][field] = scoreValue;
                // Ch·∫°y l·∫°i logic ƒë·ªÉ c·∫≠p nh·∫≠t th·ª© h·∫°ng v√† tr·∫°ng th√°i commit
                runAllLogic(); 
            }
        }
        
        /**
         * C·∫≠p nh·∫≠t t·ªâ s·ªë tr·∫≠n ƒë·∫•u v√≤ng lo·∫°i (t·∫°m th·ªùi)
         * @param {string} round - 'quarterfinals', 'semifinals', 'final'.
         * @param {number} index - Index c·ªßa tr·∫≠n ƒë·∫•u (lu√¥n l√† 0 cho final).
         * @param {string} team - 'A' ho·∫∑c 'B'.
         * @param {string} value - Gi√° tr·ªã t·ªâ s·ªë.
         */
        function updateKnockoutScore(round, index, team, value) {
             if (!tournamentData) return;
             const roundData = tournamentData[round];
             const field = team === 'A' ? 'sA' : 'sB';
             
             // ƒê·∫£m b·∫£o gi√° tr·ªã l√† s·ªë ho·∫∑c null
             const scoreValue = value.trim() === '' ? null : parseInt(value);

             if (Array.isArray(roundData) && roundData[index]) {
                 roundData[index][field] = scoreValue;
             } else if (roundData && !Array.isArray(roundData)) {
                  // Final is an object, index is ignored
                  roundData[field] = scoreValue;
             }
             
             // Ch·∫°y l·∫°i logic ƒë·ªÉ c·∫≠p nh·∫≠t ƒë·ªôi ƒëi ti·∫øp v√† tr·∫°ng th√°i commit
             runAllLogic();
        }

        /**
         * C·∫≠p nh·∫≠t th√¥ng tin chi ti·∫øt ƒë·ªôi (Tn).
         * @param {string} teamId - M√£ ƒë·ªôi (T).
         * @param {string} field - T√™n tr∆∞·ªùng ('Tn').
         * @param {string} value - Gi√° tr·ªã m·ªõi.
         */
        function updateTeamDetail(teamId, field, value) {
            const team = initialTournamentData.tL.find(t => t.T === teamId);
            if (team) {
                team[field] = value;
                renderTeamList(); // C·∫≠p nh·∫≠t hi·ªÉn th·ªã team list sau khi thay ƒë·ªïi
            }
        }

        /**
         * C·∫≠p nh·∫≠t th√¥ng tin chi ti·∫øt ng∆∞·ªùi ch∆°i (name, pL, bY).
         * @param {string} teamId - M√£ ƒë·ªôi (T).
         * @param {number} playerIndex - 0 ho·∫∑c 1.
         * @param {string} field - T√™n tr∆∞·ªùng ('name', 'pL', 'bY').
         * @param {string} value - Gi√° tr·ªã m·ªõi.
         */
        function updatePlayerDetail(teamId, playerIndex, field, value) {
            const team = initialTournamentData.tL.find(t => t.T === teamId);
            if (team && team.P && team.P[playerIndex]) {
                // ƒê·∫£m b·∫£o pL v√† bY l√† s·ªë
                const finalValue = (field === 'pL' || field === 'bY') ? parseInt(value) : value;
                team.P[playerIndex][field] = finalValue;
                renderTeamList(); // C·∫≠p nh·∫≠t hi·ªÉn th·ªã team list sau khi thay ƒë·ªïi
            }
        }


        // =================================================================
        // H√ÄM COMMIT L√äN GITHUB (ƒê√É FIX L·ªñI JSON INPUT KHI L·∫§Y SHA)
        // =================================================================
        
        /**
         * L·∫•y SHA hi·ªán t·∫°i c·ªßa file v√† commit n·ªôi dung m·ªõi.
         * @param {string} apiUrl - URL API GitHub cho file (state3.json ho·∫∑c state3s.json).
         * @param {string} base64Content - N·ªôi dung m·ªõi ƒë√£ ƒë∆∞·ª£c m√£ h√≥a Base64.
         * @param {string} commitMessage - Tin nh·∫Øn commit.
         * @param {string} buttonId - ID c·ªßa n√∫t.
         * @param {string} resultElementId - ID c·ªßa element hi·ªÉn th·ªã k·∫øt qu·∫£.
         */
        async function getShaAndCommit(apiUrl, base64Content, commitMessage, buttonId, resultElementId) {
            const btn = document.getElementById(buttonId);
            btn.disabled = true;
            btn.textContent = 'ƒêang COMMIT...';
            
            const resultElement = document.getElementById(resultElementId);
            resultElement.classList.add('hidden');
            resultElement.classList.remove('bg-red-900/50', 'bg-green-900/50');
            
            const MAX_BODY_LENGTH = 150; // Gi·ªõi h·∫°n ƒë·ªô d√†i n·ªôi dung body hi·ªÉn th·ªã

            /**
             * C·ªë g·∫Øng parse response th√†nh JSON. N·∫øu th·∫•t b·∫°i, ƒë·ªçc response th√†nh TEXT ƒë·ªÉ debug.
             * @param {Response} response 
             * @returns {Promise<Object|{jsonError: string, textBody: string}>}
             */
            async function safelyParseResponse(response) {
                let fileData;
                let responseBodyText = '';

                try {
                    fileData = await response.json();
                    return fileData; // Tr·∫£ v·ªÅ JSON object n·∫øu th√†nh c√¥ng
                } catch (e) {
                    // N·∫øu kh√¥ng ph·∫£i JSON, ƒë·ªçc n√≥ nh∆∞ TEXT ƒë·ªÉ debug
                    try {
                        responseBodyText = await response.text();
                    } catch(textError) {
                        responseBodyText = '(Kh√¥ng th·ªÉ ƒë·ªçc n·ªôi dung ph·∫£n h·ªìi)';
                    }
                    // Tr·∫£ v·ªÅ m·ªôt ƒë·ªëi t∆∞·ª£ng l·ªói ƒë·ªÉ x·ª≠ l√Ω ti·∫øp
                    return { jsonError: e.message, textBody: responseBodyText.substring(0, MAX_BODY_LENGTH) };
                }
            }


            try {
                // 1. L·∫•y SHA hi·ªán t·∫°i c·ªßa file (GET request)
                const getResponse = await fetch(apiUrl, {
                    headers: {
                        'Authorization': `token ${githubToken}`
                    }
                });
                
                let fileData = await safelyParseResponse(getResponse);

                if (!getResponse.ok) {
                    let errorDetails;
                    if (fileData.jsonError) {
                        // L·ªói non-JSON khi status l√† l·ªói (4xx, 5xx)
                        errorDetails = `L·ªói ph·∫£n h·ªìi (Status ${getResponse.status}): N·ªôi dung KH√îNG ph·∫£i JSON. Body: "${fileData.textBody}"`;
                    } else {
                        // L·ªói JSON h·ª£p l·ªá (v√≠ d·ª•: {"message": "Not Found"})
                        errorDetails = fileData.message || getResponse.statusText;
                    }
                    throw new Error(`L·ªói khi l·∫•y SHA: ${getResponse.status} - ${errorDetails}`);
                }
                
                // --- Ki·ªÉm tra n·∫øu 200 OK nh∆∞ng JSON l·ªói (r·∫•t hi·∫øm, nh∆∞ng c√≥ th·ªÉ x·∫£y ra khi body r·ªóng) ---
                if (getResponse.ok && fileData.jsonError) {
                    throw new Error(`L·ªói c√∫ ph√°p JSON M·∫∑c d√π Status ${getResponse.status} OK. Body: "${fileData.textBody}"`);
                }

                // Ti·∫øp t·ª•c v·ªõi d·ªØ li·ªáu JSON h·ª£p l·ªá (Status 200 OK)
                const currentSha = fileData.sha;
                
                if (!currentSha) {
                    throw new Error("Kh√¥ng t√¨m th·∫•y SHA (file c√≥ th·ªÉ kh√¥ng t·ªìn t·∫°i ho·∫∑c l·ªói c·∫•u tr√∫c).");
                }

                // 2. Commit n·ªôi dung m·ªõi (PUT request)
                const commitBody = {
                    message: commitMessage,
                    content: base64Content,
                    sha: currentSha,
                    branch: BRANCH
                };

                const commitResponse = await fetch(apiUrl, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `token ${githubToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(commitBody)
                });
                
                let commitResult = await safelyParseResponse(commitResponse);

                if (!commitResponse.ok) {
                    let errorDetails;
                     if (commitResult.jsonError) {
                         // L·ªói non-JSON sau commit fail
                         errorDetails = `L·ªói Commit: ${commitResponse.status}. Ph·∫£n h·ªìi kh√¥ng ph·∫£i JSON. Body: "${commitResult.textBody}"`;
                     } else {
                         // X·ª≠ l√Ω l·ªói t·ª´ GitHub API sau commit
                         errorDetails = commitResult.message || commitResponse.statusText;
                     }
                    throw new Error(`L·ªói API Commit: ${commitResponse.status} - ${errorDetails}`);
                }
                
                // X·ª≠ l√Ω tr∆∞·ªùng h·ª£p 200 OK nh∆∞ng JSON l·ªói sau commit (r·∫•t hi·∫øm)
                if (commitResponse.ok && commitResult.jsonError) {
                    throw new Error(`L·ªói c√∫ ph√°p JSON sau Commit ${commitResponse.status} OK. Body: "${commitResult.textBody}"`);
                }
                
                // 3. X·ª≠ l√Ω th√†nh c√¥ng
                resultElement.classList.remove('hidden');
                resultElement.classList.add('bg-green-900/50');
                resultElement.textContent = `‚úÖ COMMIT th√†nh c√¥ng: ${commitResult.commit.sha.substring(0, 7)}.`;
                
                // T·∫£i l·∫°i d·ªØ li·ªáu sau khi commit th√†nh c√¥ng
                await loadDataFromGitHub();
                
            } catch (err) {
                const e = document.getElementById(resultElementId);
                e.classList.remove('hidden');
                e.classList.add('bg-red-900/50');
                e.textContent = `‚ùå L·ªói commit: ${err.message}`;
                console.error("CHI TI·∫æT L·ªñI GITHUB API:", err);
            } finally {
                btn.disabled = false;
                btn.textContent = (buttonId === 'commitScoreButton') ? 'EXPORT & COMMIT T·∫§T C·∫¢ T·ªà S·ªê (Ghi ƒë√® state3s.json)' : 'C·∫¨P NH·∫¨T TH√îNG TIN ƒê·ªòI (Ghi ƒë√® state3.json)';
            }
        }

        /**
         * Commit t·ªâ s·ªë thay ƒë·ªïi (state3s.json) l√™n GitHub.
         */
        async function commitScoreChangesToGitHub() {
            githubToken = localStorage.getItem('githubToken') || '';
            if (!githubToken) { document.getElementById('scoreCommitResult').textContent = '‚ö†Ô∏è Ch∆∞a c√≥ Token. Vui l√≤ng d√°n Token v√†o m·ª•c C·∫•u H√¨nh.'; document.getElementById('scoreCommitResult').classList.remove('hidden', 'bg-green-900/50'); document.getElementById('scoreCommitResult').classList.add('bg-red-900/50'); return; }
            
            // L·∫•y d·ªØ li·ªáu t·ªâ s·ªë ƒë√£ ƒë∆∞·ª£c chu·∫©n b·ªã
            const diffData = window.diffDataForCommit || {};
            
            const base64Content = jsonToBase64(diffData);
            
            await getShaAndCommit(SCORE_API_URL, base64Content, 'Update scores via web app', 'commitScoreButton', 'scoreCommitResult');
        }

        /**
         * Commit th√¥ng tin ƒë·ªôi (state3.json) l√™n GitHub.
         */
        async function commitTeamChangesToGitHub() {
            githubToken = localStorage.getItem('githubToken') || '';
            if (!githubToken) { document.getElementById('teamCommitResult').textContent = '‚ö†Ô∏è Ch∆∞a c√≥ Token. Vui l√≤ng d√°n Token v√†o m·ª•c C·∫•u H√¨nh.'; document.getElementById('teamCommitResult').classList.remove('hidden', 'bg-green-900/50'); document.getElementById('teamCommitResult').classList.add('bg-red-900/50'); return; }

            // S·ª≠ d·ª•ng d·ªØ li·ªáu initialTournamentData ƒë√£ ƒë∆∞·ª£c ch·ªânh s·ª≠a
            const teamData = initialTournamentData;
            const base64Content = jsonToBase64(teamData);
            
            await getShaAndCommit(BASE_API_URL, base64Content, 'Update team data via web app', 'commitTeamButton', 'teamCommitResult');
        }


        // =================================================================
        // H√ÄM GIAO DI·ªÜN & C·∫§U H√åNH
        // =================================================================
        
        /**
         * L∆∞u GitHub Token v√†o Local Storage.
         */
        function saveToken() {
            const tokenInput = document.getElementById('githubToken');
            const token = tokenInput.value;
            
            if (token && token !== '********') {
                localStorage.setItem('githubToken', token);
                githubToken = token;
                tokenInput.value = '********'; // ·∫®n token sau khi l∆∞u
                alert('‚úÖ GitHub Token ƒë√£ ƒë∆∞·ª£c l∆∞u tr·ªØ an to√†n.');
            } else if (token === '********') {
                 alert('Token ƒë√£ ƒë∆∞·ª£c l∆∞u t·ª´ tr∆∞·ªõc.');
            } else {
                alert('‚ö†Ô∏è Vui l√≤ng nh·∫≠p Token.');
            }
        }

        /**
         * Chuy·ªÉn ƒë·ªïi gi·ªØa Light Mode v√† Dark Mode.
         */
        function toggleTheme() {
            const body = document.body;
            body.classList.toggle('light-mode');
            const theme = body.classList.contains('light-mode') ? 'light' : 'dark';
            localStorage.setItem('theme', theme);
            
            document.getElementById('sunIcon').classList.toggle('hidden', theme === 'dark');
            document.getElementById('moonIcon').classList.toggle('hidden', theme === 'light');
        }

        /**
         * √Åp d·ª•ng theme ƒë√£ l∆∞u.
         */
        function applyTheme(theme) {
            const body = document.body;
            if (theme === 'light') {
                body.classList.add('light-mode');
                document.getElementById('sunIcon').classList.remove('hidden');
                document.getElementById('moonIcon').classList.add('hidden');
            } else {
                body.classList.remove('light-mode');
                document.getElementById('sunIcon').classList.add('hidden');
                document.getElementById('moonIcon').classList.remove('hidden');
            }
        }

        /**
         * Chuy·ªÉn ƒë·ªïi gi·ªØa c√°c tab.
         * @param {string} tabId - ID c·ªßa tab c·∫ßn hi·ªÉn th·ªã.
         */
        function switchTab(tabId) {
            currentTab = tabId;
            // ·∫®n t·∫•t c·∫£ tab content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.style.display = 'none';
            });

            // G·ª° active kh·ªèi t·∫•t c·∫£ tab buttons
            document.querySelectorAll('.tab-button').forEach(button => {
                button.classList.remove('active');
            });

            // Hi·ªÉn th·ªã tab content ƒë∆∞·ª£c ch·ªçn
            const activeContent = document.getElementById(tabId);
            if (activeContent) {
                activeContent.style.display = 'grid'; // D√πng grid cho c√°c tab group/knockout
                if (tabId === 'General' || tabId === 'TeamManagement' || tabId === 'Configuration') {
                     activeContent.style.display = 'block';
                }
            }

            // Th√™m active cho tab button ƒë∆∞·ª£c ch·ªçn
            document.querySelector(`.tab-button[data-tab="${tabId}"]`).classList.add('active');
        }

        /**
         * X·ª≠ l√Ω thao t√°c vu·ªët (swipe) ƒë·ªÉ chuy·ªÉn tab.
         */
        function handleGesture() {
            if (Math.abs(endX - startX) < 50) return; // Kho·∫£ng c√°ch qu√° ng·∫Øn
            
            const tabs = ['General', 'TeamManagement', 'GroupA', 'GroupB', 'GroupC', 'GroupD', 'Knockout', 'Configuration'];
            let currentIndex = tabs.indexOf(currentTab);

            if (endX < startX) { // Vu·ªët sang tr√°i (tab ti·∫øp theo)
                currentIndex = (currentIndex + 1) % tabs.length;
            } else { // Vu·ªët sang ph·∫£i (tab tr∆∞·ªõc ƒë√≥)
                currentIndex = (currentIndex - 1 + tabs.length) % tabs.length;
            }

            switchTab(tabs[currentIndex]);
        }


        // =================================================================
        // KH·ªûI T·∫†O
        // =================================================================
        function initializeApp() {
            // Load saved token and theme
            githubToken = localStorage.getItem('githubToken') || '';
            const savedTheme = localStorage.getItem('theme') || 'dark'; 
            applyTheme(savedTheme);

            if (githubToken) {
                 document.getElementById('githubToken').value = '********';
            }

            // Event listeners
            document.getElementById('themeToggle').addEventListener('click', toggleTheme);
            document.getElementById('app').addEventListener('touchstart', (e) => {
                // ƒê·∫£m b·∫£o kh√¥ng k√≠ch ho·∫°t swipe khi ch·∫°m v√†o input
                if (e.target.classList.contains('score-input') || e.target.classList.contains('text-input')) return;
                startX = e.changedTouches[0].screenX;
            }, { passive: true });

            document.getElementById('app').addEventListener('touchend', (e) => {
                // ƒê·∫£m b·∫£o kh√¥ng k√≠ch ho·∫°t swipe khi ch·∫°m v√†o input
                if (e.target.classList.contains('score-input') || e.target.classList.contains('text-input')) return;
                endX = e.changedTouches[0].screenX;
                handleGesture();
            }, { passive: true });
            
            // Modal button setup
            document.getElementById('confirmYes').onclick = window.reSyncStaticData;
            document.getElementById('confirmNo').onclick = () => document.getElementById('confirmationBox').classList.add('hidden');
            
            // Commit button listeners (Do the buttons are created in HTML, only need the function definitions)

            // Start data loading
            loadDataFromGitHub();
        }

        window.onload = initializeApp;
    </script>
</body>
</html>
