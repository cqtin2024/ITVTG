<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quản Lý Giải Đấu Pickleball Đôi Nam</title>
    <!-- Tải Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Tải phông chữ Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100;400;700;900&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #111827; /* Gray-900 */
            color: #f3f4f6; /* Gray-100 */
        }
        .container {
            max-width: 1200px;
        }
        .score-input:focus {
            box-shadow: 0 0 0 3px rgba(6, 182, 212, 0.5); /* Cyan-500 shadow */
        }
        /* Custom scrollbar for better look in dark mode */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-thumb {
            background: #4b5563; /* Gray-600 */
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #6b7280; /* Gray-500 */
        }
        .tab-button.active {
            color: #06b6d4; /* Cyan-500 */
            border-color: #06b6d4;
            background-color: #1f2937; /* Gray-800 */
        }
        .tab-content {
            display: none;
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <div id="app" class="container mx-auto">
        <!-- HEADER MỚI: Logo đã được tăng kích thước và bỏ khung bo tròn -->
        <header class="flex items-center justify-center mb-6">
            <!-- Logo đã được điều chỉnh kích thước lớn hơn và loại bỏ bo tròn, ring -->
            <img src="https://raw.githubusercontent.com/cqtin2024/ITVTG/main/LogoITGVT.png" alt="ITGVT Logo" class="h-20 w-20 md:h-24 md:w-24 shadow-lg mr-4">
            
            <!-- Khối Tiêu đề/Phụ đề -->
            <div class="text-left">
                <h1 class="text-3xl md:text-5xl font-extrabold text-white leading-none">PICKLEBALL ĐÔI NAM</h1>
                <p class="text-sm md:text-lg text-cyan-400">Quản Lý & Cập Nhật Tỉ Số Giải Đấu</p>
            </div>
        </header>

        <!-- Loading Indicator -->
        <div id="loadingMessage" class="text-center p-4 bg-blue-900/50 rounded-lg text-blue-300 font-semibold mb-6">
            Đang tải dữ liệu giải đấu Pickleball...
        </div>
        
        <!-- Tab Navigation -->
        <nav class="mb-8 border-b border-gray-700 overflow-x-auto whitespace-nowrap">
            <button class="tab-button py-3 px-4 md:px-6 text-sm md:text-base font-semibold border-b-2 border-transparent text-gray-400 hover:text-cyan-400 transition" onclick="switchTab('General')" data-tab="General">General (Thông tin chung)</button>
            <button class="tab-button py-3 px-4 md:px-6 text-sm md:text-base font-semibold border-b-2 border-transparent text-gray-400 hover:text-cyan-400 transition" onclick="switchTab('GroupA')" data-tab="GroupA">Group A</button>
            <button class="tab-button py-3 px-4 md:px-6 text-sm md:text-base font-semibold border-b-2 border-transparent text-gray-400 hover:text-cyan-400 transition" onclick="switchTab('GroupB')" data-tab="GroupB">Group B</button>
            <button class="tab-button py-3 px-4 md:px-6 text-sm md:text-base font-semibold border-b-2 border-transparent text-gray-400 hover:text-cyan-400 transition" onclick="switchTab('GroupC')" data-tab="GroupC">Group C</button>
            <button class="tab-button py-3 px-4 md:px-6 text-sm md:text-base font-semibold border-b-2 border-transparent text-gray-400 hover:text-cyan-400 transition" onclick="switchTab('GroupD')" data-tab="GroupD">Group D</button>
            <button class="tab-button py-3 px-4 md:px-6 text-sm md:text-base font-semibold border-b-2 border-transparent text-gray-400 hover:text-cyan-400 transition" onclick="switchTab('Knockout')" data-tab="Knockout">Knockout (Vòng loại)</button>
        </nav>

        <!-- TAB: General (Final Results & Team List) -->
        <div id="General" class="tab-content">
             <h2 class="text-3xl font-extrabold text-yellow-400 mb-6 border-b border-gray-700 pb-2">Final Results (Kết quả chung cuộc)</h2>
            <section id="finalResults" class="mb-10 p-6 bg-gray-900 rounded-xl shadow-2xl"></section>

            <h2 class="text-3xl font-extrabold text-white mb-6 border-b border-gray-700 pb-2">Team List (Danh sách các đội)</h2>
            <section id="teamList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                <!-- Team cards will be rendered here -->
            </section>
        </div>

        <!-- TAB: Group A (Standings & Matches) -->
        <div id="GroupA" class="tab-content grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div id="tableA" class="lg:col-span-1"></div>
            <div id="matchesA" class="p-4 bg-gray-900 rounded-xl shadow-2xl lg:col-span-2"></div>
        </div>

        <!-- TAB: Group B (Standings & Matches) -->
        <div id="GroupB" class="tab-content grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div id="tableB" class="lg:col-span-1"></div>
            <div id="matchesB" class="p-4 bg-gray-900 rounded-xl shadow-2xl lg:col-span-2"></div>
        </div>

        <!-- TAB: Group C (Standings & Matches) -->
        <div id="GroupC" class="tab-content grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div id="tableC" class="lg:col-span-1"></div>
            <div id="matchesC" class="p-4 bg-gray-900 rounded-xl shadow-2xl lg:col-span-2"></div>
        </div>

        <!-- TAB: Group D (Standings & Matches) -->
        <div id="GroupD" class="tab-content grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div id="tableD" class="lg:col-span-1"></div>
            <div id="matchesD" class="p-4 bg-gray-900 rounded-xl shadow-2xl lg:col-span-2"></div>
        </div>

        <!-- TAB: Knockout (Quarterfinals, Semifinals, Final) -->
        <div id="Knockout" class="tab-content">
            <div id="quarterfinals" class="p-4 bg-gray-900 rounded-xl shadow-2xl mb-6"></div>
            <div id="semifinals" class="p-4 bg-gray-900 rounded-xl shadow-2xl mb-6"></div>
            <div id="finalMatchSection">
                <div id="finalSection" class="p-4 bg-gray-900 rounded-xl shadow-2xl"></div>
            </div>
        </div>

    </div>

    <!-- FIREBASE SETUP (Mandatory for Canvas Environment) -->
    <script type="module">
        // Đã đổi tên các hàm import để tránh lỗi trùng lặp định danh
        import { initializeApp as initApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth as getAuthService, signInAnonymously, signInWithCustomToken, setPersistence, browserSessionPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore as getDbService, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // GLOBAL VARIABLES (provided by Canvas environment)
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        // Data structure
        let tournamentData = null;

        // Firebase instances (can be null if not initialized)
        let app, auth, db;


        // --- Tab Management Function ---
        window.switchTab = function(tabName) {
            // Hide all tab content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.style.display = 'none';
            });

            // Deactivate all buttons
            document.querySelectorAll('.tab-button').forEach(button => {
                button.classList.remove('active');
            });

            // Show the selected tab content
            const activeContent = document.getElementById(tabName);
            if (activeContent) {
                activeContent.style.display = 'grid'; // Use grid for group/knockout layouts
                if (tabName === 'General') {
                    activeContent.style.display = 'block'; // Use block for General layout
                }
            }

            // Activate the selected button
            const activeButton = document.querySelector(`.tab-button[data-tab="${tabName}"]`);
            if (activeButton) {
                activeButton.classList.add('active');
            }
        }


        // --- Core Logic Functions ---

        // Function for exponential backoff (required)
        async function fetchWithRetry(url, options = {}, maxRetries = 5) {
            let lastError = null;
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(url, options);
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response;
                } catch (error) {
                    lastError = error;
                    const delay = Math.pow(2, i) * 1000; // 1s, 2s, 4s, 8s, 16s...
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
            console.error("Failed to fetch data after multiple retries.", lastError);
            throw lastError;
        }

        // Helper to safely get match winner (assuming standard Pickleball win/loss)
        function getMatchWinner(scoreA, scoreB) {
            const sA = parseInt(scoreA);
            const sB = parseInt(scoreB);
            if (sA > sB) return 'A';
            if (sB > sA) return 'B';
            return 'Chưa có'; // Default if scores are equal or zero
        }

        // Group Standings Calculation
        function calculateGroupStandings(groupMatches) {
            const standings = {};

            // 1. Initialize standings map
            groupMatches.forEach(match => {
                if (!standings[match.A]) standings[match.A] = { D: match.A, W: 0, L: 0, HS: 0, Pts: 0, mP: 0, scoreDiff: 0 };
                if (!standings[match.B]) standings[match.B] = { D: match.B, W: 0, L: 0, HS: 0, Pts: 0, mP: 0, scoreDiff: 0 };
            });

            // 2. Process matches
            groupMatches.forEach(match => {
                const sA = parseInt(match.sA);
                const sB = parseInt(match.sB);

                // Update matches played and high score
                if (sA !== 0 || sB !== 0) { // Only count if played
                    standings[match.A].mP++;
                    standings[match.B].mP++;
                }
                
                standings[match.A].HS = Math.max(standings[match.A].HS, sA);
                standings[match.B].HS = Math.max(standings[match.B].HS, sB);

                // Update score difference
                standings[match.A].scoreDiff += (sA - sB);
                standings[match.B].scoreDiff += (sB - sA);

                // Update Wins/Losses/Points
                const winnerCode = getMatchWinner(sA, sB);
                
                if (winnerCode === 'A') {
                    standings[match.A].W++;
                    standings[match.A].Pts += 3; // 3 points for a win
                    standings[match.B].L++;
                    match.Wn = match.A; // Update winner name
                } else if (winnerCode === 'B') {
                    standings[match.B].W++;
                    standings[match.B].Pts += 3;
                    standings[match.A].L++;
                    match.Wn = match.B; // Update winner name
                } else {
                     match.Wn = 'Chưa có';
                }
            });

            // 3. Convert to array and sort (W > Pts > ScoreDiff > HS)
            const sortedStandings = Object.values(standings).sort((a, b) => {
                if (b.W !== a.W) return b.W - a.W; // 1. Wins
                if (b.Pts !== a.Pts) return b.Pts - a.Pts; // 2. Points (optional, but robust)
                if (b.scoreDiff !== a.scoreDiff) return b.scoreDiff - a.scoreDiff; // 3. Score Difference
                if (b.HS !== a.HS) return b.HS - a.HS; // 4. High Score
                return a.D.localeCompare(b.D); // 5. Team Name fallback
            }).map(({ D, W, L, HS, Pts, mP }) => ({ D, W, L, HS: String(HS), Pts, mP })); // Clean up to match JSON structure

            return sortedStandings;
        }

        // Dynamic Progression Logic
        function updateKnockoutProgression(data) {
            // Recalculate Group Standings first
            const rankings = {
                A: calculateGroupStandings(data.matchesA),
                B: calculateGroupStandings(data.matchesB),
                C: calculateGroupStandings(data.matchesC),
                D: calculateGroupStandings(data.matchesD)
            };

            const getRank = (group, rank) => rankings[group][rank - 1]?.D || `[${group}${rank}_Waiting]`;
            const calculateMatchWinnerName = (match) => {
                const winnerCode = getMatchWinner(match.sA, match.sB);
                return winnerCode === 'A' ? match.A : (winnerCode === 'B' ? match.B : 'Chưa có');
            };
            const getLoser = (match) => {
                 const winnerName = calculateMatchWinnerName(match);
                 if (winnerName === match.A) return match.B;
                 if (winnerName === match.B) return match.A;
                 return 'Chưa có';
            };


            // --- 1. Update Quarterfinals (QF) Opponents and Winners ---
            
            // QF1: A1 vs B2
            data.quarterfinals[0].A = getRank('A', 1);
            data.quarterfinals[0].B = getRank('B', 2);
            data.quarterfinals[0].Wn = calculateMatchWinnerName(data.quarterfinals[0]);

            // QF2: C1 vs D2
            data.quarterfinals[1].A = getRank('C', 1);
            data.quarterfinals[1].B = getRank('D', 2);
            data.quarterfinals[1].Wn = calculateMatchWinnerName(data.quarterfinals[1]);

            // QF3: B1 vs A2
            data.quarterfinals[2].A = getRank('B', 1);
            data.quarterfinals[2].B = getRank('A', 2);
            data.quarterfinals[2].Wn = calculateMatchWinnerName(data.quarterfinals[2]);

            // QF4: D1 vs C2
            data.quarterfinals[3].A = getRank('D', 1);
            data.quarterfinals[3].B = getRank('C', 2);
            data.quarterfinals[3].Wn = calculateMatchWinnerName(data.quarterfinals[3]);


            // --- 2. Update Semifinals (SF) Opponents and Winners ---
            
            // SF1: Wn QF1 vs Wn QF2
            data.semifinals[0].A = data.quarterfinals[0].Wn;
            data.semifinals[0].B = data.quarterfinals[1].Wn;
            data.semifinals[0].Wn = calculateMatchWinnerName(data.semifinals[0]);

            // SF2: Wn QF3 vs Wn QF4
            data.semifinals[1].A = data.quarterfinals[2].Wn;
            data.semifinals[1].B = data.quarterfinals[3].Wn;
            data.semifinals[1].Wn = calculateMatchWinnerName(data.semifinals[1]);

            // --- 3. Update Final ---
            
            // Final: Wn SF1 vs Wn SF2
            data.final.A = data.semifinals[0].Wn;
            data.final.B = data.semifinals[1].Wn;
            data.final.Wn = calculateMatchWinnerName(data.final);
            data.final.rU = getLoser(data.final);

            // --- 4. Update Final Standings (Champion, Runner-Up, Third Place) ---
            data.champion = data.final.Wn === 'Chưa có' ? 'Đang chờ...' : data.final.Wn;
            data.runnerUp = data.final.rU === 'Chưa có' ? 'Đang chờ...' : data.final.rU;
            
            // Đồng Hạng 3 là 2 đội thua Bán kết
            data.thirdPlace1 = getLoser(data.semifinals[0]) === 'Chưa có' ? 'Đang chờ...' : getLoser(data.semifinals[0]);
            data.thirdPlace2 = getLoser(data.semifinals[1]) === 'Chưa có' ? 'Đang chờ...' : getLoser(data.semifinals[1]);
            
            // Update the top level table data with calculated group standings
            data.tableA = rankings.A;
            data.tableB = rankings.B;
            data.tableC = rankings.C;
            data.tableD = rankings.D;
        }

        // --- Rendering Functions ---

        function renderTeams(teams) {
            const listHtml = teams.map(team => `
                <div class="bg-gray-800 p-4 rounded-lg shadow-xl mb-4">
                    <h3 class="text-xl font-bold text-yellow-400 mb-2 flex justify-between items-center">${team.T} <span class="text-sm font-normal text-gray-400">Bảng ${team.g}</span></h3>
                    <div class="grid grid-cols-1 gap-2 text-sm text-gray-300">
                        ${team.P.map(p => `
                            <div class="p-2 border border-gray-700 rounded-md">
                                <p class="font-semibold text-white">${p.name}</p>
                                <p>Cấp độ: <span class="text-green-400">${p.pL}</span> | NS: ${p.bY}</p>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `).join('');
            document.getElementById('teamList').innerHTML = listHtml;
        }

        function renderStandings(groupName, standings) {
            const tableId = `table${groupName}`;
            const tableHtml = `
                <div class="bg-gray-800 p-4 rounded-lg shadow-xl h-full">
                    <h3 class="text-xl font-bold text-yellow-400 mb-3">Bảng Xếp Hạng Bảng ${groupName}</h3>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-700">
                            <thead class="bg-gray-700">
                                <tr>
                                    <th class="px-2 py-2 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Hạng</th>
                                    <th class="px-2 py-2 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Đội</th>
                                    <th class="px-2 py-2 text-center text-xs font-medium text-gray-400 uppercase tracking-wider">T</th>
                                    <th class="px-2 py-2 text-center text-xs font-medium text-gray-400 uppercase tracking-wider">B</th>
                                    <th class="px-2 py-2 text-center text-xs font-medium text-gray-400 uppercase tracking-wider">Điểm</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-800">
                                ${standings.map((team, index) => `
                                    <tr class="${index < 2 ? 'bg-green-900/30' : 'bg-gray-900'}">
                                        <td class="px-2 py-2 whitespace-nowrap font-medium ${index === 0 ? 'text-yellow-400' : (index === 1 ? 'text-green-400' : 'text-gray-300')}">${index + 1}</td>
                                        <td class="px-2 py-2 whitespace-nowrap text-sm text-gray-200">${team.D}</td>
                                        <td class="px-2 py-2 whitespace-nowrap text-sm text-center text-green-500">${team.W}</td>
                                        <td class="px-2 py-2 whitespace-nowrap text-sm text-center text-red-500">${team.L}</td>
                                        <td class="px-2 py-2 whitespace-nowrap text-sm text-center font-bold text-cyan-400">${team.Pts}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                    <p class="mt-2 text-xs text-gray-500">2 đội đứng đầu vào Tứ kết.</p>
                </div>
            `;
            document.getElementById(tableId).innerHTML = tableHtml;
        }

        function renderMatches(id, matches, title, editable = true) {
            const listHtml = matches.map((match, index) => {
                const winnerName = match.Wn || 'Chưa có';
                const winnerClass = winnerName === match.A ? 'text-yellow-400' : (winnerName === match.B ? 'text-yellow-400' : 'text-gray-200');
                const winnerBg = winnerName === match.A ? 'bg-blue-900/40' : (winnerName === match.B ? 'bg-red-900/40' : 'bg-gray-800');

                return `
                    <div class="match-card p-3 mb-2 rounded-lg ${winnerBg} shadow-md border-b border-gray-700">
                        <p class="text-xs text-gray-400 mb-1 flex justify-between">
                            <span>${title.includes('Bảng') ? `Trận ${index + 1}` : `${title} ${index + 1}`}</span>
                            <span>${match.t} | Sân ${match.c}</span>
                        </p>
                        <div class="flex items-center justify-between text-white font-semibold">
                            <!-- Team A -->
                            <div class="flex-1 text-left ${winnerName === match.A ? winnerClass : 'text-gray-300'} text-sm sm:text-base">
                                ${match.A}
                            </div>
                            
                            <!-- Score Input A -->
                            <input type="number" min="0" value="${match.sA}" data-match-round="${id}" data-match-index="${index}" data-team="A"
                                class="score-input w-10 h-7 md:w-12 md:h-8 text-center rounded-md bg-gray-700 text-white mx-1 md:mx-2 focus:ring-2 focus:ring-cyan-500 transition duration-150 text-sm" ${editable ? '' : 'disabled'}>

                            <span class="text-sm md:text-lg text-gray-400 mx-1">-</span>

                            <!-- Score Input B -->
                            <input type="number" min="0" value="${match.sB}" data-match-round="${id}" data-match-index="${index}" data-team="B"
                                class="score-input w-10 h-7 md:w-12 md:h-8 text-center rounded-md bg-gray-700 text-white mx-1 md:mx-2 focus:ring-2 focus:ring-cyan-500 transition duration-150 text-sm" ${editable ? '' : 'disabled'}>
                            
                            <!-- Team B -->
                            <div class="flex-1 text-right ${winnerName === match.B ? winnerClass : 'text-gray-300'} text-sm sm:text-base">
                                ${match.B}
                            </div>
                        </div>
                        <p class="text-center text-sm mt-1 ${winnerClass === 'text-yellow-400' ? 'text-green-400' : 'text-gray-500'}">
                            Thắng: <span class="font-bold">${winnerName}</span>
                        </p>
                    </div>
                `;
            }).join('');

            // Special handling for Knockout section titles
            let sectionTitle = title;
            if (id === 'quarterfinals') {
                sectionTitle = 'Tứ Kết (Quarterfinals)';
            } else if (id === 'semifinals') {
                sectionTitle = 'Bán Kết (Seminals)';
            } else if (id === 'finalSection') {
                sectionTitle = 'Chung Kết (Final)';
            } else if (id.startsWith('matches')) {
                const groupName = id.replace('matches', '');
                sectionTitle = `Nhập Tỉ Số Bảng ${groupName} (Group ${groupName} Score Entry)`;
            }

            document.getElementById(id).innerHTML = `
                <h2 class="text-2xl font-extrabold text-cyan-400 mb-4 border-b border-gray-700 pb-2">${sectionTitle}</h2>
                ${listHtml}
            `;
        }

        function renderFinalResults(data) {
            document.getElementById('finalResults').innerHTML = `
                <h2 class="text-3xl font-extrabold text-yellow-400 mb-4">Kết Quả Chung Cuộc (Final Standings)</h2>
                <div class="space-y-4">
                    <div class="p-4 bg-yellow-900/40 rounded-lg shadow-xl border-t-4 border-yellow-400">
                        <p class="text-sm text-yellow-300">Vô Địch (Champion - 1st Place)</p>
                        <p class="text-3xl font-black text-white">${data.champion || 'Đang chờ...'}</p>
                    </div>
                    <div class="p-4 bg-gray-700/40 rounded-lg shadow-xl border-t-4 border-gray-400">
                        <p class="text-sm text-gray-300">Á Quân (Runner-Up - 2nd Place)</p>
                        <p class="text-2xl font-black text-white">${data.runnerUp || 'Đang chờ...'}</p>
                    </div>
                    <div class="p-4 bg-green-700/40 rounded-lg shadow-xl border-t-4 border-green-400">
                        <p class="text-sm text-green-300">Đồng Hạng 3 (Joint 3rd Place)</p>
                        <p class="text-xl font-black text-white">${data.thirdPlace1 || 'Đang chờ...'} & ${data.thirdPlace2 || 'Đang chờ...'}</p>
                    </div>
                </div>
            `;
        }

        function renderUI() {
            if (!tournamentData) return;

            // 1. Render Team List
            renderTeams(tournamentData.tL);

            // 2. Render Group Standings (Placement is in tab containers now)
            renderStandings('A', tournamentData.tableA);
            renderStandings('B', tournamentData.tableB);
            renderStandings('C', tournamentData.tableC);
            renderStandings('D', tournamentData.tableD);

            // 3. Render Matches (Group Stages)
            renderMatches('matchesA', tournamentData.matchesA, 'Vòng Bảng - Bảng A', true);
            renderMatches('matchesB', tournamentData.matchesB, 'Vòng Bảng - Bảng B', true);
            renderMatches('matchesC', tournamentData.matchesC, 'Vòng Bảng - Bảng C', true);
            renderMatches('matchesD', tournamentData.matchesD, 'Vòng Bảng - Bảng D', true);

            // 4. Render Knockout Stages
            renderMatches('quarterfinals', tournamentData.quarterfinals, 'Tứ Kết', true);
            renderMatches('semifinals', tournamentData.semifinals, 'Bán Kết', true);
            renderMatches('finalSection', [tournamentData.final], 'Chung Kết', true);

            // 5. Render Final Results
            renderFinalResults(tournamentData);
            
            // 6. Add event listeners for score changes
            document.querySelectorAll('.score-input').forEach(input => {
                input.removeEventListener('change', handleScoreChange); // Remove old listener
                input.addEventListener('change', handleScoreChange);   // Add new listener
            });

            // 7. Initialize to the first tab
            if (!document.querySelector('.tab-button.active')) {
                 switchTab('General');
            }
        }

        function handleScoreChange(event) {
            const input = event.target;
            let score = parseInt(input.value);
            if (isNaN(score) || score < 0) {
                score = 0;
                input.value = 0;
            }

            const roundKey = input.getAttribute('data-match-round');
            const matchIndex = parseInt(input.getAttribute('data-match-index'));
            const team = input.getAttribute('data-team');
            
            // Determine the target structure
            let targetMatch;
            if (roundKey === 'finalSection') {
                targetMatch = tournamentData.final;
            } else {
                targetMatch = tournamentData[roundKey][matchIndex];
            }
            
            // Update data structure
            const scoreKey = team === 'A' ? 'sA' : 'sB';
            targetMatch[scoreKey] = String(score);

            // Rerun all calculations and redraw UI
            recalculateTournamentState();
            renderUI();
        }

        // Main State Recalculation Function
        function recalculateTournamentState() {
            if (!tournamentData) return;
            // The core function updates standings (tableA-D) and knockout progression
            updateKnockoutProgression(tournamentData);
        }

        async function initializeApp() {
            const loadingMessage = document.getElementById('loadingMessage');
            
            // 1. Firebase Initialization (Mandatory for environment)
            try {
                // Sử dụng hàm đã được đổi tên (aliasing)
                app = initApp(firebaseConfig);
                auth = getAuthService(app);
                db = getDbService(app);
                setLogLevel('debug');

                await setPersistence(auth, browserSessionPersistence);
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Firebase initialization (non-fatal) failed:", error);
            }

            // 2. Data Loading
            loadingMessage.textContent = "Đang tải dữ liệu giải đấu Pickleball...";

            try {
                const url = 'https://raw.githubusercontent.com/cqtin2024/ITVTG/main/data/state3.json';
                const response = await fetchWithRetry(url);
                tournamentData = await response.json();
                
                // Initial Calculation and Render
                recalculateTournamentState();
                renderUI();

                loadingMessage.textContent = "Đã tải thành công! Sẵn sàng cập nhật tỉ số.";
                loadingMessage.classList.remove('bg-blue-900/50');
                loadingMessage.classList.add('bg-green-900/50');
                setTimeout(() => loadingMessage.classList.add('hidden'), 2000);

            } catch (error) {
                console.error("Error loading tournament data:", error);
                loadingMessage.textContent = "Lỗi khi tải dữ liệu. Vui lòng kiểm tra console log.";
                loadingMessage.classList.add('text-red-500');
                loadingMessage.classList.remove('bg-blue-900/50');
                loadingMessage.classList.add('bg-red-900/50');
            }
        }

        // Ensure the application starts when the window is fully loaded
        window.onload = initializeApp;
    </script>
</body>
</html>
