<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>B·∫£ng ƒêi·ªÅu Khi·ªÉn Qu·∫£n L√Ω Gi·∫£i ƒê·∫•u Pickleball</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background-color: #f4f7f6; color: #333; }
        h1, h2 { color: #007bff; border-bottom: 2px solid #007bff; padding-bottom: 5px; }
        .container { display: flex; gap: 20px; }
        .matches-section, .tables-section, .knockout-section { flex: 1; background-color: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); }
        .tables-section { flex: 1.2; }
        .group-table, .group-matches { margin-bottom: 30px; border: 1px solid #ccc; border-radius: 6px; overflow: hidden; }
        .group-matches h3, .group-table h3 { background-color: #007bff; color: white; padding: 10px; margin: 0; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 10px; text-align: left; border-bottom: 1px solid #ddd; }
        th { background-color: #e9ecef; }
        .score-input { width: 40px; text-align: center; border: 1px solid #ccc; border-radius: 3px; }
        .highlight-winner { background-color: #c3e6cb; font-weight: bold; }
        .highlight-runnerup { background-color: #ffeeba; }
        .match-status { padding: 3px 8px; border-radius: 12px; font-size: 0.8em; font-weight: bold; }
        .status-SCHEDULED { background-color: #e2e6ea; color: #495057; }
        .status-RUNNING { background-color: #fff3cd; color: #856404; animation: blinker 1s linear infinite; }
        .status-FINISHED { background-color: #d4edda; color: #155724; }
        @keyframes blinker { 50% { opacity: 0.5; } }
        /* Modal Styles */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4); }
        .modal-content { background-color: #fefefe; margin: 15% auto; padding: 20px; border: 1px solid #888; width: 80%; max-width: 500px; border-radius: 8px; position: relative; }
        .close-btn { color: #aaa; float: right; font-size: 28px; font-weight: bold; }
        .close-btn:hover, .close-btn:focus { color: #000; text-decoration: none; cursor: pointer; }
        .modal-body label { display: block; margin-top: 10px; font-weight: bold; }
        .modal-body input { width: 100%; padding: 8px; margin-top: 5px; box-sizing: border-box; }
        .score-input-modal { width: 45%; display: inline-block; }
        .modal-footer { margin-top: 20px; text-align: right; }
        .modal-footer button { padding: 10px 15px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; }
        .btn-update { background-color: #007bff; color: white; }
        .btn-start { background-color: #28a745; color: white; }
        .btn-end { background-color: #dc3545; color: white; }
        .alert { padding: 10px; background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; border-radius: 5px; margin-bottom: 10px; display: none; }
    </style>
</head>
<body>

    <h1>üèÜ B·∫£ng ƒêi·ªÅu Khi·ªÉn Qu·∫£n L√Ω Gi·∫£i ƒê·∫•u Pickleball (Ch·∫°m 11)</h1>
    <p>S·ª≠ d·ª•ng n√∫t **"Qu·∫£n l√Ω"** ƒë·ªÉ c·∫≠p nh·∫≠t chi ti·∫øt t·ªâ s·ªë, th·ªùi gian v√† s√¢n ƒë·∫•u. ƒêi·ªÉm (Pts) ƒë∆∞·ª£c t√≠nh b·∫±ng S·ªë tr·∫≠n th·∫Øng (W).</p>

    <div class="container">
        <div class="matches-section">
            <h2>Tr·∫≠n ƒê·∫•u V√≤ng B·∫£ng</h2>
            <div id="matches-container">
                </div>
        </div>

        <div class="tables-section">
            <h2>B·∫£ng X·∫øp H·∫°ng</h2>
            <div id="tables-container">
                </div>
        </div>
    </div>

    <div class="knockout-section">
        <h2>‚úÖ C√°c ƒê·ªôi V√†o T·ª© K·∫øt (Nh·∫•t & Nh√¨ B·∫£ng)</h2>
        <ul id="knockout-teams" class="knockout-list">
            </ul>
    </div>

    <div id="matchModal" class="modal">
      <div class="modal-content">
        <span class="close-btn">&times;</span>
        <h2>Qu·∫£n l√Ω Tr·∫≠n ƒê·∫•u: <span id="modalMatchName"></span></h2>
        
        <div id="modalAlert" class="alert"></div>

        <div class="modal-body">
            <input type="hidden" id="modalGroup">
            <input type="hidden" id="modalIndex">

            <label for="modalTime">Th·ªùi gian (HH:MM):</label>
            <input type="text" id="modalTime" pattern="\d{2}:\d{2}">

            <label for="modalCourt">S√¢n ƒë·∫•u (V√≠ d·ª•: S1):</label>
            <input type="text" id="modalCourt">

            <label for="modalScoreA">T·ªâ s·ªë <span id="modalTeamA"></span> (sA):</label>
            <input type="number" min="0" id="modalScoreA" class="score-input-modal">

            <label for="modalScoreB">T·ªâ s·ªë <span id="modalTeamB"></span> (sB):</label>
            <input type="number" min="0" id="modalScoreB" class="score-input-modal">
            
            <p><strong>Th·ªùi gian th·ª±c t·∫ø:</strong> <span id="modalStartTime">--</span> - <span id="modalEndTime">--</span></p>
        </div>

        <div class="modal-footer">
            <button id="btnStartMatch" class="btn-start">B·∫Øt ƒë·∫ßu</button>
            <button id="btnEndMatch" class="btn-end" style="display:none;">K·∫øt th√∫c & L∆∞u</button>
            <button id="btnUpdateSchedule" class="btn-update">C·∫≠p nh·∫≠t L·ªãch</button>
        </div>
      </div>
    </div>
    
    <script>
        // D·ªØ li·ªáu JSON kh·ªüi t·∫°o (ƒê√£ c·∫≠p nh·∫≠t m√£ m√¥n ch∆°i)
        const originalData = {
            "key_legend": { 
                "tL": "Team List (Danh s√°ch ƒë·ªôi)",
                "g": "Group (B·∫£ng ƒë·∫•u)",
                "T": "Team Name (T√™n ƒë·ªôi)",
                "s": "Seed (H·∫°t gi·ªëng)",
                "aPL": "Average Pick Level (C·∫•p ƒë·ªô ch·ªçn trung b√¨nh)",
                "P": "Players (Ng∆∞·ªùi ch∆°i)",
                "pL": "Pick Level (C·∫•p ƒë·ªô ch·ªçn c√° nh√¢n)",
                "bY": "Birth Year (NƒÉm sinh)",
                "ph": "Phone (S·ªë ƒëi·ªán tho·∫°i)",
                "em": "Email (Th∆∞ ƒëi·ªán t·ª≠)",
                "gC": "Game Code (M√£ m√¥n ch∆°i: PB_DB - Pickleball ƒê√¥i)", // C·∫≠p nh·∫≠t
                "fC": "Format Code (M√£ th·ªÉ th·ª©c: RR_KO - V√≤ng tr√≤n + Lo·∫°i tr·ª±c ti·∫øp)",
                "D": "Team Name (T√™n ƒë·ªôi - trong b·∫£ng x·∫øp h·∫°ng)",
                "W": "Wins (S·ªë tr·∫≠n th·∫Øng)",
                "L": "Losses (S·ªë tr·∫≠n thua)",
                "HS": "High Score (ƒêi·ªÉm cao nh·∫•t)",
                "Pts": "Points (ƒêi·ªÉm s·ªë t√≠ch l≈©y)",
                "mP": "Matches Played (S·ªë tr·∫≠n ƒë√£ ƒë·∫•u)",
                "t": "Time (Th·ªùi gian)",
                "c": "Court (S√¢n ƒë·∫•u)",
                "A": "Team A (ƒê·ªôi A)",
                "sA": "Score A (T·ªâ s·ªë ƒê·ªôi A)",
                "B": "Team B (ƒê·ªôi B)",
                "sB": "Score B (T·ªâ s·ªë ƒê·ªôi B)",
                "Wn": "Winner (ƒê·ªôi th·∫Øng)",
                "tStart": "Time Start (Gi·ªù b·∫Øt ƒë·∫ßu th·ª±c t·∫ø)",
                "tEnd": "Time End (Gi·ªù k·∫øt th√∫c th·ª±c t·∫ø)",
                "status": "Match Status (Tr·∫°ng th√°i tr·∫≠n ƒë·∫•u)"
             },
            "tableA": [ { "D": "Team 9", "W": 3, "L": 0, "HS": "11", "Pts": 9, "mP": 3 }, { "D": "Team 3", "W": 2, "L": 1, "HS": "11", "Pts": 6, "mP": 3 }, { "D": "Team 11", "W": 1, "L": 2, "HS": "11", "Pts": 3, "mP": 3 }, { "D": "Team 5", "W": 0, "L": 3, "HS": "0", "Pts": 0, "mP": 3 } ],
            "tableB": [ { "D": "Team 4", "W": 3, "L": 0, "HS": "11", "Pts": 9, "mP": 3 }, { "D": "Team 7", "W": 2, "L": 1, "HS": "11", "Pts": 6, "mP": 3 }, { "D": "Team 12", "W": 1, "L": 2, "HS": "11", "Pts": 3, "mP": 3 }, { "D": "Team 1", "W": 0, "L": 3, "HS": "0", "Pts": 0, "mP": 3 } ],
            "tableC": [ { "D": "Team 16", "W": 3, "L": 0, "HS": "11", "Pts": 9, "mP": 3 }, { "D": "Team 10", "W": 2, "L": 1, "HS": "11", "Pts": 6, "mP": 3 }, { "D": "Team 14", "W": 1, "L": 2, "HS": "11", "Pts": 3, "mP": 3 }, { "D": "Team 6", "W": 0, "L": 3, "HS": "0", "Pts": 0, "mP": 3 } ],
            "tableD": [ { "D": "Team 13", "W": 3, "L": 0, "HS": "11", "Pts": 9, "mP": 3 }, { "D": "Team 8", "W": 2, "L": 1, "HS": "11", "Pts": 6, "mP": 3 }, { "D": "Team 15", "W": 1, "L": 2, "HS": "11", "Pts": 3, "mP": 3 }, { "D": "Team 2", "W": 0, "L": 3, "HS": "0", "Pts": 0, "mP": 3 } ],
            "matchesA": [ { "t": "14:00", "c": "S1", "A": "Team 9", "sA": "11", "sB": "0", "Wn": "Team 9" }, { "t": "14:15", "c": "S1", "A": "Team 11", "sA": "11", "sB": "0", "Wn": "Team 11" }, { "t": "14:30", "c": "S1", "A": "Team 9", "sA": "11", "sB": "0", "Wn": "Team 9" }, { "t": "14:45", "c": "S1", "A": "Team 3", "sA": "11", "sB": "0", "Wn": "Team 3" }, { "t": "15:00", "c": "S1", "A": "Team 9", "sA": "11", "sB": "0", "Wn": "Team 9" }, { "t": "15:15", "c": "S1", "A": "Team 3", "sA": "11", "sB": "0", "Wn": "Team 3" } ],
            "matchesB": [ { "t": "14:00", "c": "S2", "A": "Team 4", "sA": "11", "sB": "0", "Wn": "Team 4" }, { "t": "14:15", "c": "S2", "A": "Team 12", "sA": "11", "sB": "0", "Wn": "Team 12" }, { "t": "14:30", "c": "S2", "A": "Team 4", "sA": "11", "sB": "0", "Wn": "Team 4" }, { "t": "14:45", "c": "S2", "A": "Team 7", "sA": "11", "sB": "0", "Wn": "Team 7" }, { "t": "15:00", "c": "S2", "A": "Team 4", "sA": "11", "sB": "0", "Wn": "Team 4" }, { "t": "15:15", "c": "S2", "A": "Team 7", "sA": "11", "sB": "0", "Wn": "Team 7" } ],
            "matchesC": [ { "t": "14:00", "c": "S3", "A": "Team 16", "sA": "11", "sB": "0", "Wn": "Team 16" }, { "t": "14:15", "c": "S3", "A": "Team 14", "sA": "11", "sB": "0", "Wn": "Team 14" }, { "t": "14:30", "c": "S3", "A": "Team 16", "sA": "11", "sB": "0", "Wn": "Team 16" }, { "t": "14:45", "c": "S3", "A": "Team 10", "sA": "11", "sB": "0", "Wn": "Team 10" }, { "t": "15:00", "c": "S3", "A": "Team 16", "sA": "11", "sB": "0", "Wn": "Team 16" }, { "t": "15:15", "c": "S3", "A": "Team 10", "sA": "11", "sB": "0", "Wn": "Team 10" } ],
            "matchesD": [ { "t": "14:00", "c": "S4", "A": "Team 13", "sA": "11", "sB": "0", "Wn": "Team 13" }, { "t": "14:15", "c": "S4", "A": "Team 15", "sA": "11", "sB": "0", "Wn": "Team 15" }, { "t": "14:30", "c": "S4", "A": "Team 13", "sA": "11", "sB": "0", "Wn": "Team 13" }, { "t": "14:45", "c": "S4", "A": "Team 8", "sA": "11", "sB": "0", "Wn": "Team 8" }, { "t": "15:00", "c": "S4", "A": "Team 13", "sA": "11", "sB": "0", "Wn": "Team 13" }, { "t": "15:15", "c": "S4", "A": "Team 8", "sA": "11", "sB": "0", "Wn": "Team 8" } ],
            "tL": [
                { "g": "A", "T": "Team 9", "aPL": 3.5, "s": 1, "P": [ { "name": "T·ª´ Duy H∆∞ng", "bY": "1995", "ph": "09xx-xxx-001", "em": "duyhung@example.com", "pL": 4, "gC": "PB_DB", "fC": "RR_KO" }, { "name": "Tr·∫ßn Nguy·ªÖn Minh T√∫", "bY": "1998", "ph": "09xx-xxx-002", "em": "minhtu@example.com", "pL": 3, "gC": "PB_DB", "fC": "RR_KO" } ] },
                { "g": "A", "T": "Team 3", "aPL": 3.5, "s": 2, "P": [ { "name": "V√µ D∆∞∆°ng Qu·ªëc Th·ªãnh", "bY": "1996", "ph": "09xx-xxx-003", "em": "quocthinh@example.com", "pL": 3, "gC": "PB_DB", "fC": "RR_KO" }, { "name": "L√™ Minh Ph∆∞∆°ng", "bY": "1997", "ph": "09xx-xxx-004", "em": "minhphuong@example.com", "pL": 4, "gC": "PB_DB", "fC": "RR_KO" } ] },
                { "g": "A", "T": "Team 11", "aPL": 2.0, "s": 3, "P": [ { "name": "Minh Chang", "bY": "2000", "ph": "09xx-xxx-005", "em": "minhchang@example.com", "pL": 2, "gC": "PB_DB", "fC": "RR_KO" }, { "name": "L√™ Minh Ch√¢u", "bY": "2001", "ph": "09xx-xxx-006", "em": "minhchau@example.com", "pL": 2, "gC": "PB_DB", "fC": "RR_KO" } ] },
                { "g": "A", "T": "Team 5", "aPL": 4.5, "s": 4, "P": [ { "name": "Mai Qu·ªëc Kh√°nh", "bY": "1993", "ph": "09xx-xxx-007", "em": "quockhanh@example.com", "pL": 5, "gC": "PB_DB", "fC": "RR_KO" }, { "name": "Nguy·ªÖn B√° Linh V≈©", "bY": "1994", "ph": "09xx-xxx-008", "em": "linhvua@example.com", "pL": 4, "gC": "PB_DB", "fC": "RR_KO" } ] },
                { "g": "B", "T": "Team 4", "aPL": 3.0, "s": 1, "P": [ { "name": "Tr·∫ßn Qu√≠ Tu·∫•n", "bY": "1992", "ph": "09xx-xxx-009", "em": "quytuan@example.com", "pL": 3, "gC": "PB_DB", "fC": "RR_KO" }, { "name": "Ho√†ng M·∫°nh H√πng", "bY": "1993", "ph": "09xx-xxx-010", "em": "manhhung@example.com", "pL": 3, "gC": "PB_DB", "fC": "RR_KO" } ] },
                { "g": "B", "T": "Team 7", "aPL": 4.5, "s": 2, "P": [ { "name": "Nguy·ªÖn Qu·ªëc H√πng", "bY": "1999", "ph": "09xx-xxx-011", "em": "quochung@example.com", "pL": 4, "gC": "PB_DB", "fC": "RR_KO" }, { "name": "Ph·∫°m ƒê·ª©c Duy", "bY": "2000", "ph": "09xx-xxx-012", "em": "ducduy@example.com", "pL": 5, "gC": "PB_DB", "fC": "RR_KO" } ] },
                { "g": "B", "T": "Team 12", "aPL": 2.5, "s": 3, "P": [ { "name": "ƒêinh Ho√†ng Thanh S∆°n", "bY": "1995", "ph": "09xx-xxx-013", "em": "thanhson@example.com", "pL": 2, "gC": "PB_DB", "fC": "RR_KO" }, { "name": "Tr·∫ßn ƒê·ªó Khoa Ti·∫øn", "bY": "1997", "ph": "09xx-xxx-014", "em": "khoatien@example.com", "pL": 3, "gC": "PB_DB", "fC": "RR_KO" } ] },
                { "g": "B", "T": "Team 1", "aPL": 5.0, "s": 4, "P": [ { "name": "B√πi Quang Ti·∫øn", "bY": "1990", "ph": "09xx-xxx-015", "em": "quangtien@example.com", "pL": 5, "gC": "PB_DB", "fC": "RR_KO" }, { "name": "Mai T·∫•t Th√†nh", "bY": "1991", "ph": "09xx-xxx-016", "em": "tatthanh@example.com", "pL": 5, "gC": "PB_DB", "fC": "RR_KO" } ] },
                { "g": "C", "T": "Team 16", "aPL": 2.5, "s": 1, "P": [ { "name": "Nguy·ªÖn Ho√†ng Thanh", "bY": "1996", "ph": "09xx-xxx-017", "em": "hoangthanh@example.com", "pL": 3, "gC": "PB_DB", "fC": "RR_KO" }, { "name": "Tr·∫ßn C√¥ng Ph∆∞∆°ng", "bY": "1997", "ph": "09xx-xxx-018", "em": "congphuong@example.com", "pL": 2, "gC": "PB_DB", "fC": "RR_KO" } ] },
                { "g": "C", "T": "Team 10", "aPL": 3.5, "s": 2, "P": [ { "name": "L√™ Duy", "bY": "1994", "ph": "09xx-xxx-019", "em": "leduy@example.com", "pL": 4, "gC": "PB_DB", "fC": "RR_KO" }, { "name": "H·ªì Thanh V∆∞∆°ng", "bY": "1995", "ph": "09xx-xxx-020", "em": "thanhvuong@example.com", "pL": 3, "gC": "PB_DB", "fC": "RR_KO" } ] },
                { "g": "C", "T": "Team 14", "aPL": 1.5, "s": 3, "P": [ { "name": "Nguy·ªÖn VƒÉn C∆∞·ªùng", "bY": "1998", "ph": "09xx-xxx-021", "em": "vancuong@example.com", "pL": 1, "gC": "PB_DB", "fC": "RR_KO" }, { "name": "ƒêo√†n VƒÉn D≈©ng", "bY": "1999", "ph": "09xx-xxx-022", "em": "vandunga@example.com", "pL": 2, "gC": "PB_DB", "fC": "RR_KO" } ] },
                { "g": "C", "T": "Team 6", "aPL": 3.5, "s": 4, "P": [ { "name": "Tr·∫ßn Ng·ªçc ƒê√¥ng Chu", "bY": "2000", "ph": "09xx-xxx-023", "em": "dongchu@example.com", "pL": 4, "gC": "PB_DB", "fC": "RR_KO" }, { "name": "Nguy·ªÖn Ng·ªçc H√πng", "bY": "2001", "ph": "09xx-xxx-024", "em": "ngochung@example.com", "pL": 3, "gC": "PB_DB", "fC": "RR_KO" } ] },
                { "g": "D", "T": "Team 13", "aPL": 4.5, "s": 1, "P": [ { "name": "L√™ B√° Ch√¢u", "bY": "1993", "ph": "09xx-xxx-025", "em": "bachau@example.com", "pL": 5, "gC": "PB_DB", "fC": "RR_KO" }, { "name": "Ng√¥ Hi·ªÅn Phong", "bY": "1994", "ph": "09xx-xxx-026", "em": "hienphong@example.com", "pL": 4, "gC": "PB_DB", "fC": "RR_KO" } ] },
                { "g": "D", "T": "Team 2", "aPL": 3.0, "s": 2, "P": [ { "name": "Tr·∫ßn Vi·∫øt Tu·∫•n", "bY": "1990", "ph": "09xx-xxx-027", "em": "viettuan@example.com", "pL": 3, "gC": "PB_DB", "fC": "RR_KO" }, { "name": "Hu·ª≥nh L√™ Quang D≈©ng", "bY": "1991", "ph": "09xx-xxx-028", "em": "quangdunga@example.com", "pL": 3, "gC": "PB_DB", "fC": "RR_KO" } ] },
                { "g": "D", "T": "Team 15", "aPL": 2.0, "s": 3, "P": [ { "name": "Hu·ª≥nh Minh Thi·ªán", "bY": "1995", "ph": "09xx-xxx-029", "em": "minhthien@example.com", "pL": 2, "gC": "PB_DB", "fC": "RR_KO" }, { "name": "Nguy·ªÖn Duy Minh", "bY": "1996", "ph": "09xx-xxx-030", "em": "duyminh@example.com", "pL": 2, "gC": "PB_DB", "fC": "RR_KO" } ] },
                { "g": "D", "T": "Team 8", "aPL": 4.5, "s": 4, "P": [ { "name": "L·∫°i Ti·∫øn M·∫°nh", "bY": "1998", "ph": "09xx-xxx-031", "em": "tienmanh@example.com", "pL": 4, "gC": "PB_DB", "fC": "RR_KO" }, { "name": "Cao Quang T√≠n", "bY": "1999", "ph": "09xx-xxx-032", "em": "quangtin@example.com", "pL": 5, "gC": "PB_DB", "fC": "RR_KO" } ] }
            ]
        };

        const groups = ['A', 'B', 'C', 'D'];
        const data = JSON.parse(JSON.stringify(originalData)); 

        // Kh·ªüi t·∫°o c√°c tr∆∞·ªùng m·ªõi cho m·ªói tr·∫≠n ƒë·∫•u
        groups.forEach(group => {
            data['matches' + group].forEach(match => {
                match.tStart = match.tStart || '';
                match.tEnd = match.tEnd || '';
                match.status = (match.sA !== '0' || match.sB !== '0') ? 'FINISHED' : 'SCHEDULED';
            });
        });

        // --- CORE FUNCTIONS ---
        
        // 1. Logic T√≠nh To√°n B·∫£ng X·∫øp H·∫°ng 
        function calculateGroupTables() {
            const tableData = {};
            
            data.tL.forEach(team => {
                const group = team.g;
                if (!tableData[group]) tableData[group] = {};
                tableData[group][team.T] = { W: 0, L: 0, Pts: 0, mP: 0, D: team.T, HS: 0, GS: 0, GC: 0 }; 
            });

            groups.forEach(group => {
                data['matches' + group].forEach(match => {
                    const scoreA = parseInt(match.sA);
                    const scoreB = parseInt(match.sB);
                    
                    if (match.status === 'FINISHED') {
                        tableData[group][match.A].mP += 1;
                        tableData[group][match.B].mP += 1;
                        tableData[group][match.A].GS += scoreA;
                        tableData[group][match.B].GS += scoreB;
                        tableData[group][match.A].GC += scoreB;
                        tableData[group][match.B].GC += scoreA;

                        if (scoreA > scoreB) {
                            tableData[group][match.A].W += 1;
                            tableData[group][match.B].L += 1;
                        } else if (scoreB > scoreA) {
                            tableData[group][match.B].W += 1;
                            tableData[group][match.A].L += 1;
                        } 
                    }
                });
            });

            groups.forEach(group => {
                const sortedTable = Object.values(tableData[group]).map(team => ({
                    ...team,
                    Pts: team.W 
                })).sort((a, b) => {
                    if (b.Pts !== a.Pts) return b.Pts - a.Pts;
                    const diffA = a.GS - a.GC;
                    const diffB = b.GS - b.GC;
                    if (diffB !== diffA) return diffB - diffA;
                    return b.GS - a.GS;
                });
                data['table' + group] = sortedTable.map(item => ({ ...item, HS: item.HS.toString() })); 
            });

            renderTables();
            renderKnockoutTeams();
        }

        // 2. Ch·ª©c nƒÉng Ki·ªÉm tra Xung ƒë·ªôt 
        function checkConflicts(group, index, newTime, newCourt, checkType) {
            const currentMatch = data['matches' + group][index];
            let conflictMessage = '';

            groups.forEach(g => {
                data['matches' + g].forEach((match, i) => {
                    if (g === group && i === index) return; 

                    if (checkType === 'START_CHECK' && match.status === 'RUNNING' && match.c === newCourt) {
                        conflictMessage = `‚ùå S√¢n ${newCourt} ƒëang c√≥ tr·∫≠n ƒë·∫•u gi·ªØa ${match.A} v√† ${match.B} (B·∫Øt ƒë·∫ßu l√∫c: ${match.tStart}).`;
                    }
                    
                    if (checkType === 'SCHEDULE_UPDATE' && match.t === newTime && match.c === newCourt) {
                        conflictMessage = `‚ö†Ô∏è Tr√πng l·ªãch! Tr·∫≠n ƒë·∫•u gi·ªØa ${match.A} v√† ${match.B} ƒë√£ ƒë∆∞·ª£c l√™n l·ªãch l√∫c ${newTime} t·∫°i S√¢n ${newCourt}.`;
                    }
                });
            });

            return conflictMessage;
        }

        // 3. Ch·ª©c nƒÉng Hi·ªÉn th·ªã Modal Qu·∫£n l√Ω 
        function showMatchEditor(group, index) {
            const match = data['matches' + group][index];
            
            document.getElementById('modalGroup').value = group;
            document.getElementById('modalIndex').value = index;
            document.getElementById('modalMatchName').textContent = `${match.A} vs ${match.B}`;
            document.getElementById('modalTeamA').textContent = match.A;
            document.getElementById('modalTeamB').textContent = match.B;
            
            document.getElementById('modalTime').value = match.t;
            document.getElementById('modalCourt').value = match.c;
            document.getElementById('modalScoreA').value = match.sA;
            document.getElementById('modalScoreB').value = match.sB;
            
            document.getElementById('modalStartTime').textContent = match.tStart || '--';
            document.getElementById('modalEndTime').textContent = match.tEnd || '--';
            document.getElementById('modalAlert').style.display = 'none';

            const btnStart = document.getElementById('btnStartMatch');
            const btnEnd = document.getElementById('btnEndMatch');
            const btnUpdateSchedule = document.getElementById('btnUpdateSchedule');

            btnUpdateSchedule.onclick = () => updateSchedule(group, index);
            btnStart.onclick = () => handleMatchTime('START', group, index);
            btnEnd.onclick = () => handleMatchTime('END', group, index);

            if (match.status === 'SCHEDULED') {
                btnStart.style.display = 'inline-block';
                btnEnd.style.display = 'none';
                // Cho ph√©p s·ª≠a l·ªãch khi ƒëang SCHEDULED
                document.getElementById('modalTime').disabled = false;
                document.getElementById('modalCourt').disabled = false;
                btnUpdateSchedule.style.display = 'inline-block';
            } else if (match.status === 'RUNNING') {
                btnStart.style.display = 'none';
                btnEnd.style.display = 'inline-block';
                // Kh√≥a s·ª≠a l·ªãch khi ƒëang RUNNING
                document.getElementById('modalTime').disabled = true;
                document.getElementById('modalCourt').disabled = true;
                btnUpdateSchedule.style.display = 'none';
            } else if (match.status === 'FINISHED') {
                btnStart.style.display = 'none';
                btnEnd.style.display = 'none';
                // Cho ph√©p s·ª≠a l·ªãch khi ƒë√£ FINISHED n·∫øu c·∫ßn ƒëi·ªÅu ch·ªânh l·∫°i
                document.getElementById('modalTime').disabled = false;
                document.getElementById('modalCourt').disabled = false;
                btnUpdateSchedule.style.display = 'inline-block';
            }

            document.getElementById('matchModal').style.display = 'block';
        }

        // 4. Ch·ª©c nƒÉng C·∫≠p nh·∫≠t L·ªãch (ƒê√É FIX L·ªñI MODAL)
        function updateSchedule(group, index) {
            const newTime = document.getElementById('modalTime').value.trim();
            const newCourt = document.getElementById('modalCourt').value.trim();
            const modalAlert = document.getElementById('modalAlert');

            if (!newTime || !newCourt) {
                modalAlert.textContent = '‚ùå Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß Th·ªùi gian v√† S√¢n ƒë·∫•u.';
                modalAlert.style.display = 'block';
                modalAlert.style.backgroundColor = '#f8d7da';
                modalAlert.style.color = '#721c24';
                return;
            }

            const conflict = checkConflicts(group, index, newTime, newCourt, 'SCHEDULE_UPDATE');
            if (conflict) {
                modalAlert.textContent = conflict;
                modalAlert.style.display = 'block';
                modalAlert.style.backgroundColor = '#f8d7da';
                modalAlert.style.color = '#721c24';
                return;
            }

            data['matches' + group][index].t = newTime;
            data['matches' + group][index].c = newCourt;
            
            modalAlert.textContent = '‚úÖ C·∫≠p nh·∫≠t l·ªãch thi ƒë·∫•u th√†nh c√¥ng!';
            modalAlert.style.backgroundColor = '#d1e7dd';
            modalAlert.style.color = '#0f5132';
            modalAlert.style.display = 'block';
            
            renderMatches(); 

            // T·ª± ƒë·ªông ƒë√≥ng modal sau 1 gi√¢y
            setTimeout(() => {
                document.getElementById('matchModal').style.display = 'none';
            }, 1000); 
        }

        // 5. Ch·ª©c nƒÉng Qu·∫£n l√Ω B·∫Øt ƒë·∫ßu/K·∫øt th√∫c Tr·∫≠n ƒë·∫•u (ƒê√É C·∫¨P NH·∫¨T LOGIC ƒê√ìNG MODAL)
        function handleMatchTime(action, group, index) {
            const now = new Date();
            const timeString = `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;
            const match = data['matches' + group][index];
            const modalAlert = document.getElementById('modalAlert');
            modalAlert.style.backgroundColor = '#f8d7da';
            modalAlert.style.color = '#721c24';


            if (action === 'START') {
                const conflict = checkConflicts(group, index, null, match.c, 'START_CHECK');
                if (conflict) {
                    modalAlert.textContent = conflict;
                    modalAlert.style.display = 'block';
                    return;
                }

                match.tStart = timeString;
                match.status = 'RUNNING';
                modalAlert.textContent = `‚úÖ Tr·∫≠n ƒë·∫•u B·∫ÆT ƒê·∫¶U l√∫c ${timeString}!`;
                modalAlert.style.backgroundColor = '#d1e7dd';
                modalAlert.style.color = '#0f5132';
                modalAlert.style.display = 'block';
                
                renderMatches(); 

                // T·ª± ƒë·ªông ƒë√≥ng modal sau 2 gi√¢y
                setTimeout(() => {
                    document.getElementById('matchModal').style.display = 'none';
                }, 2000); 

            } else if (action === 'END') {
                const scoreA = parseInt(document.getElementById('modalScoreA').value);
                const scoreB = parseInt(document.getElementById('modalScoreB').value);
                const winnerScore = Math.max(scoreA, scoreB);
                const loserScore = Math.min(scoreA, scoreB);
                let isWarning = false;

                if (isNaN(scoreA) || isNaN(scoreB)) {
                     modalAlert.textContent = '‚ùå Vui l√≤ng nh·∫≠p t·ªâ s·ªë h·ª£p l·ªá (s·ªë).';
                    modalAlert.style.display = 'block';
                    return;
                }
                
                if (scoreA === scoreB) {
                    modalAlert.textContent = '‚ùå T·ªâ s·ªë ph·∫£i kh√°c nhau ƒë·ªÉ x√°c ƒë·ªãnh ƒë·ªôi th·∫Øng.';
                    modalAlert.style.display = 'block';
                    return;
                }

                if (winnerScore !== 11 && winnerScore - loserScore !== 2) {
                    // C·∫£nh b√°o n·∫øu kh√¥ng ph·∫£i l√† ch·∫°m 11, kh√¥ng c√°ch 2 (Pickleball lu·∫≠t c≈©)
                    modalAlert.textContent = `‚ö†Ô∏è **C·∫¢NH B√ÅO:** T·ªâ s·ªë ${scoreA}-${scoreB} c√≥ v·∫ª kh√¥ng tu√¢n th·ªß lu·∫≠t Pickleball (Ch·∫°m 11). T·ªâ s·ªë chi·∫øn th·∫Øng ph·∫£i ƒë·∫°t 11 ƒëi·ªÉm v√† h∆°n ƒë·ªëi th·ªß √≠t nh·∫•t 1 ƒëi·ªÉm (v√≠ d·ª•: 11-10).`;
                    modalAlert.style.display = 'block';
                    isWarning = true;
                }
                
                if (!isWarning || confirm(modalAlert.textContent + "\n\nB·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën l∆∞u t·ªâ s·ªë n√†y v√† k·∫øt th√∫c tr·∫≠n ƒë·∫•u kh√¥ng?")) {
                    match.tEnd = timeString;
                    match.sA = scoreA.toString();
                    match.sB = scoreB.toString();
                    match.Wn = (scoreA > scoreB) ? match.A : match.B;
                    match.status = 'FINISHED';

                    calculateGroupTables();
                    renderMatches();
                    downloadJSON(data); 
                    
                    document.getElementById('matchModal').style.display = 'none';
                    alert(`‚úÖ Tr·∫≠n ƒë·∫•u K·∫æT TH√öC l√∫c ${timeString}! ƒê√£ c·∫≠p nh·∫≠t k·∫øt qu·∫£ v√† t·∫£i file JSON m·ªõi.`);
                }
            }
        }
        
        // 6. Ch·ª©c nƒÉng T·∫£i v·ªÅ file JSON 
        function downloadJSON(data) {
            const dataStr = JSON.stringify(data, null, 2);
            const blob = new Blob([dataStr], { type: "application/json" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'tournament_data_updated_pickleball.json'; 
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // --- RENDER FUNCTIONS ---
        
        function renderMatches() {
            const container = document.getElementById('matches-container');
            container.innerHTML = '';

            groups.forEach(group => {
                const matchesHtml = `
                    <div class="group-matches">
                        <h3>B·∫£ng ${group}</h3>
                        <table>
                            <thead>
                                <tr>
                                    <th>Th·ªùi gian (K·∫ø ho·∫°ch)</th>
                                    <th>S√¢n</th>
                                    <th>ƒê·ªôi A</th>
                                    <th>T·ªâ s·ªë</th>
                                    <th>ƒê·ªôi B</th>
                                    <th>Tr·∫°ng th√°i</th>
                                    <th>Qu·∫£n l√Ω</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${data['matches' + group].map((match, matchIndex) => {
                                    return `
                                        <tr>
                                            <td>${match.t}</td>
                                            <td>${match.c}</td>
                                            <td>${match.A}</td>
                                            <td>${match.sA} - ${match.sB}</td>
                                            <td>${match.B}</td>
                                            <td><span class="match-status status-${match.status}">${match.status.replace('SCHEDULED', 'L√™n l·ªãch').replace('RUNNING', 'ƒêANG DI·ªÑN RA').replace('FINISHED', 'ƒê√£ k·∫øt th√∫c')}</span></td>
                                            <td><button onclick="showMatchEditor('${group}', ${matchIndex})">Qu·∫£n l√Ω</button></td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
                container.innerHTML += matchesHtml;
            });
        }
        
        function renderTables() {
            const container = document.getElementById('tables-container');
            container.innerHTML = '';
            
            groups.forEach(group => {
                const tableHtml = `
                    <div class="group-table">
                        <h3>B·∫£ng ${group}</h3>
                        <table>
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>ƒê·ªôi (D)</th>
                                    <th>Th·∫Øng (W)</th>
                                    <th>Thua (L)</th>
                                    <th>ƒê.T√≠ch l≈©y (Pts)</th>
                                    <th>Hi·ªáu s·ªë Game</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${data['table' + group].map((team, index) => {
                                    let rowClass = '';
                                    if (index === 0) rowClass = 'highlight-winner';
                                    else if (index === 1) rowClass = 'highlight-runnerup';
                                    const gamesDiff = (team.GS || 0) - (team.GC || 0);

                                    return `
                                        <tr class="${rowClass}">
                                            <td>${index + 1}</td>
                                            <td>${team.D}</td>
                                            <td>${team.W}</td>
                                            <td>${team.L}</td>
                                            <td>${team.Pts}</td>
                                            <td>${gamesDiff}</td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
                container.innerHTML += tableHtml;
            });
        }

        function renderKnockoutTeams() {
            const ul = document.getElementById('knockout-teams');
            ul.innerHTML = '';
            
            groups.forEach(group => {
                const winner = data['table' + group][0];
                const runnerUp = data['table' + group][1];

                if (winner) {
                    ul.innerHTML += `<li>Nh·∫•t B·∫£ng ${group}: <strong>${winner.D}</strong></li>`;
                }
                if (runnerUp) {
                    ul.innerHTML += `<li>Nh√¨ B·∫£ng ${group}: <strong>${runnerUp.D}</strong></li>`;
                }
            });
        }


        // --- Kh·ªüi ch·∫°y v√† S·ª± ki·ªán Modal ---
        document.addEventListener('DOMContentLoaded', () => {
            renderMatches();
            calculateGroupTables();

            // Setup Modal Close Handlers
            const modal = document.getElementById('matchModal');
            document.querySelector('.close-btn').onclick = () => { modal.style.display = "none"; };
            window.onclick = (event) => { if (event.target == modal) { modal.style.display = "none"; } };
        });

    </script>
</body>
</html>
