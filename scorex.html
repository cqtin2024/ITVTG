<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>C·∫≠p nh·∫≠t D·ªØ li·ªáu Gi·∫£i ƒë·∫•u Pickleball ITVTG 2025</title>
    <!-- Th∆∞ vi·ªán Vue.js 3 - D√πng CDN ƒë·ªÉ ƒë∆°n gi·∫£n -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <style>
        /* CSS Styling */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap');
        
        :root {
            --primary-color: #3498db;
            --secondary-color: #2ecc71;
            --danger-color: #e74c3c;
            --text-color: #333;
            --bg-light: #f4f4f9;
            --gray-border: #ddd;
        }

        body { font-family: 'Inter', sans-serif; background-color: var(--bg-light); color: var(--text-color); margin: 0; padding: 20px; }
        .container { max-width: 1200px; margin: auto; background: #fff; padding: 30px; border-radius: 12px; box-shadow: 0 8px 16px rgba(0,0,0,0.1); }
        h1, h2, h3 { color: var(--primary-color); border-bottom: 2px solid #ecf0f1; padding-bottom: 10px; margin-top: 20px; font-weight: 700; }
        .tournament-info div { margin-bottom: 8px; font-size: 0.95rem; }

        /* Tables */
        .standings-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .standings-card { border: 1px solid var(--gray-border); border-radius: 8px; overflow: hidden; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .standings-card h3 { margin: 0; padding: 12px; background-color: var(--secondary-color); color: white; border-bottom: none; }

        .standings-table, .matches-table { width: 100%; border-collapse: collapse; }
        .matches-table th, .matches-table td, .standings-table th, .standings-table td { padding: 8px 10px; text-align: left; font-size: 0.9rem; }
        
        .standings-table th { background-color: #34495e; color: white; }
        .standings-table tr:nth-child(even) { background-color: #f9f9f9; }

        .matches-table th { background-color: var(--primary-color); color: white; }
        .matches-table tr:nth-child(even) { background-color: #f9f9f9; }
        .match-group-header { background-color: #2c3e50 !important; color: white; text-align: center !important; font-weight: bold; }
        
        input[type="number"] { width: 50px; padding: 4px; border: 1px solid #ccc; border-radius: 4px; text-align: center; }
        
        .update-button { 
            background-color: var(--danger-color); color: white; border: none; padding: 6px 12px; 
            font-size: 0.85rem; cursor: pointer; border-radius: 6px; transition: all 0.3s; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            display: flex; align-items: center; justify-content: center;
        }
        .update-button:hover { background-color: #c0392b; transform: translateY(-1px); }
        .winner-cell { font-weight: bold; color: var(--secondary-color); }
        
        /* Modal and Message Styling */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.6); display: flex; justify-content: center;
            align-items: center; z-index: 1000;
        }
        .modal-content {
            background: #fff; padding: 30px; border-radius: 10px;
            width: 90%; max-width: 450px; box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            text-align: center;
        }
        .modal-content input {
            width: 100%; padding: 10px; margin: 15px 0; border: 1px solid var(--gray-border);
            border-radius: 6px; box-sizing: border-box;
        }
        .pat-button { 
            background-color: var(--primary-color); color: white; border: none; 
            padding: 10px 20px; cursor: pointer; border-radius: 6px; 
            font-weight: bold; transition: background-color 0.3s;
        }
        .pat-button:hover { background-color: #2980b9; }

        .message-box {
            position: fixed; top: 20px; right: 20px;
            background-color: #f8d7da; color: #721c24;
            border: 1px solid #f5c6cb; border-radius: 8px;
            padding: 15px; box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            max-width: 400px; z-index: 1000;
            opacity: 0; transition: opacity 0.5s, transform 0.5s;
            transform: translateY(-20px);
        }
        .message-box.show { opacity: 1; transform: translateY(0); }
        .message-box.success { background-color: #d4edda; color: #155724; border-color: #c3e6cb; }
        .message-box button { float: right; background: none; border: none; font-size: 1.2rem; cursor: pointer; margin-left: 10px; }
        .loading-spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid white;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Responsive */
        @media (max-width: 768px) {
            .container { padding: 15px; }
            .matches-table th, .matches-table td { padding: 8px; font-size: 0.8rem; }
            .standings-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>

<div id="app" class="container">
    
    <!-- Modal Nh·∫≠p PAT -->
    <div v-if="isPatModalVisible" class="modal-overlay" @click.self="hidePatModal">
        <div class="modal-content">
            <h2>Y√™u c·∫ßu Token GitHub</h2>
            <p>
                ƒê·ªÉ c·∫≠p nh·∫≠t file <code>statex.json</code> tr√™n GitHub, b·∫°n c·∫ßn cung c·∫•p
                **Personal Access Token (PAT)**. Token n√†y c·∫ßn c√≥ quy·ªÅn **repo** (full control of private repositories) ho·∫∑c t·ªëi thi·ªÉu l√† quy·ªÅn ghi file (`write:contents`).
            </p>
            <p style="color: var(--danger-color); font-weight: bold;">
                L∆∞u √Ω: Token n√†y ƒë∆∞·ª£c l∆∞u tr·ªØ c·ª•c b·ªô tr√™n tr√¨nh duy·ªát c·ªßa b·∫°n (Local Storage) v√† KH√îNG ƒë∆∞·ª£c g·ª≠i ƒëi n∆°i kh√°c.
            </p>
            <input type="password" v-model="tempPat" placeholder="Nh·∫≠p Personal Access Token (PAT)" />
            <button class="pat-button" @click="saveAndHidePat">L∆∞u Token v√† Ti·∫øp t·ª•c</button>
        </div>
    </div>

    <!-- H·ªôp Th√¥ng B√°o L·ªói/Th√†nh C√¥ng -->
    <div v-if="errorMessage" class="message-box" :class="{ 'show': isErrorVisible, 'success': isSuccessMessage }">
        <button @click="hideErrorMessage">&times;</button>
        <strong>Th√¥ng B√°o:</strong>
        <p v-html="errorMessage"></p>
    </div>

    <!-- Th√¥ng b√°o ƒêang C·∫≠p nh·∫≠t -->
    <div v-if="isLoading" class="message-box" :class="{ 'show': isLoading }" style="background-color: #fcf8e3; color: #8a6d3b; border-color: #faebcc; right: 50%; transform: translateX(50%);">
        <div class="loading-spinner" style="border-top-color: #8a6d3b; display: inline-block; vertical-align: middle;"></div>
        <strong style="margin-left: 10px; vertical-align: middle;">ƒêang C·∫≠p nh·∫≠t GitHub...</strong>
    </div>

    <h1>{{ tournament.TN }}</h1>
    <p>Gi·∫£i ƒë·∫•u do **{{ tournament.Org }}** t·ªï ch·ª©c. H√£y c·∫≠p nh·∫≠t ƒëi·ªÉm s·ªë ƒë·ªÉ xem b·∫£ng x·∫øp h·∫°ng thay ƒë·ªïi!</p>

    <div class="tournament-info">
        <h2>Th√¥ng Tin Chung</h2>
        <!-- ... (Tournament Info unchanged) ... -->
        <div>**Th·ªùi gian:** {{ tournament.SD }} - {{ tournament.ED }} | B·∫Øt ƒë·∫ßu l√∫c {{ tournament.FTT }}</div>
        <div>**ƒê·ªãa ƒëi·ªÉm thi ƒë·∫•u:** {{ tournament.VL }} (<a :href="tournament.MapVL" target="_blank">Xem b·∫£n ƒë·ªì</a>)</div>
        <div>**Gala Dinner:** {{ tournament.GL }} | L√∫c {{ tournament.GT }} (<a :href="tournament.MapGL" target="_blank">Xem b·∫£n ƒë·ªì</a>)</div>
        <p style="font-weight: bold; color: var(--secondary-color); margin-top: 10px;">
            D·ªØ li·ªáu tr·∫≠n ƒë·∫•u ƒëang ƒë∆∞·ª£c l∆∞u tr·ªØ c·ª•c b·ªô (Local Storage).
            <span v-if="githubPat" style="color: var(--primary-color);">K·∫øt n·ªëi GitHub ƒë√£ thi·∫øt l·∫≠p.</span>
            <span v-else style="color: var(--danger-color);">Ch∆∞a c√≥ PAT GitHub. D·ªØ li·ªáu CH∆ØA ƒë∆∞·ª£c c·∫≠p nh·∫≠t l√™n remote.</span>
        </p>
    </div>

    <hr>

    <h2>üèÜ B·∫£ng X·∫øp H·∫°ng V√≤ng B·∫£ng</h2>
    <div class="standings-grid">
        <div class="standings-card" v-for="(group, groupName) in groupedStandings" :key="groupName">
            <h3>B·∫£ng {{ groupName }}</h3>
            <table class="standings-table">
                <thead>
                    <tr>
                        <th class="rank-cell">#</th>
                        <th>ƒê·ªôi (T√™n r√∫t g·ªçn)</th>
                        <th>W</th>
                        <th>L</th>
                        <th>Pts</th>
                        <th>+/-</th>
                    </tr>
                </thead>
                <tbody>
                    <tr v-for="(team, index) in group" :key="team.T">
                        <td class="rank-cell">{{ index + 1 }}</td>
                        <td>{{ team.Tn }}</td>
                        <td>{{ team.W }}</td>
                        <td>{{ team.L }}</td>
                        <td>{{ team.Pts }}</td>
                        <td>{{ team.gD }}</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <hr>

    <h2>T·∫•t C·∫£ C√°c Tr·∫≠n ƒê·∫•u</h2>
    <table class="matches-table">
        <thead>
            <tr>
                <th>M√£ Tr·∫≠n</th>
                <th>Th·ªùi gian</th>
                <th>S√¢n</th>
                <th>ƒê·ªôi A</th>
                <th>T·ª∑ s·ªë A</th>
                <th>ƒê·ªôi B</th>
                <th>T·ª∑ s·ªë B</th>
                <th>ƒê·ªôi Th·∫Øng</th>
                <th>C·∫≠p nh·∫≠t</th>
            </tr>
        </thead>
        <tbody>
            <template v-for="(match, index) in matches" :key="index">
                <!-- Ph√¢n bi·ªát v√≤ng b·∫£ng v√† lo·∫°i tr·ª±c ti·∫øp b·∫±ng header group -->
                <tr v-if="index === 0 || match.Mc.substring(0, 2) !== matches[index-1].Mc.substring(0, 2)">
                    <td colspan="9" class="match-group-header">
                        {{ getMatchGroupName(match.Mc) }}
                    </td>
                </tr>

                <tr>
                    <td>{{ match.Mc }}</td>
                    <td>{{ match.t }}</td>
                    <td>{{ match.c }}</td>
                    <td :class="{'winner-cell': match.Wn === match.A, 'loser-cell': match.Wn === match.B}">{{ match.A }}</td>
                    <td>
                        <!-- Gi·ªõi h·∫°n ƒëi·ªÉm max theo lo·∫°i tr·∫≠n -->
                        <input type="number" v-model.number="match.sA" min="0" :max="match.Mc.startsWith('G') || match.Mc.startsWith('QF') ? 11 : 15" />
                    </td>
                    <td :class="{'winner-cell': match.Wn === match.B, 'loser-cell': match.Wn === match.A}">{{ match.B }}</td>
                    <td>
                        <input type="number" v-model.number="match.sB" min="0" :max="match.Mc.startsWith('G') || match.Mc.startsWith('QF') ? 11 : 15" />
                    </td>
                    <td :class="{'winner-cell': match.Wn !== ''}">
                        {{ match.Wn === '' ? 'ƒêang ƒë·∫•u...' : match.Wn }}
                    </td>
                    <td>
                        <button 
                            class="update-button" 
                            @click="updateMatch(match)" 
                            :disabled="isLoading"
                        >
                            <span v-if="!isLoading">L∆∞u</span>
                            <div v-else class="loading-spinner"></div>
                        </button>
                    </td>
                </tr>
            </template>
        </tbody>
    </table>
    
    <p style="margin-top: 30px; font-size: 0.85rem; color: #7f8c8d;">
        *L∆∞u √Ω: Nh·∫•n n√∫t **L∆∞u** s·∫Ω c·∫≠p nh·∫≠t d·ªØ li·ªáu c·∫£ c·ª•c b·ªô v√† l√™n GitHub (n·∫øu c√≥ PAT).
    </p>

</div>

<script>
    const { createApp, ref, computed, onMounted } = Vue

    // D·ªØ li·ªáu JSON ban ƒë·∫ßu (gi·ªØ nguy√™n c·∫•u tr√∫c)
    const tournamentData = {
        "key_legend": { /* ... */ },
        "TournamentInfo": {
            "TN": "Pickleball ITVTG Tournament 2025",
            "Org": "IT V≈©ng T√†u Goup",
            "LogoL": "https://github.com/cqtin2024/ITVTG/blob/main/LogoITGVT01.png",
            "SD": "26-10-2025",
            "ED": "26-10-2025",
            "FTT": "14:00",
            "VL": "HM Sport - Pickleball & Coffee - 195 V√µ Th·ªã S√°u, V≈©ng T√†u",
            "MapVL": "https://maps.app.goo.gl/KqqrpVqmVi4uNg7s7",
            "GL": "Qu√°n nh·∫≠u Th·ªëng Nh·∫•t - 56 Th·ªëng Nh·∫•t, V≈©ng T√†u ",
            "GT": "18:30",
            "MapGL": "https://maps.app.goo.gl/Zbuo59wSeRsHP6E59"
        },
        "teamStandings": [
            { "g": "A", "W": 0, "L": 0, "HS": "11", "Pts": 0, "mP": 0, "gR": 4, "T": "Team 9", "Tn": "Duy H∆∞ng-Minh T√∫", "seed": "A1" },
            { "g": "A", "W": 0, "L": 0, "HS": "11", "Pts": 0, "mP": 0, "gR": 1, "T": "Team 3", "Tn": "Qu·ªëc Th·ªãnh-Minh Ph∆∞∆°ng", "seed": "A2" },
            { "g": "A", "W": 0, "L": 0, "HS": "11", "Pts": 0, "mP": 0, "gR": 3, "T": "Team 11", "Tn": "Minh Chang-Minh Ch√¢u", "seed": "A3" },
            { "g": "A", "W": 0, "L": 0, "HS": "11", "Pts": 0, "mP": 0, "gR": 2, "T": "Team 5", "Tn": "Qu·ªëc Kh√°nh-Linh V≈©", "seed": "A4" },
            { "g": "B", "W": 0, "L": 0, "HS": "11", "Pts": 0, "mP": 0, "gR": 4, "T": "Team 4", "Tn": "Qu√≠ Tu·∫•n-M·∫°nh H√πng", "seed": "B1" },
            { "g": "B", "W": 0, "L": 0, "HS": "11", "Pts": 0, "mP": 0, "gR": 1, "T": "Team 7", "Tn": "Qu·ªëc H√πng-ƒê·ª©c Duy", "seed": "B2" },
            { "g": "B", "W": 0, "L": 0, "HS": "11", "Pts": 0, "mP": 0, "gR": 3, "T": "Team 12", "Tn": "Thanh S∆°n-Khoa Ti·∫øn", "seed": "B3" },
            { "g": "B", "W": 0, "L": 0, "HS": "11", "Pts": 0, "mP": 0, "gR": 2, "T": "Team 1", "Tn": "Quang Ti·∫øn-T·∫•t Th√†nh", "seed": "B4" },
            { "g": "C", "W": 0, "L": 0, "HS": "11", "Pts": 0, "mP": 0, "gR": 4, "T": "Team 16", "Tn": "Ho√†ng Thanh-C√¥ng Ph∆∞∆°ng", "seed": "C1" },
            { "g": "C", "W": 0, "L": 0, "HS": "11", "Pts": 0, "mP": 0, "gR": 1, "T": "Team 10", "Tn": "L√™ Duy-Thanh V∆∞∆°ng", "seed": "C2" },
            { "g": "C", "W": 0, "L": 0, "HS": "11", "Pts": 0, "mP": 0, "gR": 3, "T": "Team 14", "Tn": "VƒÉn C∆∞·ªùng-VƒÉn D≈©ng", "seed": "C3" },
            { "g": "C", "W": 0, "L": 0, "HS": "11", "Pts": 0, "mP": 0, "gR": 2, "T": "Team 6", "Tn": "ƒê√¥ng Chu-Ng·ªçc H√πng", "seed": "C4" },
            { "g": "D", "W": 0, "L": 0, "HS": "11", "Pts": 0, "mP": 0, "gR": 4, "T": "Team 13", "Tn": "B√° Ch√¢u-Hi·ªÅn Phong", "seed": "D1" },
            { "g": "D", "W": 0, "L": 0, "HS": "11", "Pts": 0, "mP": 0, "gR": 1, "T": "Team 8", "Tn": "Ti·∫øn M·∫°nh-Quang T√≠n", "seed": "D2" },
            { "g": "D", "W": 0, "L": 0, "HS": "11", "Pts": 0, "mP": 0, "gR": 3, "T": "Team 15", "Tn": "Minh Thi·ªán-Duy Minh", "seed": "D3" },
            { "g": "D", "W": 0, "L": 0, "HS": "11", "Pts": 0, "mP": 0, "gR": 2, "T": "Team 2", "Tn": "Vi·∫øt Tu·∫•n-Quang D≈©ng", "seed": "D4" }
        ],
        "matches": [
            { "Mc": "GA1", "t": "14:15", "c": "S3", "A": "Duy H∆∞ng-Minh T√∫", "sA": 0, "B": "Qu·ªëc Th·ªãnh-Minh Ph∆∞∆°ng", "sB": 0, "Wn": "" },
            { "Mc": "GA2", "t": "14:15", "c": "S4", "A": "Minh Chang-Minh Ch√¢u", "sA": 0, "B": "Qu·ªëc Kh√°nh-Linh V≈©", "sB": 0, "Wn": "" },
            { "Mc": "GA3", "t": "14:45", "c": "S3", "A": "Duy H∆∞ng-Minh T√∫", "sA": 0, "B": "Minh Chang-Minh Ch√¢u", "sB": 0, "Wn": "" },
            { "Mc": "GA4", "t": "14:45", "c": "S4", "A": "Qu·ªëc Th·ªãnh-Minh Ph∆∞∆°ng", "sA": 0, "B": "Qu·ªëc Kh√°nh-Linh V≈©", "sB": 0, "Wn": "" },
            { "Mc": "GA5", "t": "15:15", "c": "S3", "A": "Duy H∆∞ng-Minh T√∫", "sA": 0, "B": "Qu·ªëc Kh√°nh-Linh V≈©", "sB": 0, "Wn": "" },
            { "Mc": "GA6", "t": "15:15", "c": "S4", "A": "Qu·ªëc Th·ªãnh-Minh Ph∆∞∆°ng", "sA": 0, "B": "Minh Chang-Minh Ch√¢u", "sB": 0, "Wn": "" },
            { "Mc": "GB1", "t": "14:30", "c": "S3", "A": "Qu√≠ Tu·∫•n-M·∫°nh H√πng", "sA": 0, "B": "Qu·ªëc H√πng-ƒê·ª©c Duy", "sB": 0, "Wn": "" },
            { "Mc": "GB2", "t": "14:30", "c": "S4", "A": "Thanh S∆°n-Khoa Ti·∫øn", "sA": 0, "B": "Quang Ti·∫øn-T·∫•t Th√†nh", "sB": 0, "Wn": "" },
            { "Mc": "GB3", "t": "15:00", "c": "S3", "A": "Qu√≠ Tu·∫•n-M·∫°nh H√πng", "sA": 0, "B": "Thanh S∆°n-Khoa Ti·∫øn", "sB": 0, "Wn": "" },
            { "Mc": "GB4", "t": "15:00", "c": "S4", "A": "Qu·ªëc H√πng-ƒê·ª©c Duy", "sA": 0, "B": "Quang Ti·∫øn-T·∫•t Th√†nh", "sB": 0, "Wn": "" },
            { "Mc": "GB5", "t": "15:30", "c": "S3", "A": "Qu√≠ Tu·∫•n-M·∫°nh H√πng", "sA": 0, "B": "Quang Ti·∫øn-T·∫•t Th√†nh", "sB": 0, "Wn": "" },
            { "Mc": "GB6", "t": "15:30", "c": "S4", "A": "Qu·ªëc H√πng-ƒê·ª©c Duy", "sA": 0, "B": "Thanh S∆°n-Khoa Ti·∫øn", "sB": 0, "Wn": "" },
            { "Mc": "GC1", "t": "14:15", "c": "S5", "A": "Ho√†ng Thanh-C√¥ng Ph∆∞∆°ng", "sA": 0, "B": "L√™ Duy-Thanh V∆∞∆°ng", "sB": 0, "Wn": "" },
            { "Mc": "GC2", "t": "14:15", "c": "S6", "A": "VƒÉn C∆∞·ªùng-VƒÉn D≈©ng", "sA": 0, "B": "ƒê√¥ng Chu-Ng·ªçc H√πng", "sB": 0, "Wn": "" },
            { "Mc": "GC3", "t": "14:45", "c": "S5", "A": "Ho√†ng Thanh-C√¥ng Ph∆∞∆°ng", "sA": 0, "B": "VƒÉn C∆∞·ªùng-VƒÉn D≈©ng", "sB": 0, "Wn": "" },
            { "Mc": "GC4", "t": "14:45", "c": "S6", "A": "L√™ Duy-Thanh V∆∞∆°ng", "sA": 0, "B": "ƒê√¥ng Chu-Ng·ªçc H√πng", "sB": 0, "Wn": "" },
            { "Mc": "GC5", "t": "15:15", "c": "S5", "A": "Ho√†ng Thanh-C√¥ng Ph∆∞∆°ng", "sA": 0, "B": "ƒê√¥ng Chu-Ng·ªçc H√πng", "sB": 0, "Wn": "" },
            { "Mc": "GC6", "t": "15:15", "c": "S6", "A": "L√™ Duy-Thanh V∆∞∆°ng", "sA": 0, "B": "VƒÉn C∆∞·ªùng-VƒÉn D≈©ng", "sB": 0, "Wn": "" },
            { "Mc": "GD1", "t": "14:30", "c": "S5", "A": "B√° Ch√¢u-Hi·ªÅn Phong", "sA": 0, "B": "Ti·∫øn M·∫°nh-Quang T√≠n", "sB": 0, "Wn": "" },
            { "Mc": "GD2", "t": "14:30", "c": "S6", "A": "Minh Thi·ªán-Duy Minh", "sA": 0, "B": "Vi·∫øt Tu·∫•n-Quang D≈©ng", "sB": 0, "Wn": "" },
            { "Mc": "GD3", "t": "15:00", "c": "S5", "A": "B√° Ch√¢u-Hi·ªÅn Phong", "sA": 0, "B": "Minh Thi·ªán-Duy Minh", "sB": 0, "Wn": "" },
            { "Mc": "GD4", "t": "15:00", "c": "S6", "A": "Ti·∫øn M·∫°nh-Quang T√≠n", "sA": 0, "B": "Vi·∫øt Tu·∫•n-Quang D≈©ng", "sB": 0, "Wn": "" },
            { "Mc": "GD5", "t": "15:30", "c": "S5", "A": "B√° Ch√¢u-Hi·ªÅn Phong", "sA": 0, "B": "Vi·∫øt Tu·∫•n-Quang D≈©ng", "sB": 0, "Wn": "" },
            { "Mc": "GD6", "t": "15:30", "c": "S6", "A": "Ti·∫øn M·∫°nh-Quang T√≠n", "sA": 0, "B": "Minh Thi·ªán-Duy Minh", "sB": 0, "Wn": "" },
            { "Mc": "QF1", "t": "15:45", "c": "S3", "A": "W.A", "sA": 0, "B": "R.B", "sB": 0, "Wn": "" },
            { "Mc": "QF2", "t": "15:45", "c": "S4", "A": "W.B", "sA": 0, "B": "R.A", "sB": 0, "Wn": "" },
            { "Mc": "QF3", "t": "16:00", "c": "S5", "A": "W.C", "sA": 0, "B": "R.D", "sB": 0, "Wn": "" },
            { "Mc": "QF4", "t": "16:00", "c": "S6", "A": "W.D", "sA": 0, "B": "R.C", "sB": 0, "Wn": "" },
            { "Mc": "SF1", "t": "16:10", "c": "S4", "A": "W.QF1", "sA": 0, "B": "W.QF3", "sB": 0, "Wn": "" },
            { "Mc": "SF2", "t": "16:25", "c": "S5", "A": "W.QF2", "sA": 0, "B": "W.QF4", "sB": 0, "Wn": "" },
            { "Mc": "F", "t": "17:05", "c": "S5", "A": "W.SF1", "sA": 0, "B": "W.SF2", "sB": 0, "Wn": "", "rU": "L.SF1/L.SF2" }
        ],
        "tL": [ /* ... */ ]
    };

    // H·∫∞NG S·ªê V√Ä KH√ìA L∆ØU TR·ªÆ
    const LOCAL_STORAGE_KEY = 'itvtg_pickleball_matches';
    const GITHUB_PAT_KEY = 'ITVTG_GITHUB_PAT';
    const REPO_OWNER = 'cqtin2024';
    const REPO_NAME = 'ITVTG';
    const FILE_PATH = 'data/statex.json';
    const GITHUB_API_URL = `https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/${FILE_PATH}`;


    // H√ÄM TI·ªÜN √çCH HI·ªÇN TH·ªä TH√îNG B√ÅO (THAY TH·∫æ ALERT)
    let errorTimeout;
    const showMessage = (message, isSuccess = false) => {
        const appElement = document.getElementById('app');
        if (!appElement || !appElement.__vue_app__) return;
        
        // FIX: Thay ƒë·ªïi c√°ch truy c·∫≠p setupState ƒë·ªÉ ƒë·∫£m b·∫£o l·∫•y ƒë√∫ng c√°c refs ƒë∆∞·ª£c expose
        const instance = appElement.__vue_app__._instance;
        if (!instance || !instance.setupState) {
            console.error("L·ªói: Kh√¥ng th·ªÉ truy c·∫≠p tr·∫°ng th√°i setup c·ªßa Vue instance.");
            return;
        }
        
        const app = instance.setupState;
        
        clearTimeout(errorTimeout);
        
        // ƒê·∫£m b·∫£o c√°c thu·ªôc t√≠nh Ref t·ªìn t·∫°i tr∆∞·ªõc khi truy c·∫≠p .value
        if (app.isSuccessMessage && app.errorMessage && app.isErrorVisible) {
            app.isSuccessMessage.value = isSuccess; 
            app.errorMessage.value = message;        
            app.isErrorVisible.value = true;         
        } else {
            console.error("L·ªói: Kh√¥ng th·ªÉ t√¨m th·∫•y c√°c refs th√¥ng b√°o trong setupState.");
            return;
        }
        
        errorTimeout = setTimeout(() => {
            app.isErrorVisible.value = false;
        }, 8000);
    };


    // H√ÄM QU·∫¢N L√ù D·ªÆ LI·ªÜU C·ª§C B·ªò (LOCAL STORAGE)
    const loadMatchesFromStorage = () => {
        const storedMatches = localStorage.getItem(LOCAL_STORAGE_KEY);
        if (storedMatches) {
            try {
                const loaded = JSON.parse(storedMatches);
                loaded.forEach(match => {
                    match.sA = parseInt(match.sA) || 0;
                    match.sB = parseInt(match.sB) || 0;
                });
                console.log('‚úÖ ƒê√£ t·∫£i d·ªØ li·ªáu tr·∫≠n ƒë·∫•u t·ª´ Local Storage.');
                return loaded;
            } catch (e) {
                console.error('L·ªói khi t·∫£i d·ªØ li·ªáu t·ª´ Local Storage:', e);
                return null;
            }
        }
        return null;
    };

    const saveMatchesToStorage = (currentMatches) => {
        try {
            localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(currentMatches));
            console.log('‚úÖ ƒê√£ l∆∞u d·ªØ li·ªáu tr·∫≠n ƒë·∫•u v√†o Local Storage.');
        } catch (e) {
            console.error('L·ªói khi l∆∞u d·ªØ li·ªáu v√†o Local Storage:', e);
        }
    };
    
    // T·∫£i d·ªØ li·ªáu ban ƒë·∫ßu
    const initialMatches = loadMatchesFromStorage();
    if (initialMatches) {
         tournamentData.matches = initialMatches;
    } else {
        tournamentData.matches.forEach(match => {
            match.sA = parseInt(match.sA) || 0;
            match.sB = parseInt(match.sB) || 0;
        });
    }


    // H√ÄM LOGIC CH√çNH VUE.JS
    createApp({
        setup() {
            const tournament = ref(tournamentData.TournamentInfo);
            const matches = ref(tournamentData.matches);
            const standings = ref(tournamentData.teamStandings);
            const githubPat = ref('');
            const tempPat = ref('');

            // State UI
            const errorMessage = ref('');
            const isErrorVisible = ref(false);
            const isSuccessMessage = ref(false);
            const isPatModalVisible = ref(false);
            const isLoading = ref(false);
            
            // --- Qu·∫£n l√Ω PAT ---
            const loadPat = () => {
                const pat = localStorage.getItem(GITHUB_PAT_KEY);
                if (pat) {
                    githubPat.value = pat;
                    tempPat.value = pat; // C·∫≠p nh·∫≠t cho input
                    console.log('PAT ƒë√£ ƒë∆∞·ª£c t·∫£i.');
                }
            };

            const showPatModal = (message = null) => {
                if (message) {
                    showMessage(message);
                }
                isPatModalVisible.value = true;
            };

            const hidePatModal = () => {
                isPatModalVisible.value = false;
            };

            const saveAndHidePat = () => {
                if (tempPat.value.trim()) {
                    localStorage.setItem(GITHUB_PAT_KEY, tempPat.value.trim());
                    githubPat.value = tempPat.value.trim();
                    hidePatModal();
                    // Th·ª≠ c·∫≠p nh·∫≠t l·∫°i ngay sau khi l∆∞u PAT
                    sendDataToGitHub();
                } else {
                    showMessage('PAT kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng.', false);
                }
            };
            
            const hideErrorMessage = () => {
                isErrorVisible.value = false;
                errorMessage.value = '';
                isSuccessMessage.value = false;
            };

            // --- Logic t√≠nh to√°n BXH ---
            const calculateStandings = (matches, initialStandings) => {
                const standingsMap = new Map();
                // Kh·ªüi t·∫°o/reset tr·∫°ng th√°i
                initialStandings.forEach(team => {
                    // D√πng spread operator ƒë·ªÉ t·∫°o b·∫£n sao v√† reset
                    standingsMap.set(team.Tn, {
                        ...team,
                        W: 0, L: 0, Pts: 0, mP: 0, gS: 0, gA: 0, gD: 0
                    });
                });

                matches.forEach(match => {
                    if (match.Mc.startsWith('G') && match.Wn !== '') { // Ch·ªâ t√≠nh v√≤ng b·∫£ng ƒë√£ c√≥ k·∫øt qu·∫£
                        const teamA = standingsMap.get(match.A);
                        const teamB = standingsMap.get(match.B);
                        
                        if (teamA && teamB) {
                            teamA.mP++;
                            teamB.mP++;
                            
                            teamA.gS += match.sA;
                            teamA.gA += match.sB;
                            teamB.gS += match.sB;
                            teamB.gA += match.sA;

                            if (match.sA > match.sB) {
                                teamA.W++; teamB.L++; teamA.Pts += 3; 
                            } else if (match.sB > match.sA) {
                                teamB.W++; teamA.L++; teamB.Pts += 3;
                            } 
                        }
                    }
                });

                // C·∫≠p nh·∫≠t gD v√† s·∫Øp x·∫øp
                const allTeams = Array.from(standingsMap.values()).map(team => {
                    team.gD = team.gS - team.gA;
                    // C·∫≠p nh·∫≠t l·∫°i array g·ªëc ƒë·ªÉ s·ª≠ d·ª•ng cho l·∫ßn l∆∞u sau
                    const originalTeam = initialStandings.find(t => t.Tn === team.Tn);
                    if (originalTeam) Object.assign(originalTeam, team);
                    return team;
                });
                
                // Gom nh√≥m v√† s·∫Øp x·∫øp
                const grouped = {};
                allTeams.forEach(team => {
                    const groupName = team.g;
                    if (!grouped[groupName]) {
                        grouped[groupName] = [];
                    }
                    grouped[groupName].push(team);
                });

                for (const groupName in grouped) {
                    grouped[groupName].sort((a, b) => {
                        if (b.Pts !== a.Pts) return b.Pts - a.Pts; 
                        if (b.gD !== a.gD) return b.gD - a.gD;     
                        return a.Tn.localeCompare(b.Tn);          
                    });
                }
                
                return grouped;
            };
            
            const groupedStandings = computed(() => {
                return calculateStandings(matches.value, standings.value);
            });

            // --- H√†m G·ª≠i d·ªØ li·ªáu l√™n GitHub ---
            const getCurrentStateJson = () => {
                // ƒê·∫£m b·∫£o teamStandings l√† phi√™n b·∫£n ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t W, L, Pts
                return JSON.stringify({
                    "key_legend": tournamentData.key_legend,
                    "TournamentInfo": tournament.value,
                    "teamStandings": standings.value, // ƒê√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t trong calculateStandings
                    "matches": matches.value,
                    "tL": tournamentData.tL 
                }, null, 2);
            };

            const sendDataToGitHub = async () => {
                if (!githubPat.value) {
                    showPatModal('Vui l√≤ng nh·∫≠p Personal Access Token (PAT) ƒë·ªÉ c·∫≠p nh·∫≠t d·ªØ li·ªáu l√™n GitHub.');
                    return false;
                }

                if (isLoading.value) return false;

                isLoading.value = true;
                const pat = githubPat.value;
                
                try {
                    // 1. L·∫•y SHA c·ªßa file hi·ªán t·∫°i
                    const getResponse = await fetch(GITHUB_API_URL, {
                        method: 'GET',
                        headers: {
                            'Authorization': `token ${pat}`,
                            'Accept': 'application/vnd.github.v3+json'
                        }
                    });

                    if (!getResponse.ok) {
                        if (getResponse.status === 401 || getResponse.status === 403) {
                             // N·∫øu PAT kh√¥ng h·ª£p l·ªá ho·∫∑c kh√¥ng c√≥ quy·ªÅn
                            localStorage.removeItem(GITHUB_PAT_KEY);
                            githubPat.value = '';
                            showPatModal(`K·∫øt n·ªëi GitHub th·∫•t b·∫°i (L·ªói ${getResponse.status}). PAT c√≥ th·ªÉ kh√¥ng h·ª£p l·ªá ho·∫∑c h·∫øt h·∫°n. Vui l√≤ng nh·∫≠p l·∫°i.`);
                        } else {
                            throw new Error(`L·ªói khi l·∫•y th√¥ng tin file t·ª´ GitHub (Status: ${getResponse.status})`);
                        }
                        return false;
                    }
                    
                    const fileData = await getResponse.json();
                    const currentSha = fileData.sha;
                    
                    // 2. Chu·∫©n b·ªã n·ªôi dung m·ªõi v√† m√£ h√≥a Base64
                    const newContent = getCurrentStateJson();
                    // S·ª≠a l·ªói Base64: D√πng encodeURIComponent v√† unescape ƒë·ªÉ x·ª≠ l√Ω k√Ω t·ª± Unicode (ti·∫øng Vi·ªát) tr∆∞·ªõc khi d√πng btoa
                    const base64Content = btoa(unescape(encodeURIComponent(newContent))); 
                    
                    // 3. Th·ª±c hi·ªán PUT request ƒë·ªÉ c·∫≠p nh·∫≠t file
                    const commitMessage = `C·∫≠p nh·∫≠t ƒëi·ªÉm s·ªë t·ª± ƒë·ªông - ${new Date().toLocaleString('vi-VN')}`;
                    const putPayload = {
                        message: commitMessage,
                        content: base64Content,
                        sha: currentSha
                    };

                    const putResponse = await fetch(GITHUB_API_URL, {
                        method: 'PUT',
                        headers: {
                            'Authorization': `token ${pat}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(putPayload)
                    });

                    if (!putResponse.ok) {
                         if (putResponse.status === 401 || putResponse.status === 403) {
                            // N·∫øu PAT kh√¥ng h·ª£p l·ªá ho·∫∑c kh√¥ng c√≥ quy·ªÅn
                            localStorage.removeItem(GITHUB_PAT_KEY);
                            githubPat.value = '';
                            showPatModal(`C·∫≠p nh·∫≠t GitHub th·∫•t b·∫°i (L·ªói ${putResponse.status}). PAT c√≥ th·ªÉ kh√¥ng h·ª£p l·ªá ho·∫∑c kh√¥ng c√≥ quy·ªÅn ghi. Vui l√≤ng ki·ªÉm tra l·∫°i.`);
                        } else {
                            throw new Error(`L·ªói khi c·∫≠p nh·∫≠t file l√™n GitHub (Status: ${putResponse.status})`);
                        }
                        return false;
                    }

                    showMessage('üéâ ƒê√£ c·∫≠p nh·∫≠t th√†nh c√¥ng d·ªØ li·ªáu l√™n GitHub!', true);
                    return true;

                } catch (error) {
                    console.error('L·ªói nghi√™m tr·ªçng khi c·∫≠p nh·∫≠t GitHub:', error);
                    showMessage(`C·∫≠p nh·∫≠t GitHub th·∫•t b·∫°i: ${error.message}. Vui l√≤ng ki·ªÉm tra PAT ho·∫∑c k·∫øt n·ªëi m·∫°ng.`);
                    return false;
                } finally {
                    isLoading.value = false;
                }
            };
            
            // --- H√†m Logic Tr·∫≠n ƒê·∫•u ---
            const getMatchGroupName = (mc) => {
                const prefix = mc.substring(0, 2);
                if (prefix.startsWith('G')) return `V√≤ng B·∫£ng - B·∫£ng ${mc.substring(1, 2)}`;
                switch(prefix) {
                    case 'QF': return 'V√≤ng T·ª© K·∫øt';
                    case 'SF': return 'V√≤ng B√°n K·∫øt';
                    case 'F': return 'Tr·∫≠n Chung K·∫øt';
                    default: return 'Kh√°c';
                }
            };

            const updateMatch = (match) => {
                hideErrorMessage(); // ·∫®n th√¥ng b√°o c≈©
                const scoreA = Math.max(0, parseInt(match.sA) || 0);
                const scoreB = Math.max(0, parseInt(match.sB) || 0);
                
                const prefix = match.Mc.substring(0, 2);
                let winScore; // ƒêi·ªÉm ch·∫°m ƒë·ªÉ th·∫Øng
                let message = '';
                
                // 1. X√°c ƒë·ªãnh ƒëi·ªÉm ch·∫°m (Theo y√™u c·∫ßu m·ªõi)
                if (prefix.startsWith('G') || prefix === 'QF') {
                    winScore = 11; // V√≤ng B·∫£ng/T·ª© K·∫øt: Ch·∫°m 11
                } else if (prefix === 'SF' || prefix === 'F') {
                    winScore = 15; // B√°n K·∫øt/Chung K·∫øt: Ch·∫°m 15
                } else {
                    winScore = Infinity; // M·∫∑c ƒë·ªãnh kh√¥ng h·ª£p l·ªá
                }
                
                match.sA = scoreA;
                match.sB = scoreB;
                
                let isValid = true;
                let winner = '';
                let winnerScore = 0;
                let loserScore = 0;

                if (scoreA === 0 && scoreB === 0) {
                    // N·∫øu reset v·ªÅ 0-0
                    match.Wn = '';
                    message = `‚úÖ ƒê√£ reset t·ªâ s·ªë tr·∫≠n ${match.Mc} v·ªÅ 0-0.`;
                    
                } else if (scoreA === scoreB) {
                    message = `L·ªói: T·ªâ s·ªë **Ho√†** (${scoreA}-${scoreB}) kh√¥ng h·ª£p l·ªá (Pickleball kh√¥ng c√≥ h√≤a).`;
                    isValid = false; 
                } else {
                    if (scoreA > scoreB) {
                        winner = match.A;
                        winnerScore = scoreA;
                        loserScore = scoreB;
                    } else { 
                        winner = match.B;
                        winnerScore = scoreB;
                        loserScore = scoreA;
                    }

                    // 2. Ki·ªÉm tra lu·∫≠t ƒëi·ªÉm s·ªë m·ªõi: "Ch·∫°m ƒëi·ªÉm l√† th·∫Øng"
                    
                    if (winnerScore >= winScore && winnerScore > loserScore) {
                        // H·ª£p l·ªá: ƒê·∫°t ho·∫∑c v∆∞·ª£t qu√° ƒëi·ªÉm ch·∫°m V√Ä h∆°n ƒë·ªëi th·ªß
                        match.Wn = winner;
                        message = `‚úÖ ƒê√£ c·∫≠p nh·∫≠t t·ªâ s·ªë tr·∫≠n ${match.Mc}: ${match.A} (${match.sA}) - ${match.B} (${match.sB}). ƒê·ªôi th·∫Øng: ${match.Wn}.`;
                    } else if (winnerScore < winScore) {
                        // Th·∫Øng ƒëi·ªÉm nh·ªè h∆°n ƒëi·ªÉm ch·∫°m
                        message = `L·ªói: T·ªâ s·ªë kh√¥ng h·ª£p l·ªá. ƒê·ªôi th·∫Øng ph·∫£i ƒë·∫°t t·ªëi thi·ªÉu **${winScore}** ƒëi·ªÉm. T·ªâ s·ªë hi·ªán t·∫°i: ${scoreA}-${scoreB}.`;
                        isValid = false;
                    } else if (winnerScore > winScore && loserScore >= winScore) {
                        // ƒêi·ªÉm ƒë·ªÅu tr√™n m·ª©c ch·∫°m (v√≠ d·ª• 16-15 khi winScore l√† 15) -> H·ª£p l·ªá
                        match.Wn = winner;
                        message = `‚úÖ ƒê√£ c·∫≠p nh·∫≠t t·ªâ s·ªë tr·∫≠n ${match.Mc}: ${match.A} (${match.sA}) - ${match.B} (${match.sB}). ƒê·ªôi th·∫Øng: ${match.Wn}.`;
                    }
                    // N·∫øu t·ªâ s·ªë l√† 11-10 (winScore=11) ho·∫∑c 15-14 (winScore=15) -> H·ª£p l·ªá theo lu·∫≠t "Ch·∫°m ƒëi·ªÉm l√† th·∫Øng"
                }
                
                if (isValid) {
                    // L∆∞u c·ª•c b·ªô v√† g·ª≠i l√™n GitHub
                    saveMatchesToStorage(matches.value);
                    sendDataToGitHub();
                    if (match.Wn !== '' || (scoreA === 0 && scoreB === 0)) showMessage(message, true); // Ch·ªâ hi·ªÉn th·ªã th√¥ng b√°o th√†nh c√¥ng khi c√≥ k·∫øt qu·∫£ ho·∫∑c reset

                } else {
                    // Kh√¥ng h·ª£p l·ªá: Gi·ªØ nguy√™n Wn v√† b√°o l·ªói
                    match.Wn = ''; 
                    console.error(message.replace(/<[^>]*>?/gm, ''));
                    showMessage(message, false); 
                }
            };
            
            // --- Initialization ---
            onMounted(() => {
                loadPat();
                if (!githubPat.value) {
                    showPatModal('Ch√†o m·ª´ng! Vui l√≤ng cung c·∫•p PAT GitHub ƒë·ªÉ d·ªØ li·ªáu c√≥ th·ªÉ ƒë∆∞·ª£c c·∫≠p nh·∫≠t c√¥ng khai.');
                }
            });


            return {
                tournament,
                matches,
                standings,
                groupedStandings, 
                updateMatch,
                getMatchGroupName,
                errorMessage,
                isErrorVisible,
                isSuccessMessage,
                hideErrorMessage,
                githubPat,
                tempPat,
                isPatModalVisible,
                isLoading,
                showPatModal,
                hidePatModal,
                saveAndHidePat
            }
        }
    }).mount('#app')
</script>

</body>
</html>
