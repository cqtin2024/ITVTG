<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ITVTG Pickleball Tournament Manager</title>
    <!-- T·∫£i Tailwind CSS ƒë·ªÉ styling v√† responsive -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        /* Custom styles */
        body { font-family: 'Inter', sans-serif; background-color: #f7f9fb; }
        .tab-button.active { background-color: #0d9488; color: white; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        /* Global table settings for Standings */
        .table-wrapper { overflow-x: auto; -webkit-overflow-scrolling: touch; }
        table { width: 100%; min-width: 600px; border-collapse: collapse; }
        th, td { padding: 8px 6px; text-align: left; border-bottom: 1px solid #e5e7eb; }
        
        /* T√πy ch·ªânh ƒê·∫∂C BI·ªÜT cho b·∫£ng Match Results ƒë·ªÉ v·ª´a m√†n h√¨nh nh·ªè */
        .match-table th, .match-table td {
            padding: 4px 1px; /* Gi·∫£m padding t·ªëi ƒëa */
            font-size: 0.75rem; /* Gi·∫£m font size cho mobile */
            white-space: normal; /* Cho ph√©p xu·ªëng d√≤ng */
            word-break: break-word; /* ƒê·∫£m b·∫£o t·ª´ d√†i b·ªã c·∫Øt n·∫øu c·∫ßn */
            vertical-align: middle;
        }

        /* Thu g·ªçn √¥ nh·∫≠p ƒëi·ªÉm */
        .score-input { 
            width: 2.8rem; /* Thu g·ªçn chi·ªÅu r·ªông input v·ª´a ƒë·ªß 2 ch·ªØ s·ªë */
            text-align: center; 
            font-weight: bold; 
            padding: 1px; /* Gi·∫£m padding */
            font-size: 0.7rem; /* Gi·∫£m font size */
        }

        /* C·ªôt Mc, T, C: Gi·ªØ 1 d√≤ng v√† thu g·ªçn */
        .match-table .mc-cell, 
        .match-table .time-cell, 
        .match-table .court-cell {
            white-space: nowrap; /* Gi·ªØ n·ªôi dung 1 d√≤ng */
            width: 1%; /* Thu g·ªçn t·ªëi ƒëa */
            text-align: center;
        }

        /* ƒêi·ªÅu ch·ªânh cho t√™n ƒë·ªôi: Cho ph√©p xu·ªëng d√≤ng sau d·∫•u - */
        .match-table .team-name-cell {
            min-width: 55px; /* Minimum width cho t√™n ƒë·ªôi */
            line-height: 1.2;
            padding-left: 2px;
            padding-right: 2px;
        }

        /* Desktop view: Revert to standard padding/width */
        @media (min-width: 768px) {
            table { min-width: 100%; }
            th, td { padding: 12px 10px; font-size: 1rem; }
            .match-table th, .match-table td { padding: 8px 6px; font-size: 1rem; }
            .score-input { width: 4rem; padding: 4px; font-size: 1rem; }
            .match-table .mc-cell, .match-table .time-cell, .match-table .court-cell {
                white-space: normal;
                width: auto;
            }
        }
    </style>
</head>
<body class="p-2 md:p-4">

    <!-- HEADER -->
    <header class="text-center py-4 bg-white shadow-md rounded-lg mb-4">
        <h1 class="text-2xl md:text-3xl font-bold text-teal-700">üèÜ ITVTG Pickleball Tournament 2025 Manager üèÜ</h1>
        <p class="text-sm text-gray-600 mt-1">Results & Standings Dashboard</p>
    </header>

    <!-- NAVIGATION TABS -->
    <div class="flex flex-wrap justify-center space-x-1 space-y-1 md:space-x-2 p-2 bg-gray-100 rounded-lg mb-4">
        <button class="tab-button p-2 md:px-4 md:py-2 text-sm font-medium rounded-lg text-teal-700 bg-white shadow active" data-tab="info">Info</button>
        <button class="tab-button p-2 md:px-4 md:py-2 text-sm font-medium rounded-lg text-teal-700 bg-white shadow" data-tab="group-a">Group A</button>
        <button class="tab-button p-2 md:px-4 md:py-2 text-sm font-medium rounded-lg text-teal-700 bg-white shadow" data-tab="group-b">Group B</button>
        <button class="tab-button p-2 md:px-4 md:py-2 text-sm font-medium rounded-lg text-teal-700 bg-white shadow" data-tab="group-c">Group C</button>
        <button class="tab-button p-2 md:px-4 md:py-2 text-sm font-medium rounded-lg text-teal-700 bg-white shadow" data-tab="group-d">Group D</button>
        <button class="tab-button p-2 md:px-4 md:py-2 text-sm font-medium rounded-lg text-teal-700 bg-white shadow" data-tab="final">Final Round</button>
        <button class="tab-button p-2 md:px-4 md:py-2 text-sm font-medium rounded-lg text-teal-700 bg-white shadow" data-tab="config">Config</button>
    </div>

    <!-- MAIN CONTENT -->
    <div id="content-area" class="bg-white p-4 rounded-lg shadow-xl">

        <!-- 1. INFO TAB -->
        <div id="info" class="tab-content active">
            <h2 class="text-xl font-semibold mb-3 text-teal-600">Tournament Info & Statistics</h2>
            <div id="tournament-details" class="space-y-2 text-gray-700 text-sm md:text-base mb-6 border p-3 rounded-lg bg-teal-50/50">
                <!-- Populated by JS -->
            </div>
            
            <h3 class="text-lg font-semibold mb-4 text-teal-600">Awards Summary</h3>
            <div id="trophy-display" class="grid grid-cols-2 md:grid-cols-4 gap-4">
                <!-- CHAMPION -->
                <div class="p-3 bg-yellow-100/70 border-l-4 border-yellow-500 rounded-lg shadow-md">
                    <p class="text-sm font-semibold text-yellow-700">ü•á Champion</p>
                    <p id="champion-team" class="text-lg font-bold text-yellow-800 mt-1">[TBD]</p>
                </div>
                <!-- RUNNER-UP -->
                <div class="p-3 bg-gray-100/70 border-l-4 border-gray-500 rounded-lg shadow-md">
                    <p class="text-sm font-semibold text-gray-700">ü•à Runner-Up</p>
                    <p id="runnerup-team" class="text-lg font-bold text-gray-800 mt-1">[TBD]</p>
                </div>
                <!-- THIRD PLACE 1 -->
                <div class="p-3 bg-amber-100/70 border-l-4 border-amber-500 rounded-lg shadow-md">
                    <p class="text-sm font-semibold text-amber-700">ü•â Third Place 1</p>
                    <p id="third-place-1-team" class="text-lg font-bold text-amber-800 mt-1">[TBD]</p>
                </div>
                <!-- THIRD PLACE 2 -->
                <div class="p-3 bg-amber-100/70 border-l-4 border-amber-500 rounded-lg shadow-md">
                    <p class="text-sm font-semibold text-amber-700">ü•â Third Place 2</p>
                    <p id="third-place-2-team" class="text-lg font-bold text-amber-800 mt-1">[TBD]</p>
                </div>
            </div>
        </div>
        
        <!-- 2. GROUP TABS (A, B, C, D) -->
        <div id="group-a" class="tab-content"></div>
        <div id="group-b" class="tab-content"></div>
        <div id="group-c" class="tab-content"></div>
        <div id="group-d" class="tab-content"></div>

        <!-- 3. FINAL TAB -->
        <div id="final" class="tab-content">
            <h2 class="text-xl font-semibold mb-4 text-teal-600">Final Rounds (QF, SF, F)</h2>
            <div id="final-knockout-matches">
                <!-- Knockout rounds will be rendered here -->
            </div>
        </div>

        <!-- 4. CONFIG TAB -->
        <div id="config" class="tab-content">
            <h2 class="text-xl font-semibold mb-4 text-teal-600">Configuration & Management Tools</h2>

            <!-- Automatic Update / Random -->
            <div class="p-4 border rounded-lg mb-6 bg-blue-50/50">
                <h3 class="text-lg font-semibold mb-3 text-blue-700">Automatic Score Randomization</h3>
                <p class="text-sm text-gray-600 mb-3">Generates valid random scores (11 vs &lt; 11) for all matches in the selected round(s).</p>
                <select id="random-round-select" class="p-2 border rounded-md mr-3 mb-3 w-full md:w-auto">
                    <option value="GA">Group A</option>
                    <option value="GB">Group B</option>
                    <option value="GC">Group C</option>
                    <option value="GD">Group D</option>
                    <option value="QF">Quarter Finals (QF)</option>
                    <option value="SF">Semi Finals (SF)</option>
                    <option value="F">Final (F)</option>
                    <option value="ALL">All Rounds</option>
                </select>
                <button onclick="randomizeScores()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition duration-150 w-full md:w-auto">
                    Randomize & Update
                </button>
            </div>

            <!-- Reset Scores -->
            <div class="p-4 border rounded-lg mb-6 bg-red-50/50">
                <h3 class="text-lg font-semibold mb-3 text-red-700">Reset Scores & Recalculate</h3>
                <p class="text-sm text-gray-600 mb-3">Clears results (Scores, Winner) for matches in the selected round(s) and recalculates standings.</p>
                <select id="reset-round-select" class="p-2 border rounded-md mr-3 mb-3 w-full md:w-auto">
                    <option value="F">Final (F)</option>
                    <option value="SF">Semi Finals (SF)</option>
                    <option value="QF">Quarter Finals (QF)</option>
                    <option value="GD">Group D</option>
                    <option value="GC">Group C</option>
                    <option value="GB">Group B</option>
                    <option value="GA">Group A</option>
                    <option value="ALL">All Rounds</option>
                </select>
                <button onclick="resetScores()" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition duration-150 w-full md:w-auto">
                    Reset Scores & Recalc
                </button>
            </div>
            
            <!-- Export Data CSV -->
            <div class="p-4 border rounded-lg mb-6 bg-green-50/50">
                <h3 class="text-lg font-semibold mb-3 text-green-700">Export Data (CSV)</h3>
                <p class="text-sm text-gray-600 mb-3">Download current tournament data as CSV files.</p>
                <button onclick="exportData('tL')" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg transition duration-150 mb-2 mr-2 w-full md:w-auto">
                    Export Team List & Players
                </button>
                <button onclick="exportData('matches')" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg transition duration-150 mb-2 mr-2 w-full md:w-auto">
                    Export All Match Results
                </button>
                <button onclick="exportData('teamStandings')" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg transition duration-150 mb-2 w-full md:w-auto">
                    Export Group Standings
                </button>
            </div>
            
            <!-- GitHub Save Functionality (Simulated) -->
            <div class="p-4 border rounded-lg bg-yellow-50/50">
                <h3 class="text-lg font-semibold mb-3 text-yellow-700">GitHub Save Simulation</h3>
                <p class="text-sm text-red-600 mb-3 font-semibold">‚ö† Note: Direct GitHub save requires a Backend Server. This function only simulates the process and displays the JSON output.</p>
                <label for="github-token" class="block text-sm font-medium text-gray-700">GitHub Personal Access Token (Simulated):</label>
                <input type="password" id="github-token" class="p-2 border rounded-md w-full my-2" placeholder="Enter GitHub token (optional for simulation)...">
                <button onclick="saveToGithub()" class="bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-2 px-4 rounded-lg transition duration-150 w-full md:w-auto">
                    Simulate Save JSON
                </button>
                <p id="github-message" class="mt-3 text-sm"></p>
                <textarea id="output-json" class="mt-4 w-full h-40 p-2 text-xs border rounded-md bg-gray-50" readonly placeholder="Output JSON ready for saving..."></textarea>
            </div>

        </div>
    </div>

    <!-- GLOBAL MODAL (CUSTOM ALERT/CONFIRM) -->
    <div id="modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden items-center justify-center p-4 z-50">
        <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-sm">
            <h3 id="modal-title" class="text-lg font-bold mb-3 text-teal-700">Notification</h3>
            <p id="modal-content" class="text-gray-700 mb-4"></p>
            <div class="flex justify-end space-x-3">
                <button id="modal-cancel-btn" class="px-4 py-2 bg-gray-300 text-gray-800 rounded-lg hover:bg-gray-400 hidden">Cancel</button>
                <button id="modal-ok-btn" class="px-4 py-2 bg-teal-600 text-white rounded-lg hover:bg-teal-700">OK</button>
            </div>
        </div>
    </div>

    <script>
    // --- INITIAL EMBEDDED JSON DATA (VIETNAMESE content preserved) ---
    const initialData = {
      "key_legend": { /* ... (Initial data) ... */ },
      "TournamentInfo": {
        "TN": "Pickleball ITVTG Tournament 2025",
        "Org": "IT Vung Tau Goup",
        "LogoL": "https://github.com/cqtin2024/ITVTG/blob/main/LogoITGVT01.png",
        "SD": "26-10-2025",
        "ED": "26-10-2025",
        "FTT": "14:00",
        "VL": "HM Sport - Pickleball & Coffee - 195 Vo Thi Sau, Vung Tau",
        "MapVL": "https://maps.app.goo.gl/KqqrpVqmVi4uNg7s7",
        "GL": "Quan nhau Thong Nhat - 56 Thong Nhat, Vung Tau",
        "GT": "18:30",
        "MapGL": "https://maps.app.goo.gl/Zbuo59wSeRsHP6E59"
      },
      "teamStandings": [
        { "g": "A", "W": 3, "L": 0, "HS": "11", "Pts": 9, "mP": 3, "GRank": 1, "T": "Team 9", "Tn": "Duy H∆∞ng-Minh T√∫", "PF": 33, "PA": 15, "PD": 18, "seed": "A1" },
        { "g": "A", "W": 2, "L": 1, "HS": "11", "Pts": 6, "mP": 3, "GRank": 2, "T": "Team 3", "Tn": "Qu·ªëc Th·ªãnh-Minh Ph∆∞∆°ng", "PF": 29, "PA": 22, "PD": 7, "seed": "A2" },
        { "g": "A", "W": 1, "L": 2, "HS": "11", "Pts": 3, "mP": 3, "GRank": 3, "T": "Team 11", "Tn": "Minh Chang-Minh Ch√¢u", "PF": 20, "PA": 29, "PD": -9, "seed": "A3" },
        { "g": "A", "W": 0, "L": 3, "HS": "0", "Pts": 0, "mP": 3, "GRank": 4, "T": "Team 5", "Tn": "Qu·ªëc Kh√°nh-Linh V≈©", "PF": 15, "PA": 31, "PD": -16, "seed": "A4" },
        
        { "g": "B", "W": 3, "L": 0, "HS": "11", "Pts": 9, "mP": 3, "GRank": 1, "T": "Team 4", "Tn": "Qu√≠ Tu·∫•n-M·∫°nh H√πng", "PF": 33, "PA": 12, "PD": 21, "seed": "B1" },
        { "g": "B", "W": 2, "L": 1, "HS": "11", "Pts": 6, "mP": 3, "GRank": 2, "T": "Team 7", "Tn": "Qu·ªëc H√πng-ƒê·ª©c Duy", "PF": 28, "PA": 20, "PD": 8, "seed": "B2" },
        { "g": "B", "W": 1, "L": 2, "HS": "11", "Pts": 3, "mP": 3, "GRank": 3, "T": "Team 12", "Tn": "Thanh S∆°n-Khoa Ti·∫øn", "PF": 17, "PA": 30, "PD": -13, "seed": "B3" },
        { "g": "B", "W": 0, "L": 3, "HS": "0", "Pts": 0, "mP": 3, "GRank": 4, "T": "Team 1", "Tn": "Quang Ti·∫øn-T·∫•t Th√†nh", "PF": 13, "PA": 29, "PD": -16, "seed": "B4" },
        
        { "g": "C", "W": 3, "L": 0, "HS": "11", "Pts": 9, "mP": 3, "GRank": 1, "T": "Team 16", "Tn": "Ho√†ng Thanh-C√¥ng Ph∆∞∆°ng", "PF": 33, "PA": 10, "PD": 23, "seed": "C1" },
        { "g": "C", "W": 2, "L": 1, "HS": "11", "Pts": 6, "mP": 3, "GRank": 2, "T": "Team 10", "Tn": "L√™ Duy-Thanh V∆∞∆°ng", "PF": 27, "PA": 18, "PD": 9, "seed": "C2" },
        { "g": "C", "W": 1, "L": 2, "HS": "11", "Pts": 3, "mP": 3, "GRank": 3, "T": "Team 14", "Tn": "VƒÉn C∆∞·ªùng-VƒÉn D≈©ng", "PF": 16, "PA": 29, "PD": -13, "seed": "C3" },
        { "g": "C", "W": 0, "L": 3, "HS": "0", "Pts": 0, "mP": 3, "GRank": 4, "T": "Team 6", "Tn": "ƒê√¥ng Chu-Ng·ªçc H√πng", "PF": 10, "PA": 29, "PD": -19, "seed": "C4" },
        
        { "g": "D", "W": 3, "L": 0, "HS": "11", "Pts": 9, "mP": 3, "GRank": 1, "T": "Team 13", "Tn": "B√° Ch√¢u-Hi·ªÅn Phong", "PF": 33, "PA": 14, "PD": 19, "seed": "D1" },
        { "g": "D", "W": 2, "L": 1, "HS": "11", "Pts": 6, "mP": 3, "GRank": 2, "T": "Team 8", "Tn": "Ti·∫øn M·∫°nh-Quang T√≠n", "PF": 28, "PA": 19, "PD": 9, "seed": "D2" },
        { "g": "D", "W": 1, "L": 2, "HS": "11", "Pts": 3, "mP": 3, "GRank": 3, "T": "Team 15", "Tn": "Minh Thi·ªán-Duy Minh", "PF": 15, "PA": 30, "PD": -15, "seed": "D3" },
        { "g": "D", "W": 0, "L": 3, "HS": "0", "Pts": 0, "mP": 3, "GRank": 4, "T": "Team 2", "Tn": "Vi·∫øt Tu·∫•n-Quang D≈©ng", "PF": 12, "PA": 31, "PD": -19, "seed": "D4" }
      ],
      "matches": [
        // GROUP A
        { "Mc": "GA1", "r": "GA", "t": "14:15", "c": "S3", "A": "Duy H∆∞ng-Minh T√∫", "sA": "11", "B": "Qu·ªëc Th·ªãnh-Minh Ph∆∞∆°ng", "sB": "5", "Wn": "Duy H∆∞ng-Minh T√∫" },
        { "Mc": "GA2", "r": "GA", "t": "14:15", "c": "S4", "A": "Minh Chang-Minh Ch√¢u", "sA": "11", "B": "Qu·ªëc Kh√°nh-Linh V≈©", "sB": "7", "Wn": "Minh Chang-Minh Ch√¢u" },
        { "Mc": "GA3", "r": "GA", "t": "14:45", "c": "S3", "A": "Duy H∆∞ng-Minh T√∫", "sA": "11", "B": "Minh Chang-Minh Ch√¢u", "sB": "6", "Wn": "Duy H∆∞ng-Minh T√∫" },
        { "Mc": "GA4", "r": "GA", "t": "14:45", "c": "S4", "A": "Qu·ªëc Th·ªãnh-Minh Ph∆∞∆°ng", "sA": "11", "B": "Qu·ªëc Kh√°nh-Linh V≈©", "sB": "4", "Wn": "Qu·ªëc Th·ªãnh-Minh Ph∆∞∆°ng" },
        { "Mc": "GA5", "r": "GA", "t": "15:15", "c": "S3", "A": "Duy H∆∞ng-Minh T√∫", "sA": "11", "B": "Qu·ªëc Kh√°nh-Linh V≈©", "sB": "4", "Wn": "Duy H∆∞ng-Minh T√∫" },
        { "Mc": "GA6", "r": "GA", "t": "15:15", "c": "S4", "A": "Qu·ªëc Th·ªãnh-Minh Ph∆∞∆°ng", "sA": "11", "B": "Minh Chang-Minh Ch√¢u", "sB": "3", "Wn": "Qu·ªëc Th·ªãnh-Minh Ph∆∞∆°ng" },
        
        // GROUP B
        { "Mc": "GB1", "r": "GB", "t": "14:30", "c": "S3", "A": "Qu√≠ Tu·∫•n-M·∫°nh H√πng", "sA": "11", "B": "Qu·ªëc H√πng-ƒê·ª©c Duy", "sB": "5", "Wn": "Qu√≠ Tu·∫•n-M·∫°nh H√πng" },
        { "Mc": "GB2", "r": "GB", "t": "14:30", "c": "S4", "A": "Thanh S∆°n-Khoa Ti·∫øn", "sA": "11", "B": "Quang Ti·∫øn-T·∫•t Th√†nh", "sB": "6", "Wn": "Thanh S∆°n-Khoa Ti·∫øn" },
        { "Mc": "GB3", "r": "GB", "t": "15:00", "c": "S3", "A": "Qu√≠ Tu·∫•n-M·∫°nh H√πng", "sA": "11", "B": "Thanh S∆°n-Khoa Ti·∫øn", "sB": "4", "Wn": "Qu√≠ Tu·∫•n-M·∫°nh H√πng" },
        { "Mc": "GB4", "r": "GB", "t": "15:00", "c": "S4", "A": "Qu·ªëc H√πng-ƒê·ª©c Duy", "sA": "11", "B": "Quang Ti·∫øn-T·∫•t Th√†nh", "sB": "7", "Wn": "Qu·ªëc H√πng-ƒê·ª©c Duy" },
        { "Mc": "GB5", "r": "GB", "t": "15:30", "c": "S3", "A": "Qu√≠ Tu·∫•n-M·∫°nh H√πng", "sA": "11", "B": "Quang Ti·∫øn-T·∫•t Th√†nh", "sB": "0", "Wn": "Qu√≠ Tu·∫•n-M·∫°nh H√πng" },
        { "Mc": "GB6", "r": "GB", "t": "15:30", "c": "S4", "A": "Qu·ªëc H√πng-ƒê·ª©c Duy", "sA": "11", "B": "Thanh S∆°n-Khoa Ti·∫øn", "sB": "2", "Wn": "Qu·ªëc H√πng-ƒê·ª©c Duy" },
        
        // GROUP C
        { "Mc": "GC1", "r": "GC", "t": "14:15", "c": "S5", "A": "Ho√†ng Thanh-C√¥ng Ph∆∞∆°ng", "sA": "11", "B": "L√™ Duy-Thanh V∆∞∆°ng", "sB": "3", "Wn": "Ho√†ng Thanh-C√¥ng Ph∆∞∆°ng" },
        { "Mc": "GC2", "r": "GC", "t": "14:15", "c": "S6", "A": "VƒÉn C∆∞·ªùng-VƒÉn D≈©ng", "sA": "11", "B": "ƒê√¥ng Chu-Ng·ªçc H√πng", "sB": "5", "Wn": "VƒÉn C∆∞·ªùng-VƒÉn D≈©ng" },
        { "Mc": "GC3", "r": "GC", "t": "14:45", "c": "S5", "A": "Ho√†ng Thanh-C√¥ng Ph∆∞∆°ng", "sA": "11", "B": "VƒÉn C∆∞·ªùng-VƒÉn D≈©ng", "sB": "3", "Wn": "Ho√†ng Thanh-C√¥ng Ph∆∞∆°ng" },
        { "Mc": "GC4", "r": "GC", "t": "14:45", "c": "S6", "A": "L√™ Duy-Thanh V∆∞∆°ng", "sA": "11", "B": "ƒê√¥ng Chu-Ng·ªçc H√πng", "sB": "3", "Wn": "L√™ Duy-Thanh V∆∞∆°ng" },
        { "Mc": "GC5", "r": "GC", "t": "15:15", "c": "S5", "A": "Ho√†ng Thanh-C√¥ng Ph∆∞∆°ng", "sA": "11", "B": "ƒê√¥ng Chu-Ng·ªçc H√πng", "sB": "2", "Wn": "Ho√†ng Thanh-C√¥ng Ph∆∞∆°ng" },
        { "Mc": "GC6", "r": "GC", "t": "15:15", "c": "S6", "A": "L√™ Duy-Thanh V∆∞∆°ng", "sA": "11", "B": "VƒÉn C∆∞·ªùng-VƒÉn D≈©ng", "sB": "2", "Wn": "L√™ Duy-Thanh V∆∞∆°ng" },
        
        // GROUP D
        { "Mc": "GD1", "r": "GD", "t": "14:30", "c": "S5", "A": "B√° Ch√¢u-Hi·ªÅn Phong", "sA": "11", "B": "Ti·∫øn M·∫°nh-Quang T√≠n", "sB": "6", "Wn": "B√° Ch√¢u-Hi·ªÅn Phong" },
        { "Mc": "GD2", "r": "GD", "t": "14:30", "c": "S6", "A": "Minh Thi·ªán-Duy Minh", "sA": "8", "B": "Vi·∫øt Tu·∫•n-Quang D≈©ng", "sB": "11", "Wn": "Vi·∫øt Tu·∫•n-Quang D≈©ng" },
        { "Mc": "GD3", "r": "GD", "t": "15:00", "c": "S5", "A": "B√° Ch√¢u-Hi·ªÅn Phong", "sA": "11", "B": "Minh Thi·ªán-Duy Minh", "sB": "5", "Wn": "B√° Ch√¢u-Hi·ªÅn Phong" },
        { "Mc": "GD4", "r": "GD", "t": "15:00", "c": "S6", "A": "Ti·∫øn M·∫°nh-Quang T√≠n", "sA": "11", "B": "Vi·∫øt Tu·∫•n-Quang D≈©ng", "sB": "4", "Wn": "Ti·∫øn M·∫°nh-Quang T√≠n" },
        { "Mc": "GD5", "r": "GD", "t": "15:30", "c": "S5", "A": "B√° Ch√¢u-Hi·ªÅn Phong", "sA": "11", "B": "Vi·∫øt Tu·∫•n-Quang D≈©ng", "sB": "8", "Wn": "B√° Ch√¢u-Hi·ªÅn Phong" },
        { "Mc": "GD6", "r": "GD", "t": "15:30", "c": "S6", "A": "Ti·∫øn M·∫°nh-Quang T√≠n", "sA": "11", "B": "Minh Thi·ªán-Duy Minh", "sB": "2", "Wn": "Ti·∫øn M·∫°nh-Quang T√≠n" },

        // KNOCKOUT (Group Winners/Runners-Up are placeholders for now)
        { "Mc": "QF1", "r": "QF", "t": "15:45", "c": "S3", "A": "W.A", "sA": "0", "B": "R.B", "sB": "0", "Wn": "" },
        { "Mc": "QF2", "r": "QF", "t": "15:45", "c": "S4", "A": "W.B", "sA": "0", "B": "R.A", "sB": "0", "Wn": "" },
        { "Mc": "QF3", "r": "QF", "t": "16:00", "c": "S5", "A": "W.C", "sA": "0", "B": "R.D", "sB": "0", "Wn": "" },
        { "Mc": "QF4", "r": "QF", "t": "16:00", "c": "S6", "A": "W.D", "sA": "0", "B": "R.C", "sB": "0", "Wn": "" },

        // SEMI-FINAL
        { "Mc": "SF1", "r": "SF", "t": "16:10", "c": "S4", "A": "W.QF1", "sA": "0", "B": "W.QF3", "sB": "0", "Wn": "" },
        { "Mc": "SF2", "r": "SF", "t": "16:25", "c": "S5", "A": "W.QF2", "sA": "0", "B": "W.QF4", "sB": "0", "Wn": "" },

        // FINAL
        { "Mc": "F", "r": "F", "t": "17:05", "c": "S5", "A": "W.SF1", "sA": "0", "B": "W.SF2", "sB": "0", "Wn": "", "rU": "" }
      ],
      "tL": [ /* ... (Initial data) ... */ ]
    };

    // --- GLOBAL STATE ---
    let tournamentState = JSON.parse(JSON.stringify(initialData));
    const TEAMS_BY_TN = {}; // Map Nickname to Team ID
    const TEAMS_BY_SEED = {}; // Map Seed (A1, B2) to Team Nickname

    // --- UTILITY FUNCTIONS ---

    // H√†m t√πy ch·ªânh hi·ªÉn th·ªã th√¥ng b√°o thay cho alert/confirm
    function showModal(title, content, isConfirm = false, onOk, onCancel) {
        document.getElementById('modal-title').textContent = title;
        document.getElementById('modal-content').textContent = content;
        
        const modal = document.getElementById('modal');
        const okBtn = document.getElementById('modal-ok-btn');
        const cancelBtn = document.getElementById('modal-cancel-btn');

        // Translate button text to English
        okBtn.textContent = isConfirm ? 'Confirm' : 'OK';
        cancelBtn.textContent = 'Cancel';

        okBtn.onclick = () => {
            modal.classList.add('hidden');
            modal.classList.remove('flex');
            if (onOk) onOk();
        };

        if (isConfirm) {
            cancelBtn.classList.remove('hidden');
            cancelBtn.onclick = () => {
                modal.classList.add('hidden');
                modal.classList.remove('flex');
                if (onCancel) onCancel();
            };
        } else {
            cancelBtn.classList.add('hidden');
        }

        modal.classList.remove('hidden');
        modal.classList.add('flex');
    }
    
    // Convert array of objects to CSV string
    function convertToCSV(objArray) {
        const array = typeof objArray != 'object' ? JSON.parse(objArray) : objArray;
        let str = '';

        // Header
        const header = Object.keys(array[0]);
        str += header.join(',') + '\r\n';

        // Rows
        for (let i = 0; i < array.length; i++) {
            let line = '';
            for (let index in array[i]) {
                if (line != '') line += ',';
                // Handle values containing commas
                let value = array[i][index];
                if (typeof value === 'object' && value !== null) {
                    value = JSON.stringify(value).replace(/"/g, '""');
                } else if (typeof value === 'string') {
                    value = value.replace(/"/g, '""');
                }
                line += '"' + value + '"';
            }
            str += line + '\r\n';
        }

        return str;
    }

    // Download CSV file
    function downloadCSV(csv, filename) {
        const csvFile = new Blob(["\ufeff" + csv], { type: "text/csv;charset=utf-8;" }); // Add BOM for UTF-8
        const downloadLink = document.createElement("a");
        downloadLink.download = filename;
        downloadLink.href = window.URL.createObjectURL(csvFile);
        downloadLink.style.display = "none";
        document.body.appendChild(downloadLink);
        downloadLink.click();
        document.body.removeChild(downloadLink);
    }
    
    // --- CORE LOGIC ---

    // 1. Kh·ªüi t·∫°o State v√† Map d·ªØ li·ªáu
    function initializeState() {
        tournamentState.tL.forEach(team => {
            TEAMS_BY_TN[team.Tn] = team.T;
            TEAMS_BY_SEED[team.seed] = team.Tn;
        });

        // Ensure all group matches have 'r' (Round Code)
        tournamentState.matches.forEach(match => {
            if (match.Mc.startsWith('G') && !match.r) {
                match.r = match.Mc.substring(0, 2);
            }
        });

        // Recalculate standings initially
        recalculateGroupStandings();
        updateKnockoutParticipants();
    }
    
    // 2. Recalculate Group Standings (T√≠nh W, L, PF, PA, PD, gR)
    function recalculateGroupStandings() {
        const groupStats = {};

        // Initialize stats for all teams
        tournamentState.tL.forEach(team => {
            groupStats[team.Tn] = { W: 0, L: 0, PF: 0, PA: 0, Pts: 0, mP: 0, HS: 0 };
        });

        // Calculate points from group matches
        const groupMatches = tournamentState.matches.filter(m => m.r.startsWith('G'));
        groupMatches.forEach(match => {
            const teamA = match.A;
            const teamB = match.B;
            const sA = parseInt(match.sA);
            const sB = parseInt(match.sB);

            if (!groupStats[teamA] || !groupStats[teamB] || match.Wn === "") return; // Skip if no result

            groupStats[teamA].mP++;
            groupStats[teamB].mP++;
            groupStats[teamA].PF += sA;
            groupStats[teamA].PA += sB;
            groupStats[teamB].PF += sB;
            groupStats[teamB].PA += sA;

            if (match.Wn === teamA) {
                groupStats[teamA].W++;
                groupStats[teamB].L++;
                groupStats[teamA].Pts += 3;
                groupStats[teamA].HS = Math.max(groupStats[teamA].HS, sA);
            } else if (match.Wn === teamB) {
                groupStats[teamB].W++;
                groupStats[teamA].L++;
                groupStats[teamB].Pts += 3;
                groupStats[teamB].HS = Math.max(groupStats[teamB].HS, sB);
            }
        });

        // Update and Rank (by Pts, then PD, then PF)
        ['A', 'B', 'C', 'D'].forEach(groupCode => {
            let teamsInGroup = tournamentState.teamStandings.filter(t => t.g === groupCode);

            teamsInGroup.forEach(team => {
                const stats = groupStats[team.Tn];
                if (stats) {
                    team.W = stats.W;
                    team.L = stats.L;
                    team.Pts = stats.Pts; // Gi·ªØ l·∫°i Pts cho vi·ªác s·∫Øp x·∫øp
                    team.mP = stats.mP;
                    team.PF = stats.PF;
                    team.PA = stats.PA;
                    team.PD = team.PF - team.PA;
                    team.HS = stats.HS;
                }
            });

            // Sort by: Pts (Desc), PD (Desc), PF (Desc)
            teamsInGroup.sort((a, b) => {
                if (b.Pts !== a.Pts) return b.Pts - a.Pts;
                if (b.PD !== a.PD) return b.PD - a.PD;
                return b.PF - a.PF;
            });

            // Update Group Rank
            teamsInGroup.forEach((team, index) => {
                team.GRank = index + 1;
            });
        });

        // Sort the entire array by Group and Rank
        tournamentState.teamStandings.sort((a, b) => {
            if (a.g < b.g) return -1;
            if (a.g > b.g) return 1;
            return a.GRank - b.GRank;
        });
    }

    // 3. Update Knockout Participants
    function updateKnockoutParticipants() {
        const getTeamByRank = (group, rank) => {
            const team = tournamentState.teamStandings.find(t => t.g === group && t.GRank === rank);
            return team ? team.Tn : (rank === 1 ? `W.${group}` : `R.${group}`);
        };

        const groupParticipants = {
            'W.A': getTeamByRank('A', 1), 'R.A': getTeamByRank('A', 2),
            'W.B': getTeamByRank('B', 1), 'R.B': getTeamByRank('B', 2),
            'W.C': getTeamByRank('C', 1), 'R.C': getTeamByRank('C', 2),
            'W.D': getTeamByRank('D', 1), 'R.D': getTeamByRank('D', 2),
        };

        const knockoutMatches = tournamentState.matches.filter(m => ['QF', 'SF', 'F'].includes(m.r));

        knockoutMatches.forEach(match => {
            // QF Setup
            if (match.r === 'QF') {
                match.A = groupParticipants[match.A] || match.A;
                match.B = groupParticipants[match.B] || match.B;
            }

            // SF and Final Setup (Replace placeholders with winners)
            if (['SF', 'F'].includes(match.r) && (match.A.startsWith('W.QF') || match.A.startsWith('W.SF'))) {
                const winnerA = tournamentState.matches.find(m => m.Mc === match.A.substring(2))?.Wn || match.A;
                const winnerB = tournamentState.matches.find(m => m.Mc === match.B.substring(2))?.Wn || match.B;
                
                // Only update if the winner is a real team name, not a placeholder
                if (!winnerA.startsWith('W.')) match.A = winnerA;
                if (!winnerB.startsWith('W.')) match.B = winnerB;
            }

            // Update Runner-Up for Final match
            if (match.r === 'F' && match.Wn) {
                match.rU = match.Wn === match.A ? match.B : match.A;
            }
        });
    }

    // 4. Manual Score Update (ƒê√£ ƒëi·ªÅu ch·ªânh ƒë·ªÉ l∆∞u tab hi·ªán t·∫°i v√† render l·∫°i)
    function updateMatchScore(mc, sA, sB) {
        const match = tournamentState.matches.find(m => m.Mc === mc);
        if (!match) {
            showModal("Update Error", `Match Code ${mc} not found. Please check again.`, false);
            return false;
        }

        sA = parseInt(sA);
        sB = parseInt(sB);

        // Validation: Winner score = 11, Loser score < 11
        if (sA === 11 && sB >= 0 && sB < 11) {
            match.sA = sA.toString();
            match.sB = sB.toString();
            match.Wn = match.A;
        } else if (sB === 11 && sA >= 0 && sA < 11) {
            match.sA = sA.toString();
            match.sB = sB.toString();
            match.Wn = match.B;
        } else {
            showModal("Score Error", `Invalid score (${sA}-${sB}). Score must be 11 - X (where X < 11).`, false);
            return false;
        }

        // --- B·∫Øt ƒë·∫ßu logic recalculate v√† re-render theo y√™u c·∫ßu ---
        
        // 1. L·∫•y tab hi·ªán t·∫°i (ƒë·ªÉ restore sau khi render l·∫°i to√†n b·ªô)
        const currentActiveTab = document.querySelector('.tab-content.active').id; 

        // 2. T√≠nh to√°n l·∫°i Group Standings (W, L, PF, PA, PD, GRank)
        if (match.r.startsWith('G')) {
            recalculateGroupStandings();
        }
        
        // 3. C·∫≠p nh·∫≠t c√°c ƒë·ªôi v√†o v√≤ng Knockout (ch·∫Øc ch·∫Øn lu√¥n ƒë∆∞·ª£c g·ªçi)
        updateKnockoutParticipants();
        
        // 4. Re-render UI
        renderApp();
        
        // 5. Restore tab hi·ªán t·∫°i ƒë·ªÉ ng∆∞·ªùi d√πng kh√¥ng b·ªã chuy·ªÉn sang tab Info
        changeTab(currentActiveTab);

        // Th√¥ng b√°o th√†nh c√¥ng v√† x√°c nh·∫≠n Standings ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t
        showModal("Success", `Updated score for match ${mc}: ${match.A} ${sA} - ${sB} ${match.B}. Winner: ${match.Wn}. Standings recalculated and updated.`, false);
        return true;
    }

    // 5. Calculate Final Results (Champion, Runner-up, Third Place)
    function calculateFinalResults() {
        const finalMatch = tournamentState.matches.find(m => m.r === 'F');
        const sfMatches = tournamentState.matches.filter(m => m.r === 'SF');

        const results = {
            champion: finalMatch?.Wn || "[TBD]",
            runnerUp: finalMatch?.rU || "[TBD]",
            thirdPlace: []
        };
        
        // Find 2 Semi-Final losers (Shared Third Place)
        sfMatches.forEach(match => {
            if (match.Wn && match.A !== match.Wn) {
                results.thirdPlace.push(match.A);
            }
            if (match.Wn && match.B !== match.Wn) {
                results.thirdPlace.push(match.B);
            }
        });

        // Filter out placeholders if any SF match hasn't determined the winner yet
        results.thirdPlace = [...new Set(results.thirdPlace)].filter(t => !t.startsWith('W.'));
        
        return results;
    }


    // --- RENDERING FUNCTIONS ---

    // Change Tab
    function changeTab(targetTabId) {
        document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
        document.getElementById(targetTabId).classList.add('active');
        
        document.querySelectorAll('.tab-button').forEach(btn => {
            if (btn.getAttribute('data-tab') === targetTabId) {
                btn.classList.add('active', 'bg-teal-600', 'text-white');
                btn.classList.remove('bg-white', 'text-teal-700');
            } else {
                btn.classList.remove('active', 'bg-teal-600', 'text-white');
                btn.classList.add('bg-white', 'text-teal-700');
            }
        });
    }

    // Render Info Tab
    function renderInfoTab() {
        const info = tournamentState.TournamentInfo;
        const totalTeams = tournamentState.tL.length;
        const detailsHtml = `
            <p><span class="font-bold">Tournament:</span> ${info.TN}</p>
            <p><span class="font-bold">Total Teams:</span> ${totalTeams} teams</p>
            <p><span class="font-bold">Date & Time:</span> ${info.SD} - ${info.ED} (${info.FTT})</p>
            <p><span class="font-bold">Venue:</span> <a href="${info.MapVL}" target="_blank" class="text-blue-500 hover:underline">${info.VL}</a></p>
            <p><span class="font-bold">Gala Dinner:</span> <a href="${info.MapGL}" target="_blank" class="text-blue-500 hover:underline">${info.GL}</a> (${info.GT})</p>
        `;
        document.getElementById('tournament-details').innerHTML = detailsHtml;

        // Render final results
        const finalResults = calculateFinalResults();
        document.getElementById('champion-team').textContent = finalResults.champion;
        
        // If champion is not determined, runner-up is also TBD
        if (finalResults.champion === "[TBD]") {
            document.getElementById('runnerup-team').textContent = "[TBD]";
        } else {
            // Find Runner-up based on Final match result
            const finalMatch = tournamentState.matches.find(m => m.r === 'F');
            const runnerUpName = finalMatch.Wn === finalMatch.A ? finalMatch.B : finalMatch.A;
            document.getElementById('runnerup-team').textContent = runnerUpName;
        }
        
        document.getElementById('third-place-1-team').textContent = finalResults.thirdPlace[0] || "[TBD]";
        document.getElementById('third-place-2-team').textContent = finalResults.thirdPlace[1] || "[TBD]";
    }

    // Render Group Tab (A, B, C, D)
    function renderGroupTab(groupCode) {
        const tabElement = document.getElementById(`group-${groupCode.toLowerCase()}`);
        // S·∫Øp x·∫øp c√°c ƒë·ªôi theo GRank ƒë√£ t√≠nh to√°n
        const groupTeams = tournamentState.teamStandings.filter(t => t.g === groupCode).sort((a, b) => a.GRank - b.GRank);
        const groupMatches = tournamentState.matches.filter(m => m.r === `G${groupCode}`).sort((a, b) => a.Mc.localeCompare(b.Mc));

        let html = `<h2 class="text-xl font-semibold mb-4 text-teal-600">Group ${groupCode}</h2>`;

        // 1. Standings Table
        html += `<h3 class="text-lg font-medium mb-2 text-gray-700">Group Standings</h3>`;
        html += `<div class="table-wrapper mb-6"><table class="text-sm md:text-base bg-white shadow-sm rounded-lg overflow-hidden">
                    <thead class="bg-teal-500 text-white">
                        <tr>
                            <th class="rounded-tl-lg">Rank</th>
                            <th>Team Name (Tn)</th>
                            <th>W</th>
                            <th>L</th>
                            <th>PF</th>
                            <th>PA</th>
                            <th class="rounded-tr-lg">PD</th>
                        </tr>
                    </thead><tbody>`;
        
        groupTeams.forEach(team => {
            html += `<tr class="hover:bg-gray-50 transition duration-100">
                        <td class="font-bold text-center">${team.GRank}</td>
                        <td>${team.Tn}</td>
                        <td class="text-center">${team.W}</td>
                        <td class="text-center">${team.L}</td>
                        <td class="text-center">${team.PF}</td>
                        <td class="text-center">${team.PA}</td>
                        <td class="font-semibold text-center ${team.PD > 0 ? 'text-green-600' : team.PD < 0 ? 'text-red-600' : 'text-gray-500'}">${team.PD}</td>
                    </tr>`;
        });
        html += `</tbody></table></div>`;

        // 2. Match Results & Update (S·ª≠ d·ª•ng class match-table cho CSS t·ªëi ∆∞u mobile)
        html += `<h3 class="text-lg font-medium mb-2 text-gray-700">Match Results & Update</h3>`;
        html += `<div class="table-wrapper"><table class="match-table text-sm md:text-base bg-white shadow-sm rounded-lg overflow-hidden">
                    <thead class="bg-gray-700 text-white">
                        <tr>
                            <th class="mc-cell">Mc</th>
                            <th class="time-cell">T</th>
                            <th class="court-cell">C</th>
                            <th colspan="3" class="text-center">Score</th>
                            <th>Action</th>
                        </tr>
                    </thead><tbody>`;

        groupMatches.forEach(match => {
            const isWinnerA = match.Wn === match.A;
            const isWinnerB = match.Wn === match.B;
            
            // D√πng <wbr> (Word Break Opportunity) ƒë·ªÉ g·ª£i √Ω xu·ªëng d√≤ng sau d·∫•u -
            const teamAHtml = match.A.replace('-', '<wbr>-');
            const teamBHtml = match.B.replace('-', '<wbr>-');
            
            html += `<tr class="group-match-row hover:bg-gray-50 transition duration-100" data-mc="${match.Mc}">
                        <td class="mc-cell">${match.Mc}</td>
                        <td class="time-cell">${match.t}</td>
                        <td class="court-cell">${match.c}</td>
                        
                        <!-- Team A Name: Highlight if winner -->
                        <td class="team-name-cell ${isWinnerA ? 'font-bold text-teal-600' : ''}">${teamAHtml}</td>
                        
                        <td class="score-input-cell flex items-center justify-center space-x-1">
                            <input type="number" min="0" max="11" value="${match.sA}" class="score-input border rounded-md" data-team="A">
                            <span class="font-bold">-</span>
                            <input type="number" min="0" max="11" value="${match.sB}" class="score-input border rounded-md" data-team="B">
                        </td>
                        
                        <!-- Team B Name: Highlight if winner -->
                        <td class="team-name-cell ${isWinnerB ? 'font-bold text-teal-600' : ''}">${teamBHtml}</td>
                        
                        <!-- Action Button: Changed to "Save" -->
                        <td>
                            <button onclick="handleManualUpdate('${match.Mc}')" class="update-btn bg-teal-500 hover:bg-teal-600 text-white text-xs font-bold py-1 px-2 rounded-md transition duration-150">Save</button>
                        </td>
                    </tr>`;
        });

        html += `</tbody></table></div>`;
        tabElement.innerHTML = html;
    }

    // Render Final Tab (QF, SF, F)
    function renderFinalTab() {
        const tabElement = document.getElementById('final-knockout-matches');
        const knockoutMatches = tournamentState.matches.filter(m => ['QF', 'SF', 'F'].includes(m.r));
        
        let html = '';
        const rounds = { 'QF': 'Quarter Finals', 'SF': 'Semi Finals', 'F': 'Final' };

        Object.keys(rounds).forEach(roundCode => {
            const matchesInRound = knockoutMatches.filter(m => m.r === roundCode).sort((a, b) => a.Mc.localeCompare(b.Mc));
            
            if (matchesInRound.length > 0) {
                html += `<h3 class="text-lg font-medium my-4 p-2 bg-gray-100 border-l-4 border-teal-500 text-gray-700">${rounds[roundCode]}</h3>`;
                html += `<div class="table-wrapper mb-6"><table class="match-table text-sm md:text-base bg-white shadow-sm rounded-lg overflow-hidden">
                            <thead class="bg-teal-500 text-white">
                                <tr>
                                    <th class="mc-cell">Mc</th>
                                    <th class="time-cell">T</th>
                                    <th class="court-cell">C</th>
                                    <th colspan="3" class="text-center">Score</th>
                                    <th>Action</th>
                                </tr>
                            </thead><tbody>`;
                
                matchesInRound.forEach(match => {
                    const isWinnerA = match.Wn === match.A;
                    const isWinnerB = match.Wn === match.B;
                    
                    // D√πng <wbr> (Word Break Opportunity) ƒë·ªÉ g·ª£i √Ω xu·ªëng d√≤ng sau d·∫•u -
                    const teamAHtml = match.A.replace('-', '<wbr>-');
                    const teamBHtml = match.B.replace('-', '<wbr>-');

                    html += `<tr class="group-match-row hover:bg-gray-50 transition duration-100" data-mc="${match.Mc}">
                                <td class="mc-cell">${match.Mc}</td>
                                <td class="time-cell">${match.t}</td>
                                <td class="court-cell">${match.c}</td>
                                
                                <!-- Team A Name: Highlight if winner -->
                                <td class="team-name-cell ${isWinnerA ? 'font-bold text-teal-600' : ''}">${teamAHtml}</td>
                                
                                <td class="score-input-cell flex items-center justify-center space-x-1">
                                    <input type="number" min="0" max="11" value="${match.sA}" class="score-input border rounded-md" data-team="A">
                                    <span class="font-bold">-</span>
                                    <input type="number" min="0" max="11" value="${match.sB}" class="score-input border rounded-md" data-team="B">
                                </td>
                                
                                <!-- Team B Name: Highlight if winner -->
                                <td class="team-name-cell ${isWinnerB ? 'font-bold text-teal-600' : ''}">${teamBHtml}</td>
                                
                                <!-- Action Button: Changed to "Save" -->
                                <td>
                                    <button onclick="handleManualUpdate('${match.Mc}')" class="update-btn bg-teal-500 hover:bg-teal-600 text-white text-xs font-bold py-1 px-2 rounded-md transition duration-150">Save</button>
                                </td>
                            </tr>`;
                });
                
                html += `</tbody></table></div>`;
            }
        });

        tabElement.innerHTML = html;
    }

    // Overall Render Function
    function renderApp() {
        // Update teams for knockout rounds
        updateKnockoutParticipants();

        // Render all dynamic tabs
        renderInfoTab();
        renderGroupTab('A');
        renderGroupTab('B');
        renderGroupTab('C');
        renderGroupTab('D');
        renderFinalTab();
    }


    // --- EVENT HANDLERS ---

    // Manual Update Handler
    window.handleManualUpdate = (mc) => {
        const row = document.querySelector(`tr[data-mc="${mc}"]`);
        const sA = row.querySelector('input[data-team="A"]').value;
        const sB = row.querySelector('input[data-team="B"]').value;

        updateMatchScore(mc, sA, sB);
    };

    // Randomize Scores Handler
    window.randomizeScores = () => {
        const roundCode = document.getElementById('random-round-select').value;
        const roundsToUpdate = roundCode === 'ALL' ? ['GA', 'GB', 'GC', 'GD', 'QF', 'SF', 'F'] : [roundCode];
        let updatedCount = 0;
        
        const currentActiveTab = document.querySelector('.tab-content.active').id; 

        const executeRandomUpdate = (r) => {
            const matchesInRound = tournamentState.matches.filter(m => m.r === r);

            matchesInRound.forEach(match => {
                // Only random if no result yet (or teams are still placeholders in KO)
                if (match.Wn === "" || match.A.startsWith('W.') || match.B.startsWith('R.')) {
                    
                    // Re-determine participants if needed (crucial for QF, SF, F)
                    updateKnockoutParticipants();
                    
                    // Re-check after updateKnockoutParticipants
                    if (match.A.startsWith('W.') || match.B.startsWith('R.')) return;

                    // Generate valid random score (11 vs X < 11)
                    let scoreA, scoreB;
                    // Randomly choose winner
                    if (Math.random() < 0.5) { // A wins
                        scoreA = 11;
                        scoreB = Math.floor(Math.random() * 11); // 0-10
                    } else { // B wins
                        scoreB = 11;
                        scoreA = Math.floor(Math.random() * 11); // 0-10
                    }
                    
                    match.sA = scoreA.toString();
                    match.sB = scoreB.toString();
                    match.Wn = scoreA > scoreB ? match.A : match.B;
                    
                    updatedCount++;
                }
            });
            return updatedCount;
        };

        // Random in order: GA -> GD -> QF -> SF -> F
        const sortedRounds = ['GA', 'GB', 'GC', 'GD', 'QF', 'SF', 'F'];
        sortedRounds.forEach(r => {
            if (roundsToUpdate.includes(r)) {
                executeRandomUpdate(r);
            }
        });

        // After randomizing, recalculate group standings (if updated)
        if (roundsToUpdate.some(r => r.startsWith('G'))) {
            recalculateGroupStandings();
        }
        
        // Update knockout participants again
        updateKnockoutParticipants();
        
        renderApp();
        changeTab(currentActiveTab); // Restore tab
        showModal("Randomization Complete", `Successfully generated and updated ${updatedCount} matches in round(s) ${roundCode}.`, false);
    };

    // Reset Scores Handler
    window.resetScores = () => {
        const roundCode = document.getElementById('reset-round-select').value;
        const roundsToReset = roundCode === 'ALL' ? ['F', 'SF', 'QF', 'GD', 'GC', 'GB', 'GA'] : [roundCode];

        showModal(
            "Confirm Reset", 
            `Are you sure you want to CLEAR the results for all matches in ${roundCode} and recalculate? This action cannot be undone.`, 
            true, 
            () => {
                let resetCount = 0;
                
                const currentActiveTab = document.querySelector('.tab-content.active').id; 

                // Reset in order F -> SF -> QF -> GD -> GA (reverse dependency)
                const sortedRounds = ['F', 'SF', 'QF', 'GD', 'GC', 'GB', 'GA'];
                sortedRounds.forEach(r => {
                    if (roundsToReset.includes(r)) {
                        tournamentState.matches.filter(m => m.r === r).forEach(match => {
                            match.sA = "0";
                            match.sB = "0";
                            match.Wn = "";
                            if (match.r === 'F') match.rU = "";
                            resetCount++;
                        });
                    }
                });

                // Reset knockout teams to initial placeholders if group stage is reset
                if (roundsToReset.some(r => r.startsWith('G')) || roundCode === 'ALL') {
                     tournamentState.matches.filter(m => m.r === 'QF').forEach(match => {
                        if (match.Mc === 'QF1') { match.A = 'W.A'; match.B = 'R.B'; }
                        if (match.Mc === 'QF2') { match.A = 'W.B'; match.B = 'R.A'; }
                        if (match.Mc === 'QF3') { match.A = 'W.C'; match.B = 'R.D'; }
                        if (match.Mc === 'QF4') { match.A = 'W.D'; match.B = 'R.C'; }
                    });
                }
                
                // Recalculate group standings (if needed)
                if (roundsToReset.some(r => r.startsWith('G'))) {
                    recalculateGroupStandings();
                }

                // Update knockout participants
                updateKnockoutParticipants();
                
                renderApp();
                changeTab(currentActiveTab); // Restore tab
                showModal("Reset Complete", `Successfully cleared scores for ${resetCount} matches in round(s) ${roundCode}.`, false);
            }
        );
    };

    // Export Data CSV Handler
    window.exportData = (dataType) => {
        let data, filename, headers;
        
        if (dataType === 'tL') {
            data = tournamentState.tL.map(team => {
                const players = team.P.map(p => `${p.name} (${p.bY})`).join(' | ');
                return { 
                    'Group': team.g, 
                    'Team ID': team.T, 
                    'Nickname': team.Tn, 
                    'Avg Pick Level': team.aPL, 
                    'Players': players 
                };
            });
            filename = 'team_list_players.csv';
        } else if (dataType === 'matches') {
            data = tournamentState.matches;
            filename = 'all_matches_results.csv';
        } else if (dataType === 'teamStandings') {
            // Use calculated fields
            data = tournamentState.teamStandings.map(s => ({
                'Group': s.g,
                'Rank': s.GRank,
                'Nickname': s.Tn,
                'W': s.W,
                'L': s.L,
                'Pts': s.Pts,
                'Played': s.mP,
                'PF': s.PF,
                'PA': s.PA,
                'PD': s.PD,
            }));
            filename = 'group_standings.csv';
        } else {
            return;
        }

        const csv = convertToCSV(data);
        downloadCSV(csv, filename);
    };

    // GitHub Save Simulation Handler
    window.saveToGithub = () => {
        const messageElement = document.getElementById('github-message');
        const outputJsonElement = document.getElementById('output-json');
        
        // Create final JSON (entire state)
        const finalJson = JSON.stringify(tournamentState, null, 2);
        outputJsonElement.value = finalJson;
        
        // Simulation logic
        const token = document.getElementById('github-token').value.trim();

        if (!token) {
            messageElement.textContent = "‚ö† Paste this JSON into the data/statex.json file on GitHub. Automated saving requires a Token and Backend.";
            messageElement.classList.remove('text-green-600', 'text-red-600');
            messageElement.classList.add('text-yellow-600', 'font-bold');
            outputJsonElement.focus();
            outputJsonElement.select();
            showModal("Save Simulation", "Due to security limits, you must manually paste the exported JSON content into the file on GitHub.", false);
            return;
        }

        // If token is present (simulated success for user feedback)
        messageElement.textContent = "‚úÖ Simulation successful! JSON created. If a real Backend were connected, it would now be pushed to GitHub.";
        messageElement.classList.remove('text-yellow-600', 'text-red-600');
        messageElement.classList.add('text-green-600', 'font-bold');
        outputJsonElement.focus();
        outputJsonElement.select();

    };


    // --- INITIALIZATION ---

    document.addEventListener('DOMContentLoaded', () => {
        // 1. Initialize data and initial calculations
        initializeState();

        // 2. Render UI for the first time
        renderApp();
        
        // 3. Set up Event Listener for Tabs
        document.querySelectorAll('.tab-button').forEach(button => {
            button.addEventListener('click', (e) => {
                changeTab(e.target.getAttribute('data-tab'));
            });
        });
        
        // Set default tab to Info
        changeTab('info');
    });

    </script>
</body>
</html>
