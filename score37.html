<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pickleball Tournament Management (GitHub Sync)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100;400;700;900&display=swap" rel="stylesheet">
    <style>
        /* Base styles for Dark Mode */
        :root {
            --bg-color: #111827; /* Gray-900 */
            --text-color: #f3f4f6; /* Gray-100 */
            --card-bg: #1f2937; /* Gray-800 */
            --border-color: #374151; /* Gray-700 */
            --accent-color: #06b6d4; /* Cyan-500 */
            --match-bg: #1f2937;
            --input-bg: #4b5563; /* Gray-600 */
            --group-header-text: #60a5fa; /* Blue-400 */
        }
        
        /* Light Mode Overrides */
        .light-mode {
            --bg-color: #f9fafb; /* Gray-50 */
            --text-color: #111827; /* Gray-900 */
            --card-bg: #ffffff; /* White */
            --border-color: #e5e7eb; /* Gray-200 */
            --accent-color: #0ea5e9; /* Sky-500 */
            --match-bg: #f3f4f6; /* Gray-100 */
            --input-bg: #e5e7eb; /* Gray-200 */
            --group-header-text: #1d4ed8; /* Blue-700 */
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            transition: background-color 0.3s, color 0.3s;
        }

        .card {
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
        }

        .score-input, .text-input {
            background-color: var(--input-bg);
            color: var(--text-color);
        }

        .tab-button {
            transition: all 0.2s;
        }

        .tab-button.active {
            border-color: var(--accent-color);
            color: var(--accent-color);
        }
        
        .match-card {
            background-color: var(--match-bg);
        }

        .group-header {
            color: var(--group-header-text);
        }
        
        /* Utility for mobile swipe */
        #app {
            overflow-x: hidden;
        }

        .tab-content {
            width: 100%;
            flex-shrink: 0;
            transition: transform 0.3s ease-in-out;
        }
        
        .active-tab-container {
            display: flex;
            width: 500%; /* For 5 tabs: Group, QF, SF, Final, Settings */
        }
    </style>
</head>
<body class="p-4">
    <div id="app" class="max-w-4xl mx-auto">
        
        <header class="flex justify-between items-center mb-4">
            <h1 class="text-2xl font-bold text-accent-color">Pickleball Tour</h1>
            <button id="themeToggle" class="p-2 rounded-full card">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" />
                </svg>
            </button>
        </header>

        <div class="flex border-b border-border-color mb-4 sticky top-0 bg-bg-color z-10">
            <button class="tab-button flex-1 py-2 px-1 text-sm font-medium border-b-2 border-transparent active" data-tab="group">Vòng Bảng</button>
            <button class="tab-button flex-1 py-2 px-1 text-sm font-medium border-b-2 border-transparent" data-tab="qf">Tứ kết</button>
            <button class="tab-button flex-1 py-2 px-1 text-sm font-medium border-b-2 border-transparent" data-tab="sf">Bán kết</button>
            <button class="tab-button flex-1 py-2 px-1 text-sm font-medium border-b-2 border-transparent" data-tab="final">Chung kết & Giải</button>
            <button class="tab-button flex-1 py-2 px-1 text-sm font-medium border-b-2 border-transparent" data-tab="settings">Cài đặt</button>
        </div>
        
        <div class="overflow-hidden">
            <div id="tabContentContainer" class="active-tab-container">
                <div id="group" class="tab-content">
                    </div>
                
                <div id="qf" class="tab-content hidden">
                    <h2 class="text-xl font-bold mb-3 group-header">TỨ KẾT</h2>
                    <div id="quarterfinals-matches" class="space-y-4"></div>
                </div>

                <div id="sf" class="tab-content hidden">
                    <h2 class="text-xl font-bold mb-3 group-header">BÁN KẾT</h2>
                    <div id="semifinals-matches" class="space-y-4"></div>
                </div>
                
                <div id="final" class="tab-content hidden">
                    <h2 class="text-xl font-bold mb-3 group-header">CHUNG KẾT</h2>
                    <div id="final-match" class="space-y-4"></div>
                    <div id="final-ranks-summary" class="mt-8 p-4 card">
                        <h3 class="text-lg font-bold mb-3 group-header">XẾP HẠNG CHUNG CUỘC</h3>
                        </div>
                </div>

                <div id="settings" class="tab-content hidden">
                    <h2 class="text-xl font-bold mb-4 group-header">CÀI ĐẶT & ĐỒNG BỘ</h2>
                    <div class="card p-4 mb-4 space-y-3">
                        <h3 class="text-lg font-semibold">Cấu hình GitHub</h3>
                        <input id="githubRepo" type="text" placeholder="Tên repo (vd: user/repo)" class="text-input w-full p-2 rounded" value="">
                        <input id="githubBranch" type="text" placeholder="Branch (vd: main)" class="text-input w-full p-2 rounded" value="main">
                        <input id="githubToken" type="password" placeholder="Token cá nhân (Personal Access Token)" class="text-input w-full p-2 rounded">
                        <div class="flex space-x-2">
                            <button onclick="saveGitHubSettings()" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded transition">Lưu Cấu hình</button>
                            <button onclick="loadDataFromGitHub()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded transition">Tải dữ liệu</button>
                        </div>
                    </div>

                    <div class="card p-4 space-y-3">
                        <h3 class="text-lg font-semibold">Thao tác Dữ liệu</h3>
                        <button onclick="commitChanges()" class="w-full bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-2 px-4 rounded transition">ĐỒNG BỘ LÊN GITHUB</button>
                        <button onclick="reSyncStaticDataPrompt()" class="w-full bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-2 px-4 rounded transition">Làm mới Cấu trúc Giải (CẨN THẬN)</button>
                        <button onclick="clearLocalStorage()" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded transition">Xóa Cấu hình Đã Lưu</button>
                    </div>
                    
                    <p class="text-sm text-gray-400 mt-4" id="lastSyncStatus">Chưa đồng bộ.</p>
                </div>
            </div>
        </div>
        
        <div id="confirmationBox" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
            <div class="bg-card p-6 rounded-lg shadow-xl max-w-sm mx-4">
                <h3 class="text-xl font-bold mb-4 text-red-400">CẢNH BÁO</h3>
                <p class="mb-4">Bạn có chắc chắn muốn **LÀM MỚI CẤU TRÚC GIẢI ĐẤU** từ file `state3.json` không? Thao tác này sẽ **XÓA HẾT MỌI TỈ SỐ ĐÃ NHẬP**.</p>
                <div class="flex justify-end space-x-3">
                    <button id="confirmNo" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded">Hủy</button>
                    <button id="confirmYes" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded">ĐỒNG Ý (Xóa Tỉ số)</button>
                </div>
            </div>
        </div>

    </div>

    <script>
        // --- GLOBAL VARIABLES ---
        let tournamentData = null; // Dữ liệu state3.json (cấu trúc gốc)
        let scoreDiffData = {};    // Dữ liệu state3s.json (tỉ số đã thay đổi)
        let githubConfig = {};
        let currentTab = 'group';
        let startX = 0;
        let endX = 0;
        
        const GROUP_ORDER = ['A', 'B', 'C', 'D'];
        const GROUP_SCORE_WIN = 3;
        
        // --- UTILITY FUNCTIONS ---
        function getGitHubConfig() {
            try {
                const config = localStorage.getItem('githubConfig');
                if (config) {
                    githubConfig = JSON.parse(config);
                } else {
                    githubConfig = { repo: '', branch: 'main', token: '' };
                }
            } catch (e) {
                console.error("Error loading config:", e);
                githubConfig = { repo: '', branch: 'main', token: '' };
            }
        }
        
        function saveGitHubSettings() {
            githubConfig.repo = document.getElementById('githubRepo').value.trim();
            githubConfig.branch = document.getElementById('githubBranch').value.trim() || 'main';
            // Không lưu Token nếu nó là '********' (chỉ thay đổi khi người dùng nhập mới)
            const tokenInput = document.getElementById('githubToken').value.trim();
            if (tokenInput !== '********') {
                githubConfig.token = tokenInput;
            }
            localStorage.setItem('githubConfig', JSON.stringify(githubConfig));
            alert('Đã lưu cấu hình GitHub!');
            loadDataFromGitHub(); // Tải lại dữ liệu sau khi lưu config
        }
        
        function clearLocalStorage() {
            localStorage.removeItem('githubConfig');
            localStorage.removeItem('darkMode');
            alert('Đã xóa cấu hình GitHub và Theme đã lưu.');
            window.location.reload();
        }

        function toggleTheme() {
            const body = document.body;
            body.classList.toggle('light-mode');
            const isLight = body.classList.contains('light-mode');
            localStorage.setItem('darkMode', !isLight); // Lưu trạng thái ngược lại
        }
        
        function applyTheme() {
            const isDark = localStorage.getItem('darkMode') !== 'false'; // Mặc định là Dark
            if (!isDark) {
                 document.body.classList.add('light-mode');
            }
        }
        
        // --- GITHUB API FUNCTIONS ---
        
        async function fetchGitHubFile(filename) {
            if (!githubConfig.repo || !githubConfig.token) {
                console.error(`Missing GitHub config for ${filename}`);
                // Bỏ qua lỗi 404 cho state3s.json (dữ liệu tỉ số có thể chưa tồn tại)
                if (filename === 'state3s.json') return {}; 
                document.getElementById('lastSyncStatus').textContent = 'LỖI: Vui lòng nhập cấu hình GitHub và Token hợp lệ.';
                return null;
            }
            
            // Xử lý trường hợp branch không được điền. Mặc định là main
            const branchRef = githubConfig.branch || 'main';
            const url = `https://api.github.com/repos/${githubConfig.repo}/contents/${filename}?ref=${branchRef}`;
            
            try {
                const response = await fetch(url, {
                    headers: {
                        'Authorization': `token ${githubConfig.token}`,
                        'Accept': 'application/vnd.github.v3.raw'
                    }
                });
                
                if (!response.ok) {
                     // Nếu là state3s.json và không tồn tại (404), trả về đối tượng rỗng
                    if (filename === 'state3s.json' && response.status === 404) return {};
                    throw new Error(`GitHub API error for ${filename}: ${response.statusText} (Status: ${response.status})`);
                }
                
                const data = await response.json();
                document.getElementById('lastSyncStatus').textContent = `Tải file ${filename} thành công lúc: ${new Date().toLocaleTimeString()}`;
                return data;
            } catch (error) {
                console.error(`Error fetching ${filename}:`, error.message);
                document.getElementById('lastSyncStatus').textContent = `LỖI tải file ${filename}: ${error.message}`;
                return null;
            }
        }
        
        async function getFileSha(filename) {
            if (!githubConfig.repo || !githubConfig.token) return null;
             
            const branchRef = githubConfig.branch || 'main';
            const url = `https://api.github.com/repos/${githubConfig.repo}/contents/${filename}?ref=${branchRef}`;
            
            try {
                const response = await fetch(url, {
                    headers: {
                        'Authorization': `token ${githubConfig.token}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                
                if (!response.ok) {
                     // Nếu file chưa tồn tại (404), trả về null (không phải lỗi)
                    if (response.status === 404) return null;
                    throw new Error(`GitHub API error for SHA ${filename}: ${response.statusText}`);
                }
                
                const data = await response.json();
                return data.sha;
            } catch (error) {
                console.error(`Error fetching SHA for ${filename}:`, error.message);
                return null;
            }
        }
        
        async function uploadGitHubFile(filename, content, commitMessage) {
            if (!githubConfig.repo || !githubConfig.token) {
                alert('Lỗi: Thiếu cấu hình Repo hoặc Token GitHub.');
                return false;
            }
            
            const sha = await getFileSha(filename);
            const contentBase64 = btoa(unescape(encodeURIComponent(JSON.stringify(content, null, 2))));
            
            const data = {
                message: commitMessage,
                content: contentBase64,
                branch: githubConfig.branch || 'main'
            };
            
            if (sha) {
                data.sha = sha; // Chỉ thêm SHA nếu file đã tồn tại
            }
            
            const url = `https://api.github.com/repos/${githubConfig.repo}/contents/${filename}`;
            
            try {
                const response = await fetch(url, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `token ${githubConfig.token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`Upload failed for ${filename}: ${response.statusText}. Details: ${JSON.stringify(errorData)}`);
                }
                
                document.getElementById('lastSyncStatus').textContent = `ĐỒNG BỘ ${filename} thành công lúc: ${new Date().toLocaleTimeString()}`;
                return true;
            } catch (error) {
                console.error(`Error uploading ${filename}:`, error.message);
                alert(`LỖI ĐỒNG BỘ ${filename}: ${error.message}`);
                return false;
            }
        }
        
        async function loadDataFromGitHub() {
            getGitHubConfig();
            
            if (!githubConfig.repo || !githubConfig.token) {
                document.getElementById('lastSyncStatus').textContent = 'Vui lòng nhập cấu hình GitHub và nhấn "Lưu Cấu hình".';
                return;
            }

            // 1. Tải state3.json (Cấu trúc gốc)
            const staticData = await fetchGitHubFile('state3.json');
            
            if (!staticData) {
                 // Nếu không tải được cấu trúc gốc, dừng lại và chỉ hiển thị giao diện mặc định
                tournamentData = null;
                runAllLogic(); 
                return;
            }
            
            tournamentData = staticData;

            // 2. Tải state3s.json (Tỉ số thay đổi)
            const diffData = await fetchGitHubFile('state3s.json');
            // diffData sẽ là {} nếu file không tồn tại hoặc có lỗi (xem fetchGitHubFile)
            scoreDiffData = diffData || {}; 
            
            runAllLogic();
        }
        
        // --- MATCH & SCORE LOGIC ---
        
        function calculateWinner(match, includeScoreDiff = true) {
            let sA, sB;
            if (includeScoreDiff) {
                const diff = scoreDiffData[match.Id] || {};
                sA = diff.sA !== undefined ? diff.sA : match.sA;
                sB = diff.sB !== undefined ? diff.sB : match.sB;
            } else {
                sA = match.sA;
                sB = match.sB;
            }

            // Chỉ tính nếu có đủ điểm hợp lệ
            if (sA === null || sB === null || isNaN(sA) || isNaN(sB)) {
                return { winnerId: null, loserId: null };
            }

            if (sA > sB) {
                return { winnerId: match.pA, loserId: match.pB };
            } else if (sB > sA) {
                return { winnerId: match.pB, loserId: match.pA };
            } else {
                return { winnerId: null, loserId: null }; // Hòa hoặc điểm bằng nhau
            }
        }

        function updateScore(matchId, participant, score) {
            const scoreValue = parseInt(score);
            if (isNaN(scoreValue)) return; // Bỏ qua nếu không phải số
            
            // Tìm trận đấu gốc trong tournamentData (ở bất cứ đâu)
            let match = findMatchById(matchId);
            if (!match) return;

            // Cập nhật vào scoreDiffData
            if (!scoreDiffData[matchId]) {
                scoreDiffData[matchId] = {};
            }
            
            if (participant === 'pA') {
                scoreDiffData[matchId].sA = scoreValue;
            } else if (participant === 'pB') {
                scoreDiffData[matchId].sB = scoreValue;
            }

            // Nếu đây là trận Knockout, phải chạy lại logic để xác định đội đi tiếp
            if (match.round === 'quarterfinals' || match.round === 'semifinals' || match.round === 'final') {
                runAllLogic();
            } else {
                 // Nếu là trận Vòng Bảng, chỉ cần chạy lại logic của Vòng Bảng và render lại
                recalculateAndSortGroupTables();
                renderGroupSection();
            }
        }
        
        function findMatchById(matchId) {
            if (!tournamentData) return null;
            
            // Kiểm tra vòng bảng
            for (const groupKey in tournamentData.groups) {
                const group = tournamentData.groups[groupKey];
                const match = group.matches.find(m => m.Id === matchId);
                if (match) {
                    match.round = 'group';
                    return match;
                }
            }
            
            // Kiểm tra vòng Knockout
            const rounds = ['quarterfinals', 'semifinals', 'final'];
            for (const round of rounds) {
                const matches = tournamentData[round];
                if (matches && Array.isArray(matches)) {
                    const match = matches.find(m => m.Id === matchId);
                    if (match) {
                        match.round = round;
                        return match;
                    }
                } else if (round === 'final' && matches && matches.Id === matchId) {
                    matches.round = round;
                    return matches;
                }
            }
            
            return null;
        }

        // --- GROUP STAGE LOGIC ---
        
        function recalculateAndSortGroupTables() {
            if (!tournamentData || !tournamentData.groups) return;

            for (const groupKey in tournamentData.groups) {
                const group = tournamentData.groups[groupKey];
                const teams = {};

                // Khởi tạo bảng thống kê cho từng đội
                group.teams.forEach(team => {
                    teams[team.Id] = {
                        ...team,
                        P: 0, W: 0, D: 0, L: 0, 
                        PF: 0, PA: 0, PD: 0, Pts: 0
                    };
                });

                // Xử lý từng trận đấu
                group.matches.forEach(match => {
                    const diff = scoreDiffData[match.Id] || {};
                    const sA = diff.sA !== undefined ? diff.sA : match.sA;
                    const sB = diff.sB !== undefined ? diff.sB : match.sB;
                    
                    if (sA === null || sB === null || isNaN(sA) || isNaN(sB)) return;

                    const teamA = teams[match.pA];
                    const teamB = teams[match.pB];

                    if (!teamA || !teamB) return; 

                    teamA.P++; teamB.P++;
                    teamA.PF += sA; teamA.PA += sB; teamA.PD += (sA - sB);
                    teamB.PF += sB; teamB.PA += sA; teamB.PD += (sB - sA);

                    if (sA > sB) {
                        teamA.W++; teamB.L++; teamA.Pts += GROUP_SCORE_WIN;
                    } else if (sB > sA) {
                        teamB.W++; teamA.L++; teamB.Pts += GROUP_SCORE_WIN;
                    } else {
                        teamA.D++; teamB.D++; // Không có điểm nếu hòa (theo ví dụ)
                    }
                });

                // Sắp xếp lại danh sách đội trong group
                const sortedTeams = Object.values(teams).sort((a, b) => {
                    // 1. Số trận thắng (W)
                    if (b.W !== a.W) return b.W - a.W;
                    // 2. Điểm tích lũy (Pts) - 3 điểm/thắng
                    if (b.Pts !== a.Pts) return b.Pts - a.Pts;
                    // 3. Hiệu số điểm (PD)
                    if (b.PD !== a.PD) return b.PD - a.PD;
                    // 4. Điểm ghi được (PF)
                    return b.PF - a.PF;
                });
                
                // Cập nhật lại list team
                group.teams = sortedTeams;
                
                // Xác định 2 đội đi tiếp
                if (group.teams.length >= 2) {
                    group.team1 = group.teams[0].Id;
                    group.team2 = group.teams[1].Id;
                } else {
                    group.team1 = null;
                    group.team2 = null;
                }
            }
        }
        
        // --- KNOCKOUT STAGE LOGIC ---
        
        function seedKnockoutMatches() {
            if (!tournamentData || !tournamentData.groups) return;
            
            const g = tournamentData.groups;
            
            // Kiểm tra và điền các đội vào Tứ kết
            if (tournamentData.quarterfinals && tournamentData.quarterfinals.length === 4) {
                // QF1: A1 vs B2
                tournamentData.quarterfinals[0].pA = g.A.team1;
                tournamentData.quarterfinals[0].pB = g.B.team2;
                
                // QF2: B1 vs A2
                tournamentData.quarterfinals[1].pA = g.B.team1;
                tournamentData.quarterfinals[1].pB = g.A.team2;
                
                // QF3: C1 vs D2
                tournamentData.quarterfinals[2].pA = g.C.team1;
                tournamentData.quarterfinals[2].pB = g.D.team2;
                
                // QF4: D1 vs C2
                tournamentData.quarterfinals[3].pA = g.D.team1;
                tournamentData.quarterfinals[3].pB = g.C.team2;
            }
        }
        
        function updateKnockoutMatches(round) {
            if (!tournamentData) return;
            
            let currentMatches, nextMatches;

            if (round === 'quarterfinals') {
                currentMatches = tournamentData.quarterfinals;
                nextMatches = tournamentData.semifinals;
            } else if (round === 'semifinals') {
                currentMatches = tournamentData.semifinals;
                nextMatches = tournamentData.final;
            } else if (round === 'final') {
                currentMatches = [tournamentData.final]; // Đưa vào mảng để xử lý dễ dàng
            } else {
                return;
            }

            currentMatches.forEach((match, index) => {
                const { winnerId, loserId } = calculateWinner(match, true);
                
                match.Wn = winnerId;

                // XÁC ĐỊNH HẠNG BA & Á QUÂN
                if (round === 'final') {
                    // Chung kết: rU là Á quân
                    match.rU = loserId; 
                } else if (round === 'semifinals') { 
                    // Bán kết: rU là ID đội thua (sẽ là hạng Ba đồng hạng)
                    match.rU = loserId; 
                } else {
                    // Tứ kết: Đảm bảo rU là null
                    match.rU = null;
                }


                // Chuyển đội thắng sang vòng tiếp theo (trừ trận Chung kết)
                if (winnerId && round !== 'final' && nextMatches) {
                    let nextMatch;
                    let nextPos; // pA hoặc pB

                    if (Array.isArray(nextMatches)) { // Tứ kết -> Bán kết
                         // Logic phức tạp hơn nếu không có trường Pos rõ ràng. Giả định Pos được sử dụng để phân biệt.
                         nextMatch = nextMatches.find(m => m.Pos === match.Pos);
                         // Xác định vị trí tiếp theo (pA/pB) dựa trên vị trí của người thắng trong cặp đấu tiếp theo
                         if (match.Pos === 'W_QF1' || match.Pos === 'W_QF2') { // QF1, QF2 -> SF1 (nextMatch là SF1)
                             if (index === 0) nextPos = 'pA'; // Người thắng QF1 là pA của SF1
                             else if (index === 1) nextPos = 'pB'; // Người thắng QF2 là pB của SF1
                         } else if (match.Pos === 'W_QF3' || match.Pos === 'W_QF4') { // QF3, QF4 -> SF2
                             if (index === 2) nextPos = 'pA'; // Người thắng QF3 là pA của SF2
                             else if (index === 3) nextPos = 'pB'; // Người thắng QF4 là pB của SF2
                         }

                    } else { // Bán kết -> Chung kết
                        nextMatch = nextMatches; // nextMatches là đối tượng final
                        // Giả định SF1 -> pA của Final, SF2 -> pB của Final
                        nextPos = match.Pos === 'W_SF1' ? 'pA' : 'pB';
                    }
                    
                    if (nextMatch) {
                        if (nextPos === 'pA') {
                            nextMatch.pA = winnerId;
                        } else if (nextPos === 'pB') {
                            nextMatch.pB = winnerId;
                        }
                    }
                }
            });
        }
        
        // HÀM MỚI XÁC ĐỊNH HẠNG CUỐI CÙNG
        function determineFinalRanks() {
            if (!tournamentData) return;

            const finalMatch = tournamentData.final;
            const semifinals = tournamentData.semifinals;
            
            const finalResults = {
                champion: null, // Vô địch (Wn của Final)
                runnerUp: null, // Á quân (rU của Final)
                thirdPlace: []  // Hai giải Ba đồng hạng (rU của Semifinals)
            };

            // 1. Vô địch & Á quân
            if (finalMatch && finalMatch.Wn && finalMatch.rU) {
                finalResults.champion = finalMatch.Wn; 
                finalResults.runnerUp = finalMatch.rU; 
            }

            // 2. Hai giải Ba đồng hạng
            if (semifinals && Array.isArray(semifinals)) {
                semifinals.forEach(match => {
                    // Đọc ID đội thua (rU) từ 2 trận Bán kết
                    if (match.rU) { 
                        finalResults.thirdPlace.push(match.rU);
                    }
                });
            }
            
            // Lưu kết quả cuối cùng vào đối tượng dữ liệu giải đấu
            tournamentData.finalRanks = finalResults;
        }

        // --- RENDER FUNCTIONS ---
        
        function getTeamName(id) {
            if (!tournamentData || !tournamentData.teams) return `[Đội ID: ${id}]`;
            const team = tournamentData.teams.find(t => t.Id === id);
            return team ? team.Name : `[Đội ID: ${id}]`;
        }
        
        function renderMatch(match, round) {
            // Nếu không có dữ liệu giải đấu, hiển thị thẻ rỗng
            if (!tournamentData) return `<div class="match-card p-3 rounded-lg shadow-md flex justify-center text-gray-500">Chưa tải được cấu trúc giải đấu. Vui lòng kiểm tra tab Cài đặt.</div>`;
            
            const diff = scoreDiffData[match.Id] || {};
            const sA = diff.sA !== undefined ? diff.sA : match.sA;
            const sB = diff.sB !== undefined ? diff.sB : match.sB;
            
            const teamAId = match.pA;
            const teamBId = match.pB;
            
            const teamAName = getTeamName(teamAId);
            const teamBName = getTeamName(teamBId);
            
            const winnerClassA = (match.Wn && match.Wn === teamAId) ? 'font-bold text-accent-color' : '';
            const winnerClassB = (match.Wn && match.Wn === teamBId) ? 'font-bold text-accent-color' : '';

            // Nếu chưa xác định pA hoặc pB (vòng Knockout chưa đủ đội)
            const teamALabel = teamAId ? teamAName : (match.pA_Pos || match.Pos ? `(${match.pA_Pos || match.Pos.replace('W_', 'Thắng ')})` : 'Chờ đội...');
            const teamBLabel = teamBId ? teamBName : (match.pB_Pos ? `(${match.pB_Pos.replace('W_', 'Thắng ')})` : 'Chờ đội...');
            
            return `
                <div class="match-card p-3 rounded-lg shadow-md flex justify-between items-center space-x-2">
                    <div class="flex-1 space-y-2">
                        <div class="flex items-center space-x-2">
                            <span class="flex-1 truncate ${winnerClassA}">${teamALabel}</span>
                            <input 
                                type="number" 
                                min="0"
                                value="${sA !== null ? sA : ''}"
                                class="score-input w-16 p-1 text-center rounded text-base focus:outline-none focus:ring-2 focus:ring-accent-color"
                                onchange="updateScore('${match.Id}', 'pA', this.value)"
                                ${!teamAId ? 'disabled' : ''}
                            />
                        </div>
                        <div class="flex items-center space-x-2">
                            <span class="flex-1 truncate ${winnerClassB}">${teamBLabel}</span>
                            <input 
                                type="number" 
                                min="0"
                                value="${sB !== null ? sB : ''}"
                                class="score-input w-16 p-1 text-center rounded text-base focus:outline-none focus:ring-2 focus:ring-accent-color"
                                onchange="updateScore('${match.Id}', 'pB', this.value)"
                                ${!teamBId ? 'disabled' : ''}
                            />
                        </div>
                    </div>
                </div>
            `;
        }

        function renderGroupSection() {
            const groupDiv = document.getElementById('group');
            if (!tournamentData || !tournamentData.groups) {
                groupDiv.innerHTML = `<div class="text-center py-12 text-gray-500">Chưa có dữ liệu vòng bảng. Vui lòng tải từ GitHub (tab Cài đặt).</div>`;
                return;
            }
            
            let html = '';

            GROUP_ORDER.forEach(groupKey => {
                const group = tournamentData.groups[groupKey];
                if (!group) return;

                // 1. Render Bảng Xếp Hạng
                html += `
                    <div class="mb-6 card p-3 rounded-lg shadow-xl">
                        <h3 class="text-xl font-bold mb-3 group-header">BẢNG ${groupKey}</h3>
                        <div class="overflow-x-auto">
                            <table class="min-w-full text-sm">
                                <thead class="border-b border-border-color">
                                    <tr class="text-left font-semibold">
                                        <th class="py-2 px-1">#</th>
                                        <th class="py-2 px-1">Đội</th>
                                        <th class="py-2 px-1 text-center">P</th>
                                        <th class="py-2 px-1 text-center">W</th>
                                        <th class="py-2 px-1 text-center">PD</th>
                                        <th class="py-2 px-1 text-center">Pts</th>
                                    </tr>
                                </thead>
                                <tbody>
                `;
                
                group.teams.forEach((team, index) => {
                    const rankClass = (index === 0 || index === 1) ? 'font-bold text-accent-color' : '';
                    html += `
                        <tr class="border-b border-border-color/50">
                            <td class="py-2 px-1 ${rankClass}">${index + 1}</td>
                            <td class="py-2 px-1 truncate max-w-[100px] ${rankClass}">${team.Name}</td>
                            <td class="py-2 px-1 text-center">${team.P}</td>
                            <td class="py-2 px-1 text-center">${team.W}</td>
                            <td class="py-2 px-1 text-center">${team.PD > 0 ? '+' : ''}${team.PD}</td>
                            <td class="py-2 px-1 text-center ${rankClass}">${team.Pts}</td>
                        </tr>
                    `;
                });

                html += `
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
                
                // 2. Render Trận Đấu
                html += `<h4 class="text-lg font-semibold mb-2 group-header">Trận đấu Bảng ${groupKey}</h4>`;
                html += '<div class="space-y-3 mb-6">';
                group.matches.forEach(match => {
                    html += renderMatch(match, 'group');
                });
                html += '</div>';
            });

            groupDiv.innerHTML = html;
        }

        function renderKnockoutSection(round) {
            const containerId = round + '-matches';
            const container = document.getElementById(containerId);
            if (!tournamentData || !tournamentData[round]) {
                if (container) container.innerHTML = `<div class="text-center py-6 text-gray-500">Chưa có dữ liệu vòng ${round}.</div>`;
                return;
            }
            
            let html = '';
            
            if (round === 'final') {
                html = renderMatch(tournamentData.final, 'final');
            } else { 
                tournamentData[round].forEach(match => {
                    html += renderMatch(match, round);
                });
            }

            if (container) container.innerHTML = html;
        }
        
        function renderFinalSection() {
            // Render trận Chung kết trước
            renderKnockoutSection('final');
            
            const summaryDiv = document.getElementById('final-ranks-summary');
            let html = '<ul class="space-y-3 font-semibold">';

            if (tournamentData && tournamentData.finalRanks) {
                const ranks = tournamentData.finalRanks;
                
                // 1. Vô địch
                html += `
                    <li class="p-3 bg-yellow-900/50 rounded-lg flex justify-between items-center">
                        <span class="text-xl text-yellow-300">🥇 VÔ ĐỊCH</span>
                        <span class="text-xl text-yellow-300">${ranks.champion ? getTeamName(ranks.champion) : 'Chưa có'}</span>
                    </li>
                `;
                
                // 2. Á quân
                html += `
                    <li class="p-3 bg-gray-700/50 rounded-lg flex justify-between items-center">
                        <span class="text-lg text-gray-300">🥈 Á QUÂN</span>
                        <span class="text-lg text-gray-300">${ranks.runnerUp ? getTeamName(ranks.runnerUp) : 'Chưa có'}</span>
                    </li>
                `;
                
                // 3. Hai giải Ba đồng hạng
                html += `
                    <li class="p-3 bg-amber-700/50 rounded-lg">
                        <span class="block text-md text-amber-300 mb-2">🥉 HẠNG BA ĐỒNG HẠNG</span>
                        <ul class="ml-4 space-y-1">
                            ${ranks.thirdPlace.map(id => 
                                `<li class="text-amber-200">${getTeamName(id)}</li>`
                            ).join('')}
                            ${ranks.thirdPlace.length < 2 ? `<li class="text-amber-200">Chưa đủ đội</li>` : ''}
                        </ul>
                    </li>
                `;
                
            } else {
                 html += `<li class="text-center text-gray-400">Chưa có đủ dữ liệu để xếp hạng chung cuộc.</li>`;
            }

            html += '</ul>';
            summaryDiv.innerHTML = `<h3 class="text-lg font-bold mb-3 group-header">XẾP HẠNG CHUNG CUỘC</h3>${html}`;
        }


        // --- MAIN LOGIC FLOW ---
        
        function runAllLogic() {
            if (!tournamentData) {
                 renderAllSections();
                 updateDiffData();
                 return;
            }
            
            // 1. Vòng Bảng
            recalculateAndSortGroupTables(); 
            
            // 2. Vòng Knockout: Gieo hạt (chuyển đội từ Vòng Bảng)
            seedKnockoutMatches();
            
            // 3. Cập nhật kết quả Knockout (theo thứ tự)
            updateKnockoutMatches('quarterfinals');
            updateKnockoutMatches('semifinals');
            updateKnockoutMatches('final');
            
            // 4. TÍNH TOÁN XẾP HẠNG CUỐI CÙNG
            determineFinalRanks(); 

            // 5. Render và chuẩn bị đồng bộ
            renderAllSections();
            updateDiffData();
        }

        function renderAllSections() {
            renderGroupSection();
            renderKnockoutSection('quarterfinals');
            renderKnockoutSection('semifinals');
            renderFinalSection();
        }

        function updateDiffData() {
            const commitButton = document.querySelector('button[onclick="commitChanges()"]');
            if (!commitButton) return;

            if (Object.keys(scoreDiffData).length > 0) {
                 commitButton.textContent = `ĐỒNG BỘ LÊN GITHUB (${Object.keys(scoreDiffData).length} thay đổi)`;
                 commitButton.classList.add('bg-red-600', 'hover:bg-red-700');
                 commitButton.classList.remove('bg-cyan-600', 'hover:bg-cyan-700');
            } else {
                 commitButton.textContent = 'ĐỒNG BỘ LÊN GITHUB (Không thay đổi)';
                 commitButton.classList.remove('bg-red-600', 'hover:bg-red-700');
                 commitButton.classList.add('bg-cyan-600', 'hover:bg-cyan-700');
            }
        }

        async function commitChanges() {
            if (Object.keys(scoreDiffData).length === 0) {
                alert('Không có thay đổi tỉ số nào để đồng bộ.');
                return;
            }
            
            // Chuẩn bị commit message
            const count = Object.keys(scoreDiffData).length;
            const commitMessage = `Cập nhật tỉ số (${count} trận) - ${new Date().toLocaleString()}`;
            
            const success = await uploadGitHubFile('state3s.json', scoreDiffData, commitMessage);
            
            if (success) {
                // Sau khi upload thành công, xóa dữ liệu diff cũ và tải lại để đảm bảo đồng bộ
                scoreDiffData = {}; 
                updateDiffData(); // Cập nhật lại nút
                alert('Đồng bộ tỉ số thành công!');
                loadDataFromGitHub();
            }
        }
        
        // --- DATA RESYNC UTILS ---
        
        function reSyncStaticDataPrompt() {
            document.getElementById('confirmationBox').classList.remove('hidden');
        }

        async function reSyncStaticData() {
            document.getElementById('confirmationBox').classList.add('hidden');
             const staticData = await fetchGitHubFile('state3.json');
             if (staticData) {
                 tournamentData = staticData;
                 scoreDiffData = {}; // Xóa hết tỉ số cũ
                 runAllLogic();
                 alert('Đã làm mới cấu trúc giải đấu (state3.json) và xóa tỉ số (state3s.json).');
             }
        }


        // --- TAB & SWIPE LOGIC ---
        
        function changeTab(targetTabId) {
            currentTab = targetTabId;
            const tabs = ['group', 'qf', 'sf', 'final', 'settings'];
            const tabButtons = document.querySelectorAll('.tab-button');
            const container = document.getElementById('tabContentContainer');
            
            const tabIndex = tabs.indexOf(targetTabId);
            const offset = tabIndex * -20; // 100% / 5 tabs = 20%
            container.style.transform = `translateX(${offset}%)`;
            
            tabButtons.forEach(button => {
                button.classList.remove('active');
                button.classList.add('border-transparent');
                if (button.getAttribute('data-tab') === targetTabId) {
                    button.classList.add('active');
                    button.classList.remove('border-transparent');
                }
            });
            
             // Chỉ ẩn/hiện tab đang hoạt động để tránh lỗi render
            tabs.forEach(tabId => {
                const tabElement = document.getElementById(tabId);
                if (tabElement) {
                    if (tabId === targetTabId) {
                        tabElement.classList.remove('hidden');
                    } else {
                        tabElement.classList.add('hidden');
                    }
                }
            });
        }
        
        document.querySelectorAll('.tab-button').forEach(button => {
            button.addEventListener('click', (e) => {
                changeTab(e.target.getAttribute('data-tab'));
            });
        });

        function handleGesture() {
            const tabs = ['group', 'qf', 'sf', 'final', 'settings'];
            const currentIndex = tabs.indexOf(currentTab);

            if (startX - endX > 50) { // Vuốt sang trái (Chuyển sang tab tiếp theo)
                if (currentIndex < tabs.length - 1) {
                    changeTab(tabs[currentIndex + 1]);
                }
            } else if (endX - startX > 50) { // Vuốt sang phải (Chuyển sang tab trước đó)
                if (currentIndex > 0) {
                    changeTab(tabs[currentIndex - 1]);
                }
            }
        }


        // --- INITIALIZATION ---
        
        function initializeApp() {
            applyTheme();
            getGitHubConfig();
            
            // Điền thông tin setting đã lưu (nếu có)
            document.getElementById('githubRepo').value = githubConfig.repo || '';
            document.getElementById('githubBranch').value = githubConfig.branch || 'main';
            if (githubConfig.token) {
                 document.getElementById('githubToken').value = '********';
            }

            // Event listeners
            document.getElementById('themeToggle').addEventListener('click', toggleTheme);
            document.getElementById('app').addEventListener('touchstart', (e) => {
                // Đảm bảo không kích hoạt swipe khi chạm vào input
                if (e.target.classList.contains('score-input') || e.target.classList.contains('text-input')) return;
                startX = e.changedTouches[0].screenX;
            }, { passive: true });

            document.getElementById('app').addEventListener('touchend', (e) => {
                // Đảm bảo không kích hoạt swipe khi chạm vào input
                if (e.target.classList.contains('score-input') || e.target.classList.contains('text-input')) return;
                endX = e.changedTouches[0].screenX;
                handleGesture();
            }, { passive: true });
            
            // Modal button setup
            document.getElementById('confirmYes').onclick = window.reSyncStaticData;
            document.getElementById('confirmNo').onclick = () => document.getElementById('confirmationBox').classList.add('hidden');
            
            // ----------------------------------------------------
            // KHẮC PHỤC QUAN TRỌNG: Khởi tạo UI và Tab trước khi tải Data
            // ----------------------------------------------------
            changeTab(currentTab); 
            renderAllSections(); 
            
            // Bắt đầu tải dữ liệu (sẽ không làm hỏng UI nếu lỗi)
            loadDataFromGitHub();
        }

        window.onload = initializeApp;
    </script>
</body>
</html>
