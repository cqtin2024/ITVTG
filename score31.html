<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qu·∫£n L√Ω Gi·∫£i ƒê·∫•u Pickleball ƒê√¥i Nam (GitHub API Sync)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100;400;700;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #111827;
            --text-color: #f3f4f6;
            --card-bg: #1f2937;
            --border-color: #374151;
            --accent-color: #06b6d4;
            --match-bg: #1f2937;
            --input-bg: #4b5563;
            --group-header-text: #60a5fa;
        }
        .light-mode {
            --bg-color: #f9fafb;
            --text-color: #111827;
            --card-bg: #ffffff;
            --border-color: #e5e7eb;
            --accent-color: #ef4444;
            --match-bg: #f3f4f6;
            --input-bg: #ffffff;
            --group-header-text: #10b981;
        }
        body { font-family: 'Inter', sans-serif; background-color: var(--bg-color); color: var(--text-color); transition: background-color 0.3s, color 0.3s; }
        .tab-button.active { color: var(--accent-color); border-color: var(--accent-color); background-color: var(--card-bg); }
        .tab-content { display: none; background-color: var(--card-bg); border-radius: 0.75rem; padding: 1.5rem; }
    </style>
</head>
<body class="p-4 md:p-8">
    <div id="app" class="container mx-auto">
        <header class="flex items-center justify-between mb-6">
            <div class="flex items-center">
                <svg class="w-10 h-10 text-[var(--accent-color)]" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 15.75l-4-4m0 0l4-4m-4 4h14M17 12a5 5 0 11-10 0 5 5 0 0110 0z"></path></svg>
                <div class="ml-4">
                    <h1 class="text-2xl font-extrabold text-[var(--text-color)]">PICKLEBALL ƒê√îI NAM</h1>
                    <p class="text-xs text-[var(--accent-color)]">Qu·∫£n L√Ω & C·∫≠p Nh·∫≠t T·ªâ S·ªë (GitHub API Sync)</p>
                </div>
            </div>
            <button id="themeToggle" class="p-3 rounded-full bg-[var(--card-bg)] text-[var(--text-color)] hover:bg-[var(--border-color)]">
                üåó
            </button>
        </header>

        <div id="statusMessage" class="text-center p-4 bg-blue-900/50 rounded-lg text-blue-300 font-semibold mb-6">
            ƒêang t·∫£i d·ªØ li·ªáu t·ª´ GitHub...
        </div>

        <nav class="mb-8 border-b border-[var(--border-color)] overflow-x-auto whitespace-nowrap">
            <button class="tab-button py-3 px-4 border-b-2 border-transparent" onclick="switchTab('General')" data-tab="General">General</button>
            <button class="tab-button py-3 px-4 border-b-2 border-transparent" onclick="switchTab('GroupA')" data-tab="GroupA">Group A</button>
            <button class="tab-button py-3 px-4 border-b-2 border-transparent" onclick="switchTab('GroupB')" data-tab="GroupB">Group B</button>
            <button class="tab-button py-3 px-4 border-b-2 border-transparent" onclick="switchTab('GroupC')" data-tab="GroupC">Group C</button>
            <button class="tab-button py-3 px-4 border-b-2 border-transparent" onclick="switchTab('GroupD')" data-tab="GroupD">Group D</button>
            <button class="tab-button py-3 px-4 border-b-2 border-transparent" onclick="switchTab('Knockout')" data-tab="Knockout">Knockout</button>
            <button class="tab-button py-3 px-4 border-b-2 border-transparent" onclick="switchTab('Configuration')" data-tab="Configuration">C·∫•u H√¨nh</button>
        </nav>

        <div id="General" class="tab-content">
            <h2 class="text-xl font-bold text-yellow-500 mb-2">K·∫øt qu·∫£ chung cu·ªôc</h2>
            <div id="finalResults"></div>
        </div>
        <div id="GroupA" class="tab-content grid grid-cols-1 lg:grid-cols-3 gap-6"><div id="tableA"></div><div id="matchesA"></div></div>
        <div id="GroupB" class="tab-content grid grid-cols-1 lg:grid-cols-3 gap-6"><div id="tableB"></div><div id="matchesB"></div></div>
        <div id="GroupC" class="tab-content grid grid-cols-1 lg:grid-cols-3 gap-6"><div id="tableC"></div><div id="matchesC"></div></div>
        <div id="GroupD" class="tab-content grid grid-cols-1 lg:grid-cols-3 gap-6"><div id="tableD"></div><div id="matchesD"></div></div>
        <div id="Knockout" class="tab-content"><div id="quarterfinals"></div><div id="semifinals"></div><div id="finalSection"></div></div>

        <div id="Configuration" class="tab-content space-y-8">
            <h2 class="text-2xl font-bold text-red-500">C·∫•u H√¨nh & ƒê·ªìng B·ªô (GitHub API)</h2>
            <input type="password" id="githubToken" class="w-full p-2 rounded-md border border-gray-600" placeholder="D√°n GitHub Token v√†o ƒë√¢y...">
            <button onclick="saveToken()" class="bg-green-600 text-white px-4 py-2 rounded-lg mt-2">L∆∞u Token</button>
            <button onclick="commitChangesToGitHub()" id="commitButton" class="bg-purple-600 text-white px-4 py-2 rounded-lg mt-2">COMMIT T·ªà S·ªê L√äN GITHUB</button>
            <div id="commitResult" class="hidden mt-3 p-3 rounded-lg text-sm font-semibold"></div>
        </div>
    </div>

<!-- ========================================================= -->
<!-- üîß SCRIPT ƒê√É ƒê∆Ø·ª¢C FIX: COMMIT KH√îNG L·ªñI                    -->
<!-- ========================================================= -->
<script>
const GITHUB_REPO_OWNER = 'cqtin2024';
const GITHUB_REPO_NAME = 'ITVTG';
const FILE_PATH = 'data/state3s.json';
const BRANCH = 'main';
const API_URL = `https://api.github.com/repos/${GITHUB_REPO_OWNER}/${GITHUB_REPO_NAME}/contents/${FILE_PATH}`;
const BASE_DATA_URL = `https://raw.githubusercontent.com/${GITHUB_REPO_OWNER}/${GITHUB_REPO_NAME}/main/data/state3.json`;

let tournamentData = null;
let githubToken = '';

function jsonToBase64(obj) {
  return btoa(unescape(encodeURIComponent(JSON.stringify(obj, null, 2))));
}
function showStatus(message, type = 'info') {
  const el = document.getElementById('commitResult');
  el.innerHTML = message;
  el.classList.remove('hidden');
  el.className = `mt-3 p-3 rounded-lg text-sm font-semibold ${type === 'success'
    ? 'bg-green-900/50 text-green-200'
    : type === 'error'
      ? 'bg-red-900/50 text-red-200'
      : 'bg-blue-900/50 text-blue-200'}`;
  console.log(message);
}

async function loadDataFromGitHub() {
  const status = document.getElementById('statusMessage');
  status.textContent = 'ƒêang t·∫£i d·ªØ li·ªáu t·ª´ GitHub...';
  status.classList.remove('hidden');
  try {
    const res = await fetch(BASE_DATA_URL);
    if (!res.ok) throw new Error(`Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu (${res.status})`);
    tournamentData = await res.json();
    status.textContent = '‚úÖ D·ªØ li·ªáu ƒë√£ t·∫£i xong.';
    setTimeout(() => status.classList.add('hidden'), 1500);
    renderUI();
  } catch (e) {
    console.error(e);
    status.textContent = '‚ùå L·ªói khi t·∫£i d·ªØ li·ªáu.';
    status.classList.add('bg-red-900/50');
  }
}

async function commitChangesToGitHub() {
  githubToken = localStorage.getItem('githubToken') || '';
  if (!githubToken) return showStatus('‚ö†Ô∏è Vui l√≤ng nh·∫≠p v√† l∆∞u GitHub Token.', 'error');
  if (!tournamentData) return showStatus('‚ùå Ch∆∞a c√≥ d·ªØ li·ªáu ƒë·ªÉ commit.', 'error');

  const base64Content = jsonToBase64(tournamentData);
  const headers = {
    'Authorization': `token ${githubToken}`,
    'Accept': 'application/vnd.github.v3+json',
    'Content-Type': 'application/json'
  };

  try {
    const getRes = await fetch(API_URL + `?ref=${BRANCH}`, { headers });
    let currentSha = null;
    if (getRes.status === 200) {
      const data = await getRes.json();
      currentSha = data.sha;
      showStatus(`ƒê√£ l·∫•y SHA hi·ªán t·∫°i: ${currentSha.substring(0, 8)}...`);
    } else if (getRes.status === 404) showStatus('File ch∆∞a t·ªìn t·∫°i, s·∫Ω t·∫°o m·ªõi...', 'info');
    else if (getRes.status === 401) throw new Error('Token kh√¥ng h·ª£p l·ªá ho·∫∑c thi·∫øu quy·ªÅn repo.');

    const putRes = await fetch(API_URL, {
      method: 'PUT',
      headers,
      body: JSON.stringify({
        message: 'Update state3s.json via tournament app',
        content: base64Content,
        branch: BRANCH,
        sha: currentSha || undefined
      })
    });

    if (putRes.status === 401) throw new Error('Token sai ho·∫∑c h·∫øt h·∫°n.');
    if (!putRes.ok) {
      const err = await putRes.json();
      throw new Error(`L·ªói commit: ${putRes.status} - ${err.message}`);
    }

    const result = await putRes.json();
    showStatus(
      `‚úÖ Commit th√†nh c√¥ng! SHA: <a href="${result.commit.html_url}" target="_blank" class="underline">${result.commit.sha.substring(0, 7)}</a>`,
      'success'
    );
  } catch (err) {
    console.error(err);
    showStatus(`‚ùå L·ªói khi commit: ${err.message}`, 'error');
  }
}

function saveToken() {
  const token = document.getElementById('githubToken').value.trim();
  if (!token) {
    localStorage.removeItem('githubToken');
    showStatus('ƒê√£ x√≥a token c·ª•c b·ªô.', 'info');
    return;
  }
  localStorage.setItem('githubToken', token);
  document.getElementById('githubToken').value = '********';
  showStatus('ƒê√£ l∆∞u token c·ª•c b·ªô.', 'success');
}

function switchTab(tabName) {
  document.querySelectorAll('.tab-content').forEach(c => c.style.display = 'none');
  document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
  document.getElementById(tabName).style.display = 'block';
  const btn = document.querySelector(`.tab-button[data-tab="${tabName}"]`);
  if (btn) btn.classList.add('active');
}

function renderUI() {
  if (!tournamentData) return;
  document.getElementById('finalResults').innerHTML =
    `<p class="text-yellow-400">C·∫≠p nh·∫≠t t·ª´ GitHub th√†nh c√¥ng (${new Date().toLocaleTimeString()})</p>`;
  switchTab('General');
}

function initializeApp() {
  githubToken = localStorage.getItem('githubToken') || '';
  if (githubToken) document.getElementById('githubToken').value = '********';
  document.getElementById('themeToggle').onclick = () => document.body.classList.toggle('light-mode');
  loadDataFromGitHub();
}
window.onload = initializeApp;
</script>
</body>
</html>
