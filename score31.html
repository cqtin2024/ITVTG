<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Pickleball Championship ‚Äì Final Stable</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;600;800&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Inter', sans-serif; transition: background 0.3s, color 0.3s; }
    :root {
      --bg: #111827; --text: #f9fafb; --accent: #06b6d4;
      --card: #1f2937; --border: #374151;
    }
    .light-mode {
      --bg: #f9fafb; --text: #111827; --accent: #ef4444;
      --card: #ffffff; --border: #e5e7eb;
    }
    body { background-color: var(--bg); color: var(--text); }
    .tab-button.active { color: var(--accent); border-color: var(--accent); }
    .tab-content { display: none; background: var(--card); padding: 1.5rem; border-radius: 0.75rem; }
  </style>
</head>

<body class="p-4 md:p-8">
  <div class="container mx-auto">
    <header class="flex items-center justify-between mb-6">
      <div class="flex items-center">
        <svg class="w-10 h-10 text-[var(--accent)]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 15.75l-4-4m0 0l4-4m-4 4h14M17 12a5 5 0 11-10 0 5 5 0 0110 0z"/>
        </svg>
        <div class="ml-4">
          <h1 class="text-2xl font-extrabold">Pickleball Championship</h1>
          <p class="text-xs text-[var(--accent)]">Stable Version ‚Äì Sync with GitHub</p>
        </div>
      </div>
      <button id="themeToggle" class="p-3 rounded-full bg-[var(--card)] text-[var(--text)] hover:bg-[var(--border)]">üåó</button>
    </header>

    <div id="statusMessage" class="text-center p-4 bg-blue-900/50 rounded-lg text-blue-300 font-semibold mb-6">
      ƒêang t·∫£i d·ªØ li·ªáu...
    </div>

    <!-- Tabs -->
    <nav class="mb-8 border-b border-[var(--border)] overflow-x-auto whitespace-nowrap">
      <button class="tab-button py-3 px-4 border-b-2 border-transparent" onclick="switchTab('General')" data-tab="General">General</button>
      <button class="tab-button py-3 px-4 border-b-2 border-transparent" onclick="switchTab('GroupA')" data-tab="GroupA">Group A</button>
      <button class="tab-button py-3 px-4 border-b-2 border-transparent" onclick="switchTab('GroupB')" data-tab="GroupB">Group B</button>
      <button class="tab-button py-3 px-4 border-b-2 border-transparent" onclick="switchTab('GroupC')" data-tab="GroupC">Group C</button>
      <button class="tab-button py-3 px-4 border-b-2 border-transparent" onclick="switchTab('GroupD')" data-tab="GroupD">Group D</button>
      <button class="tab-button py-3 px-4 border-b-2 border-transparent" onclick="switchTab('Knockout')" data-tab="Knockout">Knockout</button>
      <button class="tab-button py-3 px-4 border-b-2 border-transparent" onclick="switchTab('Configuration')" data-tab="Configuration">C·∫•u H√¨nh</button>
    </nav>

    <div id="General" class="tab-content"><div id="finalResults"></div></div>
    <div id="GroupA" class="tab-content grid grid-cols-1 lg:grid-cols-2 gap-4"><div id="tableA"></div><div id="matchesA"></div></div>
    <div id="GroupB" class="tab-content grid grid-cols-1 lg:grid-cols-2 gap-4"><div id="tableB"></div><div id="matchesB"></div></div>
    <div id="GroupC" class="tab-content grid grid-cols-1 lg:grid-cols-2 gap-4"><div id="tableC"></div><div id="matchesC"></div></div>
    <div id="GroupD" class="tab-content grid grid-cols-1 lg:grid-cols-2 gap-4"><div id="tableD"></div><div id="matchesD"></div></div>
    <div id="Knockout" class="tab-content space-y-4"><div id="quarterfinals"></div><div id="semifinals"></div><div id="finalSection"></div></div>

    <div id="Configuration" class="tab-content space-y-4">
      <h2 class="text-xl font-bold text-red-500">ƒê·ªìng B·ªô D·ªØ Li·ªáu</h2>
      <input type="password" id="githubToken" class="w-full p-2 rounded-md border border-gray-600" placeholder="D√°n GitHub Token..." />
      <button onclick="saveToken()" class="bg-green-600 text-white px-4 py-2 rounded-lg mt-2">L∆∞u Token</button>
      <button onclick="commitChangesToGitHub()" class="bg-purple-600 text-white px-4 py-2 rounded-lg mt-2">COMMIT L√äN GITHUB</button>
      <div id="commitResult" class="hidden mt-3 p-3 rounded-lg text-sm font-semibold"></div>
    </div>
  </div>

  <!-- ========================================================= -->
  <!-- SCRIPT CHU·∫®N HO√Å: ·ªîN ƒê·ªäNH GITHUB + LOAD D·ªÆ LI·ªÜU AN TO√ÄN   -->
  <!-- ========================================================= -->
  <script>
  const OWNER = "cqtin2024";
  const REPO = "ITVTG";
  const FILE_PATH = "data/state3s.json";
  const BRANCH = "main";
  const API_URL = `https://api.github.com/repos/${OWNER}/${REPO}/contents/${FILE_PATH}`;
  const BASE_DATA_URL = `https://raw.githubusercontent.com/${OWNER}/${REPO}/${BRANCH}/data/state3.json`;

  let tournamentData = null;
  let githubToken = '';

  function jsonToBase64(obj) {
    return btoa(unescape(encodeURIComponent(JSON.stringify(obj, null, 2))));
  }

  function showStatus(msg, type = 'info') {
    const el = document.getElementById('commitResult');
    el.innerHTML = msg;
    el.classList.remove('hidden');
    el.className = `mt-3 p-3 rounded-lg text-sm font-semibold ${
      type === 'success' ? 'bg-green-900/50 text-green-200' :
      type === 'error' ? 'bg-red-900/50 text-red-200' :
      'bg-blue-900/50 text-blue-200'}`;
    console.log(msg);
  }

  // ---------- ƒê·ªçc d·ªØ li·ªáu t·ª´ GitHub, c√≥ retry ----------
  async function fetchWithRetry(url, options = {}, retries = 3) {
    for (let i = 0; i < retries; i++) {
      try {
        const res = await fetch(url, options);
        if (res.ok) return res;
        console.warn(`Fetch attempt ${i+1} failed: ${res.status}`);
      } catch (e) {
        console.warn(`Fetch error: ${e.message}`);
      }
      await new Promise(r => setTimeout(r, 1500));
    }
    throw new Error(`Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu sau ${retries} l·∫ßn th·ª≠`);
  }

  async function loadDataFromGitHub() {
    const status = document.getElementById('statusMessage');
    status.textContent = 'ƒêang t·∫£i d·ªØ li·ªáu t·ª´ GitHub...';
    try {
      const res = await fetchWithRetry(BASE_DATA_URL);
      tournamentData = await res.json();
      status.textContent = '‚úÖ D·ªØ li·ªáu ƒë√£ t·∫£i xong.';
      setTimeout(()=>status.classList.add('hidden'),1500);
      renderUI();
    } catch(err) {
      status.textContent = '‚ùå L·ªói khi t·∫£i d·ªØ li·ªáu: ' + err.message;
      status.classList.add('bg-red-900/50');
      console.error(err);
    }
  }

  // ---------- Commit c·∫≠p nh·∫≠t t·ªâ s·ªë l√™n GitHub ----------
  async function commitChangesToGitHub() {
    githubToken = localStorage.getItem('githubToken') || '';
    if (!githubToken) return showStatus('‚ö†Ô∏è Vui l√≤ng nh·∫≠p Token.', 'error');
    if (!tournamentData) return showStatus('‚ùå Ch∆∞a c√≥ d·ªØ li·ªáu.', 'error');

    const headers = {
      'Authorization': `token ${githubToken}`,
      'Accept': 'application/vnd.github.v3+json',
      'Content-Type': 'application/json'
    };
    const content = jsonToBase64(tournamentData);

    try {
      const getRes = await fetch(API_URL + `?ref=${BRANCH}`, { headers });
      let sha = null;
      if (getRes.status === 200) {
        const data = await getRes.json();
        sha = data.sha;
        showStatus(`ƒê√£ l·∫•y SHA hi·ªán t·∫°i: ${sha.substring(0,8)}...`);
      } else if (getRes.status === 404) showStatus('File ch∆∞a t·ªìn t·∫°i, s·∫Ω t·∫°o m·ªõi...');
      else if (getRes.status === 401) throw new Error('Token kh√¥ng h·ª£p l·ªá ho·∫∑c thi·∫øu quy·ªÅn.');

      const putRes = await fetch(API_URL, {
        method: 'PUT',
        headers,
        body: JSON.stringify({
          message: `Update state3s.json via app ‚Äì ${new Date().toLocaleString()}`,
          content,
          branch: BRANCH,
          sha: sha || undefined
        })
      });

      if (putRes.status === 401) throw new Error('Token sai ho·∫∑c h·∫øt h·∫°n.');
      if (!putRes.ok) {
        const e = await putRes.json();
        throw new Error(`L·ªói commit: ${e.message}`);
      }

      const result = await putRes.json();
      showStatus(
        `‚úÖ Commit th√†nh c√¥ng! SHA: <a href="${result.commit.html_url}" target="_blank" class="underline">${result.commit.sha.substring(0,7)}</a>`,
        'success'
      );
    } catch(err) {
      console.error(err);
      showStatus(`‚ùå ${err.message}`, 'error');
    }
  }

  // ---------- Token c·ª•c b·ªô ----------
  function saveToken() {
    const t = document.getElementById('githubToken').value.trim();
    if (!t) {
      localStorage.removeItem('githubToken');
      showStatus('ƒê√£ xo√° token c·ª•c b·ªô.', 'info');
      return;
    }
    localStorage.setItem('githubToken', t);
    document.getElementById('githubToken').value = '********';
    showStatus('ƒê√£ l∆∞u token.', 'success');
  }

  // ---------- Giao di·ªán ----------
  function renderGroup(name, tableId, matchesId) {
    const g = tournamentData.groups?.[name];
    if (!g) return;
    document.getElementById(tableId).innerHTML =
      `<h3 class="text-lg font-bold mb-2 text-cyan-400">B·∫£ng ${name}</h3>
      <table class="min-w-full border text-sm">
      <thead><tr><th>ƒê·ªôi</th><th>W</th><th>L</th><th>+/-</th></tr></thead>
      <tbody>${g.teams.map(t=>`<tr><td>${t.name}</td><td>${t.wins}</td><td>${t.losses}</td><td>${t.diff}</td></tr>`).join('')}</tbody>
      </table>`;
    document.getElementById(matchesId).innerHTML =
      `<h4 class="font-semibold mb-2 text-yellow-400">Tr·∫≠n ƒë·∫•u</h4>` +
      g.matches.map(m=>`<div class="p-2 border-b flex justify-between"><span>${m.team1} vs ${m.team2}</span><span>${m.score || '-'}</span></div>`).join('');
  }

  function renderKnockout() {
    const qf = tournamentData.quarterfinals || [];
    const sf = tournamentData.semifinals || [];
    const fn = tournamentData.final || [];
    const section = (t,a)=>`<h3 class="text-lg font-bold mb-2 text-green-400">${t}</h3>` + a.map(m=>`<div class="p-2 border-b">${m.team1} vs ${m.team2} (${m.score||'-'})</div>`).join('');
    document.getElementById('quarterfinals').innerHTML = section('T·ª© k·∫øt', qf);
    document.getElementById('semifinals').innerHTML = section('B√°n k·∫øt', sf);
    document.getElementById('finalSection').innerHTML = section('Chung k·∫øt', fn);
  }

  function renderUI() {
    if (!tournamentData) return;
    renderGroup('A','tableA','matchesA');
    renderGroup('B','tableB','matchesB');
    renderGroup('C','tableC','matchesC');
    renderGroup('D','tableD','matchesD');
    renderKnockout();
    document.getElementById('finalResults').innerHTML = `<p class="text-yellow-400">D·ªØ li·ªáu c·∫≠p nh·∫≠t l√∫c ${new Date().toLocaleTimeString()}</p>`;
    switchTab('General');
  }

  function switchTab(tab) {
    document.querySelectorAll('.tab-content').forEach(c=>c.style.display='none');
    document.querySelectorAll('.tab-button').forEach(b=>b.classList.remove('active'));
    document.getElementById(tab).style.display='block';
    const btn = document.querySelector(`[data-tab="${tab}"]`);
    if(btn) btn.classList.add('active');
    window.scrollTo({ top: 0, behavior: 'smooth' });
  }

  function initializeApp() {
    githubToken = localStorage.getItem('githubToken')||'';
    if (githubToken) document.getElementById('githubToken').value='********';
    document.getElementById('themeToggle').onclick = ()=>document.body.classList.toggle('light-mode');
    loadDataFromGitHub();
  }
  window.onload = initializeApp;
  </script>
</body>
</html>
